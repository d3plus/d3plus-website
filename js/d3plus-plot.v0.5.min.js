/*
  d3plus-plot v0.5.17
  A reusable javascript x/y plot built on D3.
  Copyright (c) 2017 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3plus-common"),require("d3-array"),require("d3-collection"),require("d3-scale"),require("d3-shape"),require("d3plus-axis"),require("d3plus-color"),require("d3plus-shape"),require("d3plus-viz")):typeof define==="function"&&define.amd?define("d3plus-plot",["exports","d3plus-common","d3-array","d3-collection","d3-scale","d3-shape","d3plus-axis","d3plus-color","d3plus-shape","d3plus-viz"],e):e(t.d3plus=t.d3plus||{},t.d3plusCommon,t.d3Array,t.d3Collection,t.scales,t.d3Shape,t.d3plusAxis,t.d3plusColor,t.shapes,t.d3plusViz)})(this,function(t,e,i,r,n,s,o,a,c,f){"use strict";var d=function(t){if(t.includes("d3plus-buffer-start")){return t}var e=["d3plus-buffer-start"];t.forEach(function(t){e.push(t);e.push("d3plus-buffer-"+t)});return e};var h=function(t,e,r){var n=this;var s=this._discrete==="x"?r:e;var o=s.domain().slice();if(this._discrete==="x"){o.reverse()}var a=t.map(function(t){return t[n._discrete==="x"?"y":"x"]});var c=s.invert(s(i.max(a))+(this._discrete==="x"?-10:10));if(c>o[1]){o[1]=c}if(this._discrete==="x"){o.reverse()}s.domain(o);var f=this._discrete==="x"?e:r;f.domain(d(f.domain()));return[e,r]};var u=function(t,e,i,r){var n=e.domain().slice(),s=i.domain().slice();var o=e.range(),a=i.range();if(!e.invert){n=d(n)}if(!i.invert){s=d(s)}t.forEach(function(t){var c=r.r(t.data,t.i)*2;if(e.invert&&e(t.x)-o[0]<c){var f=e.invert(e(t.x)-c);if(f<n[0]){n[0]=f}}if(e.invert&&o[1]-e(t.x)<c){var d=e.invert(e(t.x)+c);if(d>n[1]){n[1]=d}}if(i.invert&&i(t.y)-a[0]<c){var h=i.invert(i(t.y)-c);if(h>s[0]){s[0]=h}}if(i.invert&&a[1]-i(t.y)<c){var u=i.invert(i(t.y)+c);if(u<s[1]){s[1]=u}}});e.domain(n).range(o);i.domain(s).range(a);return[e,i]};var _=function(t,e,i,r){var n=e.domain().slice(),s=i.domain().slice();var o=e.range(),a=i.range();if(!e.invert){n=d(n)}if(!i.invert){s=d(s)}t.forEach(function(t){var c=r.height(t.data,t.i),f=r.width(t.data,t.i);if(e.invert&&e(t.x)-o[0]<f){var d=e.invert(e(t.x)-f);if(d<n[0]){n[0]=d}}if(e.invert&&o[1]-e(t.x)<f){var h=e.invert(e(t.x)+f);if(h>n[1]){n[1]=h}}if(i.invert&&i(t.y)-a[0]<c){var u=i.invert(i(t.y)-c);if(u>s[0]){s[0]=u}}if(i.invert&&a[1]-i(t.y)<c){var _=i.invert(i(t.y)+c);if(_<s[1]){s[1]=_}}});e.domain(n);i.domain(s);return[e,i]};var l=function(t,e,r){var n=this;var s=this._discrete==="x"?r:e;var o=s.domain().slice();if(this._discrete==="x"){o.reverse()}var a=t.map(function(t){return t[n._discrete==="x"?"y":"x"]});var c=s.invert(s(i.max(a))+(this._discrete==="x"?-10:10));if(c>o[1]){o[1]=c}if(this._discrete==="x"){o.reverse()}s.domain(o);return[e,r]};var p=function(t){function f(){var i=this;t.call(this);this._barPadding=5;this._buffer={Bar:h,Circle:u,Line:l,Rect:_};this._groupPadding=20;this._shape=e.constant("Circle");this._shapeConfig=e.assign(this._shapeConfig,{Area:{label:function(t,e){return i._stacked?i._drawLabel(t,e):false},labelConfig:{fontResize:true}},Bar:{labelConfig:{textAnchor:function(){return i._discrete==="x"?"middle":"end"},verticalAlign:function(){return i._discrete==="x"?"top":"middle"}}},Circle:{r:e.constant(5)},Line:{fill:e.constant("none"),label:false,stroke:function(t,e){return a.colorAssign(i._id(t,e))},strokeWidth:e.constant(1)},Rect:{height:e.constant(10),width:e.constant(10)}});this._stackOffset=s.stackOffsetNone;this._stackOrder=s.stackOrderNone;this._x=e.accessor("x");this._xAxis=(new o.AxisBottom).align("end");this._x2Axis=(new o.AxisTop).align("start");this._xTest=(new o.AxisBottom).align("end").gridSize(0);this._xConfig={title:"X Axis"};this._x2Config={};this._y=e.accessor("y");this._yAxis=(new o.AxisLeft).align("start");this._y2Axis=(new o.AxisRight).align("end");this._yTest=(new o.AxisLeft).align("start").gridSize(0);this._yConfig={gridConfig:{stroke:function(t){var e=i._yAxis.domain();return e[e.length-1]===t.id?"transparent":"#ccc"}},title:"Y Axis"};this._y2Config={}}if(t)f.__proto__=t;f.prototype=Object.create(t&&t.prototype);f.prototype.constructor=f;f.prototype._draw=function a(f){var d=this;t.prototype._draw.call(this,f);if(!this._filteredData.length){return this}var h=function(t,e){return d._stacked?""+(d._groupBy.length>1?d._ids(t,e).slice(0,-1).join("_"):"group"):""+d._ids(t,e).join("_")};var u=this._filteredData.map(function(t,e){return{__d3plus__:true,data:t,group:h(t,e),i:e,id:d._ids(t,e).slice(0,d._drawDepth+1).join("_"),shape:d._shape(t,e),x:d._x(t,e),y:d._y(t,e)}});var _=this._height-this._margin.top-this._margin.bottom,l=this._discrete?this._discrete==="x"?"y":"x":undefined,p=this._select,g="translate("+this._margin.left+", "+this._margin.top+")",y=this._transition,x=this._width-this._margin.left-this._margin.right;var v=this._time&&u[0].x===this._time(u[0].data,u[0].i),m=this._time&&u[0].y===this._time(u[0].data,u[0].i);for(var k=0;k<u.length;k++){var C=u[k];if(v){C.x=o.date(C.x)}if(m){C.y=o.date(C.y)}C.discrete=C.shape==="Bar"?C[d._discrete]+"_"+C.group:""+C[d._discrete]}var A,w,b,O;if(this._stacked){var S=r.nest().key(function(t){return t.group}).entries(u).reduce(function(t,e){if(!t[e.key]){t[e.key]=0}t[e.key]+=i.sum(e.values,function(t){return t[l]});return t},{});u=u.sort(function(t,e){var i=t[d._discrete],r=e[d._discrete];if(i-r!==0){return i-r}if(t.group!==e.group){return S[e.group]-S[t.group]}return e[l]-t[l]});A=Array.from(new Set(u.map(function(t){return t.discrete})));O=Array.from(new Set(u.map(function(t){return t.id})));b=r.nest().key(function(t){return t.discrete}).entries(u).map(function(t){return t.values});b.forEach(function(t){var e=Array.from(new Set(t.map(function(t){return t.id})));if(e.length<O.length){O.forEach(function(i){if(!e.includes(i)){var r=u.filter(function(t){return t.id===i})[0];if(r.shape==="Area"){var n=h(r.data,r.i);var s={__d3plus__:true,data:r.data,discrete:r.shape==="Bar"?t[0][d._discrete]+"_"+n:""+t[0][d._discrete],group:n,id:i,shape:r.shape};s[d._discrete]=t[0][d._discrete];s[l]=0;u.push(s)}}})}});u.sort(function(t,e){return t[d._discrete]-e[d._discrete]});var L=this._stackOrder;if(L instanceof Array){O.sort(function(t,e){return L.indexOf(t)-L.indexOf(e)})}b=s.stack().keys(O).offset(this._stackOffset).order(L instanceof Array?s.stackOrderNone:L).value(function(t,e){var i=t.filter(function(t){return t.id===e});return i.length?i[0][l]:0})(b);w={};w[this._discrete]=i.extent(u,function(t){return t[d._discrete]});w[l]=[i.min(b.map(function(t){return i.min(t.map(function(t){return t[1]}))})),i.max(b.map(function(t){return i.max(t.map(function(t){return t[1]}))}))]}else{w={x:i.extent(u,function(t){return t.x}),y:i.extent(u,function(t){return t.y})}}var B=this._xDomain?this._xDomain.slice():w.x,P="Linear";if(B[0]===void 0){B[0]=w.x[0]}if(B[1]===void 0){B[1]=w.x[1]}if(v){B=B.map(o.date);P="Time"}else if(this._discrete==="x"){B=Array.from(new Set(u.sort(function(t,e){return d._xSort?d._xSort(t.data,e.data):t.x-e.x}).map(function(t){return t.x})));P="Ordinal"}var D=this._yDomain?this._yDomain.slice():w.y,T="Linear";if(D[0]===void 0){D[0]=w.y[0]}if(D[1]===void 0){D[1]=w.y[1]}if(m){D=D.map(o.date);T="Time"}else if(this._discrete==="y"){D=Array.from(new Set(u.sort(function(t,e){return d._ySort?d._ySort(t.data,e.data):t.y-e.y}).map(function(t){return t.y})));T="Ordinal"}w={x:B,y:D};if(l&&this._baseline!==void 0){var j=this._baseline;if(w[l][0]>j){w[l][0]=j}else if(w[l][1]<j){w[l][1]=j}}var z=n["scale"+P]().domain(w.x).range(i.range(0,x+1,x/(w.x.length-1))),q=n["scale"+T]().domain(w.y.reverse()).range(i.range(0,_+1,_/(w.y.length-1)));var E=r.nest().key(function(t){return t.shape}).entries(u);E.forEach(function(t){if(d._buffer[t.key]){var e=d._buffer[t.key].bind(d)(t.values,z,q,d._shapeConfig[t.key]);z=e[0];q=e[1]}});B=z.domain();D=q.domain();var R=e.elem("g.d3plus-plot-test",{enter:{opacity:0},parent:this._select}),N=this._discrete==="x"&&!v?w.x:undefined,U=this._discrete==="y"&&!m?w.y:undefined;var V={barConfig:{"stroke-width":!this._discrete||this._discrete==="y"?1:0},gridConfig:{"stroke-width":!this._discrete||this._discrete==="x"?1:0},shapeConfig:{stroke:this._discrete?"transparent":this._yTest.barConfig().stroke}};this._yTest.domain(D).height(_).scale(T.toLowerCase()).select(R.node()).ticks(U).width(x).config(V).config(this._yConfig).render();var M=this._yTest.outerBounds();var W=M.width?M.width+this._yTest.padding():undefined;var X={barConfig:{"stroke-width":!this._discrete||this._discrete==="x"?1:0},gridConfig:{"stroke-width":!this._discrete||this._discrete==="y"?1:0},shapeConfig:{stroke:this._discrete?"transparent":this._xTest.barConfig().stroke}};this._xTest.domain(B).height(_).range([W,undefined]).scale(P.toLowerCase()).select(R.node()).ticks(N).width(x).config(X).config(this._xConfig).render();var Y=e.elem("g.d3plus-plot-x-axis",{parent:p,transition:y,enter:{transform:g},update:{transform:g}});this._xAxis.domain(B).height(_).range([W,undefined]).scale(P.toLowerCase()).select(Y.node()).ticks(N).width(x).config(X).config(this._xConfig).render();z=this._xAxis._d3Scale;this._x2Axis.config(X).domain(B).gridSize(0).height(_).labels([]).range([W,undefined]).scale(P.toLowerCase()).select(Y.node()).ticks([]).width(z.range()[z.range().length-1]+this._xAxis.padding()).title(false).tickSize(0).barConfig({"stroke-width":this._discrete?0:this._xAxis.barConfig()["stroke-width"]}).config(this._x2Config).render();var F=e.elem("g.d3plus-plot-y-axis",{parent:p,transition:y,enter:{transform:g},update:{transform:g}});this._yAxis.domain(D).height(_).range([this._xAxis.outerBounds().y,this._xTest.outerBounds().y]).scale(T.toLowerCase()).select(F.node()).ticks(U).width(z.range()[z.range().length-1]+this._xAxis.padding()).config(V).config(this._yConfig).render();this._y2Axis.config(V).domain(D).gridSize(0).height(_).labels([]).range([this._xAxis.outerBounds().y,this._xTest.outerBounds().y]).scale(T.toLowerCase()).select(F.node()).ticks([]).width(z.range()[z.range().length-1]+this._xAxis.padding()).title(false).tickSize(0).barConfig({"stroke-width":this._discrete?0:this._yAxis.barConfig()["stroke-width"]}).config(this._y2Config).render();q=this._yAxis._d3Scale;var G={duration:this._duration,label:function(t){return d._drawLabel(t.data,t.i)},select:e.elem("g.d3plus-plot-shapes",{parent:p,transition:y,enter:{transform:g},update:{transform:g}}).node(),x:function(t){return z(t.x)},y:function(t){return q(t.y)}};function H(t){var e={};var i=function(i){if({}.hasOwnProperty.call(t,i)&&!c[i]){e[i]=typeof t[i]==="function"?function(e){return t[i](e.data,e.i)}:t[i]}};for(var r in t)i(r);return e}G=e.assign(G,H(this._shapeConfig));var I={x0:this._discrete==="x"?G.x:z(0),x1:this._discrete==="x"?null:G.x,y0:this._discrete==="y"?G.y:q(0),y1:this._discrete==="y"?null:G.y};if(this._stacked){var J=l==="x"?z:q;I[""+l]=I[l+"0"]=function(t){var e=O.indexOf(t.id),i=A.indexOf(t.discrete);return e>=0?J(b[e][i][0]):J(0)};I[l+"1"]=function(t){var e=O.indexOf(t.id),i=A.indexOf(t.discrete);return e>=0?J(b[e][i][1]):J(0)}}G=e.assign(G,I);var K=Object.keys(this._on);E.forEach(function(t){var e=(new c[t.key]).config(G).data(t.values);if(t.key==="Bar"){var s;var o=d._discrete==="x"?z:q;var a=o.domain().filter(function(t){return typeof t!=="string"||t.indexOf("d3plus-buffer-")<0});var f=o.range();if(a.length>1){s=o(a[1])-o(a[0])}else{s=f[f.length-1]-f[0]}s-=d._groupPadding;var h=s;var u=r.nest().key(function(t){return t[d._discrete]}).key(function(t){return t.group}).entries(t.values);var _=i.merge(u.map(function(t){return t.values.map(function(t){return t.key})}));var l=Array.from(new Set(_));if(i.max(u.map(function(t){return t.values.length}))===1){e[d._discrete](function(t,e){return G[d._discrete](t,e)})}else{h=(h-d._barPadding*l.length-1)/l.length;var p=s/2-h/2;var g=n.scaleLinear().domain([0,l.length-1]).range([-p,p]);e[d._discrete](function(t,e){return G[d._discrete](t,e)+g(l.indexOf(t.group))})}e.width(h);e.height(h)}var y=K.filter(function(e){return e.includes("."+t.key)}),x=K.filter(function(t){return!t.includes(".")}),v=K.filter(function(t){return t.includes(".shape")});var m=function(t){e.on(x[t],function(e){return d._on[x[t]](e.data,e.i)})};for(var k=0;k<x.length;k++)m(k);var C=function(t){e.on(v[t],function(e){return d._on[v[t]](e.data,e.i)})};for(var A=0;A<v.length;A++)C(A);var w=function(t){e.on(y[t],function(e){return d._on[y[t]](e.data,e.i)})};for(var b=0;b<y.length;b++)w(b);e.config(d._shapeConfig[t.key]?H(d._shapeConfig[t.key]):{}).render();d._shapes.push(e)});return this};f.prototype.barPadding=function t(e){return arguments.length?(this._barPadding=e,this):this._barPadding};f.prototype.baseline=function t(e){return arguments.length?(this._baseline=e,this):this._baseline};f.prototype.discrete=function t(e){return arguments.length?(this._discrete=e,this):this._discrete};f.prototype.groupPadding=function t(e){return arguments.length?(this._groupPadding=e,this):this._groupPadding};f.prototype.stacked=function t(e){return arguments.length?(this._stacked=e,this):this._stacked};f.prototype.stackOffset=function t(e){return arguments.length?(this._stackOffset=typeof e==="function"?e:s["stackOffset"+(e.charAt(0).toUpperCase()+e.slice(1))],this):this._stackOffset};f.prototype.stackOrder=function t(e){return arguments.length?(this._stackOrder=typeof e==="string"?s["stackOrder"+(e.charAt(0).toUpperCase()+e.slice(1))]:e,this):this._stackOrder};f.prototype.x=function t(i){if(arguments.length){if(typeof i==="function"){this._x=i}else{this._x=e.accessor(i);if(!this._aggs[i]&&this._discrete==="x"){this._aggs[i]=function(t){var e=Array.from(new Set(t));return e.length===1?e[0]:e}}}return this}else{return this._x}};f.prototype.xConfig=function t(i){return arguments.length?(this._xConfig=e.assign(this._xConfig,i),this):this._xConfig};f.prototype.x2Config=function t(i){return arguments.length?(this._x2Config=e.assign(this._x2Config,i),this):this._x2Config};f.prototype.xDomain=function t(e){return arguments.length?(this._xDomain=e,this):this._xDomain};f.prototype.xSort=function t(e){return arguments.length?(this._xSort=e,this):this._xSort};f.prototype.y=function t(i){if(arguments.length){if(typeof i==="function"){this._y=i}else{this._y=e.accessor(i);if(!this._aggs[i]&&this._discrete==="y"){this._aggs[i]=function(t){var e=Array.from(new Set(t));return e.length===1?e[0]:e}}}return this}else{return this._y}};f.prototype.yConfig=function t(i){if(arguments.length){if(i.domain){i.domain=i.domain.slice().reverse()}this._yConfig=e.assign(this._yConfig,i);return this}return this._yConfig};f.prototype.y2Config=function t(i){return arguments.length?(this._y2Config=e.assign(this._y2Config,i),this):this._y2Config};f.prototype.yDomain=function t(e){return arguments.length?(this._yDomain=e,this):this._yDomain};f.prototype.ySort=function t(e){return arguments.length?(this._ySort=e,this):this._ySort};return f}(f.Viz);var g=function(t){function i(){t.call(this);this._baseline=0;this._discrete="x";this._shape=e.constant("Area");this.x("x")}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;return i}(p);var y=function(t){function i(){t.call(this);this._baseline=0;this._discrete="x";this._shape=e.constant("Bar");this.x("x")}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;return i}(p);var x=function(t){function i(){t.call(this);this._discrete="x";this._shape=e.constant("Line");this.x("x")}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;return i}(p);var v=function(t){function e(){t.call(this);this._stacked=true}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;return e}(g);t.AreaPlot=g;t.BarChart=y;t.LinePlot=x;t.Plot=p;t.StackedArea=v;Object.defineProperty(t,"__esModule",{value:true})});