/*
  d3plus-priestley v0.1.2
  A reusable Priestley timeline built on D3.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-array"),require("d3-collection"),require("d3-scale"),require("d3plus-axis"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-viz")):"function"==typeof define&&define.amd?define("d3plus-priestley",["exports","d3-array","d3-collection","d3-scale","d3plus-axis","d3plus-common","d3plus-shape","d3plus-viz"],e):e(t.d3plus=t.d3plus||{},t.d3Array,t.d3Collection,t.d3Scale,t.d3plusAxis,t.d3plusCommon,t.d3plusShape,t.d3plusViz)}(this,function(t,e,i,n,s,r,a,o){"use strict";var u=function(t){function o(){t.call(this),this._axis=(new s.Axis).align("end").orient("bottom"),this._axisConfig={scale:"time"},this._axisTest=(new s.Axis).align("end").gridSize(0).orient("bottom"),this.end("end"),this.start("start")}return t&&(o.__proto__=t),o.prototype=Object.create(t&&t.prototype),o.prototype.constructor=o,o.prototype.render=function(o){var u=this;t.prototype.render.call(this,o);var d,h=this._filteredData.map(function(t,e){return{data:t,end:"time"===u._axisConfig.scale?s.date(u._end(t,e)):u._end(t,e),i:e,id:u._id(t,e),start:"time"===u._axisConfig.scale?s.date(u._start(t,e)):u._start(t,e)}}).filter(function(t){return t.end-t.start>0}).sort(function(t,e){return t.start-e.start});if(this._groupBy.length>1&&this._drawDepth>0){for(var l=i.nest(),c=function(t){l.key(function(e){return u._groupBy[t](e.data,e.i)})},p=0;p<this._drawDepth;p++)c(p);d=l.entries(h)}else d=[{values:h}];var f=0;d.forEach(function(t){var e=[];t.values.forEach(function(t){e=e.map(function(e){return!(e<=t.start)&&e});var i=e.indexOf(!1);i<0?(t.lane=f+e.length,e.push(t.end)):(e[i]=t.end,t.lane=f+i)}),f+=e.length});var _={domain:[e.min(h,function(t){return t.start}),e.max(h,function(t){return t.end})],height:this._height-this._margin.top-this._margin.bottom,width:this._width-this._margin.left-this._margin.right},g="translate("+this._margin.left+", "+this._margin.top+")";this._axisTest.config(_).config(this._axisConfig).select(r.elem("g.d3plus-priestley-axis-test",{parent:this._select,enter:{opacity:0}}).node()).render(),this._axis.config(_).config(this._axisConfig).select(r.elem("g.d3plus-priestley-axis",{parent:this._select,enter:{transform:g},update:{transform:g}}).node()).render();var m=this._axisTest._padding,x=this._axis._d3Scale,y=n.scalePoint().domain(e.range(0,f,1)).padding(.5).rangeRound([this._height-this._margin.bottom-this._axisTest.outerBounds().height-m,this._margin.top+m]),v=y.step(),b=this._shapeConfig,C={},w=function(t){"labelBounds"!==t&&{}.hasOwnProperty.call(b,t)&&("function"==typeof b[t]?C[t]=function(e,i){return b[t](e.data,i)}:C[t]=b[t])};for(var q in b)w(q);return this._shapes.push((new a.Rect).config({on:Object.keys(this._on).filter(function(t){return!t.includes(".")||t.includes(".shape")}).reduce(function(t,e){return t[e]=function(t,i){return u._on[e]?u._on[e](t.data,i):null},t},{})}).data(h).duration(this._duration).height(v>=2*this._padding?v-this._padding:v>2?v-2:v).label(function(t,e){return u._drawLabel(t.data,e)}).select(r.elem("g.d3plus-priestley-shapes",{parent:this._select}).node()).width(function(t){var e=x(t.end)-x(t.start);return e>2?e-2:e}).x(function(t){return x(t.start)+(x(t.end)-x(t.start))/2}).y(function(t){return y(t.lane)}).config(C).render()),this},o.prototype.axisConfig=function(t){return arguments.length?(this._axisConfig=Object.assign(this._axisConfig,t),this):this._axisConfig},o.prototype.end=function(t){return arguments.length?("function"==typeof t?this._end=t:(this._end=r.accessor(t),this._aggs[t]||(this._aggs[t]=function(t){return e.max(t)})),this):this._end},o.prototype.start=function(t){return arguments.length?("function"==typeof t?this._start=t:(this._start=r.accessor(t),this._aggs[t]||(this._aggs[t]=function(t){return e.min(t)})),this):this._start},o}(o.Viz);t.Priestley=u,Object.defineProperty(t,"__esModule",{value:!0})});