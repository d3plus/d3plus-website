/*
  d3plus-geomap v0.5.6
  A reusable geo map built on D3 and Topojson
  Copyright (c) 2018 D3plus - https://d3plus.org
  @license MIT
*/
if(typeof Object.assign!=="function"){Object.defineProperty(Object,"assign",{value:function t(e){"use strict";if(e===null){throw new TypeError("Cannot convert undefined or null to object")}var i=Object(e);for(var o=1;o<arguments.length;o++){var n=arguments[o];if(n!==null){for(var r in n){if(Object.prototype.hasOwnProperty.call(n,r)){i[r]=n[r]}}}}return i},writable:true,configurable:true})}if(!Array.prototype.includes){Object.defineProperty(Array.prototype,"includes",{value:function t(e,i){var o=Object(this);var n=o.length>>>0;if(n===0)return false;var r=i|0;var s=Math.max(r>=0?r:n-Math.abs(r),0);function a(t,e){return t===e||typeof t==="number"&&typeof e==="number"&&isNaN(t)&&isNaN(e)}while(s<n){if(a(o[s],e)){return true}s++}return false}})}(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3-array"),require("d3-color"),require("d3-geo"),require("d3-scale"),require("d3-tile"),require("topojson-client"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-viz")):typeof define==="function"&&define.amd?define("d3plus-geomap",["exports","d3-array","d3-color","d3-geo","d3-scale","d3-tile","topojson-client","d3plus-common","d3plus-shape","d3plus-viz"],e):e(t.d3plus={},t.d3Array,t.d3Color,t.d3Geo,t.scales,t.d3Tile,t.topojsonClient,t.d3plusCommon,t.d3plusShape,t.d3plusViz)})(this,function(t,O,n,C,G,e,o,M,q,r){"use strict";function w(t,e){var i=e&&t.objects[e]?e:Object.keys(t.objects)[0];return o.feature(t,t.objects[i])}var i=function(P){function t(){var o=this;P.call(this);this._fitObject=false;this._noDataMessage=false;this._ocean="#cdd1d3";this._point=M.accessor("point");this._pointSize=M.constant(1);this._pointSizeMax=10;this._pointSizeMin=5;this._pointSizeScale="linear";this._projection=C.geoMercator();this._projectionPadding=M.parseSides(20);this._rotate=[0,0];this._shape=M.constant("Circle");this._shapeConfig=M.assign(this._shapeConfig,{ariaLabel:function(t,e){return o._drawLabel(t,e)+", "+o._pointSize(t,e)},hoverOpacity:1,Path:{ariaLabel:function(t,e){var i=o._colorScale?", "+o._colorScale(t,e):"";return""+o._drawLabel(t,e)+i+"."},fill:function(t){if(o._colorScale&&!o._coordData.features.includes(t)){var e=o._colorScale(t);if(e!==undefined&&e!==null){if(o._colorScaleClass._colorScale){return o._colorScaleClass._colorScale(e)}else{var i=o._colorScaleClass.color();if(i instanceof Array){i=i[i.length-1]}return i}}}return"#f5f5f3"},on:{mouseenter:function(t){return!o._coordData.features.includes(t)?o._on.mouseenter.bind(o)(t):null},"mousemove.shape":function(t){return!o._coordData.features.includes(t)?o._on["mousemove.shape"].bind(o)(t):null},mouseleave:function(t){return!o._coordData.features.includes(t)?o._on.mouseleave.bind(o)(t):null}},stroke:function(t,e){var i=typeof o._shapeConfig.Path.fill==="function"?o._shapeConfig.Path.fill(t,e):o._shapeConfig.Path.fill;return n.color(i).darker()},strokeWidth:1}});this._tiles=true;this._tileGen=e.tile().wrap(false);this._tileUrl="https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}@2x.png";this._topojson=false;this._topojsonFilter=function(t){return!["010"].includes(t.id)};this._topojsonId=M.accessor("id");this._zoom=true;this._zoomSet=false}if(P)t.__proto__=P;t.prototype=Object.create(P&&P.prototype);t.prototype.constructor=t;t.prototype._renderTiles=function t(e,i){var o=this;if(i===void 0)i=0;var n=[];if(this._tiles){n=this._tileGen.extent(this._zoomBehavior.translateExtent()).scale(this._projection.scale()*(2*Math.PI)*e.k).translate(e.apply(this._projection.translate()))();this._tileGroup.transition().duration(i).attr("transform",e)}var r=this._tileGroup.selectAll("image.tile").data(n,function(t){return t.x+"-"+t.y+"-"+t.z});r.exit().transition().duration(i).attr("opacity",0).remove();var s=n.scale/e.k;r.enter().append("image").attr("class","tile").attr("opacity",0).attr("xlink:href",function(t){return o._tileUrl.replace("{s}",["a","b","c"][Math.random()*3|0]).replace("{z}",t.z).replace("{x}",t.x).replace("{y}",t.y)}).attr("width",s).attr("height",s).attr("x",function(t){return t.x*s+n.translate[0]*s-e.x/e.k}).attr("y",function(t){return t.y*s+n.translate[1]*s-e.y/e.k}).transition().duration(i).attr("opacity",1);r.attr("width",s).attr("height",s).attr("x",function(t){return t.x*s+n.translate[0]*s-e.x/e.k}).attr("y",function(t){return t.y*s+n.translate[1]*s-e.y/e.k})};t.prototype._draw=function t(e){var o=this;P.prototype._draw.call(this,e);var i=this._height-this._margin.top-this._margin.bottom,n=this._width-this._margin.left-this._margin.right;this._container=this._select.selectAll("svg.d3plus-geomap").data([0]);this._container=this._container.enter().append("svg").attr("class","d3plus-geomap").attr("opacity",0).attr("width",n).attr("height",i).attr("x",this._margin.left).attr("y",this._margin.top).style("background-color",this._ocean||"transparent").merge(this._container);this._container.transition(this._transition).attr("opacity",1).attr("width",n).attr("height",i).attr("x",this._margin.left).attr("y",this._margin.top);var r=this._container.selectAll("rect.d3plus-geomap-ocean").data([0]);r.enter().append("rect").attr("class","d3plus-geomap-ocean").merge(r).attr("width",n).attr("height",i).attr("fill",this._ocean||"transparent");this._tileGroup=this._container.selectAll("g.d3plus-geomap-tileGroup").data([0]);this._tileGroup=this._tileGroup.enter().append("g").attr("class","d3plus-geomap-tileGroup").merge(this._tileGroup);this._zoomGroup=this._container.selectAll("g.d3plus-geomap-zoomGroup").data([0]);this._zoomGroup=this._zoomGroup.enter().append("g").attr("class","d3plus-geomap-zoomGroup").merge(this._zoomGroup);var s=this._zoomGroup.selectAll("g.d3plus-geomap-paths").data([0]);s=s.enter().append("g").attr("class","d3plus-geomap-paths").merge(s);var a=this._coordData=this._topojson?w(this._topojson,this._topojsonKey):{type:"FeatureCollection",features:[]};if(this._topojsonFilter){a.features=a.features.filter(this._topojsonFilter)}var u=this._path=C.geoPath().projection(this._projection);var p=this._filteredData.filter(function(t,e){return o._point(t,e)instanceof Array});var c=this._filteredData.filter(function(t,e){return!(o._point(t,e)instanceof Array)}).reduce(function(t,e){t[o._id(e)]=e;return t},{});var l=a.features.reduce(function(t,e){var i=o._topojsonId(e);t.push({__d3plus__:true,data:c[i],feature:e,id:i});return t},[]);var h=G["scale"+this._pointSizeScale.charAt(0).toUpperCase()+this._pointSizeScale.slice(1)]().domain(O.extent(p,function(t,e){return o._pointSize(t,e)})).range([this._pointSizeMin,this._pointSizeMax]);if(!this._zoomSet){var f=this._fitObject?w(this._fitObject,this._fitKey):a;this._extentBounds={type:"FeatureCollection",features:this._fitFilter?f.features.filter(this._fitFilter):f.features.slice()};this._extentBounds.features=this._extentBounds.features.reduce(function(t,e){if(e.geometry){var i={type:e.type,id:e.id,geometry:{coordinates:e.geometry.coordinates,type:e.geometry.type}};if(e.geometry.coordinates.length>1){var o=[],n=[];e.geometry.coordinates.forEach(function(t){i.geometry.coordinates=[t];o.push(u.area(i))});i.geometry.coordinates=[e.geometry.coordinates[o.indexOf(O.max(o))]];var r=u.centroid(i);e.geometry.coordinates.forEach(function(t){i.geometry.coordinates=[t];n.push(q.pointDistance(u.centroid(i),r))});var s=O.quantile(o.reduce(function(t,e,i){if(e){t.push(o[i]/e)}return t},[]),.9);i.geometry.coordinates=e.geometry.coordinates.filter(function(t,e){var i=n[e];return i===0||o[e]/i>=s})}t.push(i)}return t},[]);if(!this._extentBounds.features.length&&p.length){var d=[[undefined,undefined],[undefined,undefined]];p.forEach(function(t,e){var i=o._projection(o._point(t,e));if(d[0][0]===void 0||i[0]<d[0][0]){d[0][0]=i[0]}if(d[1][0]===void 0||i[0]>d[1][0]){d[1][0]=i[0]}if(d[0][1]===void 0||i[1]<d[0][1]){d[0][1]=i[1]}if(d[1][1]===void 0||i[1]>d[1][1]){d[1][1]=i[1]}});this._extentBounds={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"MultiPoint",coordinates:d.map(function(t){return o._projection.invert(t)})}}]};var _=O.max(p,function(t,e){return h(o._pointSize(t,e))});this._projectionPadding.top+=_;this._projectionPadding.right+=_;this._projectionPadding.bottom+=_;this._projectionPadding.left+=_}this._zoomBehavior.extent([[0,0],[n,i]]).scaleExtent([1,this._zoomMax]).translateExtent([[0,0],[n,i]]);this._zoomSet=true}this._projection=this._projection.fitExtent(this._extentBounds.features.length?[[this._projectionPadding.left,this._projectionPadding.top],[n-this._projectionPadding.right,i-this._projectionPadding.bottom]]:[[0,0],[n,i]],this._extentBounds.features.length?this._extentBounds:{type:"Sphere"});this._shapes.push((new q.Path).data(l).d(function(t){return u(t.feature)}).select(s.node()).x(0).y(0).config(M.configPrep.bind(this)(this._shapeConfig,"shape","Path")).render());var g=this._zoomGroup.selectAll("g.d3plus-geomap-pins").data([0]);g=g.enter().append("g").attr("class","d3plus-geomap-pins").merge(g);var y=(new q.Circle).config(M.configPrep.bind(this)(this._shapeConfig,"shape","Circle")).data(p).r(function(t,e){return h(o._pointSize(t,e))}).select(g.node()).sort(function(t,e){return o._pointSize(e)-o._pointSize(t)}).x(function(t,e){return o._projection(o._point(t,e))[0]}).y(function(t,e){return o._projection(o._point(t,e))[1]});var m=Object.keys(this._on);var j=m.filter(function(t){return t.includes(".Circle")}),v=m.filter(function(t){return!t.includes(".")}),b=m.filter(function(t){return t.includes(".shape")});for(var x=0;x<v.length;x++){y.on(v[x],o._on[v[x]])}for(var z=0;z<b.length;z++){y.on(b[z],o._on[b[z]])}for(var S=0;S<j.length;S++){y.on(j[S],o._on[j[S]])}this._shapes.push(y.render());return this};t.prototype.fitFilter=function t(e){if(arguments.length){if(typeof e==="function"){return this._fitFilter=e,this}if(!(e instanceof Array)){e=[e]}return this._fitFilter=function(t){return e.includes(t.id)},this}return this._fitFilter};t.prototype.fitKey=function t(e){return arguments.length?(this._fitKey=e,this):this._fitKey};t.prototype.fitObject=function t(e,i){if(arguments.length){var o=this._queue.find(function(t){return t[3]==="fitObject"});var n=[r.dataLoad.bind(this),e,i,"fitObject"];if(o){this._queue[this._queue.indexOf(o)]=n}else{this._queue.push(n)}return this}return this._fitObject};t.prototype.ocean=function t(e){return arguments.length?(this._ocean=e,this):this._ocean};t.prototype.point=function t(e){return arguments.length?(this._point=typeof e==="function"?e:M.constant(e),this):this._point};t.prototype.pointSize=function t(e){return arguments.length?(this._pointSize=typeof e==="function"?e:M.constant(e),this):this._pointSize};t.prototype.pointSizeMax=function t(e){return arguments.length?(this._pointSizeMax=e,this):this._pointSizeMax};t.prototype.pointSizeMin=function t(e){return arguments.length?(this._pointSizeMin=e,this):this._pointSizeMin};t.prototype.projection=function t(e){if(arguments.length&&e!=="geoMercator"){this._tiles=false}return arguments.length?(this._projection=typeof e==="string"?C[e]():e,this):this._projection};t.prototype.projectionPadding=function t(e){return arguments.length?(this._projectionPadding=M.parseSides(e),this):this._projectionPadding};t.prototype.tiles=function t(e){return arguments.length?(this._tiles=e,this):this._tiles};t.prototype.tileUrl=function t(e){return arguments.length?(this._tileUrl=e,this):this._tileUrl};t.prototype.topojson=function t(e,i){if(arguments.length){var o=this._queue.find(function(t){return t[3]==="topojson"});var n=[r.dataLoad.bind(this),e,i,"topojson"];if(o){this._queue[this._queue.indexOf(o)]=n}else{this._queue.push(n)}return this}return this._topojson};t.prototype.topojsonFilter=function t(e){if(arguments.length){if(typeof e==="function"){return this._topojsonFilter=e,this}if(!(e instanceof Array)){e=[e]}return this._topojsonFilter=function(t){return e.includes(t.id)},this}return this._topojsonFilter};t.prototype.topojsonKey=function t(e){return arguments.length?(this._topojsonKey=e,this):this._topojsonKey};t.prototype.topojsonId=function t(e){return arguments.length?(this._topojsonId=typeof e==="function"?e:M.accessor(e),this):this._topojsonId};return t}(r.Viz);t.Geomap=i;Object.defineProperty(t,"__esModule",{value:true})});