/*
  d3plus-geomap v0.2.5
  A reusable geo map built on D3 and Topojson
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3-array"),require("d3-geo"),require("d3-scale"),require("d3-selection"),require("d3-tile"),require("d3-zoom"),require("topojson-client"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-viz")):typeof define==="function"&&define.amd?define("d3plus-geomap",["exports","d3-array","d3-geo","d3-scale","d3-selection","d3-tile","d3-zoom","topojson-client","d3plus-common","d3plus-shape","d3plus-viz"],e):e(t.d3plus=t.d3plus||{},t.d3Array,t.d3Geo,t.scales,t.d3Selection,t.d3Tile,t.d3Zoom,t.topojsonClient,t.d3plusCommon,t.d3plusShape,t.d3plusViz)})(this,function(t,e,o,i,n,r,s,a,p,h,u){"use strict";var l=function(t){function u(){t.call(this);this._ocean="#cdd1d3";this._padding=20;this._point=p.accessor("point");this._pointSize=p.constant(1);this._pointSizeMax=10;this._pointSizeMin=5;this._pointSizeScale="linear";this._projection=o.geoMercator();this._rotate=[0,0];this._shape=p.constant("Circle");this._shapeConfig=p.assign(this._shapeConfig,{Path:{fill:"#f5f5f3",stroke:"#b1babe",strokeWidth:1}});this._tiles=true;this._tileGen=r.tile();this._tileUrl="https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png";this._topojsonFilter=function(t){return!["010"].includes(t.id)};this._topojsonKey="countries";this._zoom=true;this._zoomBehavior=s.zoom();this._zoomBrush=false;this._zoomPan=true;this._zoomScroll=true;this._zoomSet=false}if(t)u.__proto__=t;u.prototype=Object.create(t&&t.prototype);u.prototype.constructor=u;u.prototype._renderTiles=function t(){var e=this;var o=2*Math.PI,i=s.zoomTransform(this._geomapGroup.node());var n=[];if(this._tiles){n=this._tileGen.extent(this._zoomBehavior.translateExtent()).scale(this._projection.scale()*o*i.k).translate(i.apply(this._projection.translate()))();this._tileGroup.attr("transform","scale("+n.scale+")translate("+n.translate+")")}var r=this._tileGroup.selectAll("image.tile").data(n,function(t){return t.join("-")});r.exit().remove();r.enter().append("image").attr("class","tile").attr("xlink:href",function(t){return e._tileUrl.replace("{s}",["a","b","c"][Math.random()*3|0]).replace("{z}",t[2]).replace("{x}",t[0]).replace("{y}",t[1])}).attr("width",1).attr("height",1).attr("x",function(t){return t[0]}).attr("y",function(t){return t[1]})};u.prototype._zoomed=function t(){this._zoomGroup.attr("transform",n.event.transform);this._renderTiles()};u.prototype._zoomEvents=function t(){if(this._zoomBrush){this._geomapGroup.on(".zoom",null)}else if(this._zoom){this._geomapGroup.call(this._zoomBehavior);if(!this._zoomScroll){this._geomapGroup.on("mousewheel.zoom",null).on("MozMousePixelScroll.zoom",null).on("wheel.zoom",null)}if(!this._zoomPan){this._geomapGroup.on("mousedown.zoom",null).on("mousemove.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null)}}else{this._geomapGroup.on(".zoom",null)}};u.prototype.render=function n(r){var s=this;t.prototype.render.call(this,r);var p=this._height-this._margin.top-this._margin.bottom,u=this._width-this._margin.left-this._margin.right;this._geomapGroup=this._select.selectAll("svg.d3plus-geomap-geomapGroup").data([0]);this._geomapGroup=this._geomapGroup.enter().append("svg").attr("class","d3plus-geomap-geomapGroup").attr("opacity",0).attr("width",u).attr("height",p).style("background-color",this._ocean||"transparent").merge(this._geomapGroup);this._geomapGroup.transition(this._transition).attr("opacity",1).attr("width",u).attr("height",p);var l=this._geomapGroup.selectAll("rect.d3plus-geomap-ocean").data([0]);l.enter().append("rect").attr("class","d3plus-geomap-ocean").merge(l).attr("width",u).attr("height",p).attr("fill",this._ocean||"transparent");this._tileGroup=this._geomapGroup.selectAll("g.d3plus-geomap-tileGroup").data([0]);this._tileGroup=this._tileGroup.enter().append("g").attr("class","d3plus-geomap-tileGroup").merge(this._tileGroup);this._zoomGroup=this._geomapGroup.selectAll("g.d3plus-geomap-zoomGroup").data([0]);this._zoomGroup=this._zoomGroup.enter().append("g").attr("class","d3plus-geomap-zoomGroup").merge(this._zoomGroup);var c=this._zoomGroup.selectAll("g.d3plus-geomap-paths").data([0]);c=c.enter().append("g").attr("class","d3plus-geomap-paths").merge(c);var _=this._topojson?a.feature(this._topojson,this._topojson.objects[this._topojsonKey]):{type:"FeatureCollection",features:[]};if(this._topojsonFilter){_.features=_.features.filter(this._topojsonFilter)}var d=this._path=o.geoPath().projection(this._projection);var f=this._filteredData.filter(function(t,e){return s._shape(t,e)!=="Path"});var m=i["scale"+this._pointSizeScale.charAt(0).toUpperCase()+this._pointSizeScale.slice(1)]().domain(e.extent(f,function(t,e){return s._pointSize(t,e)})).range([this._pointSizeMin,this._pointSizeMax]);if(!this._zoomSet){var g={type:"FeatureCollection",features:this._bounds?_.features.filter(this._bounds):_.features.slice()};g.features=g.features.reduce(function(t,o){var i={type:o.type,id:o.id,geometry:{coordinates:o.geometry.coordinates,type:o.geometry.type}};if(o.geometry.coordinates.length>1){var n=[],r=[];o.geometry.coordinates.forEach(function(t){i.geometry.coordinates=[t];n.push(d.area(i))});i.geometry.coordinates=[o.geometry.coordinates[n.indexOf(e.max(n))]];var s=d.centroid(i);o.geometry.coordinates.forEach(function(t){i.geometry.coordinates=[t];r.push(h.pointDistance(d.centroid(i),s))});var a=e.quantile(n.reduce(function(t,e,o){if(e){t.push(n[o]/e)}return t},[]),.9);i.geometry.coordinates=o.geometry.coordinates.filter(function(t,e){var o=r[e];return o===0||n[e]/o>=a})}t.push(i);return t},[]);var z=this._padding;if(!g.features.length&&f.length){var y=[[undefined,undefined],[undefined,undefined]];f.forEach(function(t,e){var o=s._projection(s._point(t,e));if(y[0][0]===void 0||o[0]<y[0][0]){y[0][0]=o[0]}if(y[1][0]===void 0||o[0]>y[1][0]){y[1][0]=o[0]}if(y[0][1]===void 0||o[1]<y[0][1]){y[0][1]=o[1]}if(y[1][1]===void 0||o[1]>y[1][1]){y[1][1]=o[1]}});g={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"MultiPoint",coordinates:y.map(function(t){return s._projection.invert(t)})}}]};z=e.max(f,function(t,e){return m(s._pointSize(t,e))+z})}this._projection=this._projection.fitExtent(g.features.length?[[z,z],[u-z*2,p-z*2]]:[[0,0],[u,p]],g.features.length?g:{type:"Sphere"});this._zoomBehavior.scaleExtent([1,16]).translateExtent([[0,0],[u,p]]).on("zoom",this._zoomed.bind(this));this._zoomSet=true}this._shapes.push((new h.Path).config(this._shapeConfig.Path).data(_.features).d(d).select(c.node()).x(0).y(0).render());var v=this._zoomGroup.selectAll("g.d3plus-geomap-pins").data([0]);v=v.enter().append("g").attr("class","d3plus-geomap-pins").merge(v);var j=(new h.Circle).config(this._shapeConfig).config(this._shapeConfig.Circle||{}).data(f).r(function(t,e){return m(s._pointSize(t,e))}).select(v.node()).sort(function(t,e){return s._pointSize(e)-s._pointSize(t)}).x(function(t,e){return s._projection(s._point(t,e))[0]}).y(function(t,e){return s._projection(s._point(t,e))[1]});var G=Object.keys(this._on);var S=G.filter(function(t){return t.includes(".Circle")}),x=G.filter(function(t){return!t.includes(".")}),b=G.filter(function(t){return t.includes(".shape")});for(var M=0;M<x.length;M++){j.on(x[M],s._on[x[M]])}for(var C=0;C<b.length;C++){j.on(b[C],s._on[b[C]])}for(var q=0;q<S.length;q++){j.on(S[q],s._on[S[q]])}this._shapes.push(j.render());this._zoomEvents();this._renderTiles();return this};u.prototype.bounds=function t(e){if(arguments.length){if(typeof e==="function"){return this._bounds=e,this}if(!(e instanceof Array)){e=[e]}return this._bounds=function(t){return e.includes(t.id)},this}return this._bounds};u.prototype.ocean=function t(e){return arguments.length?(this._ocean=e,this):this._ocean};u.prototype.padding=function t(e){return arguments.length?(this._padding=e,this):this._padding};u.prototype.point=function t(e){return arguments.length?(this._point=typeof e==="function"?e:p.constant(e),this):this._point};u.prototype.pointSize=function t(e){return arguments.length?(this._pointSize=typeof e==="function"?e:p.constant(e),this):this._pointSize};u.prototype.pointSizeMax=function t(e){return arguments.length?(this._pointSizeMax=e,this):this._pointSizeMax};u.prototype.pointSizeMin=function t(e){return arguments.length?(this._pointSizeMin=e,this):this._pointSizeMin};u.prototype.tiles=function t(e){return arguments.length?(this._tiles=e,this):this._tiles};u.prototype.topojson=function t(e){return arguments.length?(this._topojson=e,this):this._topojson};u.prototype.topojsonFilter=function t(e){if(arguments.length){if(typeof e==="function"){return this._topojsonFilter=e,this}if(!(e instanceof Array)){e=[e]}return this._topojsonFilter=function(t){return e.includes(t.id)},this}return this._topojsonFilter};u.prototype.topojsonKey=function t(e){return arguments.length?(this._topojsonKey=e,this):this._topojsonKey};u.prototype.zoom=function t(e){return arguments.length?(this._zoom=e,this):this._zoom};return u}(u.Viz);t.Geomap=l;Object.defineProperty(t,"__esModule",{value:true})});