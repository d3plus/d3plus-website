/*
  d3plus-plot v0.4.0
  A reusable javascript x/y plot built on D3.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3plus-common"),require("d3-array"),require("d3-collection"),require("d3-scale"),require("d3-shape"),require("d3-selection"),require("d3plus-axis"),require("d3plus-color"),require("d3plus-shape"),require("d3plus-viz")):typeof define==="function"&&define.amd?define("d3plus-plot",["exports","d3plus-common","d3-array","d3-collection","d3-scale","d3-shape","d3-selection","d3plus-axis","d3plus-color","d3plus-shape","d3plus-viz"],e):e(t.d3plus=t.d3plus||{},t.d3plusCommon,t.d3Array,t.d3Collection,t.scales,t.d3Shape,t.d3Selection,t.d3plusAxis,t.d3plusColor,t.shapes,t.d3plusViz)})(this,function(t,e,i,r,n,s,a,o,c,f,u){"use strict";var d=function(t){if(t.includes("d3plus-buffer-start")){return t}var e=["d3plus-buffer-start"];t.forEach(function(t){e.push(t);e.push("d3plus-buffer-"+t)});return e};var h=function(t,e,r){var n=this;var s=this._discrete==="x"?r:e;var a=s.domain().slice();if(this._discrete==="x"){a.reverse()}var o=t.map(function(t){return t[n._discrete==="x"?"y":"x"]});var c=s.invert(s(i.max(o))+(this._discrete==="x"?-10:10));if(c>a[1]){a[1]=c}if(this._discrete==="x"){a.reverse()}s.domain(a);var f=this._discrete==="x"?e:r;f.domain(d(f.domain()));return[e,r]};var l=function(t,e,i,r){var n=e.domain().slice(),s=i.domain().slice();var a=e.range(),o=i.range();if(!e.invert){n=d(n)}if(!i.invert){s=d(s)}t.forEach(function(t){var c=r.r(t.data,t.i)*2;if(e.invert&&e(t.x)-a[0]<c){var f=e.invert(e(t.x)-c);if(f<n[0]){n[0]=f}}if(e.invert&&a[1]-e(t.x)<c){var u=e.invert(e(t.x)+c);if(u>n[1]){n[1]=u}}if(i.invert&&i(t.y)-o[0]<c){var d=i.invert(i(t.y)-c);if(d>s[0]){s[0]=d}}if(i.invert&&o[1]-i(t.y)<c){var h=i.invert(i(t.y)+c);if(h<s[1]){s[1]=h}}});e.domain(n).range(a);i.domain(s).range(o);return[e,i]};var _=function(t,e,i,r){var n=e.domain().slice(),s=i.domain().slice();var a=e.range(),o=i.range();if(!e.invert){n=d(n)}if(!i.invert){s=d(s)}t.forEach(function(t){var c=r.height(t.data,t.i),f=r.width(t.data,t.i);if(e.invert&&e(t.x)-a[0]<f){var u=e.invert(e(t.x)-f);if(u<n[0]){n[0]=u}}if(e.invert&&a[1]-e(t.x)<f){var d=e.invert(e(t.x)+f);if(d>n[1]){n[1]=d}}if(i.invert&&i(t.y)-o[0]<c){var h=i.invert(i(t.y)-c);if(h>s[0]){s[0]=h}}if(i.invert&&o[1]-i(t.y)<c){var l=i.invert(i(t.y)+c);if(l<s[1]){s[1]=l}}});e.domain(n);i.domain(s);return[e,i]};var p=function(t,e,r){var n=this;var s=this._discrete==="x"?r:e;var a=s.domain().slice();if(this._discrete==="x"){a.reverse()}var o=t.map(function(t){return t[n._discrete==="x"?"y":"x"]});var c=s.invert(s(i.max(o))+(this._discrete==="x"?-10:10));if(c>a[1]){a[1]=c}if(this._discrete==="x"){a.reverse()}s.domain(a);return[e,r]};var y=function(t){function u(){var i=this;t.call(this);this._buffer={Bar:h,Circle:l,Line:p,Rect:_};this._shape=e.constant("Circle");this._shapeConfig=e.assign(this._shapeConfig,{Bar:{textAnchor:function(){return i._discrete==="x"?"middle":"end"},verticalAlign:function(){return i._discrete==="x"?"top":"middle"}},Circle:{r:e.constant(5)},Line:{fill:e.constant("none"),label:false,stroke:function(t,e){return c.assign(i._id(t,e))},strokeWidth:e.constant(1)},Rect:{height:e.constant(10),width:e.constant(10)}});this._stackOffset=s.stackOffsetNone;this._stackOrder=s.stackOrderNone;this._x=e.accessor("x");this._xAxis=(new o.AxisBottom).align("end");this._xTest=(new o.AxisBottom).align("end").gridSize(0);this._xConfig={title:"X Axis"};this._y=e.accessor("y");this._yAxis=(new o.AxisLeft).align("start");this._yTest=(new o.AxisLeft).align("start").gridSize(0);this._yConfig={title:"Y Axis"}}if(t)u.__proto__=t;u.prototype=Object.create(t&&t.prototype);u.prototype.constructor=u;u.prototype.render=function c(u){var d=this;t.prototype.render.call(this,u);var h=this._filteredData.map(function(t,e){return{__d3plus__:true,data:t,i:e,id:d._id(t,e),shape:d._shape(t,e),x:d._x(t,e),y:d._y(t,e)}});var l=this._height-this._margin.top-this._margin.bottom,_=this._discrete?this._discrete==="x"?"y":"x":undefined,p=this._select,y=this,x="translate("+this._margin.left+", "+this._margin.top+")",v=this._transition,g=this._width-this._margin.left-this._margin.right;var m=this._time&&h[0].x===this._time(h[0].data,h[0].i),k=this._time&&h[0].y===this._time(h[0].data,h[0].i);if(m||k){h.forEach(function(t){if(m){t.x=o.date(t.x)}if(k){t.y=o.date(t.y)}})}var C,O,A,b;if(this._stacked){b=Array.from(new Set(h.map(function(t){return t.id})));A=r.nest().key(function(t){return t[d._discrete]}).entries(h).sort(function(t,e){return t.key-e.key});C=A.map(function(t){return t.key});A=A.map(function(t){return t.values});A.forEach(function(t){var e=Array.from(new Set(t.map(function(t){return t.id})));if(e.length<b.length){b.forEach(function(i){if(!e.includes(i)){var r=h.filter(function(t){return t.id===i})[0];if(r.shape==="Area"){var n={__d3plus__:true,data:r.data,id:i,shape:r.shape};n[d._discrete]=t[0][d._discrete];n[_]=0;h.push(n)}}})}});h.sort(function(t,e){return t[d._discrete]-e[d._discrete]});A=s.stack().keys(b).offset(this._stackOffset).order(this._stackOrder).value(function(t,e){var i=t.filter(function(t){return t.id===e});return i.length?i[0][_]:0})(A);O={};O[this._discrete]=i.extent(h,function(t){return t[d._discrete]});O[_]=[i.min(A.map(function(t){return i.min(t.map(function(t){return t[1]}))})),i.max(A.map(function(t){return i.max(t.map(function(t){return t[1]}))}))]}else{O={x:i.extent(h,function(t){return t.x}),y:i.extent(h,function(t){return t.y})}}var w=this._xDomain?this._xDomain.slice():O.x,S="Linear";if(w[0]===void 0){w[0]=O.x[0]}if(w[1]===void 0){w[1]=O.x[1]}if(m){w=w.map(o.date);S="Time"}else if(this._discrete==="x"){w=Array.from(new Set(h.map(function(t){return t.x}))).sort();S="Ordinal"}var L=this._yDomain?this._yDomain.slice():O.y,D="Linear";if(L[0]===void 0){L[0]=O.y[0]}if(L[1]===void 0){L[1]=O.y[1]}if(k){L=L.map(o.date);D="Time"}else if(this._discrete==="y"){L=Array.from(new Set(h.map(function(t){return t.y}))).sort();D="Ordinal"}O={x:w,y:L};if(_&&this._baseline!==void 0){var q=this._baseline;if(O[_][0]>q){O[_][0]=q}else if(O[_][1]<q){O[_][1]=q}}var B=n["scale"+S]().domain(O.x).range(i.range(0,g+1,g/(O.x.length-1))),T=n["scale"+D]().domain(O.y.reverse()).range(i.range(0,l+1,l/(O.y.length-1)));var j=r.nest().key(function(t){return t.shape}).entries(h);j.forEach(function(t){if(d._buffer[t.key]){var e=d._buffer[t.key].bind(d)(t.values,B,T,d._shapeConfig[t.key]);B=e[0];T=e[1]}});w=B.domain();L=T.domain();var E=e.elem("g.d3plus-plot-test",{enter:{opacity:0},parent:this._select}),z=this._discrete==="x"&&!m?O.x:undefined,P=this._discrete==="y"&&!k?O.y:undefined;this._yTest.domain(L).height(l).scale(D.toLowerCase()).select(E.node()).ticks(P).width(g).config(this._yConfig).render();var N=this._yTest.outerBounds();var R=N.width?N.width+this._yTest.padding():undefined;this._xTest.domain(w).height(l).range([R,undefined]).scale(S.toLowerCase()).select(E.node()).ticks(z).width(g).config(this._xConfig).render();this._xAxis.domain(w).height(l).range([R,undefined]).scale(S.toLowerCase()).select(e.elem("g.d3plus-plot-x-axis",{parent:p,transition:v,enter:{transform:x},update:{transform:x}}).node()).ticks(z).width(g).config(this._xConfig).render();B=this._xAxis._d3Scale;this._yAxis.domain(L).height(l).range([this._xAxis.outerBounds().y,this._xTest.outerBounds().y]).scale(D.toLowerCase()).select(e.elem("g.d3plus-plot-y-axis",{parent:p,transition:v,enter:{transform:x},update:{transform:x}}).node()).ticks(P).width(B.range()[B.range().length-1]+this._xAxis.padding()).config(this._yConfig).render();T=this._yAxis._d3Scale;var U={duration:this._duration,label:function(t){return d._drawLabel(t.data,t.i)},select:e.elem("g.d3plus-plot-shapes",{parent:p,transition:v,enter:{transform:x},update:{transform:x}}).node(),x:function(t){return B(t.x)},y:function(t){return T(t.y)}};function V(t){var e={};var i=function(i){if({}.hasOwnProperty.call(t,i)&&!f[i]){e[i]=typeof t[i]==="function"?function(e){return t[i](e.data,e.i)}:t[i]}};for(var r in t)i(r);return e}U=e.assign(U,V(this._shapeConfig));var M={x0:this._discrete==="x"?U.x:B(0),x1:this._discrete==="x"?null:U.x,y0:this._discrete==="y"?U.y:T(0),y1:this._discrete==="y"?null:U.y};if(this._stacked){var W=_==="x"?B:T;M[""+_]=M[_+"0"]=function(t){var e=b.indexOf(t.id),i=C.indexOf(""+t[d._discrete]);return e>=0?W(A[e][i][0]):W(0)};M[_+"1"]=function(t){var e=b.indexOf(t.id),i=C.indexOf(""+t[d._discrete]);return e>=0?W(A[e][i][1]):W(0)}}U=e.assign(U,M);function X(t){if(!this){return false}if(t.nested&&t.values){var i=y._discrete,r=a.mouse(y._select.node())[i==="x"?0:1],n=t.values.map(function(t){return U[i](t)});t=t.values[n.indexOf(e.closest(r,n))]}return this(t.data,t.i)}var Y=Object.keys(this._on);j.forEach(function(t){var e=(new f[t.key]).config(U).data(t.values);if(t.key==="Bar"){var i;var r=d._discrete==="x"?B:T;var s=r.domain().filter(function(t){return typeof t!=="string"||t.indexOf("d3plus-buffer-")<0});var a=r.range();if(s.length>1){i=r(s[1])-r(s[0])}else{i=a[a.length-1]-a[0]}i-=20;var o=i;if(!d._stacked){var c=Array.from(new Set(t.values.map(function(t){return t.id})));o/=c.length;var u=i/2-o/2;var h=n.scaleOrdinal().domain([0,c.length-1]).range([-u,u]);e[d._discrete](function(t,e){return U[d._discrete](t,e)+h(c.indexOf(t.id))})}e.width(o);e.height(o)}var l=Y.filter(function(e){return e.includes("."+t.key)}),_=Y.filter(function(t){return!t.includes(".")}),p=Y.filter(function(t){return t.includes(".shape")});for(var y=0;y<_.length;y++){e.on(_[y],X.bind(d._on[_[y]]))}for(var x=0;x<p.length;x++){e.on(p[x],X.bind(d._on[p[x]]))}for(var v=0;v<l.length;v++){e.on(l[v],X.bind(d._on[l[v]]))}e.config(d._shapeConfig[t.key]?V(d._shapeConfig[t.key]):{}).render();d._shapes.push(e)});return this};u.prototype.baseline=function t(e){return arguments.length?(this._baseline=e,this):this._baseline};u.prototype.discrete=function t(e){return arguments.length?(this._discrete=e,this):this._discrete};u.prototype.stacked=function t(e){return arguments.length?(this._stacked=e,this):this._stacked};u.prototype.stackOffset=function t(e){return arguments.length?(this._stackOffset=typeof e==="function"?e:s["stackOffset"+(e.charAt(0).toUpperCase()+e.slice(1))],this):this._stackOffset};u.prototype.stackOrder=function t(e){return arguments.length?(this._stackOrder=typeof e==="function"?e:s["stackOrder"+(e.charAt(0).toUpperCase()+e.slice(1))],this):this._stackOrder};u.prototype.x=function t(i){if(arguments.length){if(typeof i==="function"){this._x=i}else{this._x=e.accessor(i);if(!this._aggs[i]&&this._discrete==="x"){this._aggs[i]=function(t){var e=Array.from(new Set(t));return e.length===1?e[0]:e}}}return this}else{return this._x}};u.prototype.xConfig=function t(i){return arguments.length?(this._xConfig=e.assign(this._xConfig,i),this):this._xConfig};u.prototype.xDomain=function t(e){return arguments.length?(this._xDomain=e,this):this._xDomain};u.prototype.y=function t(i){if(arguments.length){if(typeof i==="function"){this._y=i}else{this._y=e.accessor(i);if(!this._aggs[i]&&this._discrete==="y"){this._aggs[i]=function(t){var e=Array.from(new Set(t));return e.length===1?e[0]:e}}}return this}else{return this._y}};u.prototype.yConfig=function t(i){if(arguments.length){if(i.domain){i.domain=i.domain.slice().reverse()}this._yConfig=e.assign(this._yConfig,i);return this}return this._yConfig};u.prototype.yDomain=function t(e){return arguments.length?(this._yDomain=e,this):this._yDomain};return u}(u.Viz);var x=function(t){function i(){t.call(this);this._baseline=0;this._discrete="x";this._shape=e.constant("Area");this.x("x")}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;return i}(y);var v=function(t){function i(){t.call(this);this._baseline=0;this._discrete="x";this._shape=e.constant("Bar");this.x("x")}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;return i}(y);var g=function(t){function i(){t.call(this);this._discrete="x";this._shape=e.constant("Line");this.x("x")}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;return i}(y);var m=function(t){function e(){t.call(this);this._stacked=true}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;return e}(x);t.AreaPlot=x;t.BarChart=v;t.LinePlot=g;t.Plot=y;t.StackedArea=m;Object.defineProperty(t,"__esModule",{value:true})});