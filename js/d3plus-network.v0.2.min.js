/*
  d3plus-network v0.2.1
  Javascript network visualizations built upon d3 modules.
  Copyright (c) 2018 D3plus - https://d3plus.org
  @license MIT
*/
if(typeof Object.assign!=="function"){Object.defineProperty(Object,"assign",{value:function e(t){"use strict";if(t===null){throw new TypeError("Cannot convert undefined or null to object")}var r=Object(t);for(var n=1;n<arguments.length;n++){var i=arguments[n];if(i!==null){for(var o in i){if(Object.prototype.hasOwnProperty.call(i,o)){r[o]=i[o]}}}}return r},writable:true,configurable:true})}if(!Array.prototype.includes){Object.defineProperty(Array.prototype,"includes",{value:function e(t,r){var n=Object(this);var i=n.length>>>0;if(i===0)return false;var o=r|0;var s=Math.max(o>=0?o:i-Math.abs(o),0);function a(e,t){return e===t||typeof e==="number"&&typeof t==="number"&&isNaN(e)&&isNaN(t)}while(s<i){if(a(n[s],t)){return true}s++}return false}})}(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?t(exports,require("d3-array"),require("d3-collection"),require("d3-scale"),require("d3-zoom"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-viz")):typeof define==="function"&&define.amd?define("d3plus-network",["exports","d3-array","d3-collection","d3-scale","d3-zoom","d3plus-common","d3plus-shape","d3plus-viz"],t):t(e.d3plus={},e.d3Array,e.d3Collection,e.scales,e.d3Zoom,e.d3plusCommon,e.shapes,e.d3plusViz)})(this,function(e,L,D,P,c,S,T,o){"use strict";var t=function(j){function e(){var f=this;j.call(this);this._labelCutoff=100;this._links=[];this._noDataMessage=false;this._nodes=[];this._on["click.shape"]=function(e,t){f._tooltipClass.data([]).render();if(f._hover&&f._drawDepth>=f._groupBy.length-1){if(f._focus&&f._focus===e.id){f.active(false);f._on.mouseenter.bind(f)(e,t);f._focus=undefined;f._zoomToBounds(null)}else{f.hover(false);var r=f._nodeGroupBy&&f._nodeGroupBy[f._drawDepth](e,t)?f._nodeGroupBy[f._drawDepth](e,t):f._id(e,t),n=f._linkLookup[r],i=f._nodeLookup[r];var o=[i.id];var s=[i.x-i.r,i.x+i.r],a=[i.y-i.r,i.y+i.r];n.forEach(function(e){o.push(e.id);if(e.x-e.r<s[0]){s[0]=e.x-e.r}if(e.x+e.r>s[1]){s[1]=e.x+e.r}if(e.y-e.r<a[0]){a[0]=e.y-e.r}if(e.y+e.r>a[1]){a[1]=e.y+e.r}});f.active(function(e,t){if(e.source&&e.target){return e.source.id===i.id||e.target.id===i.id}else{return o.includes(f._ids(e,t)[f._drawDepth])}});f._focus=e.id;var u=c.zoomTransform(f._container.node());s=s.map(function(e){return e*u.k+u.x});a=a.map(function(e){return e*u.k+u.y});f._zoomToBounds([[s[0],a[0]],[s[1],a[1]]])}}};this._on["click.legend"]=function(e,t){var r=f._id(e);var n=f._ids(e);n=n[n.length-1];if(f._hover&&f._drawDepth>=f._groupBy.length-1){if(f._focus&&f._focus===r){f.active(false);f._on.mouseenter.bind(f)(e,t);f._focus=undefined;f._zoomToBounds(null)}else{f.hover(false);var i=r.map(function(e){return f._nodeLookup[e]});var o=[n];var s=[i[0].x-i[0].r,i[0].x+i[0].r],a=[i[0].y-i[0].r,i[0].y+i[0].r];i.forEach(function(e){o.push(e.id);if(e.x-e.r<s[0]){s[0]=e.x-e.r}if(e.x+e.r>s[1]){s[1]=e.x+e.r}if(e.y-e.r<a[0]){a[0]=e.y-e.r}if(e.y+e.r>a[1]){a[1]=e.y+e.r}});f.active(function(e,t){if(e.source&&e.target){return o.includes(e.source.id)&&o.includes(e.target.id)}else{var r=f._ids(e,t);return o.includes(r[r.length-1])}});f._focus=r;var u=c.zoomTransform(f._container.node());s=s.map(function(e){return e*u.k+u.x});a=a.map(function(e){return e*u.k+u.y});f._zoomToBounds([[s[0],a[0]],[s[1],a[1]]])}f._on["mousemove.legend"].bind(f)(e,t)}};this._sizeMin=5;this._sizeScale="sqrt";this._shape=S.constant("Circle");this._shapeConfig=S.assign(this._shapeConfig,{labelConfig:{duration:0,fontMin:1,fontResize:true,labelPadding:0,textAnchor:"middle",verticalAlign:"middle"},Path:{fill:"none",label:false,stroke:"#eee",strokeWidth:1}});this._x=S.accessor("x");this._y=S.accessor("y");this._zoom=true}if(j)e.__proto__=j;e.prototype=Object.create(j&&j.prototype);e.prototype.constructor=e;e.prototype._draw=function e(t){var i=this;j.prototype._draw.call(this,t);var r=this._height-this._margin.top-this._margin.bottom,n="translate("+this._margin.left+", "+this._margin.top+")",o=this._transition,s=this._width-this._margin.left-this._margin.right;var a=this._filteredData.reduce(function(e,t,r){e[i._id(t,r)]=t;return e},{});var u=this._nodes.reduce(function(e,t,r){e[i._nodeGroupBy?i._nodeGroupBy[i._drawDepth](t,r):i._id(t,r)]=t;return e},{});u=Array.from(new Set(Object.keys(a).concat(Object.keys(u)))).map(function(e,t){var r=a[e],n=u[e];if(n===undefined){return false}return{__d3plus__:true,data:r||n,i:t,id:e,fx:r!==undefined&&i._x(r)!==undefined?i._x(r):i._x(n),fy:r!==undefined&&i._y(r)!==undefined?i._y(r):i._y(n),node:n,r:i._size?r!==undefined&&i._size(r)!==undefined?i._size(r):i._size(n):i._sizeMin,shape:r!==undefined&&i._shape(r)!==undefined?i._shape(r):i._shape(n)}}).filter(function(e){return e});var f=L.extent(u.map(function(e){return e.fx})),c=L.extent(u.map(function(e){return e.fy}));var d=P.scaleLinear().domain(f).range([0,s]),h=P.scaleLinear().domain(c).range([0,r]);var l=(f[1]-f[0])/(c[1]-c[0]),_=s/r;if(l>_){var p=r*_/l;h.range([(r-p)/2,r-(r-p)/2])}else{var y=s*l/_;d.range([(s-y)/2,s-(s-y)/2])}u.forEach(function(e){e.x=d(e.fx);e.y=h(e.fy)});var g=L.extent(u.map(function(e){return e.r}));var m=this._sizeMax||L.min(L.merge(u.map(function(t){return u.map(function(e){return t===e?null:T.pointDistance([t.x,t.y],[e.x,e.y])})})))/2;var v=P["scale"+this._sizeScale.charAt(0).toUpperCase()+this._sizeScale.slice(1)]().domain(g).range([g[0]===g[1]?m:L.min([m/2,this._sizeMin]),m]),x=d.domain(),z=h.domain();var k=x[1]-x[0],b=z[1]-z[0];u.forEach(function(e){var t=v(e.r);if(x[0]>d.invert(e.x-t)){x[0]=d.invert(e.x-t)}if(x[1]<d.invert(e.x+t)){x[1]=d.invert(e.x+t)}if(z[0]>h.invert(e.y-t)){z[0]=h.invert(e.y-t)}if(z[1]<h.invert(e.y+t)){z[1]=h.invert(e.y+t)}});var w=x[1]-x[0],C=z[1]-z[0];m*=L.min([k/w,b/C]);v.range([g[0]===g[1]?m:L.min([m/2,this._sizeMin]),m]);d.domain(x);h.domain(z);u.forEach(function(e){e.x=d(e.fx);e.fx=e.x;e.y=h(e.fy);e.fy=e.y;e.r=v(e.r);e.width=e.r*2;e.height=e.r*2});var M=this._nodeLookup=u.reduce(function(e,t){e[t.id]=t;return e},{});var q=u.map(function(e){return e.node});var O=this._links.map(function(e){return{source:typeof e.source==="number"?u[q.indexOf(i._nodes[e.source])]:M[e.source.id],target:typeof e.target==="number"?u[q.indexOf(i._nodes[e.target])]:M[e.target.id]}});this._linkLookup=O.reduce(function(e,t){if(!e[t.source.id]){e[t.source.id]=[]}e[t.source.id].push(t.target);if(!e[t.target.id]){e[t.target.id]=[]}e[t.target.id].push(t.source);return e},{});this._container=this._select.selectAll("svg.d3plus-network").data([0]);this._container=this._container.enter().append("svg").attr("class","d3plus-network").attr("opacity",0).attr("width",s).attr("height",r).attr("x",this._margin.left).attr("y",this._margin.top).style("background-color","transparent").merge(this._container);this._container.transition(this._transition).attr("opacity",1).attr("width",s).attr("height",r).attr("x",this._margin.left).attr("y",this._margin.top);var B=this._container.selectAll("rect.d3plus-network-hitArea").data([0]);B.enter().append("rect").attr("class","d3plus-network-hitArea").merge(B).attr("width",s).attr("height",r).attr("fill","transparent").on("click",function(){if(i._focus){i.active(false);i._focus=undefined;i._zoomToBounds(null)}});this._zoomGroup=this._container.selectAll("g.d3plus-network-zoomGroup").data([0]);var A=this._zoomGroup=this._zoomGroup.enter().append("g").attr("class","d3plus-network-zoomGroup").merge(this._zoomGroup);this._shapes.push((new T.Path).config(this._shapeConfig).config(this._shapeConfig.Path).d(function(e){return"M"+e.source.x+","+e.source.y+" "+e.target.x+","+e.target.y}).data(O).select(S.elem("g.d3plus-network-links",{parent:A,transition:o,enter:{transform:n},update:{transform:n}}).node()).render());var G={label:function(e){return u.length<=i._labelCutoff||(i._hover&&i._hover(e)||i._active&&i._active(e))?i._drawLabel(e.data||e.node,e.i):false},select:S.elem("g.d3plus-network-nodes",{parent:A,transition:o,enter:{transform:n},update:{transform:n}}).node()};D.nest().key(function(e){return e.shape}).entries(u).forEach(function(e){i._shapes.push((new T[e.key]).config(S.configPrep.bind(i)(i._shapeConfig,"shape",e.key)).config(G).config(G[e.key]||{}).data(e.values).render())});return this};e.prototype.labelCutoff=function e(t){return arguments.length?(this._labelCutoff=t,this):this._labelCutoff};e.prototype.links=function e(t,r){if(arguments.length){var n=this._queue.find(function(e){return e[3]==="links"});var i=[o.dataLoad.bind(this),t,r,"links"];if(n){this._queue[this._queue.indexOf(n)]=i}else{this._queue.push(i)}return this}return this._links};e.prototype.nodeGroupBy=function e(t){var r=this;if(!arguments.length){return this._nodeGroupBy}if(!(t instanceof Array)){t=[t]}return this._nodeGroupBy=t.map(function(e){if(typeof e==="function"){return e}else{if(!r._aggs[e]){r._aggs[e]=function(e){var t=Array.from(new Set(e));return t.length===1?t[0]:t}}return S.accessor(e)}}),this};e.prototype.nodes=function e(t,r){if(arguments.length){var n=this._queue.find(function(e){return e[3]==="nodes"});var i=[o.dataLoad.bind(this),t,r,"nodes"];if(n){this._queue[this._queue.indexOf(n)]=i}else{this._queue.push(i)}return this}return this._nodes};e.prototype.size=function e(t){return arguments.length?(this._size=typeof t==="function"||!t?t:S.accessor(t),this):this._size};e.prototype.sizeMax=function e(t){return arguments.length?(this._sizeMax=t,this):this._sizeMax};e.prototype.sizeMin=function e(t){return arguments.length?(this._sizeMin=t,this):this._sizeMin};e.prototype.sizeScale=function e(t){return arguments.length?(this._sizeScale=t,this):this._sizeScale};e.prototype.x=function e(t){if(arguments.length){if(typeof t==="function"){this._x=t}else{this._x=S.accessor(t);if(!this._aggs[t]){this._aggs[t]=function(e){return L.mean(e)}}}return this}else{return this._x}};e.prototype.y=function e(t){if(arguments.length){if(typeof t==="function"){this._y=t}else{this._y=S.accessor(t);if(!this._aggs[t]){this._aggs[t]=function(e){return L.mean(e)}}}return this}else{return this._y}};return e}(o.Viz);e.Network=t;Object.defineProperty(e,"__esModule",{value:true})});