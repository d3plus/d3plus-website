/*
  d3plus-shape v0.9.3
  Fancy SVG shapes for visualizations
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3-selection"),require("d3-transition"),require("d3plus-common"),require("d3plus-color"),require("d3plus-text"),require("d3-array"),require("d3-collection"),require("d3-interpolate-path"),require("d3-shape")):typeof define==="function"&&define.amd?define("d3plus-shape",["exports","d3-selection","d3-transition","d3plus-common","d3plus-color","d3plus-text","d3-array","d3-collection","d3-interpolate-path","d3-shape"],e):e(t.d3plus=t.d3plus||{},t.d3Selection,t.d3Transition,t.d3plusCommon,t.d3plusColor,t.d3plusText,t.d3Array,t.d3Collection,t.d3InterpolatePath,t.paths)})(this,function(t,e,i,n,r,s,o,a,h,c){"use strict";var u=function(t,e){if(!(t instanceof Array))t=[t.x,t.y];if(!(e instanceof Array))e=[e.x,e.y];var i=Math.abs(t[0]-e[0]);var n=Math.abs(t[1]-e[1]);return Math.sqrt(i*i+n*n)};var p=function t(){this._duration=600;this._height=n.accessor("height");this._id=n.accessor("url");this._select;this._url=n.accessor("url");this._width=n.accessor("width");this._x=n.accessor("x",0);this._y=n.accessor("y",0)};p.prototype.render=function t(n){var r=this;if(this._select===void 0)this.select(e.select("body").append("svg").style("width",window.innerWidth+"px").style("height",window.innerHeight+"px").style("display","block").node());var s=this._select.selectAll(".d3plus-shape-image").data(this._data,this._id);var o=s.enter().append("image").attr("class","d3plus-shape-image").attr("opacity",0);var a=i.transition().duration(this._duration),h=this,c=o.merge(s);c.attr("xlink:href",this._url).transition(a).attr("opacity",1).attr("width",function(t,e){return r._width(t,e)}).attr("height",function(t,e){return r._height(t,e)}).attr("x",function(t,e){return r._x(t,e)}).attr("y",function(t,e){return r._y(t,e)}).each(function(t,i){var n=e.select(this),r=h._url(t,i);var s=r.indexOf("http://")===0||r.indexOf("https://")===0;if(!s||r.indexOf(window.location.hostname)===0){var o=new p;o.src=r;o.crossOrigin="Anonymous";o.onload=function(){var t=document.createElement("canvas");t.width=this.width;t.height=this.height;var e=t.getContext("2d");e.drawImage(this,0,0);n.attr("xlink:href",t.toDataURL("image/png"))}}});s.exit().transition(a).attr("width",function(t,e){return r._width(t,e)}).attr("height",function(t,e){return r._height(t,e)}).attr("x",function(t,e){return r._x(t,e)}).attr("y",function(t,e){return r._y(t,e)}).attr("opacity",0).remove();if(n)setTimeout(n,this._duration+100);return this};p.prototype.data=function t(e){return arguments.length?(this._data=e,this):this._data};p.prototype.duration=function t(e){return arguments.length?(this._duration=e,this):this._duration};p.prototype.height=function t(e){return arguments.length?(this._height=typeof e==="function"?e:n.constant(e),this):this._height};p.prototype.id=function t(e){return arguments.length?(this._id=e,this):this._id};p.prototype.select=function t(i){return arguments.length?(this._select=e.select(i),this):this._select};p.prototype.url=function t(e){return arguments.length?(this._url=e,this):this._url};p.prototype.width=function t(e){return arguments.length?(this._width=typeof e==="function"?e:n.constant(e),this):this._width};p.prototype.x=function t(e){return arguments.length?(this._x=typeof e==="function"?e:n.constant(e),this):this._x};p.prototype.y=function t(e){return arguments.length?(this._y=typeof e==="function"?e:n.constant(e),this):this._y};var l=function(t){function o(){var e=this;t.call(this);this._backgroundImage=n.constant(false);this._data=[];this._duration=600;this._fill=n.constant("black");this._fontColor=function(t,i){return r.contrast(e._fill(t,i))};this._fontFamily=n.constant("Verdana");this._fontResize=n.constant(false);this._fontSize=n.constant(12);this._id=function(t,e){return t.id!==void 0?t.id:e};this._label=n.constant(false);this._labelPadding=n.constant(5);this._name="Shape";this._opacity=n.constant(1);this._scale=n.constant(1);this._shapeRendering=n.constant("geometricPrecision");this._stroke=n.constant("black");this._strokeWidth=n.constant(0);this._textAnchor=n.constant("start");this._vectorEffect=n.constant("non-scaling-stroke");this._verticalAlign=n.constant("top");this._x=n.accessor("x",0);this._y=n.accessor("y",0)}if(t)o.__proto__=t;o.prototype=Object.create(t&&t.prototype);o.prototype.constructor=o;o.prototype._aes=function t(){return{}};o.prototype._applyEvents=function t(e){var i=this;var n=Object.keys(this._on);var r=function(t){e.on(n[t],function(e,r){if(!i._on[n[t]])return;var s=this.className.baseVal==="hitArea";var o=s?this.parentNode:this;i._on[n[t]].bind(o)(e,s?i._data.indexOf(e):r)})};for(var s=0;s<n.length;s++)r(s)};o.prototype._applyImage=function t(e,i){if(i===void 0)i=true;var n=this;e.each(function(t,e){var r=n._aes(t,e);var s=[];var o=0,a=0;if(i&&(r.r||r.width&&r.height)){o=r.r?r.r*2:r.height;a=r.r?r.r*2:r.width;var h=n._backgroundImage(t,e);if(h)s.push({url:h})}(new p).data(s).duration(n._duration).height(o).select(this).width(a).x(-a/2).y(-o/2).render()})};o.prototype._applyLabels=function t(e,i){if(i===void 0)i=true;var n=this;e.each(function(t,e){var r=t;if(t.nested&&t.key&&t.values){r=t.values[0];e=n._data.indexOf(r)}var o=[];if(i){var a=n._label(r,e);if(n._labelBounds&&a!==false&&a!==void 0){var h=n._labelBounds(r,e,n._aes(t,e));if(h){if(a.constructor!==Array)a=[a];var c=n._fontColor(r,e),u=n._fontFamily(r,e),p=n._fontResize(r,e),l=n._fontSize(r,e),_=n._lineHeight(r,e),d=n._labelPadding(r,e),f=n._textAnchor(r,e),y=n._verticalAlign(r,e);for(var g=0;g<a.length;g++){var v=h.constructor===Array?h[g]:Object.assign({},h),x=d.constructor===Array?d[g]:d;v.height-=x*2;v.width-=x*2;v.x+=x;v.y+=x;v.id=n._id(r,e)+"_"+g;v.text=a[g];v.fC=c.constructor===Array?c[g]:c;v.fF=u.constructor===Array?u[g]:u;v.fR=p.constructor===Array?p[g]:p;v.fS=l.constructor===Array?l[g]:l;v.lH=_.constructor===Array?_[g]:_;v.tA=f.constructor===Array?f[g]:f;v.vA=y.constructor===Array?y[g]:y;o.push(v)}}}}(new s.TextBox).data(o).delay(n._duration/2).duration(n._duration).fontColor(function(t){return t.fC}).fontFamily(function(t){return t.fF}).fontResize(function(t){return t.fR}).fontSize(function(t){return t.fS}).lineHeight(function(t){return t.lH}).textAnchor(function(t){return t.tA}).verticalAlign(function(t){return t.vA}).select(this).render()})};o.prototype._applyStyle=function t(e){var i=this;function n(t,e){return t.nested&&t.key&&t.values?this(t.values[0],i._data.indexOf(t.values[0])):this(t,e)}e.attr("fill",n.bind(this._fill)).attr("stroke",n.bind(this._stroke)).attr("stroke-width",n.bind(this._strokeWidth)).attr("vector-effect",n.bind(this._vectorEffect))};o.prototype._applyTransform=function t(e){var i=this;e.attr("transform",function(t,e){return"\n        translate("+(t.__d3plusShape__?t.translate?t.translate:i._x(t.data,t.i)+","+i._y(t.data,t.i):i._x(t,e)+","+i._y(t,e))+")\n        scale("+(t.__d3plusShape__?t.scale||i._scale(t.data,t.i):i._scale(t,e))+")"})};o.prototype._nestWrapper=function t(e){return function(t,i){return e(t.__d3plusShape__?t.data:t,t.__d3plusShape__?t.i:i)}};o.prototype.render=function t(r){var o=this;if(this._select===void 0){this.select(e.select("body").append("svg").style("width",window.innerWidth+"px").style("height",window.innerHeight+"px").style("display","block").node())}if(this._lineHeight===void 0){this.lineHeight(function(t,e){return o._fontSize(t,e)*1.1})}this._transition=i.transition().duration(this._duration);var a=this._data,h=this._id;if(this._dataFilter){a=this._dataFilter(a);if(a.key)h=a.key}if(this._sort)a=a.sort(function(t,e){return o._sort(t.__d3plusShape__?t.data:t,e.__d3plusShape__?e.data:e)});var c=this._select.selectAll(".d3plus-"+this._name).data(a,h);c.order().attr("shape-rendering",this._nestWrapper(this._shapeRendering)).transition(this._transition).call(this._applyTransform.bind(this));this._update=c.select(".d3plus-Shape-bg");var u=c.enter().append("g").attr("class",function(t,e){return"d3plus-Shape d3plus-"+o._name+" d3plus-id-"+s.strip(o._nestWrapper(o._id)(t,e))}).call(this._applyTransform.bind(this)).attr("opacity",this._nestWrapper(this._opacity)).attr("shape-rendering",this._nestWrapper(this._shapeRendering));this._enter=u.append("g").attr("class","d3plus-Shape-bg");var p=u.append("g").attr("class","d3plus-Shape-fg");var l=u.merge(c);p.merge(c.select(".d3plus-Shape-fg")).call(this._applyImage.bind(this)).call(this._applyLabels.bind(this));l.attr("pointer-events","none").transition(this._transition).attr("opacity",this._nestWrapper(this._opacity)).transition().attr("pointer-events","all");var _=this;var d=l.selectAll(".d3plus-Shape-hitArea").data(this._hitArea?[0]:[]);d.exit().remove();d=d.enter().append("rect").attr("class","d3plus-Shape-hitArea").attr("fill","none").merge(d).data(function(t){return[t]}).each(function(t){var i=_._hitArea(t,_._data.indexOf(t),_._aes(t,_._data.indexOf(t)));return i?e.select(this).call(n.attrize,i):e.select(this).remove()});this._applyEvents(this._hitArea?d:l);var f=c.exit();f.select(".d3plus-Shape-fg").call(this._applyImage.bind(this),false).call(this._applyLabels.bind(this),false);f.transition().delay(this._duration).remove();this._exit=f.select(".d3plus-Shape-bg");if(r)setTimeout(r,this._duration+100);return this};o.prototype.backgroundImage=function t(e){return arguments.length?(this._backgroundImage=typeof e==="function"?e:n.constant(e),this):this._backgroundImage};o.prototype.data=function t(e){return arguments.length?(this._data=e,this):this._data};o.prototype.duration=function t(e){return arguments.length?(this._duration=e,this):this._duration};o.prototype.fill=function t(e){return arguments.length?(this._fill=typeof e==="function"?e:n.constant(e),this):this._fill};o.prototype.fontColor=function t(e){return arguments.length?(this._fontColor=typeof e==="function"?e:n.constant(e),this):this._fontColor};o.prototype.fontFamily=function t(e){return arguments.length?(this._fontFamily=typeof e==="function"?e:n.constant(e),this):this._fontFamily};o.prototype.fontResize=function t(e){return arguments.length?(this._fontResize=typeof e==="function"?e:n.constant(e),this):this._fontResize};o.prototype.fontSize=function t(e){return arguments.length?(this._fontSize=typeof e==="function"?e:n.constant(e),this):this._fontSize};o.prototype.hitArea=function t(e){return arguments.length?(this._hitArea=typeof e==="function"?e:n.constant(e),this):this._hitArea};o.prototype.id=function t(e){return arguments.length?(this._id=e,this):this._id};o.prototype.label=function t(e){return arguments.length?(this._label=typeof e==="function"?e:n.constant(e),this):this._label};o.prototype.labelBounds=function t(e){return arguments.length?(this._labelBounds=typeof e==="function"?e:n.constant(e),this):this._labelBounds};o.prototype.labelPadding=function t(e){return arguments.length?(this._labelPadding=typeof e==="function"?e:n.constant(e),this):this._labelPadding};o.prototype.lineHeight=function t(e){return arguments.length?(this._lineHeight=typeof e==="function"?e:n.constant(e),this):this._lineHeight};o.prototype.opacity=function t(e){return arguments.length?(this._opacity=typeof e==="function"?e:n.constant(e),this):this._opacity};o.prototype.scale=function t(e){return arguments.length?(this._scale=typeof e==="function"?e:n.constant(e),this):this._scale};o.prototype.select=function t(i){return arguments.length?(this._select=e.select(i),this):this._select};o.prototype.shapeRendering=function t(e){return arguments.length?(this._shapeRendering=typeof e==="function"?e:n.constant(e),this):this._shapeRendering};o.prototype.sort=function t(e){return arguments.length?(this._sort=e,this):this._sort};o.prototype.stroke=function t(e){return arguments.length?(this._stroke=typeof e==="function"?e:n.constant(e),this):this._stroke};o.prototype.strokeWidth=function t(e){return arguments.length?(this._strokeWidth=typeof e==="function"?e:n.constant(e),this):this._strokeWidth};o.prototype.textAnchor=function t(e){return arguments.length?(this._textAnchor=typeof e==="function"?e:n.constant(e),this):this._textAnchor};o.prototype.vectorEffect=function t(e){return arguments.length?(this._vectorEffect=typeof e==="function"?e:n.constant(e),this):this._vectorEffect};o.prototype.verticalAlign=function t(e){return arguments.length?(this._verticalAlign=typeof e==="function"?e:n.constant(e),this):this._verticalAlign};o.prototype.x=function t(e){return arguments.length?(this._x=typeof e==="function"?e:n.constant(e),this):this._x};o.prototype.y=function t(e){return arguments.length?(this._y=typeof e==="function"?e:n.constant(e),this):this._y};return o}(n.BaseClass);var _=function(t){function i(){t.call(this);this._curve="linear";this._defined=function(){return true};this._name="Area";this._x=n.accessor("x");this._x0=n.accessor("x");this._x1=null;this._y=n.constant(0);this._y0=n.constant(0);this._y1=n.accessor("y")}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;i.prototype._dataFilter=function t(e){var i=this;var r=a.nest().key(this._id).entries(e).map(function(t){t.data=n.merge(t.values);t.i=e.indexOf(t.values[0]);var r=o.extent(t.values.map(i._x).concat(t.values.map(i._x0)).concat(i._x1?t.values.map(i._x1):[]));t.xR=r;t.width=r[1]-r[0];t.x=r[0]+t.width/2;var s=o.extent(t.values.map(i._y).concat(t.values.map(i._y0)).concat(i._y1?t.values.map(i._y1):[]));t.yR=s;t.height=s[1]-s[0];t.y=s[0]+t.height/2;t.nested=true;t.translate=[t.x,t.y];t.__d3plusShape__=true;return t});r.key=function(t){return t.key};return r};i.prototype.render=function i(n){t.prototype.render.call(this,n);var r=this._path=c.area().defined(this._defined).curve(c["curve"+this._curve.charAt(0).toUpperCase()+this._curve.slice(1)]).x(this._x).x0(this._x0).x1(this._x1).y(this._y).y0(this._y0).y1(this._y1);var s=c.area().defined(function(t){return t}).curve(c["curve"+this._curve.charAt(0).toUpperCase()+this._curve.slice(1)]).x(this._x).x0(this._x0).x1(this._x1).y(this._y).y0(this._y0).y1(this._y1);this._enter.append("path").attr("transform",function(t){return"translate("+(-t.xR[0]-t.width/2)+", "+(-t.yR[0]-t.height/2)+")"}).attr("d",function(t){return r(t.values)}).call(this._applyStyle.bind(this));this._update.select("path").transition(this._transition).attr("transform",function(t){return"translate("+(-t.xR[0]-t.width/2)+", "+(-t.yR[0]-t.height/2)+")"}).attrTween("d",function(t){return h.interpolatePath(e.select(this).attr("d"),r(t.values))}).call(this._applyStyle.bind(this));this._exit.select("path").transition(this._transition).attrTween("d",function(t){return h.interpolatePath(e.select(this).attr("d"),s(t.values))});return this};i.prototype._aes=function t(e,i){var n=this;return{points:e.values.map(function(t){return[n._x(t,i),n._y(t,i)]})}};i.prototype.curve=function t(e){return arguments.length?(this._curve=e,this):this._curve};i.prototype.defined=function t(e){return arguments.length?(this._defined=e,this):this._defined};i.prototype.x0=function t(e){return arguments.length?(this._x0=typeof e==="function"?e:n.constant(e),this):this._x0};i.prototype.x1=function t(e){return arguments.length?(this._x1=typeof e==="function"||e===null?e:n.constant(e),this):this._x1};i.prototype.y0=function t(e){return arguments.length?(this._y0=typeof e==="function"?e:n.constant(e),this):this._y0};i.prototype.y1=function t(e){return arguments.length?(this._y1=typeof e==="function"||e===null?e:n.constant(e),this):this._y1};return i}(l);var d=function(t){function e(){t.call(this);this._name="Circle";this._r=n.accessor("r")}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;e.prototype._applyPosition=function t(e){var i=this;e.attr("r",function(t,e){return i._r(t,e)}).attr("x",function(t,e){return-i._r(t,e)/2}).attr("y",function(t,e){return-i._r(t,e)/2})};e.prototype.render=function e(i){t.prototype.render.call(this,i);this._enter.append("circle").attr("r",0).attr("x",0).attr("y",0).call(this._applyStyle.bind(this)).transition(this._transition).call(this._applyPosition.bind(this));this._update.select("circle").transition(this._transition).call(this._applyStyle.bind(this)).call(this._applyPosition.bind(this));this._exit.select("circle").transition(this._transition).attr("r",0).attr("x",0).attr("y",0);return this};e.prototype._aes=function t(e,i){return{r:this._r(e,i)}};e.prototype.r=function t(e){return arguments.length?(this._r=typeof e==="function"?e:n.constant(e),this):this._r};return e}(l);var f=function(t){function i(){t.call(this);this._curve="linear";this._defined=function(t){return t};this._fill=n.constant("none");this._name="Line";this._path=c.line();this._strokeWidth=n.constant(1)}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;i.prototype._dataFilter=function t(e){var i=this;var r=a.nest().key(this._id).entries(e).map(function(t){t.data=n.merge(t.values);t.i=e.indexOf(t.values[0]);var r=o.extent(t.values,i._x);t.xR=r;t.width=r[1]-r[0];t.x=r[0]+t.width/2;var s=o.extent(t.values,i._y);t.yR=s;t.height=s[1]-s[0];t.y=s[0]+t.height/2;t.nested=true;t.translate=[t.x,t.y];t.__d3plusShape__=true;return t});r.key=function(t){return t.key};return r};i.prototype.render=function i(n){var r=this;t.prototype.render.call(this,n);var s=this;this._path.curve(c["curve"+this._curve.charAt(0).toUpperCase()+this._curve.slice(1)]).defined(this._defined).x(this._x).y(this._y);this._enter.append("path").attr("transform",function(t){return"translate("+(-t.xR[0]-t.width/2)+", "+(-t.yR[0]-t.height/2)+")"}).attr("d",function(t){return r._path(t.values)}).call(this._applyStyle.bind(this));this._update.select("path").transition(this._transition).attr("transform",function(t){return"translate("+(-t.xR[0]-t.width/2)+", "+(-t.yR[0]-t.height/2)+")"}).attrTween("d",function(t){return h.interpolatePath(e.select(this).attr("d"),s._path(t.values))}).call(this._applyStyle.bind(this));return this};i.prototype._aes=function t(e,i){var n=this;return{points:e.values.map(function(t){return[n._x(t,i),n._y(t,i)]})}};i.prototype.curve=function t(e){return arguments.length?(this._curve=e,this):this._curve};i.prototype.defined=function t(e){return arguments.length?(this._defined=e,this):this._defined};return i}(l);var y=function(t){function e(){t.call(this);this._d=n.accessor("path");this._name="Path"}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;e.prototype.render=function e(i){t.prototype.render.call(this,i);this._enter.append("path").attr("opacity",0).attr("d",this._d).call(this._applyStyle.bind(this)).transition(this._transition).attr("opacity",1);this._update.select("path").transition(this._transition).call(this._applyStyle.bind(this)).attr("opacity",1).attr("d",this._d);this._exit.select("path").transition(this._transition).attr("opacity",0);return this};e.prototype.d=function t(e){return arguments.length?(this._d=typeof e==="function"?e:n.constant(e),this):this._d};return e}(l);var g=function(t){function e(){t.call(this);this._height=n.accessor("height");this._labelBounds=function(t,e,i){return{width:i.width,height:i.height,x:-i.width/2,y:-i.height/2}};this._name="Rect";this._width=n.accessor("width")}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;e.prototype.render=function e(i){t.prototype.render.call(this,i);this._enter.append("rect").attr("width",0).attr("height",0).attr("x",0).attr("y",0).call(this._applyStyle.bind(this)).transition(this._transition).call(this._applyPosition.bind(this));this._update.select("rect").transition(this._transition).call(this._applyStyle.bind(this)).call(this._applyPosition.bind(this));this._exit.select("rect").transition(this._transition).attr("width",0).attr("height",0).attr("x",0).attr("y",0);return this};e.prototype._aes=function t(e,i){return{width:this._width(e,i),height:this._height(e,i)}};e.prototype._applyPosition=function t(e){var i=this;e.attr("width",function(t,e){return i._width(t,e)}).attr("height",function(t,e){return i._height(t,e)}).attr("x",function(t,e){return-i._width(t,e)/2}).attr("y",function(t,e){return-i._height(t,e)/2})};e.prototype.height=function t(e){return arguments.length?(this._height=typeof e==="function"?e:n.constant(e),this):this._height};e.prototype.width=function t(e){return arguments.length?(this._width=typeof e==="function"?e:n.constant(e),this):this._width};return e}(l);t.pointDistance=u;t.Image=p;t.Shape=l;t.Area=_;t.Circle=d;t.Line=f;t.Path=y;t.Rect=g;Object.defineProperty(t,"__esModule",{value:true})});