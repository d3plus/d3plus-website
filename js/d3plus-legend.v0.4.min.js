/*
  d3plus-legend v0.4.1
  A collection of chart legends and keys.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("d3plus-common"),require("d3-selection"),require("d3-transition"),require("d3-array"),require("d3-scale"),require("d3plus-text"),require("d3-collection"),require("d3plus-shape")):"function"==typeof define&&define.amd?define("d3plus-legend",["exports","d3plus-common","d3-selection","d3-transition","d3-array","d3-scale","d3plus-text","d3-collection","d3plus-shape"],i):i(t.d3plus=t.d3plus||{},t.d3plusCommon,t.d3Selection,t.d3Transition,t.d3Array,t.scales,t.d3plusText,t.d3Collection,t.d3plus)}(this,function(t,i,e,n,o,h,s,r,a){"use strict";var d=function(t){function i(){t.call(this),this._duration=600,this._height=200,this._outerBounds={width:0,height:0,x:0,y:0},this._padding=5,this._width=400}return t&&(i.__proto__=t),i.prototype=Object.create(t&&t.prototype),i.prototype.constructor=i,i.prototype.duration=function(t){return arguments.length?(this._duration=t,this):this._duration},i.prototype.height=function(t){return arguments.length?(this._height=t,this):this._height},i.prototype.outerBounds=function(){return this._outerBounds},i.prototype.padding=function(t){return arguments.length?(this._padding=t,this):this._padding},i.prototype.render=function(t){return void 0===this._select&&this.select(e.select("body").append("svg").attr("width",this._width+"px").attr("height",this._height+"px").node()),this._transition=n.transition().duration(this._duration),t&&setTimeout(t,this._duration+100),this},i.prototype.select=function(t){return arguments.length?(this._select=e.select(t),this):this._select},i.prototype.width=function(t){return arguments.length?(this._width=t,this):this._width},i}(i.BaseClass),l=function(t){function e(){t.call(this),this._align="middle",this._domain=[0,10],this.orient("bottom"),this._scale="linear",this._strokeWidth=1,this._textBoxConfig={fontFamily:s.textBox().fontFamily(),fontResize:!1,fontSize:i.constant(10)},this._tickSize=5}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype._barPosition=function(t){var i=this._position,e=i.height,n=i.x,o=i.y,h=["top","left"].includes(this._orient)?this._outerBounds[o]+this._outerBounds[e]:this._outerBounds[o];t.attr(n+"1",this._d3Scale(this._d3Scale.domain()[0])).attr(n+"2",this._d3Scale(this._d3Scale.domain()[1])).attr(o+"1",h).attr(o+"2",h)},e.prototype._clipPosition=function(t){var i=this._position,e=i.width,n=i.height,o=i.x,h=i.y,s=this._d3Scale.domain(),r=this._strokeWidth,a=this._d3Scale(s[1])-this._d3Scale(s[0]),d=["top","left"].includes(this._orient)?this._outerBounds[h]+this._outerBounds[n]-this._tickSize:this._outerBounds[h];t.attr(o,this._d3Scale(this._d3Scale.domain()[0])-r).attr(h,d).attr(e,a+2*r).attr(n,this._tickSize+r)},e.prototype._tickPosition=function(t,i){void 0===i&&(i=!1);var e=this._position,n=e.height,o=e.x,h=e.y,s=["top","left"].includes(this._orient)?this._outerBounds[h]+this._outerBounds[n]:this._outerBounds[h],r=i?this._lastScale||this._d3Scale:this._d3Scale,a=["top","left"].includes(this._orient)?-this._tickSize:this._tickSize;t.attr("stroke-width",this._strokeWidth).attr(o+"1",function(t){return r(t.id)}).attr(o+"2",function(t){return r(t.id)}).attr(h+"1",s).attr(h+"2",i?s:s+a)},e.prototype.render=function(i){function e(t,i){var e=this._textBoxConfig.fontFamily(t,i),n=this._lineHeight(t,i),h=this._textBoxConfig.fontSize(t,i),r=s.textWrap().fontFamily(e).fontSize(h).lineHeight(n).width(f).height(this._height-this._tickSize-c)(t);return r.width=Math.ceil(o.max(r.lines.map(function(t){return s.textWidth(t,{"font-family":e,"font-size":h})}))),r.height=Math.ceil(r.lines.length*(n+1)),r}var n=this;t.prototype.render.call(this,i),void 0===this._lineHeight&&(this._lineHeight=function(t,i){return 1.1*n._textBoxConfig.fontSize(t,i)});var r=this._position,a=r.width,d=r.height,l=r.x,_=r.y,u="d3plus-ShapeLegend-clip-"+this._uuid,c=this._padding,p=this["_"+a]-2*c;this._d3Scale=h["scale"+this._scale.charAt(0).toUpperCase()+this._scale.slice(1)]().domain(this._domain).range([c,c+p]);for(var g=this._ticks||this._d3Scale.ticks(),f=0,m=0;m<g.length;m++){var y=n._d3Scale(g[m+1])-n._d3Scale(g[m]);y>f&&(f=y)}f-=c;var x=g.map(e.bind(this)),v=x[0][a],S=x[x.length-1][a];p-=v/2+S/2,this._d3Scale.range([c+v/2,c+v/2+p]);var w;this._outerBounds=(w={},w[d]=this._tickSize+o.max(x,function(t){return t[d]})+2*c,w[a]=this["_"+a]-2*c,w[l]=c,w),this._outerBounds[_]="start"===this._align?this._padding:"end"===this._align?this["_"+d]-this._outerBounds[d]:this["_"+d]/2-this._outerBounds[d]/2;var B=this._select.selectAll("g#d3plus-ScaleLegend-"+u).data([0]);B=B.enter().append("g").attr("id","d3plus-ScaleLegend-"+u).merge(B);var b=B.selectAll("defs").data([null]);b=b.enter().append("defs").merge(b);var C=b.selectAll("clipPath#"+u).data([null]);C=C.enter().append("clipPath").attr("id",u).merge(C);var k=C.selectAll("rect").data([null]);k.enter().append("rect").call(this._clipPosition.bind(this)).merge(k).transition(this._transition).call(this._clipPosition.bind(this));var z=B.selectAll("line.bar").data([null]);z.enter().append("line").attr("class","bar").attr("stroke","#000").attr("opacity",0).call(this._barPosition.bind(this)).merge(z).transition(this._transition).attr("opacity",1).call(this._barPosition.bind(this));var A=g.map(function(t){return{id:t}}),D=B.selectAll("line.tick").data(A,function(t){return t.id});D.exit().transition(this._transition).attr("opacity",0).call(this._tickPosition.bind(this)).remove(),D.enter().append("line").attr("class","tick").attr("stroke","#000").attr("opacity",0).attr("clip-path","url(#"+u+")").call(this._tickPosition.bind(this),!0).merge(D).transition(this._transition).attr("opacity",1).call(this._tickPosition.bind(this));var P=o.max(x,function(t){return t.height}),H=o.max(x,function(t,i){return t.width+n._textBoxConfig.fontSize(g[i],i)});return s.textBox().data(A).duration(this._duration).height(P).select(B.node()).text(function(t){return t.id}).textAnchor("left"===this._orient?"end":"right"===this._orient?"start":"middle").verticalAlign("bottom"===this._orient?"top":"top"===this._orient?"bottom":"middle").width(H).x(function(t,i){return["top","bottom"].includes(n._orient)?n._d3Scale(t.id)-H/2:"left"===n._orient?n._outerBounds.x-n._textBoxConfig.fontSize(g[i],i)/2:n._outerBounds.x+n._tickSize+n._padding}).y(function(t){return["left","right"].includes(n._orient)?n._d3Scale(t.id)-P/2:["right","bottom"].includes(n._orient)?n._outerBounds.y+n._tickSize+c:n._outerBounds.y}).config(this._textBoxConfig)(),this._lastScale=this._d3Scale,this},e.prototype.align=function(t){return arguments.length?(this._align=t,this):this._align},e.prototype.domain=function(t){return arguments.length?(this._domain=t,this):this._domain},e.prototype.orient=function(t){if(arguments.length){var i=["top","bottom"].includes(t);return this._position={width:i?"width":"height",height:i?"height":"width",x:i?"x":"y",y:i?"y":"x"},this._orient=t,this}return this._orient},e.prototype.scale=function(t){return arguments.length?(this._scale=t,this):this._scale},e.prototype.textBoxConfig=function(t){return arguments.length?(this._textBoxConfig=Object.assign(this._textBoxConfig,t),this):this._textBoxConfig},e.prototype.ticks=function(t){return arguments.length?(this._ticks=t,this):this._ticks},e.prototype.tickSize=function(t){return arguments.length?(this._tickSize=t,this):this._tickSize},e}(d),_=function(t){function e(){var e=this;t.call(this);var n=new a.Shape;this._align="center",this._id=i.accessor("id"),this._label=i.accessor("id"),this._lineData=[],this._orient="horizontal",this._shape=i.constant("Rect"),this._shapeConfig={duration:n.duration(),fill:i.accessor("color"),fontColor:i.constant("#444"),fontFamily:n.fontFamily(),fontSize:i.constant(10),height:i.constant(10),labelBounds:function(t,i){var n=e._lineData[i],o=void 0!==t.r?t.r:t.width/2;return{width:n.width,height:n.height,x:o+e._padding,y:1-n.height/2}},opacity:1,r:i.constant(5),width:i.constant(10),x:function(t,i){var n=e._shapeConfig.width;return"vertical"===e._orient?e._outerBounds.x+n(t,i)/2:e._outerBounds.x+o.sum(e._data.slice(0,i).map(function(t,i){return n(t,i)}))+o.sum(e._lineData.slice(0,i).map(function(n){return n.width-e._shapeConfig.fontSize(t,i)}))+n(t,i)/2+3*e._padding*i},y:function(t,i){var n=e._shapeConfig.height;if("horizontal"===e._orient)return e._outerBounds.y+o.max(e._lineData.map(function(t){return t.height}).concat(e._data.map(function(t,i){return n(t,i)})))/2;var h=n(t,i),s=e._lineData[i].height>h?e._lineData[i].height/2:h/2,r=o.sum(e._lineData.slice(0,i),function(t,i){return o.max([t.height,n(t.data,i)])});return e._outerBounds.y+r+s+e._padding*i}},this._verticalAlign="middle"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.render=function(i){var e=this;t.prototype.render.call(this,i),void 0===this._lineHeight&&(this._lineHeight=function(t,i){return 1.1*e._shapeConfig.fontSize(t,i)}),this._lineData=this._data.map(function(t,i){var n=e._shapeConfig.fontFamily(t,i),h=e._lineHeight(t,i),r=e._shapeConfig.fontSize(t,i),a="horizontal"===e._orient?e._height-(e._data.length+1)*e._padding:e._height,d="vertical"===e._orient?e._width-3*e._padding-e._shapeConfig.width(t,i):e._width,l=s.textWrap().fontFamily(n).fontSize(r).lineHeight(h).width(d).height(a)(e._label(t,i));return l.width=Math.ceil(o.max(l.lines.map(function(t){return s.textWidth(t,{"font-family":n,"font-size":r})})))+r,l.height=Math.ceil(l.lines.length*(h+1)),l.og={height:l.height,width:l.width},l.data=t,l.f=n,l.s=r,l.lh=h,l});var n,h,d=!0;if("horizontal"===this._orient){if(n=this._width-o.sum(this._data.map(function(t,i){return e._shapeConfig.width(t,i)+3*e._padding}))-2*this._padding,h=o.sum(this._lineData.map(function(t,i){return t.width-e._shapeConfig.fontSize(t,i)})),h>n){var l=this._lineData.filter(function(t){return t.words.length>1}).sort(function(t,i){return i.sentence.length-t.sentence.length});if(l.length&&this._height>2*l[0].height)for(var _=2;_<=5;){var u=l.filter(function(t){return t.words.length>=_});if(!u.length)break;for(var c=function(t){var i=l[t],e=i.og.height*_,r=i.og.width*(1.5*(1/_)),a=s.textWrap().fontFamily(i.f).fontSize(i.s).lineHeight(i.lh).width(r).height(e)(i.sentence);if(!a.truncated&&(h-=i.width,i.width=Math.ceil(o.max(a.lines.map(function(t){return s.textWidth(t,{"font-family":i.f,"font-size":i.s})})))+i.s,i.height=a.lines.length*(i.lh+1),h+=i.width,h<=n))return"break"},p=0;p<l.length;p++){var g=c(p);if("break"===g)break}if(h<=n)break;_++}else d=!1}}else n=this._width-o.max(this._data.map(function(t,i){return e._shapeConfig.width(t,i)+3*e._padding}))-2*this._padding,h=o.max(this._lineData.map(function(t,i){return t.width-e._shapeConfig.fontSize(t,i)}));if(h>n&&(d=!1),!d){h=0;for(var f=0;f<this._lineData.length;f++)e._lineData[f].width=0,e._lineData[f].height=0}var m=o.max(this._lineData,function(t,i){return o.max([t.height,e._shapeConfig.height(t.data,i)])}),y="horizontal"===this._orient?h+o.sum(this._data,function(t,i){return e._shapeConfig.width(t,i)})+this._padding*(this._data.length*(d?3:1)-2):h+o.max(this._data,function(t,i){return e._shapeConfig.width(t,i)})+3*this._padding;this._outerBounds.width=y,this._outerBounds.height=m;var x=this._padding,v=this._padding;"center"===this._align?x=(this._width-2*this._padding-y)/2:"right"===this._align&&(x=this._width-2*this._padding-y),"middle"===this._verticalAlign?v=(this._height-2*this._padding-m)/2:"bottom"===this._verticalAlign&&(v=this._height-2*this._padding-m),this._outerBounds.x=x,this._outerBounds.y=v;var S=this._select.selectAll("g.d3plus-ShapeLegend").data([0]);return S=S.enter().append("g").attr("class","d3plus-ShapeLegend").merge(S),r.nest().key(this._shape).entries(this._data).forEach(function(t){(new a[t.key]).data(t.values).duration(e._duration).id(e._id).lineHeight(e._lineHeight).label(!!d&&e._label).labelPadding(0).select(S.node()).verticalAlign("top").config(e._shapeConfig).render()}),i&&setTimeout(i,this._shapeConfig.duration+100),this},e.prototype.align=function(t){return arguments.length?(this._align=t,this):this._align},e.prototype.data=function(t){return arguments.length?(this._data=t,this):this._data},e.prototype.id=function(t){return arguments.length?(this._id=t,this):this._id},e.prototype.label=function(t){return arguments.length?(this._label="function"==typeof t?t:i.constant(t),this):this._label},e.prototype.orient=function(t){return arguments.length?(this._orient=t,this):this._orient},e.prototype.shape=function(t){return arguments.length?(this._shape="function"==typeof t?t:i.constant(t),this):this._shape},e.prototype.shapeConfig=function(t){return arguments.length?(this._shapeConfig=Object.assign(this._shapeConfig,t),this):this._shapeConfig},e.prototype.verticalAlign=function(t){return arguments.length?(this._verticalAlign=t,this):this._verticalAlign},e}(d);t.BaseLegend=d,t.ScaleLegend=l,t.ShapeLegend=_,Object.defineProperty(t,"__esModule",{value:!0})});