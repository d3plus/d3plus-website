/*
  d3plus-legend v0.4.0
  A collection of chart legends and keys.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("d3plus-common"),require("d3-array"),require("d3-selection"),require("d3-transition"),require("d3-scale"),require("d3plus-text"),require("d3-collection"),require("d3plus-shape")):"function"==typeof define&&define.amd?define("d3plus-legend",["exports","d3plus-common","d3-array","d3-selection","d3-transition","d3-scale","d3plus-text","d3-collection","d3plus-shape"],i):i(t.d3plus=t.d3plus||{},t.d3plusCommon,t.d3Array,t.d3Selection,t.d3Transition,t.scales,t.d3plusText,t.d3Collection,t.d3plus)}(this,function(t,i,e,n,h,o,s,r,a){"use strict";var d=function(){this._align="middle",this._domain=[0,10],this._duration=600,this._height=100,this.orient("bottom"),this._outerBounds={width:0,height:0,x:0,y:0},this._padding=5,this._scale="linear",this._strokeWidth=1,this._textBoxConfig={fontFamily:s.textBox().fontFamily(),fontResize:!1,fontSize:i.constant(10)},this._tickSize=5,this._uuid=(new Date).getTime(),this._width=400};d.prototype._barPosition=function(t){var i=this._position,e=i.height,n=i.x,h=i.y,o=["top","left"].includes(this._orient)?this._outerBounds[h]+this._outerBounds[e]:this._outerBounds[h];t.attr(n+"1",this._d3Scale(this._d3Scale.domain()[0])).attr(n+"2",this._d3Scale(this._d3Scale.domain()[1])).attr(h+"1",o).attr(h+"2",o)},d.prototype._clipPosition=function(t){var i=this._position,e=i.width,n=i.height,h=i.x,o=i.y,s=this._d3Scale.domain(),r=this._strokeWidth,a=this._d3Scale(s[1])-this._d3Scale(s[0]),d=["top","left"].includes(this._orient)?this._outerBounds[o]+this._outerBounds[n]-this._tickSize:this._outerBounds[o];t.attr(h,this._d3Scale(this._d3Scale.domain()[0])-r).attr(o,d).attr(e,a+2*r).attr(n,this._tickSize+r)},d.prototype._tickPosition=function(t,i){void 0===i&&(i=!1);var e=this._position,n=e.height,h=e.x,o=e.y,s=["top","left"].includes(this._orient)?this._outerBounds[o]+this._outerBounds[n]:this._outerBounds[o],r=i?this._lastScale||this._d3Scale:this._d3Scale,a=["top","left"].includes(this._orient)?-this._tickSize:this._tickSize;t.attr("stroke-width",this._strokeWidth).attr(h+"1",function(t){return r(t.id)}).attr(h+"2",function(t){return r(t.id)}).attr(o+"1",s).attr(o+"2",i?s:s+a)},d.prototype.render=function(t){function i(t,i){var n=this._textBoxConfig.fontFamily(t,i),h=this._lineHeight(t,i),o=this._textBoxConfig.fontSize(t,i),r=s.textWrap().fontFamily(n).fontSize(o).lineHeight(h).width(y).height(this._height-this._tickSize-p)(t);return r.width=Math.ceil(e.max(r.lines.map(function(t){return s.textWidth(t,{"font-family":n,"font-size":o})}))),r.height=Math.ceil(r.lines.length*(h+1)),r}var r=this;void 0===this._select&&this.select(n.select("body").append("svg").attr("width",this._width+"px").attr("height",this._height+"px").node()),void 0===this._lineHeight&&(this._lineHeight=function(t,i){return 1.1*r._textBoxConfig.fontSize(t,i)});var a=this._position,d=a.width,l=a.height,_=a.x,u=a.y,c="d3plus-ShapeLegend-clip-"+this._uuid,p=this._padding,g=h.transition().duration(this._duration),f=this["_"+d]-2*p;this._d3Scale=o["scale"+this._scale.charAt(0).toUpperCase()+this._scale.slice(1)]().domain(this._domain).range([p,p+f]);for(var m=this._ticks||this._d3Scale.ticks(),y=0,x=0;x<m.length;x++){var v=r._d3Scale(m[x+1])-r._d3Scale(m[x]);v>y&&(y=v)}y-=p;var w=m.map(i.bind(this)),S=w[0][d],B=w[w.length-1][d];f-=S/2+B/2,this._d3Scale.range([p+S/2,p+S/2+f]);var b;this._outerBounds=(b={},b[l]=this._tickSize+e.max(w,function(t){return t[l]})+2*p,b[d]=f,b[_]=this._d3Scale.range()[0],b),this._outerBounds[u]="start"===this._align?this._padding:"end"===this._align?this["_"+l]-this._outerBounds[l]:this["_"+l]/2-this._outerBounds[l]/2;var k=this._select.selectAll("g#d3plus-ScaleLegend-"+c).data([0]);k=k.enter().append("g").attr("id","d3plus-ScaleLegend-"+c).merge(k);var C=k.selectAll("defs").data([null]);C=C.enter().append("defs").merge(C);var z=C.selectAll("clipPath#"+c).data([null]);z=z.enter().append("clipPath").attr("id",c).merge(z);var A=z.selectAll("rect").data([null]);A.enter().append("rect").call(this._clipPosition.bind(this)).merge(A).transition(g).call(this._clipPosition.bind(this));var P=k.selectAll("line.bar").data([null]);P.enter().append("line").attr("class","bar").attr("stroke","#000").attr("opacity",0).call(this._barPosition.bind(this)).merge(P).transition(g).attr("opacity",1).call(this._barPosition.bind(this));var D=m.map(function(t){return{id:t}}),H=k.selectAll("line.tick").data(D,function(t){return t.id});H.exit().transition(g).attr("opacity",0).call(this._tickPosition.bind(this)).remove(),H.enter().append("line").attr("class","tick").attr("stroke","#000").attr("opacity",0).attr("clip-path","url(#"+c+")").call(this._tickPosition.bind(this),!0).merge(H).transition(g).attr("opacity",1).call(this._tickPosition.bind(this));var W=e.max(w,function(t){return t.height}),F=e.max(w,function(t,i){return t.width+r._textBoxConfig.fontSize(m[i],i)});return s.textBox().data(D).duration(this._duration).height(W).select(k.node()).text(function(t){return t.id}).textAnchor("left"===this._orient?"end":"right"===this._orient?"start":"middle").verticalAlign("bottom"===this._orient?"top":"top"===this._orient?"bottom":"middle").width(F).x(function(t,i){return["top","bottom"].includes(r._orient)?r._d3Scale(t.id)-F/2:"left"===r._orient?r._outerBounds.x-r._textBoxConfig.fontSize(m[i],i)/2:r._outerBounds.x+r._tickSize+r._padding}).y(function(t){return["left","right"].includes(r._orient)?r._d3Scale(t.id)-W/2:["right","bottom"].includes(r._orient)?r._outerBounds.y+r._tickSize+p:r._outerBounds.y}).config(this._textBoxConfig)(),this._lastScale=this._d3Scale,t&&setTimeout(t,this._duration+100),this},d.prototype.align=function(t){return arguments.length?(this._align=t,this):this._align},d.prototype.config=function t(i){var e=this;if(arguments.length){for(var n in i)({}).hasOwnProperty.call(i,n)&&n in e&&e[n](i[n]);return this}var t={};for(var h in this.prototype.constructor)"config"!==h&&{}.hasOwnProperty.call(e,h)&&(t[h]=e[h]());return t},d.prototype.domain=function(t){return arguments.length?(this._domain=t,this):this._domain},d.prototype.height=function(t){return arguments.length?(this._height=t,this):this._height},d.prototype.orient=function(t){if(arguments.length){var i=["top","bottom"].includes(t);return this._position={width:i?"width":"height",height:i?"height":"width",x:i?"x":"y",y:i?"y":"x"},this._orient=t,this}return this._orient},d.prototype.outerBounds=function(){return this._outerBounds},d.prototype.padding=function(t){return arguments.length?(this._padding=t,this):this._padding},d.prototype.scale=function(t){return arguments.length?(this._scale=t,this):this._scale},d.prototype.select=function(t){return arguments.length?(this._select=n.select(t),this):this._select},d.prototype.textBoxConfig=function(t){return arguments.length?(this._textBoxConfig=Object.assign(this._textBoxConfig,t),this):this._textBoxConfig},d.prototype.ticks=function(t){return arguments.length?(this._ticks=t,this):this._ticks},d.prototype.tickSize=function(t){return arguments.length?(this._tickSize=t,this):this._tickSize},d.prototype.width=function(t){return arguments.length?(this._width=t,this):this._width};var l=function(){var t=this,n=new a.Shape;this._align="center",this._height=100,this._id=i.accessor("id"),this._label=i.accessor("id"),this._lineData=[],this._orient="horizontal",this._outerBounds={width:0,height:0,x:0,y:0},this._padding=5,this._shape=i.constant("Rect"),this._shapeConfig={duration:n.duration(),fill:i.accessor("color"),fontColor:i.constant("#444"),fontFamily:n.fontFamily(),fontSize:i.constant(10),height:i.constant(10),labelBounds:function(i,e){var n=t._lineData[e],h=void 0!==i.r?i.r:i.width/2;return{width:n.width,height:n.height,x:h+t._padding,y:1-n.height/2}},opacity:1,r:i.constant(5),width:i.constant(10),x:function(i,n){var h=t._shapeConfig.width;return"vertical"===t._orient?t._outerBounds.x+h(i,n)/2:t._outerBounds.x+e.sum(t._data.slice(0,n).map(function(t,i){return h(t,i)}))+e.sum(t._lineData.slice(0,n).map(function(e){return e.width-t._shapeConfig.fontSize(i,n)}))+h(i,n)/2+3*t._padding*n},y:function(i,n){var h=t._shapeConfig.height;if("horizontal"===t._orient)return t._outerBounds.y+e.max(t._lineData.map(function(t){return t.height}).concat(t._data.map(function(t,i){return h(t,i)})))/2;var o=h(i,n),s=t._lineData[n].height>o?t._lineData[n].height/2:o/2,r=e.sum(t._lineData.slice(0,n),function(t,i){return e.max([t.height,h(t.data,i)])});return t._outerBounds.y+r+s+t._padding*n}},this._verticalAlign="middle",this._width=400};l.prototype.render=function(t){var i=this;void 0===this._select&&this.select(n.select("body").append("svg").attr("width",window.innerWidth+"px").attr("height",window.innerHeight+"px").node()),void 0===this._lineHeight&&(this._lineHeight=function(t,e){return 1.1*i._shapeConfig.fontSize(t,e)}),this._lineData=this._data.map(function(t,n){var h=i._shapeConfig.fontFamily(t,n),o=i._lineHeight(t,n),r=i._shapeConfig.fontSize(t,n),a="horizontal"===i._orient?i._height-(i._data.length+1)*i._padding:i._height,d="vertical"===i._orient?i._width-3*i._padding-i._shapeConfig.width(t,n):i._width,l=s.textWrap().fontFamily(h).fontSize(r).lineHeight(o).width(d).height(a)(i._label(t,n));return l.width=Math.ceil(e.max(l.lines.map(function(t){return s.textWidth(t,{"font-family":h,"font-size":r})})))+r,l.height=Math.ceil(l.lines.length*(o+1)),l.og={height:l.height,width:l.width},l.data=t,l.f=h,l.s=r,l.lh=o,l});var h,o,d=!0;if("horizontal"===this._orient){if(h=this._width-e.sum(this._data.map(function(t,e){return i._shapeConfig.width(t,e)+3*i._padding}))-2*this._padding,o=e.sum(this._lineData.map(function(t,e){return t.width-i._shapeConfig.fontSize(t,e)})),o>h){var l=this._lineData.filter(function(t){return t.words.length>1}).sort(function(t,i){return i.sentence.length-t.sentence.length});if(l.length&&this._height>2*l[0].height)for(var _=2;_<=5;){var u=l.filter(function(t){return t.words.length>=_});if(!u.length)break;for(var c=function(t){var i=l[t],n=i.og.height*_,r=i.og.width*(1.5*(1/_)),a=s.textWrap().fontFamily(i.f).fontSize(i.s).lineHeight(i.lh).width(r).height(n)(i.sentence);if(!a.truncated&&(o-=i.width,i.width=Math.ceil(e.max(a.lines.map(function(t){return s.textWidth(t,{"font-family":i.f,"font-size":i.s})})))+i.s,i.height=a.lines.length*(i.lh+1),o+=i.width,o<=h))return"break"},p=0;p<l.length;p++){var g=c(p);if("break"===g)break}if(o<=h)break;_++}else d=!1}}else h=this._width-e.max(this._data.map(function(t,e){return i._shapeConfig.width(t,e)+3*i._padding}))-2*this._padding,o=e.max(this._lineData.map(function(t,e){return t.width-i._shapeConfig.fontSize(t,e)}));if(o>h&&(d=!1),!d){o=0;for(var f=0;f<this._lineData.length;f++)i._lineData[f].width=0,i._lineData[f].height=0}var m=e.max(this._lineData,function(t,n){return e.max([t.height,i._shapeConfig.height(t.data,n)])}),y="horizontal"===this._orient?o+e.sum(this._data,function(t,e){return i._shapeConfig.width(t,e)})+this._padding*(this._data.length*(d?3:1)-2):o+e.max(this._data,function(t,e){return i._shapeConfig.width(t,e)})+3*this._padding;this._outerBounds.width=y,this._outerBounds.height=m;var x=this._padding,v=this._padding;"center"===this._align?x=(this._width-2*this._padding-y)/2:"right"===this._align&&(x=this._width-2*this._padding-y),"middle"===this._verticalAlign?v=(this._height-2*this._padding-m)/2:"bottom"===this._verticalAlign&&(v=this._height-2*this._padding-m),this._outerBounds.x=x,this._outerBounds.y=v;var w=this._select.selectAll("g.d3plus-ShapeLegend").data([0]);return w=w.enter().append("g").attr("class","d3plus-ShapeLegend").merge(w),r.nest().key(this._shape).entries(this._data).forEach(function(t){(new a[t.key]).data(t.values).id(i._id).lineHeight(i._lineHeight).label(!!d&&i._label).labelPadding(0).select(w.node()).verticalAlign("top").config(i._shapeConfig).render()}),t&&setTimeout(t,this._shapeConfig.duration+100),this},l.prototype.align=function(t){return arguments.length?(this._align=t,this):this._align},l.prototype.config=function t(i){var e=this;if(arguments.length){for(var n in i)({}).hasOwnProperty.call(i,n)&&n in e&&e[n](i[n]);return this}var t={};for(var h in this.prototype.constructor)"config"!==h&&{}.hasOwnProperty.call(e,h)&&(t[h]=e[h]());return t},l.prototype.data=function(t){return arguments.length?(this._data=t,this):this._data},l.prototype.height=function(t){return arguments.length?(this._height=t,this):this._height},l.prototype.id=function(t){return arguments.length?(this._id=t,this):this._id},l.prototype.label=function(t){return arguments.length?(this._label="function"==typeof t?t:i.constant(t),this):this._label},l.prototype.orient=function(t){return arguments.length?(this._orient=t,this):this._orient},l.prototype.outerBounds=function(){return this._outerBounds},l.prototype.padding=function(t){return arguments.length?(this._padding=t,this):this._padding},l.prototype.select=function(t){return arguments.length?(this._select=n.select(t),this):this._select},l.prototype.shape=function(t){return arguments.length?(this._shape="function"==typeof t?t:i.constant(t),this):this._shape},l.prototype.shapeConfig=function(t){return arguments.length?(this._shapeConfig=Object.assign(this._shapeConfig,t),this):this._shapeConfig},l.prototype.verticalAlign=function(t){return arguments.length?(this._verticalAlign=t,this):this._verticalAlign},l.prototype.width=function(t){return arguments.length?(this._width=t,this):this._width},t.ScaleLegend=d,t.ShapeLegend=l,Object.defineProperty(t,"__esModule",{value:!0})});