/*
  d3plus-legend v0.4.4
  A collection of chart legends and keys.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("d3plus-common"),require("d3-selection"),require("d3-transition"),require("d3-array"),require("d3-scale"),require("d3plus-text"),require("d3-collection"),require("d3plus-shape")):"function"==typeof define&&define.amd?define("d3plus-legend",["exports","d3plus-common","d3-selection","d3-transition","d3-array","d3-scale","d3plus-text","d3-collection","d3plus-shape"],i):i(t.d3plus=t.d3plus||{},t.d3plusCommon,t.d3Selection,t.d3Transition,t.d3Array,t.scales,t.d3plusText,t.d3Collection,t.d3plus)}(this,function(t,i,e,n,o,h,s,r,a){"use strict";var l=function(t){function i(){t.call(this),this._duration=600,this._height=200,this._outerBounds={width:0,height:0,x:0,y:0},this._padding=5,this._titleConfig={fontFamily:"Verdana",fontSize:12,lineHeight:13,textAnchor:"middle"},this._width=400}return t&&(i.__proto__=t),i.prototype=Object.create(t&&t.prototype),i.prototype.constructor=i,i.prototype.duration=function(t){return arguments.length?(this._duration=t,this):this._duration},i.prototype.height=function(t){return arguments.length?(this._height=t,this):this._height},i.prototype.outerBounds=function(){return this._outerBounds},i.prototype.padding=function(t){return arguments.length?(this._padding=t,this):this._padding},i.prototype.render=function(t){return void 0===this._select&&this.select(e.select("body").append("svg").attr("width",this._width+"px").attr("height",this._height+"px").node()),this._transition=n.transition().duration(this._duration),t&&setTimeout(t,this._duration+100),this},i.prototype.select=function(t){return arguments.length?(this._select=e.select(t),this):this._select},i.prototype.title=function(t){return arguments.length?(this._title=t,this):this._title},i.prototype.titleConfig=function(t){return arguments.length?(this._titleConfig=Object.assign(this._titleConfig,t),this):this._titleConfig},i.prototype.width=function(t){return arguments.length?(this._width=t,this):this._width},i}(i.BaseClass),d=function(t){function e(){t.call(this),this._align="middle",this._domain=[0,10],this.orient("bottom"),this._scale="linear",this._strokeWidth=1,this._textBoxConfig={fontFamily:(new s.TextBox).fontFamily(),fontResize:!1,fontSize:i.constant(10)},this._tickScale=h.scaleSqrt().domain([10,400]).range([10,50]),this._tickSize=5}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype._barPosition=function(t){var i=this._position,e=i.height,n=i.x,o=i.y,h=["top","left"].includes(this._orient)?this._outerBounds[o]+this._outerBounds[e]:this._outerBounds[o];t.attr(n+"1",this._d3Scale(this._d3Scale.domain()[0])).attr(n+"2",this._d3Scale(this._d3Scale.domain()[1])).attr(o+"1",h).attr(o+"2",h)},e.prototype._clipPosition=function(t){var i=this._position,e=i.width,n=i.height,o=i.x,h=i.y,s=this._d3Scale.domain(),r=this._strokeWidth,a=this._d3Scale(s[1])-this._d3Scale(s[0]),l=["top","left"].includes(this._orient)?this._outerBounds[h]+this._outerBounds[n]-this._tickSize:this._outerBounds[h];t.attr(o,this._d3Scale(this._d3Scale.domain()[0])-r).attr(h,l).attr(e,a+2*r).attr(n,this._tickSize+r)},e.prototype._tickPosition=function(t,i){void 0===i&&(i=!1);var e=this._position,n=e.height,o=e.x,h=e.y,s=["top","left"].includes(this._orient)?this._outerBounds[h]+this._outerBounds[n]:this._outerBounds[h],r=i?this._lastScale||this._d3Scale:this._d3Scale,a=["top","left"].includes(this._orient)?-this._tickSize:this._tickSize;t.attr("stroke-width",this._strokeWidth).attr(o+"1",function(t){return r(t.id)}).attr(o+"2",function(t){return r(t.id)}).attr(h+"1",s).attr(h+"2",i?s:s+a)},e.prototype.render=function(i){var e=this;t.prototype.render.call(this,i),void 0===this._lineHeight&&(this._lineHeight=function(t,i){return 1.1*e._textBoxConfig.fontSize(t,i)});var n=this._position,r=n.width,a=n.height,l=n.x,d=n.y,_="d3plus-ShapeLegend-clip-"+this._uuid,u=this._padding,c=this._range?this._range.slice():[void 0,void 0];void 0===c[0]&&(c[0]=u),void 0===c[1]&&(c[1]=this["_"+r]-u);var g=c[1]-c[0];if(this._titleHeight=0,this._title){var p=this._titleConfig.lineHeight?this._titleConfig.lineHeight:1.1*this._titleConfig.fontSize,f=s.textWrap().fontFamily(this._titleConfig.fontFamily).fontSize(this._titleConfig.fontSize).lineHeight(p).width(g).height(this._height-this._tickSize-u)(this._title);this._titleHeight=f.lines.length*p+u}this._d3Scale=h["scale"+this._scale.charAt(0).toUpperCase()+this._scale.slice(1)]().domain(this._domain).rangeRound(c);var m=this._ticks||this._d3Scale.ticks(Math.floor(g/this._tickScale(g))),y=this._d3Scale.tickFormat(m.length-1);this._ticks||(m=m.map(y).map(Number));var x=this._tickLabels||m,v=0;if(x.length>1)for(var S=0;S<x.length;S++){var w=e._d3Scale(x[S+1])-e._d3Scale(x[S]);w>v&&(v=w)}else v=g;var B=x.map(function(t,i){var n=e._textBoxConfig.fontFamily(t,i),h=e._textBoxConfig.fontSize(t,i),r=e._textBoxConfig.lineHeight?e._textBoxConfig.lineHeight(t,i):1.1*h,a=s.textWrap().fontFamily(n).fontSize(h).lineHeight(r).width(v).height(e._height-e._tickSize-u)(t);return a.lines=a.lines.filter(function(t){return""!==t}),a.d=t,a.fS=h,a.width=Math.ceil(o.max(a.lines.map(function(t){return s.textWidth(t,{"font-family":n,"font-size":h})}))),a.height=Math.ceil(a.lines.length*(r+1)),a.width%2&&a.width++,a}),b=c.slice();if(B.length){var C=B[0],k=B[B.length-1],z=this._d3Scale(C.d)-C[r]/2-u;if(z<c[0]){var H=c[0]-z;void 0===this._range||void 0===this._range[0]?(g-=H,c[0]+=H):this._range&&(b[0]-=H)}var A=this._d3Scale(k.d)+k[r]/2+u;if(A>c[1]){var L=A-c[1];void 0===this._range||void 0===this._range[1]?(g-=L,c[1]-=L):this._range&&(b[1]+=L)}this._d3Scale.rangeRound(c)}var D,F=B.length?2*u:0;this._outerBounds=(D={},D[a]=this._titleHeight+this._tickSize+(o.max(B,function(t){return t[a]})||0)+F,D[r]=b[1]-b[0],D[l]=b[0],D),this._outerBounds[d]="start"===this._align?this._padding:"end"===this._align?this["_"+a]-this._outerBounds[a]:this["_"+a]/2-this._outerBounds[a]/2;var P=this._select.selectAll("g#d3plus-ScaleLegend-"+_).data([0]);P=P.enter().append("g").attr("id","d3plus-ScaleLegend-"+_).merge(P);var W=P.selectAll("defs").data([null]);W=W.enter().append("defs").merge(W);var q=W.selectAll("clipPath#"+_).data([null]);q=q.enter().append("clipPath").attr("id",_).merge(q);var j=q.selectAll("rect").data([null]);j.enter().append("rect").call(this._clipPosition.bind(this)).merge(j).transition(this._transition).call(this._clipPosition.bind(this));var O=P.selectAll("line.bar").data([null]);O.enter().append("line").attr("class","bar").attr("stroke","#000").attr("opacity",0).call(this._barPosition.bind(this)).merge(O).transition(this._transition).attr("opacity",1).call(this._barPosition.bind(this));var M=P.selectAll("line.tick").data(m.map(function(t){return{id:t}}),function(t){return t.id});M.exit().transition(this._transition).attr("opacity",0).call(this._tickPosition.bind(this)).remove(),M.enter().append("line").attr("class","tick").attr("stroke","#000").attr("opacity",0).attr("clip-path","url(#"+_+")").call(this._tickPosition.bind(this),!0).merge(M).transition(this._transition).attr("opacity",1).call(this._tickPosition.bind(this));var T=o.max(B,function(t){return t.height})||0,R=o.max(B,function(t){return t.width+t.fS})||0,E=P.selectAll("g.d3plus-scaleLegend-title").data([null]);E=E.enter().append("g").attr("class","d3plus-scaleLegend-title").merge(E),(new s.TextBox).data(this._title?[{text:this._title}]:[]).duration(this._duration).height(this._outerBounds.height).rotate("left"===this._orient?-90:"right"===this._orient?90:0).select(E.node()).text(function(t){return t.text}).textAnchor("middle").verticalAlign("bottom"===this._orient?"bottom":"top").width(this._outerBounds[r]).x(["top","bottom"].includes(this._orient)?this._outerBounds.x:"left"===this._orient?this._outerBounds.x+this._titleHeight/2-this._outerBounds[r]/2:this._outerBounds.x+this._outerBounds.width-this._titleHeight/2-this._outerBounds[r]/2).y(["top","bottom"].includes(this._orient)?this._outerBounds.y:this._outerBounds.y-this._titleHeight/2+this._outerBounds[r]/2).config(this._titleConfig).render();var N=P.selectAll("g.d3plus-scaleLegend-ticks").data([null]);return N=N.enter().append("g").attr("class","d3plus-scaleLegend-ticks").merge(N),(new s.TextBox).data(x.filter(function(t,i){return B[i].lines.length}).map(function(t){return{id:t}})).duration(this._duration).height(T).select(N.node()).text(function(t){return y(t.id)}).textAnchor("left"===this._orient?"end":"right"===this._orient?"start":"middle").verticalAlign("bottom"===this._orient?"top":"top"===this._orient?"bottom":"middle").width(R).x(function(t,i){return["top","bottom"].includes(e._orient)?e._d3Scale(t.id)-R/2:"left"===e._orient?e._titleHeight+e._outerBounds.x-e._textBoxConfig.fontSize(x[i],i)/2:e._outerBounds.x+e._tickSize+e._padding}).y(function(t){return["left","right"].includes(e._orient)?e._d3Scale(t.id)-T/2:"bottom"===e._orient?e._outerBounds.y+e._tickSize+u:e._titleHeight+e._outerBounds.y}).config(this._textBoxConfig).render(),this._lastScale=this._d3Scale,this},e.prototype.align=function(t){return arguments.length?(this._align=t,this):this._align},e.prototype.domain=function(t){return arguments.length?(this._domain=t,this):this._domain},e.prototype.orient=function(t){if(arguments.length){var i=["top","bottom"].includes(t);return this._position={width:i?"width":"height",height:i?"height":"width",x:i?"x":"y",y:i?"y":"x"},this._orient=t,this}return this._orient},e.prototype.range=function(t){return arguments.length?(this._range=t,this):this._range},e.prototype.scale=function(t){return arguments.length?(this._scale=t,this):this._scale},e.prototype.textBoxConfig=function(t){return arguments.length?(this._textBoxConfig=Object.assign(this._textBoxConfig,t),this):this._textBoxConfig},e.prototype.tickLabels=function(t){return arguments.length?(this._tickLabels=t,this):this._tickLabels},e.prototype.ticks=function(t){return arguments.length?(this._ticks=t,this):this._ticks},e.prototype.tickSize=function(t){return arguments.length?(this._tickSize=t,this):this._tickSize},e}(l),_=function(t){function e(){var e=this;t.call(this);var n=new a.Shape;this._align="center",this._data=[],this._id=i.accessor("id"),this._label=i.accessor("id"),this._lineData=[],this._orient="horizontal",this._shape=i.constant("Rect"),this._shapeConfig={duration:n.duration(),fill:i.accessor("color"),fontColor:i.constant("#444"),fontFamily:n.fontFamily(),fontSize:i.constant(10),height:i.constant(10),labelBounds:function(t,i,n){var o=e._lineData[t.i],h=void 0!==n.r?n.r:n.width/2;return{width:o.width,height:o.height,x:h+e._padding,y:1-o.height/2}},opacity:1,r:i.constant(5),width:i.constant(10),x:function(t,i){var n=e._shapeConfig.width;return"vertical"===e._orient?e._outerBounds.x+n(t,i)/2:e._outerBounds.x+o.sum(e._data.slice(0,i).map(function(t,i){return n(t,i)}))+o.sum(e._lineData.slice(0,i).map(function(n){return n.width-e._shapeConfig.fontSize(t,i)}))+n(t,i)/2+3*e._padding*i},y:function(t,i){var n=e._shapeConfig.height;if("horizontal"===e._orient)return e._titleHeight+e._outerBounds.y+o.max(e._lineData.map(function(t){return t.height}).concat(e._data.map(function(t,i){return n(t,i)})))/2;var h=n(t,i),s=e._lineData[i].height>h?e._lineData[i].height/2:h/2,r=o.sum(e._lineData.slice(0,i),function(t,i){return o.max([t.height,n(t.data,i)])});return e._titleHeight+e._outerBounds.y+r+s+e._padding*i}},this._verticalAlign="middle"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.render=function(i){var e=this;t.prototype.render.call(this,i),void 0===this._lineHeight&&(this._lineHeight=function(t,i){return 1.1*e._shapeConfig.fontSize(t,i)});var n=this._select.selectAll("g.d3plus-ShapeLegend").data([0]);n=n.enter().append("g").attr("class","d3plus-ShapeLegend").merge(n);var h=this._height;if(this._titleHeight=0,this._title){var l=this._titleConfig.fontFamily,d=this._titleConfig.lineHeight,_=this._titleConfig.fontSize,u=s.textWrap().fontFamily(l).fontSize(_).lineHeight(d).width(this._width).height(this._height)(this._title);this._titleHeight=d+u.lines.length+this._padding,h-=this._titleHeight}this._lineData=this._data.map(function(t,i){var n=e._shapeConfig.fontFamily(t,i),r=e._lineHeight(t,i),a=e._shapeConfig.fontSize(t,i),l="horizontal"===e._orient?h-(e._data.length+1)*e._padding:e._height,d="vertical"===e._orient?e._width-3*e._padding-e._shapeConfig.width(t,i):e._width,_=s.textWrap().fontFamily(n).fontSize(a).lineHeight(r).width(d).height(l)(e._label(t,i));return _.width=Math.ceil(o.max(_.lines.map(function(t){return s.textWidth(t,{"font-family":n,"font-size":a})})))+a,_.height=Math.ceil(_.lines.length*(r+1)),_.og={height:_.height,width:_.width},_.data=t,_.f=n,_.s=a,_.lh=r,_.id=e._id(t,i),_});var c,g,p=!0;if("horizontal"===this._orient){if(c=this._width-o.sum(this._data.map(function(t,i){return e._shapeConfig.width(t,i)+3*e._padding}))-2*this._padding,g=o.sum(this._lineData.map(function(t,i){return t.width-e._shapeConfig.fontSize(t,i)})),g>c){var f=this._lineData.filter(function(t){return t.words.length>1}).sort(function(t,i){return i.sentence.length-t.sentence.length});if(f.length&&h>2*f[0].height)for(var m=2;m<=5;){var y=f.filter(function(t){return t.words.length>=m});if(!y.length)break;for(var x=function(t){var i=f[t],e=i.og.height*m,n=i.og.width*(1.5*(1/m)),h=s.textWrap().fontFamily(i.f).fontSize(i.s).lineHeight(i.lh).width(n).height(e)(i.sentence);if(!h.truncated&&(g-=i.width,i.width=Math.ceil(o.max(h.lines.map(function(t){return s.textWidth(t,{"font-family":i.f,"font-size":i.s})})))+i.s,i.height=h.lines.length*(i.lh+1),g+=i.width,g<=c))return"break"},v=0;v<f.length;v++){var S=x(v);if("break"===S)break}if(g<=c)break;m++}else p=!1}}else c=this._width-o.max(this._data.map(function(t,i){return e._shapeConfig.width(t,i)+3*e._padding}))-2*this._padding,g=o.max(this._lineData.map(function(t,i){return t.width-e._shapeConfig.fontSize(t,i)}));if(g>c&&(p=!1),!p){g=0;for(var w=0;w<this._lineData.length;w++)e._lineData[w].width=0,e._lineData[w].height=0}var B=o.max(this._lineData,function(t,i){return o.max([t.height,e._shapeConfig.height(t.data,i)])})+this._titleHeight,b="horizontal"===this._orient?g+o.sum(this._data,function(t,i){return e._shapeConfig.width(t,i)})+this._padding*(this._data.length*(p?3:1)-2):g+o.max(this._data,function(t,i){return e._shapeConfig.width(t,i)})+3*this._padding;this._outerBounds.width=b,this._outerBounds.height=B;var C=this._padding,k=this._padding;"center"===this._align?C=(this._width-2*this._padding-b)/2:"right"===this._align&&(C=this._width-2*this._padding-b),"middle"===this._verticalAlign?k=(this._height-2*this._padding-B)/2:"bottom"===this._verticalAlign&&(k=this._height-2*this._padding-B),this._outerBounds.x=C,this._outerBounds.y=k,(new s.TextBox).data(this._title?[{text:this._title}]:[]).duration(this._duration).select(n.node()).width(this._width).x(0).y(this._outerBounds.y).config(this._titleConfig).render();var z=this._shapeConfig,H={id:function(t){return t.id},label:function(t){return t.label},lineHeight:function(t){return t.lH}},A=this._data.map(function(t,i){var n={data:t,i:i,id:e._id(t,i),label:p?e._label(t,i):null,lH:e._lineHeight(t,i),shape:e._shape(t,i)},o=function(e){"labelBounds"!==e&&{}.hasOwnProperty.call(z,e)&&"function"==typeof z[e]&&(n[e]=z[e](t,i),H[e]=function(t){return t[e]})};for(var h in z)o(h);return n});return r.nest().key(function(t){return t.shape}).entries(A).forEach(function(t){(new a[t.key]).data(t.values).duration(e._duration).labelPadding(0).select(n.node()).verticalAlign("top").config(z).config(H).render()}),this},e.prototype.align=function(t){return arguments.length?(this._align=t,this):this._align},e.prototype.data=function(t){return arguments.length?(this._data=t,this):this._data},e.prototype.id=function(t){return arguments.length?(this._id=t,this):this._id},e.prototype.label=function(t){return arguments.length?(this._label="function"==typeof t?t:i.constant(t),this):this._label},e.prototype.orient=function(t){return arguments.length?(this._orient=t,this):this._orient},e.prototype.shape=function(t){return arguments.length?(this._shape="function"==typeof t?t:i.constant(t),this):this._shape},e.prototype.shapeConfig=function(t){return arguments.length?(this._shapeConfig=Object.assign(this._shapeConfig,t),this):this._shapeConfig},e.prototype.verticalAlign=function(t){return arguments.length?(this._verticalAlign=t,this):this._verticalAlign},e}(l);t.BaseLegend=l,t.ScaleLegend=d,t.ShapeLegend=_,Object.defineProperty(t,"__esModule",{value:!0})});