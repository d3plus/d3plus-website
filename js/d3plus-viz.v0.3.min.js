/*
  d3plus-viz v0.3.8
  Abstract ES6 class that drives d3plus visualizations.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3-array"),require("d3-color"),require("d3-collection"),require("d3-selection"),require("d3-transition"),require("d3plus-axis"),require("d3plus-color"),require("d3plus-common"),require("d3plus-legend"),require("d3plus-text"),require("d3plus-timeline"),require("d3plus-tooltip")):typeof define==="function"&&define.amd?define("d3plus-viz",["exports","d3-array","d3-color","d3-collection","d3-selection","d3-transition","d3plus-axis","d3plus-color","d3plus-common","d3plus-legend","d3plus-text","d3plus-timeline","d3plus-tooltip"],e):e(t.d3plus=t.d3plus||{},t.d3Array,t.d3Color,t.d3Collection,t.d3Selection,t.d3Transition,t.d3plusAxis,t.d3plusColor,t.d3plusCommon,t.d3plusLegend,t.d3plusText,t.d3plusTimeline,t.d3plusTooltip)})(this,function(t,e,i,n,r,s,o,h,a,l,u,p,d){"use strict";var _=function(t,i,r){if(r===void 0)r=[];if(r&&!(r instanceof Array))r=[r];var s=n.nest().key(i).entries(t);var o,h;if(r.length){var l=s.length;var u=function(i){var u=s.map(function(t){return Array.from(new Set(t.values.map(function(t){return r[i](t)})))}),p=e.sum(u,function(t){return t.length}),d=new Set(e.merge(u)).size;if(p===l&&d===l||i===r.length-1){h=r[i];o=n.nest().key(h).entries(t).map(function(t){return a.merge(t.values)});return"break"}};for(var p=0;p<r.length;p++){var d=u(p);if(d==="break")break}}else{h=i;o=s.map(function(t){return a.merge(t.values)})}return{data:o,id:h}};function g(t,e){if(t.tagName===undefined||["BODY","HTML"].indexOf(t.tagName)>=0){var i=window["inner"+(e.charAt(0).toUpperCase()+e.slice(1))];var n=r.select(t);if(e==="width"){i-=parseFloat(n.style("margin-left"),10);i-=parseFloat(n.style("margin-right"),10);i-=parseFloat(n.style("padding-left"),10);i-=parseFloat(n.style("padding-right"),10)}else{i-=parseFloat(n.style("margin-top"),10);i-=parseFloat(n.style("margin-bottom"),10);i-=parseFloat(n.style("padding-top"),10);i-=parseFloat(n.style("padding-bottom"),10)}return i}else{var s=parseFloat(r.select(t).style(e),10);if(typeof s==="number"&&s>0)return s;else return g(t.parentNode,e)}}var f=function(t){return[g(t,"width"),g(t,"height")]};var c=function(t){function g(){var e=this;t.call(this);this._aggs={};this._backClass=(new u.TextBox).on("click",function(){if(e._history.length)e.config(e._history.pop()).render();else e.depth(e._drawDepth-1).filter(false).render()}).on("mousemove",function(){return e._backClass.select().style("cursor","pointer")});this._data=[];this._duration=600;this._highlightOpacity=.5;this._history=[];this._groupBy=[a.accessor("id")];this._legend=true;this._legendConfig={shapeConfig:{fontResize:false}};this._legendClass=new l.Legend;this._on={click:function(t,i){e._select.style("cursor","auto");if(e._drawDepth<e._groupBy.length-1){var n=e._groupBy[e._drawDepth],r=e._id(t,i);e.highlight(false);if(e._tooltip)e._tooltipClass.data([]).render();e._history.push({depth:e._depth,filter:e._filter});e.config({depth:e._drawDepth+1,filter:function(t,e){return n(t,e)===r}}).render()}},mouseenter:function(t,i){var n=e._id(t,i);e.highlight(function(t,i){var r=e._id(t,i);if(r.constructor===Array&&n.constructor!==Array)return r.includes(n);if(r.constructor!==Array&&n.constructor===Array)return n.includes(r);return r===n});if(e._tooltip){var s=e._drawDepth<e._groupBy.length-1;e._select.style("cursor",s?"pointer":"auto");e._tooltipClass.data([t]).footer(s?"Click to Expand":"").translate(r.mouse(r.select("html").node())).render()}},mousemove:function(){if(e._tooltip){e._tooltipClass.translate(r.mouse(r.select("html").node())).render()}},mouseleave:function(){e.highlight(false);e._select.style("cursor","auto");if(e._tooltip)e._tooltipClass.data([]).render()}};this._padding=5;this._shapes=[];this._shapeConfig={fill:function(t,i){return h.assign(e._id(t,i))},opacity:a.constant(1),stroke:function(t,n){return i.color(h.assign(e._id(t,n))).darker()},strokeWidth:a.constant(0)};this._timeline=true;this._timelineClass=(new p.Timeline).align("end").on("end",function(t){if(!(t instanceof Array))t=[t,t];t=t.map(Number);e._timelineClass.selection(t);e.timeFilter(function(i){var n=o.date(e._time(i)).getTime();return n>=t[0]&&n<=t[1]}).render()});this._timelineConfig={};this._tooltip=true;this._tooltipClass=(new d.Tooltip).pointerEvents("none");this._tooltipConfig={duration:50}}if(t)g.__proto__=t;g.prototype=Object.create(t&&t.prototype);g.prototype.constructor=g;g.prototype._uiGroup=function t(e,i){if(i===void 0)i=true;return a.elem("g.d3plus-viz-"+e,{condition:i,enter:{transform:"translate(0, "+this._height/2+")"},exit:{opacity:0},parent:this._select,transition:this._transition,update:{opacity:1,transform:"translate(0, "+this._height/2+")"}})};g.prototype.render=function t(i){var h=this;this._margin={bottom:0,left:0,right:0,top:0};this._transition=s.transition().duration(this._duration);if(this._select===void 0||this._select.node().tagName.toLowerCase()!=="svg"){var l=this._select===void 0?r.select("body"):this._select;var u=f(l.node());var p=u[0];var d=u[1];if(!this._width)this.width(p);if(!this._height)this.height(d);p=this._width;d=this._height;this.select(l.append("svg").style("width",p+"px").style("height",d+"px").style("display","block").node())}if(!this._width||!this._height){var g=f(this._select.node());var c=g[0];var y=g[1];if(!this._width)this.width(c);if(!this._height)this.height(y)}var m=this;this._drawDepth=this._depth!==void 0?this._depth:this._groupBy.length-1;this._id=this._groupBy[this._drawDepth];this._drawLabel=this._label||function(t,e){var i=m._id(t,e);if(i.constructor!==Array)return i;for(var n=m._drawDepth;n>=0;n--){i=m._groupBy[n](t,e);if(i.constructor!==Array)break}return i};this._legendData=[];this._filteredData=[];if(this._data.length){var v=this._timeFilter?this._data.filter(this._timeFilter):this._data;if(this._filter)v=v.filter(this._filter);var C=n.nest();for(var w=0;w<=this._drawDepth;w++)C.key(h._groupBy[w]);C.rollup(function(t){return h._legendData.push(a.merge(t,h._aggs))}).entries(v);if(this._discrete&&"_"+this._discrete in this)C.key(this["_"+this._discrete]);C.rollup(function(t){return h._filteredData.push(a.merge(t,h._aggs))}).entries(v)}var b=this._time&&this._timeline;var k=b?Array.from(new Set(this._data.map(this._time))).map(o.date):[];b=b&&k.length>1;var x=this._uiGroup("timeline",b);if(b){var A=this._timelineClass.domain(e.extent(k)).duration(this._duration).height(this._height/2-this._margin.bottom).select(x.node()).ticks(k).width(this._width);if(A.selection()===void 0){var B=e.extent(Array.from(new Set(e.merge(this._filteredData.map(function(t){var e=h._time(t);return e instanceof Array?e:[e]})))).map(o.date));if(B.length===1)B=B[0];A.selection(B)}A.config(this._timelineConfig).render();this._margin.bottom+=A.outerBounds().height+A.padding()*2}var D=this._uiGroup("legend",this._legend);if(this._legend){var F=_(this._legendData,this._shapeConfig.fill,this._groupBy);this._legendClass.id(F.id).duration(this._duration).data(F.data.length>1?F.data:[]).height(this._height/2-this._margin.bottom).label(this._label||F.id).select(D.node()).verticalAlign("bottom").width(this._width).shapeConfig(this._shapeConfig).shapeConfig({on:Object.keys(this._on).filter(function(t){return!t.includes(".")||t.includes(".legend")}).reduce(function(t,e){t[e]=h._on[e];return t},{})}).config(this._legendConfig).render();var O=this._legendClass.outerBounds();if(O.height)this._margin.bottom+=O.height+this._legendClass.padding()*2}var q=a.elem("g.d3plus-viz-titles",{parent:this._select});this._backClass.data(this._history.length?[{text:"Back",x:this._padding*2,y:0}]:[]).select(q.node()).render();this._margin.top+=this._history.length?this._backClass.fontSize()()+this._padding:0;this._tooltipClass.title(this._drawLabel).config(this._tooltipConfig);if(i)setTimeout(i,this._duration+100);return this};g.prototype.aggs=function t(e){return arguments.length?(this._aggs=Object.assign(this._aggs,e),this):this._aggs};g.prototype.data=function t(e){return arguments.length?(this._data=e,this):this._data};g.prototype.depth=function t(e){return arguments.length?(this._depth=e,this):this._depth};g.prototype.discrete=function t(e){return arguments.length?(this._discrete=e,this):this._discrete};g.prototype.duration=function t(e){return arguments.length?(this._duration=e,this):this._duration};g.prototype.filter=function t(e){return arguments.length?(this._filter=e,this):this._filter};g.prototype.groupBy=function t(e){var i=this;if(!arguments.length)return this._groupBy;if(!(e instanceof Array))e=[e];return this._groupBy=e.map(function(t){if(typeof t==="function")return t;else{if(!i._aggs[t]){i._aggs[t]=function(t){var e=Array.from(new Set(t));return e.length===1?e[0]:e}}return a.accessor(t)}}),this};g.prototype.height=function t(e){return arguments.length?(this._height=e,this):this._height};g.prototype.highlight=function t(e){var i=e?Array.from(new Set(this._data.filter(e).map(this._id))).map(u.strip):[],n=this;var r=this._select.select(".d3plus-viz-legend");this._shapes.forEach(function(t){return r=r.merge(t.select())});r.selectAll(".d3plus-Shape").style(a.prefix()+"transition","opacity "+this._tooltipClass.duration()/1e3+"s").style("opacity",function(){var t=this.className.baseVal.split(" ").filter(function(t){return t.indexOf("d3plus-id-")===0})[0].slice(10);return i.length===0||i.includes(t)?1:n._highlightOpacity});return this};g.prototype.highlightOpacity=function t(e){return arguments.length?(this._highlightOpacity=e,this):this._highlightOpacity};g.prototype.label=function t(e){return arguments.length?(this._label=typeof e==="function"?e:a.constant(e),this):this._label};g.prototype.legend=function t(e){return arguments.length?(this._legend=e,this):this._legend};g.prototype.legendConfig=function t(e){return arguments.length?(this._legendConfig=e,this):this._legendConfig};g.prototype.select=function t(e){return arguments.length?(this._select=r.select(e),this):this._select};g.prototype.shape=function t(e){return arguments.length?(this._shape=typeof e==="function"?e:a.constant(e),this):this._shape};g.prototype.shapeConfig=function t(e){return arguments.length?(this._shapeConfig=Object.assign(this._shapeConfig,e),this):this._shapeConfig};g.prototype.time=function t(e){if(arguments.length){if(typeof e==="function"){this._time=e}else{this._time=a.accessor(e);if(!this._aggs[e]){this._aggs[e]=function(t){var e=Array.from(new Set(t));return e.length===1?e[0]:e}}}return this}else return this._time};g.prototype.timeFilter=function t(e){return arguments.length?(this._timeFilter=e,this):this._timeFilter};g.prototype.timeline=function t(e){return arguments.length?(this._timeline=e,this):this._timeline};g.prototype.timelineConfig=function t(e){return arguments.length?(this._timelineConfig=Object.assign(this._timelineConfig,e),this):this._timelineConfig};g.prototype.tooltip=function t(e){return arguments.length?(this._tooltip=e,this):this._tooltip};g.prototype.tooltipConfig=function t(e){return arguments.length?(this._tooltipConfig=Object.assign(this._tooltipConfig,e),this):this._tooltipConfig};g.prototype.width=function t(e){return arguments.length?(this._width=e,this):this._width};return g}(a.BaseClass);t.Viz=c;Object.defineProperty(t,"__esModule",{value:true})});