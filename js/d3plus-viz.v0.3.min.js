/*
  d3plus-viz v0.3.6
  Abstract ES6 class that drives d3plus visualizations.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-array"),require("d3-color"),require("d3-collection"),require("d3-selection"),require("d3-transition"),require("d3plus-axis"),require("d3plus-color"),require("d3plus-common"),require("d3plus-legend"),require("d3plus-text"),require("d3plus-timeline"),require("d3plus-tooltip")):"function"==typeof define&&define.amd?define("d3plus-viz",["exports","d3-array","d3-color","d3-collection","d3-selection","d3-transition","d3plus-axis","d3plus-color","d3plus-common","d3plus-legend","d3plus-text","d3plus-timeline","d3plus-tooltip"],e):e(t.d3plus=t.d3plus||{},t.d3Array,t.d3Color,t.d3Collection,t.d3Selection,t.d3Transition,t.d3plusAxis,t.d3plusColor,t.d3plusCommon,t.d3plusLegend,t.d3plusText,t.d3plusTimeline,t.d3plusTooltip)}(this,function(t,e,i,n,s,r,o,h,a,l,u,d,p){"use strict";function _(t,e){if(void 0===t.tagName||["BODY","HTML"].indexOf(t.tagName)>=0){var i=window["inner"+(e.charAt(0).toUpperCase()+e.slice(1))],n=s.select(t);return"width"===e?(i-=parseFloat(n.style("margin-left"),10),i-=parseFloat(n.style("margin-right"),10),i-=parseFloat(n.style("padding-left"),10),i-=parseFloat(n.style("padding-right"),10)):(i-=parseFloat(n.style("margin-top"),10),i-=parseFloat(n.style("margin-bottom"),10),i-=parseFloat(n.style("padding-top"),10),i-=parseFloat(n.style("padding-bottom"),10)),i}var r=parseFloat(s.select(t).style(e),10);return"number"==typeof r&&r>0?r:_(t.parentNode,e)}var g=function(t,i,s){void 0===s&&(s=[]),!s||s instanceof Array||(s=[s]);var r,o,h=n.nest().key(i).entries(t);if(s.length)for(var l=h.length,u=function(i){var u=h.map(function(t){return Array.from(new Set(t.values.map(function(t){return s[i](t)})))}),d=e.sum(u,function(t){return t.length}),p=new Set(e.merge(u)).size;if(d===l&&p===l||i===s.length-1)return o=s[i],r=n.nest().key(o).entries(t).map(function(t){return a.merge(t.values)}),"break"},d=0;d<s.length;d++){var p=u(d);if("break"===p)break}else o=i,r=h.map(function(t){return a.merge(t.values)});return{data:r,id:o}},c=function(t){return[_(t,"width"),_(t,"height")]},f=function(t){function _(){var e=this;t.call(this),this._aggs={},this._backClass=(new u.TextBox).on("click",function(){e._history.length?e.config(e._history.pop()).render():e.depth(e._drawDepth-1).filter(!1).render()}).on("mousemove",function(){return e._backClass.select().style("cursor","pointer")}),this._data=[],this._duration=600,this._history=[],this._groupBy=[a.accessor("id")],this._legend=!0,this._legendConfig={shapeConfig:{fontResize:!1}},this._legendClass=new l.Legend,this._on={click:function(t,i){if(e._select.style("cursor","auto"),e._drawDepth<e._groupBy.length-1){var n=e._groupBy[e._drawDepth],s=e._id(t,i);e.highlight(!1),e._tooltip&&e._tooltipClass.data([]).render(),e._history.push({depth:e._depth,filter:e._filter}),e.config({depth:e._drawDepth+1,filter:function(t,e){return n(t,e)===s}}).render()}},mouseenter:function(t,i){var n=e._id(t,i);if(e.highlight(function(t,i){var s=e._id(t,i);return s.constructor===Array&&n.constructor!==Array?s.includes(n):s.constructor!==Array&&n.constructor===Array?n.includes(s):s===n}),e._tooltip){var r=e._drawDepth<e._groupBy.length-1;e._select.style("cursor",r?"pointer":"auto"),e._tooltipClass.data([t]).footer(r?"Click to Expand":"").translate(s.mouse(s.select("html").node())).render()}},mousemove:function(){e._tooltip&&e._tooltipClass.translate(s.mouse(s.select("html").node())).render()},mouseleave:function(){e.highlight(!1),e._select.style("cursor","auto"),e._tooltip&&e._tooltipClass.data([]).render()}},this._padding=5,this._shapes=[],this._shapeConfig={fill:function(t,i){return h.assign(e._id(t,i))},opacity:a.constant(1),stroke:function(t,n){return i.color(h.assign(e._id(t,n))).darker()},strokeWidth:a.constant(0)},this._timeline=!0,this._timelineClass=(new d.Timeline).align("end").on("end",function(t){t instanceof Array||(t=[t,t]),t=t.map(Number),e._timelineClass.selection(t),e.timeFilter(function(i){var n=o.date(e._time(i)).getTime();return n>=t[0]&&n<=t[1]}).render()}),this._timelineConfig={},this._tooltip=!0,this._tooltipClass=(new p.Tooltip).pointerEvents("none"),this._tooltipConfig={duration:50}}return t&&(_.__proto__=t),_.prototype=Object.create(t&&t.prototype),_.prototype.constructor=_,_.prototype._uiGroup=function(t,e){return void 0===e&&(e=!0),a.elem("g.d3plus-plot-"+t,{condition:e,enter:{transform:"translate(0, "+this._height/2+")"},exit:{opacity:0},parent:this._select,transition:this._transition,update:{opacity:1,transform:"translate(0, "+this._height/2+")"}})},_.prototype.render=function(t){var i=this;if(this._margin={bottom:0,left:0,right:0,top:0},this._transition=r.transition().duration(this._duration),void 0===this._select||"svg"!==this._select.node().tagName.toLowerCase()){var h=void 0===this._select?s.select("body"):this._select,l=c(h.node()),u=l[0],d=l[1];this._width||this.width(u),this._height||this.height(d),u=this._width,d=this._height,this.select(h.append("svg").style("width",u+"px").style("height",d+"px").style("display","block").node())}if(!this._width||!this._height){var p=c(this._select.node()),_=p[0],f=p[1];this._width||this.width(_),this._height||this.height(f)}var m=this;if(this._drawDepth=void 0!==this._depth?this._depth:this._groupBy.length-1,this._id=this._groupBy[this._drawDepth],this._drawLabel=this._label||function(t,e){var i=m._id(t,e);if(i.constructor!==Array)return i;for(var n=m._drawDepth;n>=0&&(i=m._groupBy[n](t,e),i.constructor===Array);n--);return i},this._legendData=[],this._filteredData=[],this._data.length){var y=this._timeFilter?this._data.filter(this._timeFilter):this._data;this._filter&&(y=y.filter(this._filter));for(var v=n.nest(),C=0;C<=this._drawDepth;C++)v.key(i._groupBy[C]);v.rollup(function(t){return i._legendData.push(a.merge(t,i._aggs))}).entries(y),this._discrete&&"_"+this._discrete in this&&v.key(this["_"+this._discrete]),v.rollup(function(t){return i._filteredData.push(a.merge(t,i._aggs))}).entries(y)}var w=this._time&&this._timeline,b=w?Array.from(new Set(this._data.map(this._time))).map(o.date):[];w=w&&b.length>1;var x=this._uiGroup("timeline",w);if(w){var k=this._timelineClass.domain(e.extent(b)).duration(this._duration).height(this._height/2-this._margin.bottom).select(x.node()).ticks(b).width(this._width);if(void 0===k.selection()){var A=e.extent(Array.from(new Set(e.merge(this._filteredData.map(function(t){var e=i._time(t);return e instanceof Array?e:[e]})))).map(o.date));1===A.length&&(A=A[0]),k.selection(A)}k.config(this._timelineConfig).render(),this._margin.bottom+=k.outerBounds().height+2*k.padding()}var B=this._uiGroup("legend",this._legend);if(this._legend){var D=g(this._legendData,this._shapeConfig.fill,this._groupBy);this._legendClass.id(function(t,e){return D.id(t,e)}).duration(this._duration).data(D.data.length>1?D.data:[]).height(this._height/2-this._margin.bottom).label(this._drawLabel).select(B.node()).verticalAlign("bottom").width(this._width).shapeConfig(this._shapeConfig).shapeConfig({on:Object.keys(this._on).filter(function(t){return!t.includes(".")||t.includes(".legend")}).reduce(function(t,e){return t[e]=i._on[e],t},{})}).config(this._legendConfig).render();var F=this._legendClass.outerBounds();F.height&&(this._margin.bottom+=F.height+2*this._legendClass.padding())}var q=a.elem("g.d3plus-plot-titles",{parent:this._select});return this._backClass.data(this._history.length?[{text:"Back",x:2*this._padding,y:0}]:[]).select(q.node()).render(),this._margin.top+=this._history.length?this._backClass.fontSize()()+this._padding:0,this._tooltipClass.title(this._drawLabel).config(this._tooltipConfig),t&&setTimeout(t,this._duration+100),this},_.prototype.aggs=function(t){return arguments.length?(this._aggs=Object.assign(this._aggs,t),this):this._aggs},_.prototype.data=function(t){return arguments.length?(this._data=t,this):this._data},_.prototype.depth=function(t){return arguments.length?(this._depth=t,this):this._depth},_.prototype.discrete=function(t){return arguments.length?(this._discrete=t,this):this._discrete},_.prototype.duration=function(t){return arguments.length?(this._duration=t,this):this._duration},_.prototype.filter=function(t){return arguments.length?(this._filter=t,this):this._filter},_.prototype.groupBy=function(t){var e=this;return arguments.length?(t instanceof Array||(t=[t]),this._groupBy=t.map(function(t){return"function"==typeof t?t:(e._aggs[t]||(e._aggs[t]=function(t){var e=Array.from(new Set(t));return 1===e.length?e[0]:e}),a.accessor(t))}),this):this._groupBy},_.prototype.height=function(t){return arguments.length?(this._height=t,this):this._height},_.prototype.highlight=function(t){var e=t?Array.from(new Set(this._data.filter(t).map(this._id))).map(u.strip):[];return this._select.selectAll(".d3plus-Shape").style(a.prefix()+"transition","opacity "+this._tooltipClass.duration()/1e3+"s").style("opacity",function(){var t=this.className.baseVal.split(" ").filter(function(t){return 0===t.indexOf("d3plus-id-")})[0].slice(10);return 0===e.length||e.includes(t)?1:.25}),this},_.prototype.label=function(t){return arguments.length?(this._label="function"==typeof t?t:a.constant(t),this):this._label},_.prototype.legend=function(t){return arguments.length?(this._legend=t,this):this._legend},_.prototype.legendConfig=function(t){return arguments.length?(this._legendConfig=t,this):this._legendConfig},_.prototype.select=function(t){return arguments.length?(this._select=s.select(t),this):this._select},_.prototype.shape=function(t){return arguments.length?(this._shape="function"==typeof t?t:a.constant(t),this):this._shape},_.prototype.shapeConfig=function(t){return arguments.length?(this._shapeConfig=Object.assign(this._shapeConfig,t),this):this._shapeConfig},_.prototype.time=function(t){return arguments.length?("function"==typeof t?this._time=t:(this._time=a.accessor(t),this._aggs[t]||(this._aggs[t]=function(t){var e=Array.from(new Set(t));return 1===e.length?e[0]:e})),this):this._time},_.prototype.timeFilter=function(t){return arguments.length?(this._timeFilter=t,this):this._timeFilter},_.prototype.timeline=function(t){return arguments.length?(this._timeline=t,this):this._timeline},_.prototype.timelineConfig=function(t){return arguments.length?(this._timelineConfig=Object.assign(this._timelineConfig,t),this):this._timelineConfig},_.prototype.tooltip=function(t){return arguments.length?(this._tooltip=t,this):this._tooltip},_.prototype.tooltipConfig=function(t){return arguments.length?(this._tooltipConfig=Object.assign(this._tooltipConfig,t),this):this._tooltipConfig},_.prototype.width=function(t){return arguments.length?(this._width=t,this):this._width},_}(a.BaseClass);t.Viz=f,Object.defineProperty(t,"__esModule",{value:!0})});