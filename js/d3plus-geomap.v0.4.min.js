/*
  d3plus-geomap v0.4.9
  A reusable geo map built on D3 and Topojson
  Copyright (c) 2017 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3-array"),require("d3-color"),require("d3-geo"),require("d3-scale"),require("d3-selection"),require("d3-tile"),require("d3-zoom"),require("topojson-client"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-viz")):typeof define==="function"&&define.amd?define("d3plus-geomap",["exports","d3-array","d3-color","d3-geo","d3-scale","d3-selection","d3-tile","d3-zoom","topojson-client","d3plus-common","d3plus-shape","d3plus-viz"],e):e(t.d3plus=t.d3plus||{},t.d3Array,t.d3Color,t.d3Geo,t.scales,t.d3Selection,t.d3Tile,t.d3Zoom,t.topojsonClient,t.d3plusCommon,t.d3plusShape,t.d3plusViz)})(this,function(t,e,o,i,r,n,s,a,p,u,l,h){"use strict";var c=function(t){function c(){var e=this;t.call(this);this._fitObject=false;this._ocean="#cdd1d3";this._padding=20;this._point=u.accessor("point");this._pointSize=u.constant(1);this._pointSizeMax=10;this._pointSizeMin=5;this._pointSizeScale="linear";this._projection=i.geoMercator();this._rotate=[0,0];this._shape=u.constant("Circle");this._shapeConfig=u.assign(this._shapeConfig,{Path:{fill:function(t){if(e._colorScale&&!e._coordData.features.includes(t)){var o=e._colorScale(t);console.log(t,o,e._colorScaleClass._colorScale.range());if(o!==undefined&&o!==null){return e._colorScaleClass._colorScale(o)}}return"#f5f5f3"},on:{mouseenter:function(t){return!e._coordData.features.includes(t)?e._on.mouseenter.bind(e)(t):null},"mousemove.shape":function(t){return!e._coordData.features.includes(t)?e._on["mousemove.shape"].bind(e)(t):null},mouseleave:function(t){return!e._coordData.features.includes(t)?e._on.mouseleave.bind(e)(t):null}},stroke:function(t,i){return o.color(e._shapeConfig.Path.fill(t,i)).darker()},strokeWidth:1}});this._tiles=true;this._tileGen=s.tile().wrap(false);this._tileUrl="https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png";this._topojson=false;this._topojsonFilter=function(t){return!["010"].includes(t.id)};this._topojsonId=u.accessor("id");this._zoom=true;this._zoomBehavior=a.zoom();this._zoomBrush=false;this._zoomPan=true;this._zoomScroll=true;this._zoomSet=false}if(t)c.__proto__=t;c.prototype=Object.create(t&&t.prototype);c.prototype.constructor=c;c.prototype._renderTiles=function t(){var e=this;var o=2*Math.PI,i=a.zoomTransform(this._geomapGroup.node());var r=[];if(this._tiles){r=this._tileGen.extent(this._zoomBehavior.translateExtent()).scale(this._projection.scale()*o*i.k).translate(i.apply(this._projection.translate()))();this._tileGroup.attr("transform","scale("+r.scale+")translate("+r.translate+")")}var n=this._tileGroup.selectAll("image.tile").data(r,function(t){return t.x+"-"+t.y+"-"+t.z});n.exit().remove();n.enter().append("image").attr("class","tile").attr("xlink:href",function(t){return e._tileUrl.replace("{s}",["a","b","c"][Math.random()*3|0]).replace("{z}",t.z).replace("{x}",t.x).replace("{y}",t.y)}).attr("width",1).attr("height",1).attr("x",function(t){return t.x}).attr("y",function(t){return t.y})};c.prototype._zoomed=function t(){this._zoomGroup.attr("transform",n.event.transform);this._renderTiles()};c.prototype._zoomEvents=function t(){if(this._zoomBrush){this._geomapGroup.on(".zoom",null)}else if(this._zoom){this._geomapGroup.call(this._zoomBehavior);if(!this._zoomScroll){this._geomapGroup.on("mousewheel.zoom",null).on("MozMousePixelScroll.zoom",null).on("wheel.zoom",null)}if(!this._zoomPan){this._geomapGroup.on("mousedown.zoom",null).on("mousemove.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null)}}else{this._geomapGroup.on(".zoom",null)}};c.prototype._draw=function o(n){var s=this;t.prototype._draw.call(this,n);var a=this._height-this._margin.top-this._margin.bottom,h=this._width-this._margin.left-this._margin.right;this._geomapGroup=this._select.selectAll("svg.d3plus-geomap-geomapGroup").data([0]);this._geomapGroup=this._geomapGroup.enter().append("svg").attr("class","d3plus-geomap-geomapGroup").attr("opacity",0).attr("width",h).attr("height",a).attr("x",this._margin.left).attr("y",this._margin.top).style("background-color",this._ocean||"transparent").merge(this._geomapGroup);this._geomapGroup.transition(this._transition).attr("opacity",1).attr("width",h).attr("height",a).attr("x",this._margin.left).attr("y",this._margin.top);var c=this._geomapGroup.selectAll("rect.d3plus-geomap-ocean").data([0]);c.enter().append("rect").attr("class","d3plus-geomap-ocean").merge(c).attr("width",h).attr("height",a).attr("fill",this._ocean||"transparent");this._tileGroup=this._geomapGroup.selectAll("g.d3plus-geomap-tileGroup").data([0]);this._tileGroup=this._tileGroup.enter().append("g").attr("class","d3plus-geomap-tileGroup").merge(this._tileGroup);this._zoomGroup=this._geomapGroup.selectAll("g.d3plus-geomap-zoomGroup").data([0]);this._zoomGroup=this._zoomGroup.enter().append("g").attr("class","d3plus-geomap-zoomGroup").merge(this._zoomGroup);var f=this._zoomGroup.selectAll("g.d3plus-geomap-paths").data([0]);f=f.enter().append("g").attr("class","d3plus-geomap-paths").merge(f);function _(t,e){var o=e&&t.objects[e]?e:Object.keys(t.objects)[0];return p.feature(t,t.objects[o])}var d=this._coordData=this._topojson?_(this._topojson,this._topojsonKey):{type:"FeatureCollection",features:[]};if(this._topojsonFilter){d.features=d.features.filter(this._topojsonFilter)}var m=this._path=i.geoPath().projection(this._projection);var g=this._filteredData.filter(function(t,e){return s._point(t,e)instanceof Array});var y=this._filteredData.filter(function(t,e){return!(s._point(t,e)instanceof Array)}).reduce(function(t,e){t[s._id(e)]=e;return t},{});var z=d.features.reduce(function(t,e){var o=s._topojsonId(e);t.push({__d3plus__:true,data:y[o],feature:e,id:o});return t},[]);var v=r["scale"+this._pointSizeScale.charAt(0).toUpperCase()+this._pointSizeScale.slice(1)]().domain(e.extent(g,function(t,e){return s._pointSize(t,e)})).range([this._pointSizeMin,this._pointSizeMax]);if(!this._zoomSet){var j=this._fitObject?_(this._fitObject,this._fitKey):d;var S={type:"FeatureCollection",features:this._fitFilter?j.features.filter(this._fitFilter):j.features.slice()};S.features=S.features.reduce(function(t,o){var i={type:o.type,id:o.id,geometry:{coordinates:o.geometry.coordinates,type:o.geometry.type}};if(o.geometry.coordinates.length>1){var r=[],n=[];o.geometry.coordinates.forEach(function(t){i.geometry.coordinates=[t];r.push(m.area(i))});i.geometry.coordinates=[o.geometry.coordinates[r.indexOf(e.max(r))]];var s=m.centroid(i);o.geometry.coordinates.forEach(function(t){i.geometry.coordinates=[t];n.push(l.pointDistance(m.centroid(i),s))});var a=e.quantile(r.reduce(function(t,e,o){if(e){t.push(r[o]/e)}return t},[]),.9);i.geometry.coordinates=o.geometry.coordinates.filter(function(t,e){var o=n[e];return o===0||r[e]/o>=a})}t.push(i);return t},[]);var G=this._padding;if(typeof G==="string"){G=G.match(/([-\d\.]+)/g).map(Number);if(G.length===3){G.push(G[1])}if(G.length===2){G=G.concat(G)}if(G.length===1){G=Array(4).fill(G)}}else{G=Array(4).fill(G)}if(!S.features.length&&g.length){var x=[[undefined,undefined],[undefined,undefined]];g.forEach(function(t,e){var o=s._projection(s._point(t,e));if(x[0][0]===void 0||o[0]<x[0][0]){x[0][0]=o[0]}if(x[1][0]===void 0||o[0]>x[1][0]){x[1][0]=o[0]}if(x[0][1]===void 0||o[1]<x[0][1]){x[0][1]=o[1]}if(x[1][1]===void 0||o[1]>x[1][1]){x[1][1]=o[1]}});S={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"MultiPoint",coordinates:x.map(function(t){return s._projection.invert(t)})}}]};var b=e.max(g,function(t,e){return v(s._pointSize(t,e))});G=G.map(function(t){return t+b})}this._projection=this._projection.fitExtent(S.features.length?[[G[3],G[0]],[h-G[1]*2,a-G[2]*2]]:[[0,0],[h,a]],S.features.length?S:{type:"Sphere"});this._zoomBehavior.extent([[0,0],[h,a]]).scaleExtent([1,16]).translateExtent([[0,0],[h,a]]).on("zoom",this._zoomed.bind(this));this._zoomSet=true}this._shapes.push((new l.Path).data(z).d(function(t){return m(t.feature)}).select(f.node()).x(0).y(0).config(u.configPrep.bind(this)(this._shapeConfig,"shape","Path")).render());var C=this._zoomGroup.selectAll("g.d3plus-geomap-pins").data([0]);C=C.enter().append("g").attr("class","d3plus-geomap-pins").merge(C);var F=(new l.Circle).config(u.configPrep.bind(this)(this._shapeConfig,"shape","Circle")).data(g).r(function(t,e){return v(s._pointSize(t,e))}).select(C.node()).sort(function(t,e){return s._pointSize(e)-s._pointSize(t)}).x(function(t,e){return s._projection(s._point(t,e))[0]}).y(function(t,e){return s._projection(s._point(t,e))[1]});var M=Object.keys(this._on);var A=M.filter(function(t){return t.includes(".Circle")}),q=M.filter(function(t){return!t.includes(".")}),w=M.filter(function(t){return t.includes(".shape")});for(var P=0;P<q.length;P++){F.on(q[P],s._on[q[P]])}for(var O=0;O<w.length;O++){F.on(w[O],s._on[w[O]])}for(var E=0;E<A.length;E++){F.on(A[E],s._on[A[E]])}this._shapes.push(F.render());this._zoomEvents();this._renderTiles();return this};c.prototype.fitFilter=function t(e){if(arguments.length){if(typeof e==="function"){return this._fitFilter=e,this}if(!(e instanceof Array)){e=[e]}return this._fitFilter=function(t){return e.includes(t.id)},this}return this._fitFilter};c.prototype.fitKey=function t(e){return arguments.length?(this._fitKey=e,this):this._fitKey};c.prototype.fitObject=function t(e,o){return arguments.length?(this._queue.push([h.dataLoad.bind(this),e,o,"fitObject"]),this):this._fitObject};c.prototype.ocean=function t(e){return arguments.length?(this._ocean=e,this):this._ocean};c.prototype.padding=function t(e){return arguments.length?(this._padding=e,this):this._padding};c.prototype.point=function t(e){return arguments.length?(this._point=typeof e==="function"?e:u.constant(e),this):this._point};c.prototype.pointSize=function t(e){return arguments.length?(this._pointSize=typeof e==="function"?e:u.constant(e),this):this._pointSize};c.prototype.pointSizeMax=function t(e){return arguments.length?(this._pointSizeMax=e,this):this._pointSizeMax};c.prototype.pointSizeMin=function t(e){return arguments.length?(this._pointSizeMin=e,this):this._pointSizeMin};c.prototype.tiles=function t(e){return arguments.length?(this._tiles=e,this):this._tiles};c.prototype.topojson=function t(e,o){return arguments.length?(this._queue.push([h.dataLoad.bind(this),e,o,"topojson"]),this):this._topojson};c.prototype.topojsonFilter=function t(e){if(arguments.length){if(typeof e==="function"){return this._topojsonFilter=e,this}if(!(e instanceof Array)){e=[e]}return this._topojsonFilter=function(t){return e.includes(t.id)},this}return this._topojsonFilter};c.prototype.topojsonKey=function t(e){return arguments.length?(this._topojsonKey=e,this):this._topojsonKey};c.prototype.topojsonId=function t(e){return arguments.length?(this._topojsonId=typeof e==="function"?e:u.accessor(e),this,this):this._topojsonId};c.prototype.zoom=function t(e){return arguments.length?(this._zoom=e,this):this._zoom};return c}(h.Viz);t.Geomap=c;Object.defineProperty(t,"__esModule",{value:true})});