/*
  d3plus-geomap v0.4.3
  A reusable geo map built on D3 and Topojson
  Copyright (c) 2017 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3-array"),require("d3-color"),require("d3-geo"),require("d3-scale"),require("d3-selection"),require("d3-tile"),require("d3-zoom"),require("topojson-client"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-viz")):typeof define==="function"&&define.amd?define("d3plus-geomap",["exports","d3-array","d3-color","d3-geo","d3-scale","d3-selection","d3-tile","d3-zoom","topojson-client","d3plus-common","d3plus-shape","d3plus-viz"],e):e(t.d3plus=t.d3plus||{},t.d3Array,t.d3Color,t.d3Geo,t.scales,t.d3Selection,t.d3Tile,t.d3Zoom,t.topojsonClient,t.d3plusCommon,t.d3plusShape,t.d3plusViz)})(this,function(t,e,o,i,n,r,s,a,p,u,l,h){"use strict";var c=function(t){function c(){var e=this;t.call(this);this._fitObject=false;this._ocean="#cdd1d3";this._padding=20;this._point=u.accessor("point");this._pointSize=u.constant(1);this._pointSizeMax=10;this._pointSizeMin=5;this._pointSizeScale="linear";this._projection=i.geoMercator();this._rotate=[0,0];this._shape=u.constant("Circle");this._shapeConfig=u.assign(this._shapeConfig,{Path:{fill:function(t){if(t.data&&e._colorScale){var o=e._colorScale(t.data);if(o!==undefined&&o!==null){return e._colorScaleClass._colorScale(o)}}return"#f5f5f3"},on:{mouseenter:function(t){return t.data?e._on.mouseenter.bind(e)(t):null},mousemove:function(t){return t.data?e._on["mousemove.shape"].bind(e)(t):null},mouseleave:function(t){return t.data?e._on.mouseleave.bind(e)(t):null}},stroke:function(t,i){return o.color(e._shapeConfig.Path.fill(t,i)).darker()},strokeWidth:1}});this._tiles=true;this._tileGen=s.tile().wrap(false);this._tileUrl="https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png";this._topojson=false;this._topojsonFilter=function(t){return!["010"].includes(t.id)};this._topojsonId=u.accessor("id");this._zoom=true;this._zoomBehavior=a.zoom();this._zoomBrush=false;this._zoomPan=true;this._zoomScroll=true;this._zoomSet=false}if(t)c.__proto__=t;c.prototype=Object.create(t&&t.prototype);c.prototype.constructor=c;c.prototype._renderTiles=function t(){var e=this;var o=2*Math.PI,i=a.zoomTransform(this._geomapGroup.node());var n=[];if(this._tiles){n=this._tileGen.extent(this._zoomBehavior.translateExtent()).scale(this._projection.scale()*o*i.k).translate(i.apply(this._projection.translate()))();this._tileGroup.attr("transform","scale("+n.scale+")translate("+n.translate+")")}var r=this._tileGroup.selectAll("image.tile").data(n,function(t){return t.x+"-"+t.y+"-"+t.z});r.exit().remove();r.enter().append("image").attr("class","tile").attr("xlink:href",function(t){return e._tileUrl.replace("{s}",["a","b","c"][Math.random()*3|0]).replace("{z}",t.z).replace("{x}",t.x).replace("{y}",t.y)}).attr("width",1).attr("height",1).attr("x",function(t){return t.x}).attr("y",function(t){return t.y})};c.prototype._zoomed=function t(){this._zoomGroup.attr("transform",r.event.transform);this._renderTiles()};c.prototype._zoomEvents=function t(){if(this._zoomBrush){this._geomapGroup.on(".zoom",null)}else if(this._zoom){this._geomapGroup.call(this._zoomBehavior);if(!this._zoomScroll){this._geomapGroup.on("mousewheel.zoom",null).on("MozMousePixelScroll.zoom",null).on("wheel.zoom",null)}if(!this._zoomPan){this._geomapGroup.on("mousedown.zoom",null).on("mousemove.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null)}}else{this._geomapGroup.on(".zoom",null)}};c.prototype._draw=function o(r){var s=this;t.prototype._draw.call(this,r);var a=this._height-this._margin.top-this._margin.bottom,u=this._width-this._margin.left-this._margin.right;this._geomapGroup=this._select.selectAll("svg.d3plus-geomap-geomapGroup").data([0]);this._geomapGroup=this._geomapGroup.enter().append("svg").attr("class","d3plus-geomap-geomapGroup").attr("opacity",0).attr("width",u).attr("height",a).attr("x",this._margin.left).attr("y",this._margin.top).style("background-color",this._ocean||"transparent").merge(this._geomapGroup);this._geomapGroup.transition(this._transition).attr("opacity",1).attr("width",u).attr("height",a).attr("x",this._margin.left).attr("y",this._margin.top);var h=this._geomapGroup.selectAll("rect.d3plus-geomap-ocean").data([0]);h.enter().append("rect").attr("class","d3plus-geomap-ocean").merge(h).attr("width",u).attr("height",a).attr("fill",this._ocean||"transparent");this._tileGroup=this._geomapGroup.selectAll("g.d3plus-geomap-tileGroup").data([0]);this._tileGroup=this._tileGroup.enter().append("g").attr("class","d3plus-geomap-tileGroup").merge(this._tileGroup);this._zoomGroup=this._geomapGroup.selectAll("g.d3plus-geomap-zoomGroup").data([0]);this._zoomGroup=this._zoomGroup.enter().append("g").attr("class","d3plus-geomap-zoomGroup").merge(this._zoomGroup);var c=this._zoomGroup.selectAll("g.d3plus-geomap-paths").data([0]);c=c.enter().append("g").attr("class","d3plus-geomap-paths").merge(c);function f(t,e){var o=e&&t.objects[e]?e:Object.keys(t.objects)[0];return p.feature(t,t.objects[o])}var _=this._topojson?f(this._topojson,this._topojsonKey):{type:"FeatureCollection",features:[]};if(this._topojsonFilter){_.features=_.features.filter(this._topojsonFilter)}var d=this._path=i.geoPath().projection(this._projection);var m=this._filteredData.filter(function(t,e){return s._point(t,e)instanceof Array});var g=this._filteredData.filter(function(t,e){return!(s._point(t,e)instanceof Array)}).reduce(function(t,e){t[s._id(e)]=e;return t},{});var y=_.features.reduce(function(t,e){var o=s._topojsonId(e);t.push({__d3plus__:true,data:g[o],feature:e,id:o});return t},[]);var z=n["scale"+this._pointSizeScale.charAt(0).toUpperCase()+this._pointSizeScale.slice(1)]().domain(e.extent(m,function(t,e){return s._pointSize(t,e)})).range([this._pointSizeMin,this._pointSizeMax]);if(!this._zoomSet){var v=this._fitObject?f(this._fitObject,this._fitKey):_;var j={type:"FeatureCollection",features:this._fitFilter?v.features.filter(this._fitFilter):v.features.slice()};j.features=j.features.reduce(function(t,o){var i={type:o.type,id:o.id,geometry:{coordinates:o.geometry.coordinates,type:o.geometry.type}};if(o.geometry.coordinates.length>1){var n=[],r=[];o.geometry.coordinates.forEach(function(t){i.geometry.coordinates=[t];n.push(d.area(i))});i.geometry.coordinates=[o.geometry.coordinates[n.indexOf(e.max(n))]];var s=d.centroid(i);o.geometry.coordinates.forEach(function(t){i.geometry.coordinates=[t];r.push(l.pointDistance(d.centroid(i),s))});var a=e.quantile(n.reduce(function(t,e,o){if(e){t.push(n[o]/e)}return t},[]),.9);i.geometry.coordinates=o.geometry.coordinates.filter(function(t,e){var o=r[e];return o===0||n[e]/o>=a})}t.push(i);return t},[]);var S=this._padding;if(typeof S==="string"){S=S.match(/([-\d\.]+)/g).map(Number);if(S.length===3){S.push(S[1])}if(S.length===2){S=S.concat(S)}if(S.length===1){S=Array(4).fill(S)}}else{S=Array(4).fill(S)}if(!j.features.length&&m.length){var G=[[undefined,undefined],[undefined,undefined]];m.forEach(function(t,e){var o=s._projection(s._point(t,e));if(G[0][0]===void 0||o[0]<G[0][0]){G[0][0]=o[0]}if(G[1][0]===void 0||o[0]>G[1][0]){G[1][0]=o[0]}if(G[0][1]===void 0||o[1]<G[0][1]){G[0][1]=o[1]}if(G[1][1]===void 0||o[1]>G[1][1]){G[1][1]=o[1]}});j={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"MultiPoint",coordinates:G.map(function(t){return s._projection.invert(t)})}}]};var x=e.max(m,function(t,e){return z(s._pointSize(t,e))});S=S.map(function(t){return t+x})}this._projection=this._projection.fitExtent(j.features.length?[[S[3],S[0]],[u-S[1]*2,a-S[2]*2]]:[[0,0],[u,a]],j.features.length?j:{type:"Sphere"});this._zoomBehavior.extent([[0,0],[u,a]]).scaleExtent([1,16]).translateExtent([[0,0],[u,a]]).on("zoom",this._zoomed.bind(this));this._zoomSet=true}this._shapes.push((new l.Path).data(y).d(function(t){return d(t.feature)}).select(c.node()).x(0).y(0).config(this._shapeConfigPrep("Path")).render());var b=this._zoomGroup.selectAll("g.d3plus-geomap-pins").data([0]);b=b.enter().append("g").attr("class","d3plus-geomap-pins").merge(b);var C=(new l.Circle).config(this._shapeConfigPrep("Circle")).data(m).r(function(t,e){return z(s._pointSize(t,e))}).select(b.node()).sort(function(t,e){return s._pointSize(e)-s._pointSize(t)}).x(function(t,e){return s._projection(s._point(t,e))[0]}).y(function(t,e){return s._projection(s._point(t,e))[1]});var F=Object.keys(this._on);var M=F.filter(function(t){return t.includes(".Circle")}),A=F.filter(function(t){return!t.includes(".")}),q=F.filter(function(t){return t.includes(".shape")});for(var w=0;w<A.length;w++){C.on(A[w],s._on[A[w]])}for(var P=0;P<q.length;P++){C.on(q[P],s._on[q[P]])}for(var O=0;O<M.length;O++){C.on(M[O],s._on[M[O]])}this._shapes.push(C.render());this._zoomEvents();this._renderTiles();return this};c.prototype.fitFilter=function t(e){if(arguments.length){if(typeof e==="function"){return this._fitFilter=e,this}if(!(e instanceof Array)){e=[e]}return this._fitFilter=function(t){return e.includes(t.id)},this}return this._fitFilter};c.prototype.fitKey=function t(e){return arguments.length?(this._fitKey=e,this):this._fitKey};c.prototype.fitObject=function t(e,o){return arguments.length?(this._queue.push([h.dataLoad.bind(this),e,o,"fitObject"]),this):this._fitObject};c.prototype.ocean=function t(e){return arguments.length?(this._ocean=e,this):this._ocean};c.prototype.padding=function t(e){return arguments.length?(this._padding=e,this):this._padding};c.prototype.point=function t(e){return arguments.length?(this._point=typeof e==="function"?e:u.constant(e),this):this._point};c.prototype.pointSize=function t(e){return arguments.length?(this._pointSize=typeof e==="function"?e:u.constant(e),this):this._pointSize};c.prototype.pointSizeMax=function t(e){return arguments.length?(this._pointSizeMax=e,this):this._pointSizeMax};c.prototype.pointSizeMin=function t(e){return arguments.length?(this._pointSizeMin=e,this):this._pointSizeMin};c.prototype.tiles=function t(e){return arguments.length?(this._tiles=e,this):this._tiles};c.prototype.topojson=function t(e,o){return arguments.length?(this._queue.push([h.dataLoad.bind(this),e,o,"topojson"]),this):this._topojson};c.prototype.topojsonFilter=function t(e){if(arguments.length){if(typeof e==="function"){return this._topojsonFilter=e,this}if(!(e instanceof Array)){e=[e]}return this._topojsonFilter=function(t){return e.includes(t.id)},this}return this._topojsonFilter};c.prototype.topojsonKey=function t(e){return arguments.length?(this._topojsonKey=e,this):this._topojsonKey};c.prototype.topojsonId=function t(e){return arguments.length?(this._topojsonId=typeof e==="function"?e:u.accessor(e),this,this):this._topojsonId};c.prototype.zoom=function t(e){return arguments.length?(this._zoom=e,this):this._zoom};return c}(h.Viz);t.Geomap=c;Object.defineProperty(t,"__esModule",{value:true})});