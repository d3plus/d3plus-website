/*
  d3plus-export v0.1.0
  Export methods for transforming and downloading SVG.
  Copyright (c) 2017 D3plus - https://d3plus.org
  @license MIT
*/
(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?t(exports,require("canvas-toBlob"),require("canvg-browser"),require("d3-selection"),require("file-saver"),require("jspdf")):typeof define==="function"&&define.amd?define("d3plus-export",["exports","canvas-toBlob","canvg-browser","d3-selection","file-saver","jspdf"],t):t(e.d3plus=e.d3plus||{},null,e.canvg,e.d3Selection,e.fileSaver,e.JsPDF)})(this,function(e,t,a,s,i,r){"use strict";a="default"in a?a["default"]:a;r="default"in r?r["default"]:r;var l={callback:function(){},filename:"download",padding:0,scale:1,type:"png"};var n={ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true};var c=function(e,t){if(!e){return}t=Object.assign({},l,t);var c=new RegExp(/(MSIE|Trident\/|Edge\/)/i).test(navigator.userAgent);if(t.type==="svg"){var o=c?(new XMLSerializer).serializeToString(e):e.outerHTML;i.saveAs(new Blob([o],{type:"application/svg+xml"}),t.filename+".svg");return}var h=parseFloat(s.select(e).style("height")),d=parseFloat(s.select(e).style("width"));var f=document.createElement("canvas");f.width=(d+t.padding*2)*t.scale;f.height=(h+t.padding*2)*t.scale;var p=f.getContext("2d");p.scale(t.scale,t.scale);p.clearRect(0,0,f.width/2,f.height/2);if(t.type==="pdf"){p.beginPath();p.rect(0,0,f.width/2,f.height/2);p.fillStyle="white";p.fill()}var v=[];function g(e,t){if(t===void 0)t={x:0,y:0,scale:1};s.selectAll(e.childNodes).each(function(){var e=Object.assign({},t);if(this.tagName){var a=s.select(this).attr("transform"),i=this.tagName.toLowerCase();if(i==="g"&&a){var r=a.match(/scale\(([^a-z]+)\)/i);if(r){e.scale*=Math.round(parseFloat(r[1]))}var l=a.match(/translate\(([^a-z]+)\)/i);if(l){var n=l[1].replace(/([^a-z]),*\s([^a-z])/gi,"$1,$2").split(",").map(function(t){return Math.round(parseFloat(t)*e.scale)});var c=n[0];var o=n[1];e.x+=c;e.y+=o}}if(i==="svg"){var h=s.select(this).attr("x");h=h?Math.round(parseFloat(h))*e.scale:0;e.x+=h;var d=s.select(this).attr("y");d=d?Math.round(parseFloat(d))*e.scale:0;e.y+=d;e.clip={height:Math.round(parseFloat(s.select(this).attr("height")||s.select(this).style("height"))),width:Math.round(parseFloat(s.select(this).attr("width")||s.select(this).style("width"))),x:h,y:d}}else{var f=s.select(this).attr("x");if(f){e.x+=parseFloat(f)*e.scale}var p=s.select(this).attr("y");if(p){e.y+=parseFloat(p)*e.scale}}}var u=(this.tagName||"").toLowerCase();var y=u.length?s.select(this).selectAll("*").filter(function(){var e=s.select(this).attr("fill");return e&&e.indexOf("url")===0}).size():0;if(!u.length){var m=(this.wholeText||"").replace(/\s/g,"");if(m.length){var w=this.nodeValue.replace(/^\s*/,"").replace(/^\n/,"").replace(/^\s*/,"").replace(/\n$/,"").replace(/\s*$/,"").replace(/\n$/,"");v.push({type:"text",style:this.parentNode,value:w})}}else if(u==="defs"){return}else if(u==="g"&&this.childNodes.length>0&&!s.select(this).selectAll("pattern, image, foreignobject").size()&&!y){var x=s.select(this).attr("opacity")||s.select(this).style("opacity");if(x&&parseFloat(x)>0){s.select(this).selectAll("*").each(function(){if(s.select(this).attr("stroke-width")===null){s.select(this).attr("stroke-width",0)}});v.push(Object.assign({},e,{type:"svg",value:this}))}}else if(u==="text"){if(s.select(this).attr("stroke-width")===null){s.select(this).attr("stroke-width",0)}v.push(Object.assign({},e,{type:"svg",value:this}))}else if(this.childNodes.length>0){var b=s.select(this).attr("opacity")||s.select(this).style("opacity");if(b&&parseFloat(b)>0){g(this,e)}}else if(["image","img"].includes(u)){var F=s.select(this).attr("href")||s.select(this).attr("xlink:href");if(F.length){var z=parseFloat(s.select(this).attr("height"))*e.scale,k=parseFloat(s.select(this).attr("width"))*e.scale;var M={clip:e.clip,height:z,loaded:false,type:"img",width:k,x:e.x,y:e.y};v.push(M);var j=new Image;j.crossOrigin="Anonymous";j.onload=function(){var e=document.createElement("canvas");var t=e.getContext("2d");e.height=z;e.width=k;t.drawImage(this,0,0,k,z);var a=document.createElement("img");a.src=e.toDataURL("image/png");M.loaded=true;M.value=a};j.src=F}}else{if(s.select(this).attr("stroke-width")===null){s.select(this).attr("stroke-width",0)}v.push(Object.assign({},e,{type:"svg",value:this}));var O=s.select(this).attr("fill");if(O&&O.indexOf("url")===0){var A=s.select(this).attr("transform");if(A){var S=A.match(/scale\(([^a-z]+)\)/i);if(S){e.scale*=Math.round(parseFloat(S[1]))}var E=A.match(/translate\(([^a-z]+)\)/i);if(E){var L=E[1].replace(/([^a-z]),*\s([^a-z])/gi,"$1,$2").split(",").map(function(t){return Math.round(parseFloat(t)*e.scale)});var N=L[0];var T=L[1];e.x+=N;e.y+=T}}g(s.select(O.slice(4,-1)).node(),e)}}})}g(e);function u(){var e=true;for(var t=0;t<v.length;t++){if(v[t].loaded===false){e=false;break}}if(e){y()}else{setTimeout(u,500)}}u();function y(){for(var e=0;e<v.length;e++){var l=v[e];var o=l.clip;switch(l.type){case"img":p.save();p.beginPath();p.translate(t.padding,t.padding);p.rect(o?o.x:0,o?o.y:0,o?o.width:d,o?o.height:h);p.clip();p.drawImage(l.value,l.x,l.y,l.width,l.height);p.restore();break;case"text":var g=s.select(l.style);var u=l.value.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");var y=g.style("color"),m=g.style("font-size");var w=g.style("font-family").split(",")[0];if(w.indexOf("'")!==0){w="'"+w+"'"}var x="<text stroke='none' dy='"+m+"' fill='"+y+"' font-family="+w+" font-size='"+m+"'>"+u+"</text>";p.save();p.translate(t.padding,t.padding);a(f,x,n);p.restore();break;case"svg":var b=c?(new XMLSerializer).serializeToString(l.value):l.value.outerHTML;p.save();p.translate(t.padding,t.padding);p.rect(o?o.x:0,o?o.y:0,o?o.width:d,o?o.height:h);p.clip();a(f,b,Object.assign({offsetX:l.x,offsetY:l.y},n));p.restore();break;default:console.warn("uncaught",l);break}}if(t.type==="pdf"){var F=11,z="in",k=8.5;var M=f.width/f.height,j=M>1?"landscape":"portrait";var O=new r(j,z,[k,F]);var A=j==="landscape"?k:F,S,E,L=j==="landscape"?F:k;var N=.5;if(M<L/A){A-=N*2;var T=A*M;E=N;S=(L-T)/2;L=T}else{L-=N*2;var $=L/M;S=N;E=(A-$)/2;A=$}O.addImage(f,"canvas",S,E,L,A);O.save(t.filename)}else if(["jpg","png"].includes(t.type)){f.toBlob(function(e){return i.saveAs(e,t.filename)})}t.callback(f)}};e.saveElement=c;Object.defineProperty(e,"__esModule",{value:true})});