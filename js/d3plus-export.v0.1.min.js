/*
  d3plus-export v0.1.1
  Export methods for transforming and downloading SVG.
  Copyright (c) 2017 D3plus - https://d3plus.org
  @license MIT
*/
(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?t(exports,require("canvas-toBlob"),require("canvg-browser"),require("d3-selection"),require("file-saver")):typeof define==="function"&&define.amd?define("d3plus-export",["exports","canvas-toBlob","canvg-browser","d3-selection","file-saver"],t):t(e.d3plus=e.d3plus||{},null,e.canvg,e.d3Selection,e.fileSaver)})(this,function(e,t,a,s,i){"use strict";a="default"in a?a["default"]:a;var r={callback:function(){},filename:"download",padding:0,scale:1,type:"png"};var l={ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true};var n=function(e,t){if(!e){return}t=Object.assign({},r,t);var n=new RegExp(/(MSIE|Trident\/|Edge\/)/i).test(navigator.userAgent);if(t.type==="svg"){var c=n?(new XMLSerializer).serializeToString(e):e.outerHTML;i.saveAs(new Blob([c],{type:"application/svg+xml"}),t.filename+".svg");return}var o=parseFloat(s.select(e).style("height")),h=parseFloat(s.select(e).style("width"));var d=document.createElement("canvas");d.width=(h+t.padding*2)*t.scale;d.height=(o+t.padding*2)*t.scale;var f=d.getContext("2d");f.scale(t.scale,t.scale);f.clearRect(0,0,d.width/2,d.height/2);if(t.type==="pdf"){f.beginPath();f.rect(0,0,d.width/2,d.height/2);f.fillStyle="white";f.fill()}var p=[];function g(e,t){if(t===void 0)t={x:0,y:0,scale:1};s.selectAll(e.childNodes).each(function(){var e=Object.assign({},t);if(this.tagName){var a=s.select(this).attr("transform"),i=this.tagName.toLowerCase();if(i==="g"&&a){var r=a.match(/scale\(([^a-z]+)\)/i);if(r){e.scale*=Math.round(parseFloat(r[1]))}var l=a.match(/translate\(([^a-z]+)\)/i);if(l){var n=l[1].replace(/([^a-z]),*\s([^a-z])/gi,"$1,$2").split(",").map(function(t){return Math.round(parseFloat(t)*e.scale)});var c=n[0];var o=n[1];e.x+=c;e.y+=o}}if(i==="svg"){var h=s.select(this).attr("x");h=h?Math.round(parseFloat(h))*e.scale:0;e.x+=h;var d=s.select(this).attr("y");d=d?Math.round(parseFloat(d))*e.scale:0;e.y+=d;e.clip={height:Math.round(parseFloat(s.select(this).attr("height")||s.select(this).style("height"))),width:Math.round(parseFloat(s.select(this).attr("width")||s.select(this).style("width"))),x:h,y:d}}else{var f=s.select(this).attr("x");if(f){e.x+=parseFloat(f)*e.scale}var v=s.select(this).attr("y");if(v){e.y+=parseFloat(v)*e.scale}}}var u=(this.tagName||"").toLowerCase();var y=u.length?s.select(this).selectAll("*").filter(function(){var e=s.select(this).attr("fill");return e&&e.indexOf("url")===0}).size():0;if(!u.length){var m=(this.wholeText||"").replace(/\s/g,"");if(m.length){var w=this.nodeValue.replace(/^\s*/,"").replace(/^\n/,"").replace(/^\s*/,"").replace(/\n$/,"").replace(/\s*$/,"").replace(/\n$/,"");p.push({type:"text",style:this.parentNode,value:w})}}else if(u==="defs"){return}else if(u==="g"&&this.childNodes.length>0&&!s.select(this).selectAll("pattern, image, foreignobject").size()&&!y){var x=s.select(this).attr("opacity")||s.select(this).style("opacity");if(x&&parseFloat(x)>0){s.select(this).selectAll("*").each(function(){if(s.select(this).attr("stroke-width")===null){s.select(this).attr("stroke-width",0)}});p.push(Object.assign({},e,{type:"svg",value:this}))}}else if(u==="text"){if(s.select(this).attr("stroke-width")===null){s.select(this).attr("stroke-width",0)}p.push(Object.assign({},e,{type:"svg",value:this}))}else if(this.childNodes.length>0){var b=s.select(this).attr("opacity")||s.select(this).style("opacity");if(b&&parseFloat(b)>0){g(this,e)}}else if(["image","img"].includes(u)){var z=s.select(this).attr("href")||s.select(this).attr("xlink:href");if(z.length){var F=parseFloat(s.select(this).attr("height"))*e.scale,k=parseFloat(s.select(this).attr("width"))*e.scale;var M={clip:e.clip,height:F,loaded:false,type:"img",width:k,x:e.x,y:e.y};p.push(M);var O=new Image;O.crossOrigin="Anonymous";O.onload=function(){var e=document.createElement("canvas");var t=e.getContext("2d");e.height=F;e.width=k;t.drawImage(this,0,0,k,F);var a=document.createElement("img");a.src=e.toDataURL("image/png");M.loaded=true;M.value=a};O.src=z}}else{if(s.select(this).attr("stroke-width")===null){s.select(this).attr("stroke-width",0)}p.push(Object.assign({},e,{type:"svg",value:this}));var j=s.select(this).attr("fill");if(j&&j.indexOf("url")===0){var A=s.select(this).attr("transform");if(A){var S=A.match(/scale\(([^a-z]+)\)/i);if(S){e.scale*=Math.round(parseFloat(S[1]))}var E=A.match(/translate\(([^a-z]+)\)/i);if(E){var L=E[1].replace(/([^a-z]),*\s([^a-z])/gi,"$1,$2").split(",").map(function(t){return Math.round(parseFloat(t)*e.scale)});var N=L[0];var T=L[1];e.x+=N;e.y+=T}}g(s.select(j.slice(4,-1)).node(),e)}}})}g(e);function v(){var e=true;for(var t=0;t<p.length;t++){if(p[t].loaded===false){e=false;break}}if(e){u()}else{setTimeout(v,500)}}v();function u(){for(var e=0;e<p.length;e++){var r=p[e];var c=r.clip;switch(r.type){case"img":f.save();f.beginPath();f.translate(t.padding,t.padding);f.rect(c?c.x:0,c?c.y:0,c?c.width:h,c?c.height:o);f.clip();f.drawImage(r.value,r.x,r.y,r.width,r.height);f.restore();break;case"text":var g=s.select(r.style);var v=r.value.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");var u=g.style("color"),y=g.style("font-size");var m=g.style("font-family").split(",")[0];if(m.indexOf("'")!==0){m="'"+m+"'"}var w="<text stroke='none' dy='"+y+"' fill='"+u+"' font-family="+m+" font-size='"+y+"'>"+v+"</text>";f.save();f.translate(t.padding,t.padding);a(d,w,l);f.restore();break;case"svg":var x=n?(new XMLSerializer).serializeToString(r.value):r.value.outerHTML;f.save();f.translate(t.padding,t.padding);f.rect(c?c.x:0,c?c.y:0,c?c.width:h,c?c.height:o);f.clip();a(d,x,Object.assign({offsetX:r.x,offsetY:r.y},l));f.restore();break;default:console.warn("uncaught",r);break}}if(["jpg","png"].includes(t.type)){d.toBlob(function(e){return i.saveAs(e,t.filename)})}t.callback(d)}};e.saveElement=n;Object.defineProperty(e,"__esModule",{value:true})});