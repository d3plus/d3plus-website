/*
  d3plus-legend v0.5.0
  An easy to use javascript chart legend.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("d3-array"),require("d3-collection"),require("d3-selection"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-text")):"function"==typeof define&&define.amd?define("d3plus-legend",["exports","d3-array","d3-collection","d3-selection","d3plus-common","d3plus-shape","d3plus-text"],i):i(t.d3plus=t.d3plus||{},t.d3Array,t.d3Collection,t.d3Selection,t.d3plusCommon,t.d3plus,t.d3plusText)}(this,function(t,i,e,n,h,o,a){"use strict";var s=function(t){function s(){var e=this;t.call(this);var n=new o.Shape;this._align="center",this._data=[],this._duration=600,this._height=200,this._id=h.accessor("id"),this._label=h.accessor("id"),this._lineData=[],this._orient="horizontal",this._outerBounds={width:0,height:0,x:0,y:0},this._padding=5,this._shape=h.constant("Rect"),this._shapeConfig={duration:this._duration,fill:h.accessor("color"),fontColor:h.constant("#444"),fontFamily:n.fontFamily(),fontSize:h.constant(10),height:h.constant(10),labelBounds:function(t,i,n){var h=e._lineData[t.i],o=void 0!==n.r?n.r:n.width/2;return{width:h.width,height:h.height,x:o+e._padding,y:1-h.height/2}},opacity:1,r:h.constant(5),width:h.constant(10),x:function(t,n){var h=e._shapeConfig.width;return"vertical"===e._orient?e._outerBounds.x+h(t,n)/2:e._outerBounds.x+i.sum(e._data.slice(0,n).map(function(t,i){return h(t,i)}))+i.sum(e._lineData.slice(0,n).map(function(i){return i.width-e._shapeConfig.fontSize(t,n)}))+h(t,n)/2+3*e._padding*n},y:function(t,n){var h=e._shapeConfig.height;if("horizontal"===e._orient)return e._titleHeight+e._outerBounds.y+i.max(e._lineData.map(function(t){return t.height}).concat(e._data.map(function(t,i){return h(t,i)})))/2;var o=h(t,n),a=e._lineData[n].height>o?e._lineData[n].height/2:o/2,s=i.sum(e._lineData.slice(0,n),function(t,e){return i.max([t.height,h(t.data,e)])});return e._titleHeight+e._outerBounds.y+s+a+e._padding*n}},this._titleConfig={fontFamily:"Verdana",fontSize:12,lineHeight:13,textAnchor:"middle"},this._verticalAlign="middle",this._width=400}return t&&(s.__proto__=t),s.prototype=Object.create(t&&t.prototype),s.prototype.constructor=s,s.prototype.render=function(t){var s=this;void 0===this._select&&this.select(n.select("body").append("svg").attr("width",this._width+"px").attr("height",this._height+"px").node()),void 0===this._lineHeight&&(this._lineHeight=function(t,i){return 1.1*s._shapeConfig.fontSize(t,i)});var r=h.elem("g.d3plus-Legend",{parent:this._select}),l=this._height;if(this._titleHeight=0,this._title){var d=this._titleConfig.fontFamily,u=this._titleConfig.lineHeight,_=this._titleConfig.fontSize,g=a.textWrap().fontFamily(d).fontSize(_).lineHeight(u).width(this._width).height(this._height)(this._title);this._titleHeight=u+g.lines.length+this._padding,l-=this._titleHeight}this._lineData=this._data.map(function(t,e){var n=s._shapeConfig.fontFamily(t,e),h=s._lineHeight(t,e),o=s._shapeConfig.fontSize(t,e),r="horizontal"===s._orient?l-(s._data.length+1)*s._padding:s._height,d="vertical"===s._orient?s._width-3*s._padding-s._shapeConfig.width(t,e):s._width,u=a.textWrap().fontFamily(n).fontSize(o).lineHeight(h).width(d).height(r)(s._label(t,e));return u.width=Math.ceil(i.max(u.lines.map(function(t){return a.textWidth(t,{"font-family":n,"font-size":o})})))+o,u.height=Math.ceil(u.lines.length*(h+1)),u.og={height:u.height,width:u.width},u.data=t,u.f=n,u.s=o,u.lh=h,u.id=s._id(t,e),u});var f,p,c=!0;if("horizontal"===this._orient){if(f=this._width-i.sum(this._data.map(function(t,i){return s._shapeConfig.width(t,i)+3*s._padding}))-2*this._padding,p=i.sum(this._lineData.map(function(t,i){return t.width-s._shapeConfig.fontSize(t,i)})),p>f){var y=this._lineData.filter(function(t){return t.words.length>1}).sort(function(t,i){return i.sentence.length-t.sentence.length});if(y.length&&l>2*y[0].height)for(var m=2;m<=5;){var w=y.filter(function(t){return t.words.length>=m});if(!w.length)break;for(var v=function(t){var e=y[t],n=e.og.height*m,h=e.og.width*(1.5*(1/m)),o=a.textWrap().fontFamily(e.f).fontSize(e.s).lineHeight(e.lh).width(h).height(n)(e.sentence);if(!o.truncated&&(p-=e.width,e.width=Math.ceil(i.max(o.lines.map(function(t){return a.textWidth(t,{"font-family":e.f,"font-size":e.s})})))+e.s,e.height=o.lines.length*(e.lh+1),p+=e.width,p<=f))return"break"},x=0;x<y.length;x++){var C=v(x);if("break"===C)break}if(p<=f)break;m++}else c=!1}}else f=this._width-i.max(this._data.map(function(t,i){return s._shapeConfig.width(t,i)+3*s._padding}))-2*this._padding,p=i.max(this._lineData.map(function(t,i){return t.width-s._shapeConfig.fontSize(t,i)}));if(p>f&&(c=!1),!c){p=0;for(var b=0;b<this._lineData.length;b++)s._lineData[b].width=0,s._lineData[b].height=0}var z=i.max(this._lineData,function(t,e){return i.max([t.height,s._shapeConfig.height(t.data,e)])})+this._titleHeight,H="horizontal"===this._orient?p+i.sum(this._data,function(t,i){return s._shapeConfig.width(t,i)})+this._padding*(this._data.length*(c?3:1)-2):p+i.max(this._data,function(t,i){return s._shapeConfig.width(t,i)})+3*this._padding;this._outerBounds.width=H,this._outerBounds.height=z;var B=this._padding,D=this._padding;"center"===this._align?B=(this._width-2*this._padding-H)/2:"right"===this._align&&(B=this._width-2*this._padding-H),"middle"===this._verticalAlign?D=(this._height-2*this._padding-z)/2:"bottom"===this._verticalAlign&&(D=this._height-2*this._padding-z),this._outerBounds.x=B,this._outerBounds.y=D,(new a.TextBox).data(this._title?[{text:this._title}]:[]).duration(this._duration).select(r.node()).width(this._width).x(0).y(this._outerBounds.y).config(this._titleConfig).render();var S=this._shapeConfig,A={id:function(t){return t.id},label:function(t){return t.label},lineHeight:function(t){return t.lH}},F=this._data.map(function(t,i){var e={data:t,i:i,id:s._id(t,i),label:c?s._label(t,i):null,lH:s._lineHeight(t,i),shape:s._shape(t,i)},n=function(n){"labelBounds"!==n&&{}.hasOwnProperty.call(S,n)&&"function"==typeof S[n]&&(e[n]=S[n](t,i),A[n]=function(t){return t[n]})};for(var h in S)n(h);return e});return e.nest().key(function(t){return t.shape}).entries(F).forEach(function(t){(new o[t.key]).data(t.values).duration(s._duration).labelPadding(0).select(r.node()).verticalAlign("top").config(S).config(A).render()}),t&&setTimeout(t,this._duration+100),this},s.prototype.align=function(t){return arguments.length?(this._align=t,this):this._align},s.prototype.data=function(t){return arguments.length?(this._data=t,this):this._data},s.prototype.duration=function(t){return arguments.length?(this._duration=t,this):this._duration},s.prototype.height=function(t){return arguments.length?(this._height=t,this):this._height},s.prototype.id=function(t){return arguments.length?(this._id=t,this):this._id},s.prototype.label=function(t){return arguments.length?(this._label="function"==typeof t?t:h.constant(t),this):this._label},s.prototype.orient=function(t){return arguments.length?(this._orient=t,this):this._orient},s.prototype.outerBounds=function(){return this._outerBounds},s.prototype.padding=function(t){return arguments.length?(this._padding=t,this):this._padding},s.prototype.select=function(t){return arguments.length?(this._select=n.select(t),this):this._select},s.prototype.shape=function(t){return arguments.length?(this._shape="function"==typeof t?t:h.constant(t),this):this._shape},s.prototype.shapeConfig=function(t){return arguments.length?(this._shapeConfig=Object.assign(this._shapeConfig,t),this):this._shapeConfig},s.prototype.title=function(t){return arguments.length?(this._title=t,this):this._title},s.prototype.titleConfig=function(t){return arguments.length?(this._titleConfig=Object.assign(this._titleConfig,t),this):this._titleConfig},s.prototype.verticalAlign=function(t){return arguments.length?(this._verticalAlign=t,this):this._verticalAlign},s.prototype.width=function(t){return arguments.length?(this._width=t,this):this._width},s}(h.BaseClass);t.Legend=s,Object.defineProperty(t,"__esModule",{value:!0})});