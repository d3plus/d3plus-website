/*
  d3plus-network v0.1.7
  Javascript network visualizations built upon d3 modules.
  Copyright (c) 2017 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3-array"),require("d3-brush"),require("d3-collection"),require("d3-selection"),require("d3-scale"),require("d3-zoom"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-viz")):typeof define==="function"&&define.amd?define("d3plus-network",["exports","d3-array","d3-brush","d3-collection","d3-selection","d3-scale","d3-zoom","d3plus-common","d3plus-shape","d3plus-viz"],e):e(t.d3plus=t.d3plus||{},t.d3Array,t.d3Brush,t.d3Collection,t.d3Selection,t.scales,t.d3Zoom,t.d3plusCommon,t.shapes,t.d3plusViz)})(this,function(t,e,o,r,i,n,s,a,u,h){"use strict";var l=function(t){function h(){var e=this;t.call(this);this._brushFilter=function(){return!i.event.button&&i.event.detail<2};this._handleConfig={fill:"#444"};this._handleSize=6;this._links=[];this._nodes=[];this._on["click.shape"]=function(t,o){e._tooltipClass.data([]).render();if(e._hover&&e._drawDepth>=e._groupBy.length-1){if(e._focus&&e._focus===t.id){e.active(false);e._on.mouseenter.bind(e)(t,o);e._focus=undefined;e._zoomToBounds(null)}else{var r=e._nodeGroupBy&&e._nodeGroupBy[e._drawDepth](t,o)?e._nodeGroupBy[e._drawDepth](t,o):e._id(t,o),i=e._linkLookup[r],n=e._nodeLookup[r];var s=[n.id],a=[n.x-n.r,n.x+n.r],u=[n.y-n.r,n.y+n.r];i.forEach(function(t){s.push(t.id);if(t.x-t.r<a[0]){a[0]=t.x-t.r}if(t.x+t.r>a[1]){a[1]=t.x+t.r}if(t.y-t.r<u[0]){u[0]=t.y-t.r}if(t.y+t.r>u[1]){u[1]=t.y+t.r}});e.active(function(t,o){if(t.source&&t.target){return t.source.id===n.id||t.target.id===n.id}else{return s.includes(e._ids(t,o)[e._drawDepth])}});e._focus=t.id;e._zoomToBounds([[a[0],u[0]],[a[1],u[1]]])}}};this._on["click.legend"]=function(t,o){var r=e._id(t);var i=e._ids(t);i=i[i.length-1];if(e._hover&&e._drawDepth>=e._groupBy.length-1){if(e._focus&&e._focus===r){e.active(false);e._on.mouseenter.bind(e)(t,o);e._focus=undefined;e._zoomToBounds(null)}else{var n=r.map(function(t){return e._nodeLookup[t]});var s=[i],a=[n[0].x-n[0].r,n[0].x+n[0].r],u=[n[0].y-n[0].r,n[0].y+n[0].r];n.forEach(function(t){s.push(t.id);if(t.x-t.r<a[0]){a[0]=t.x-t.r}if(t.x+t.r>a[1]){a[1]=t.x+t.r}if(t.y-t.r<u[0]){u[0]=t.y-t.r}if(t.y+t.r>u[1]){u[1]=t.y+t.r}});e.active(function(t,o){if(t.source&&t.target){return s.includes(t.source.id)&&s.includes(t.target.id)}else{var r=e._ids(t,o);return s.includes(r[r.length-1])}});e._focus=r;e._zoomToBounds([[a[0],u[0]],[a[1],u[1]]])}e._on["mousemove.legend"].bind(e)(t,o)}};this._selectionConfig={fill:"#777","stroke-width":0};this._sizeMin=5;this._sizeScale="sqrt";this._shape=a.constant("Circle");this._shapeConfig=a.assign(this._shapeConfig,{labelConfig:{textAnchor:"middle",verticalAlign:"middle"},Path:{fill:"none",label:false,stroke:"#eee",strokeWidth:1}});this._x=a.accessor("x");this._y=a.accessor("y");this._zoom=true;this._zoomBehavior=s.zoom();this._zoomBrush=o.brush().on("start",this._brushStart.bind(this)).on("brush",this._brushBrush.bind(this)).on("end",this._brushEnd.bind(this));this._zoomMax=16;this._zoomPan=true;this._zoomScroll=true}if(t)h.__proto__=t;h.prototype=Object.create(t&&t.prototype);h.prototype.constructor=h;h.prototype._brushBrush=function t(){this._brushStyle()};h.prototype._brushEnd=function t(){if(!i.event.sourceEvent){return}console.log(i.event.selection);this._brushStyle()};h.prototype._brushStart=function t(){this._brushStyle()};h.prototype._brushStyle=function t(){this._brushGroup.selectAll(".selection").call(a.attrize,this._selectionConfig);this._brushGroup.selectAll(".handle").call(a.attrize,this._handleConfig)};h.prototype._zoomed=function t(){this._zoomGroup.attr("transform",i.event.transform)};h.prototype._zoomEvents=function t(e){if(e===void 0)e=false;if(e){this._brushGroup.style("display","inline");this._networkGroup.on(".zoom",null)}else if(this._zoom){this._brushGroup.style("display","none");this._networkGroup.call(this._zoomBehavior);if(!this._zoomScroll){this._networkGroup.on("mousewheel.zoom",null).on("MozMousePixelScroll.zoom",null).on("wheel.zoom",null)}if(!this._zoomPan){this._networkGroup.on("mousedown.zoom",null).on("mousemove.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null)}}else{this._networkGroup.on(".zoom",null)}};h.prototype._zoomToBounds=function t(e){if(e){var o=this._zoomBehavior.translateExtent()[1];var r=o[0];var i=o[1];var n=e[1][0]-e[0][0],a=e[1][1]-e[0][1],u=(e[0][0]+e[1][0])/2,h=(e[0][1]+e[1][1])/2;var l=Math.max(1,Math.min(this._zoomMax,.9/Math.max(n/r,a/i)));var d=[r/2-l*u,i/2-l*h];var _=s.zoomIdentity.translate(d[0],d[1]).scale(l);this._networkGroup.transition().duration(this._zoomBehavior.duration()).call(this._zoomBehavior.transform,_)}else{this._networkGroup.transition().duration(this._zoomBehavior.duration()).call(this._zoomBehavior.transform,s.zoomIdentity)}};h.prototype.render=function o(i){var s=this;t.prototype.render.call(this,i);var h=this._height-this._margin.top-this._margin.bottom,l="translate("+this._margin.left+", "+this._margin.top+")",d=this._transition,_=this._width-this._margin.left-this._margin.right;var c=this._filteredData.reduce(function(t,e,o){t[s._id(e,o)]=e;return t},{});var p=this._nodes.reduce(function(t,e,o){t[s._nodeGroupBy?s._nodeGroupBy[s._drawDepth](e,o):s._id(e,o)]=e;return t},{});p=Array.from(new Set(Object.keys(c).concat(Object.keys(p)))).map(function(t,e){var o=c[t],r=p[t];return{__d3plus__:true,data:o||r,i:e,id:t,fx:o!==undefined&&s._x(o)!==undefined?s._x(o):s._x(r),fy:o!==undefined&&s._y(o)!==undefined?s._y(o):s._y(r),node:r,r:s._size?o!==undefined&&s._size(o)!==undefined?s._size(o):s._size(r):s._sizeMin,shape:o!==undefined&&s._shape(o)!==undefined?s._shape(o):s._shape(r)}});var f=e.extent(p.map(function(t){return t.fx})),m=e.extent(p.map(function(t){return t.fy}));var y=n.scaleLinear().domain(f).range([0,_]),g=n.scaleLinear().domain(m).range([0,h]);var z=(f[1]-f[0])/(m[1]-m[0]),v=_/h;if(z>v){var x=h*v/z;g.range([(h-x)/2,h-(h-x)/2])}else{var k=_*z/v;y.range([(_-k)/2,_-(_-k)/2])}p.forEach(function(t){t.x=y(t.fx);t.y=g(t.fy)});var b=e.extent(p.map(function(t){return t.r}));var w=this._sizeMax||e.min(e.merge(p.map(function(t){return p.map(function(e){return t===e?null:u.pointDistance([t.x,t.y],[e.x,e.y])})})))/2;var G=n["scale"+this._sizeScale.charAt(0).toUpperCase()+this._sizeScale.slice(1)]().domain(b).range([b[0]===b[1]?w:e.min([w/2,this._sizeMin]),w]),B=y.domain(),M=g.domain();var S=B[1]-B[0],A=M[1]-M[0];p.forEach(function(t){var e=G(t.r);if(B[0]>y.invert(t.x-e)){B[0]=y.invert(t.x-e)}if(B[1]<y.invert(t.x+e)){B[1]=y.invert(t.x+e)}if(M[0]>g.invert(t.y-e)){M[0]=g.invert(t.y-e)}if(M[1]<g.invert(t.y+e)){M[1]=g.invert(t.y+e)}});var C=B[1]-B[0],E=M[1]-M[0];w*=e.min([S/C,A/E]);G.range([b[0]===b[1]?w:e.min([w/2,this._sizeMin]),w]);y.domain(B);g.domain(M);p.forEach(function(t){t.x=y(t.fx);t.fx=t.x;t.y=g(t.fy);t.fy=t.y;t.r=G(t.r);t.width=t.r*2;t.height=t.r*2});var P=this._nodeLookup=p.reduce(function(t,e){t[e.id]=e;return t},{});var q=p.map(function(t){return t.node});var D=this._links.map(function(t){return{source:typeof t.source==="number"?p[q.indexOf(s._nodes[t.source])]:P[t.source.id],target:typeof t.target==="number"?p[q.indexOf(s._nodes[t.target])]:P[t.target.id]}});this._linkLookup=D.reduce(function(t,e){if(!t[e.source.id]){t[e.source.id]=[]}t[e.source.id].push(e.target);if(!t[e.target.id]){t[e.target.id]=[]}t[e.target.id].push(e.source);return t},{});this._networkGroup=this._select.selectAll("svg.d3plus-network-svg").data([0]);this._networkGroup=this._networkGroup.enter().append("svg").attr("class","d3plus-network-svg").attr("opacity",0).attr("width",_).attr("height",h).style("background-color","transparent").merge(this._networkGroup);this._networkGroup.transition(this._transition).attr("opacity",1).attr("width",_).attr("height",h);var L=this._networkGroup.selectAll("rect.d3plus-network-hitArea").data([0]);L.enter().append("rect").attr("class","d3plus-network-hitArea").merge(L).attr("width",_).attr("height",h).attr("fill","transparent");this._zoomGroup=this._networkGroup.selectAll("g.d3plus-network-zoomGroup").data([0]);this._zoomGroup=this._zoomGroup.enter().append("g").attr("class","d3plus-network-zoomGroup").merge(this._zoomGroup);this._zoomBrush.extent([[0,0],[_,h]]).filter(this._brushFilter).handleSize(this._handleSize);var O=this._select.selectAll("g.brush").data([0]);this._brushGroup=O.enter().append("g").attr("class","brush").merge(O).call(this._zoomBrush);this._zoomBehavior.scaleExtent([1,this._zoomMax]).translateExtent([[0,0],[_,h]]).on("zoom",this._zoomed.bind(this));var j=this._zoomGroup;this._shapes.push((new u.Path).config(this._shapeConfig).config(this._shapeConfig.Path).d(function(t){return"M"+t.source.x+","+t.source.y+" "+t.target.x+","+t.target.y}).data(D).select(a.elem("g.d3plus-network-links",{parent:j,transition:d,enter:{transform:l},update:{transform:l}}).node()).render());var T={label:function(t){return s._drawLabel(t.data||t.node,t.i)},select:a.elem("g.d3plus-network-nodes",{parent:j,transition:d,enter:{transform:l},update:{transform:l}}).node()};r.nest().key(function(t){return t.shape}).entries(p).forEach(function(t){s._shapes.push((new u[t.key]).config(a.configPrep.bind(s)(s._shapeConfig,"shape",t.key)).config(T).data(t.values).render())});this._zoomEvents();return this};h.prototype.links=function t(e){return arguments.length?(this._links=e,this):this._links};h.prototype.nodeGroupBy=function t(e){var o=this;if(!arguments.length){return this._nodeGroupBy}if(!(e instanceof Array)){e=[e]}return this._nodeGroupBy=e.map(function(t){if(typeof t==="function"){return t}else{if(!o._aggs[t]){o._aggs[t]=function(t){var e=Array.from(new Set(t));return e.length===1?e[0]:e}}return a.accessor(t)}}),this};h.prototype.nodes=function t(e){return arguments.length?(this._nodes=e,this):this._nodes};h.prototype.size=function t(e){return arguments.length?(this._size=typeof e==="function"||!e?e:a.accessor(e),this):this._size};h.prototype.sizeMax=function t(e){return arguments.length?(this._sizeMax=e,this):this._sizeMax};h.prototype.sizeMin=function t(e){return arguments.length?(this._sizeMin=e,this):this._sizeMin};h.prototype.sizeScale=function t(e){return arguments.length?(this._sizeScale=e,this):this._sizeScale};h.prototype.x=function t(o){if(arguments.length){if(typeof o==="function"){this._x=o}else{this._x=a.accessor(o);if(!this._aggs[o]){this._aggs[o]=function(t){return e.mean(t)}}}return this}else{return this._x}};h.prototype.y=function t(o){if(arguments.length){if(typeof o==="function"){this._y=o}else{this._y=a.accessor(o);if(!this._aggs[o]){this._aggs[o]=function(t){return e.mean(t)}}}return this}else{return this._y}};h.prototype.zoom=function t(e){return arguments.length?(this._zoom=e,this):this._zoom};h.prototype.zoomMax=function t(e){return arguments.length?(this._zoomMax=e,this):this._zoomMax};h.prototype.zoomPan=function t(e){return arguments.length?(this._zoomPan=e,this):this._zoomPan};h.prototype.zoomScroll=function t(e){return arguments.length?(this._zoomScroll=e,this):this._zoomScroll};return h}(h.Viz);t.Network=l;Object.defineProperty(t,"__esModule",{value:true})});