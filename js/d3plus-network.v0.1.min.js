/*
  d3plus-network v0.1.0
  Javascript network visualizations built upon d3 modules.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?t(exports,require("d3-array"),require("d3-collection"),require("d3-scale"),require("d3plus-color"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-viz")):typeof define==="function"&&define.amd?define("d3plus-network",["exports","d3-array","d3-collection","d3-scale","d3plus-color","d3plus-common","d3plus-shape","d3plus-viz"],t):t(e.d3plus=e.d3plus||{},e.d3Array,e.d3Collection,e.scales,e.d3plusColor,e.d3plusCommon,e.shapes,e.d3plusViz)})(this,function(e,t,n,i,r,s,o,a){"use strict";var u=function(e){function a(){var t=this;e.call(this);this._links=[];this._nodes=[];this._sizeMin=5;this._sizeScale="sqrt";this._shape=s.constant("Circle");this._shapeConfig=s.assign(this._shapeConfig,{Path:{fill:s.constant("none"),label:false,stroke:function(e,n){return r.assign(t._id(e,n))},strokeWidth:s.constant(1)},textAnchor:"middle",verticalAlign:"middle"});this._x=s.accessor("x");this._y=s.accessor("y")}if(e)a.__proto__=e;a.prototype=Object.create(e&&e.prototype);a.prototype.constructor=a;a.prototype.render=function r(a){var u=this;e.prototype.render.call(this,a);var c=this._height-this._margin.top-this._margin.bottom,h=this._select,f="translate("+this._margin.left+", "+this._margin.top+")",p=this._transition,d=this._width-this._margin.left-this._margin.right;var l=this._filteredData.reduce(function(e,t,n){e[u._id(t,n)]=t;return e},{});var _=this._nodes.reduce(function(e,t,n){e[u._nodeGroupBy?u._nodeGroupBy[u._drawDepth](t,n):u._id(t,n)]=t;return e},{});_=Array.from(new Set(Object.keys(l).concat(Object.keys(_)))).map(function(e,t){var n=l[e],i=_[e];return{__d3plus__:true,data:n||i,i:t,id:e,fx:n!==void 0&&u._x(n)!==void 0?u._x(n):u._x(i),fy:n!==void 0&&u._y(n)!==void 0?u._y(n):u._y(i),node:i,r:u._size?n!==void 0&&u._size(n)!==void 0?u._size(n):u._size(i):1,shape:n!==void 0&&u._shape(n)!==void 0?u._shape(n):u._shape(i)}});var y=t.extent(_.map(function(e){return e.fx})),g=t.extent(_.map(function(e){return e.fy}));var m=i.scaleLinear().domain(y).range([0,d]),v=i.scaleLinear().domain(g).range([0,c]);var x=(y[1]-y[0])/(g[1]-g[0]),z=d/c;if(x>z){var k=c*z/x;v.range([(c-k)/2,c-(c-k)/2])}else{var w=d*x/z;m.range([(d-w)/2,d-(d-w)/2])}_.forEach(function(e){e.x=m(e.fx);e.y=v(e.fy)});var M=t.extent(_.map(function(e){return e.r}));var b=this._sizeMax||t.min(t.merge(_.map(function(e){return _.map(function(t){return e===t?null:o.pointDistance(e,t)})})))/2;var C=i["scale"+this._sizeScale.charAt(0).toUpperCase()+this._sizeScale.slice(1)]().domain(M).range([M[0]===M[1]?b:this._sizeMin,b]),q=m.domain(),S=v.domain();var A=q[1]-q[0],O=S[1]-S[0];_.forEach(function(e){var t=C(e.r);if(q[0]>m.invert(e.x-t)){q[0]=m.invert(e.x-t)}if(q[1]<m.invert(e.x+t)){q[1]=m.invert(e.x+t)}if(S[0]>v.invert(e.y-t)){S[0]=v.invert(e.y-t)}if(S[1]<v.invert(e.y+t)){S[1]=v.invert(e.y+t)}});var P=q[1]-q[0],j=S[1]-S[0];b*=t.min([A/P,O/j]);C.range([M[0]===M[1]?b:this._sizeMin,b]);m.domain(q);v.domain(S);_.forEach(function(e){e.x=m(e.fx);e.fx=e.x;e.y=v(e.fy);e.fy=e.y;e.r=C(e.r);e.width=e.r*2;e.height=e.r*2});var B=_.map(function(e){return e.node});var G=this._links.map(function(e){return{source:typeof e.source==="number"?_[B.indexOf(u._nodes[e.source])]:e.source,target:typeof e.target==="number"?_[B.indexOf(u._nodes[e.target])]:e.target}});this._shapes.push((new o.Path).config(this._shapeConfigPrep("Path")).d(function(e){return"M"+e.source.x+","+e.source.y+" "+e.target.x+","+e.target.y}).data(G).select(s.elem("g.d3plus-network-links",{parent:h,transition:p,enter:{transform:f},update:{transform:f}}).node()).render());var E={label:function(e){return u._drawLabel(e.data||e.node,e.i)},select:s.elem("g.d3plus-network-nodes",{parent:h,transition:p,enter:{transform:f},update:{transform:f}}).node(),x:function(e){return e.x},y:function(e){return e.y}};n.nest().key(function(e){return e.shape}).entries(_).forEach(function(e){u._shapes.push((new o[e.key]).config(u._shapeConfigPrep(e.key)).config(E).data(e.values).render())});return this};a.prototype.links=function e(t){return arguments.length?(this._links=t,this):this._links};a.prototype.nodeGroupBy=function e(t){var n=this;if(!arguments.length){return this._nodeGroupBy}if(!(t instanceof Array)){t=[t]}return this._nodeGroupBy=t.map(function(e){if(typeof e==="function"){return e}else{if(!n._aggs[e]){n._aggs[e]=function(e){var t=Array.from(new Set(e));return t.length===1?t[0]:t}}return s.accessor(e)}}),this};a.prototype.nodes=function e(t){return arguments.length?(this._nodes=t,this):this._nodes};a.prototype.x=function e(n){if(arguments.length){if(typeof n==="function"){this._x=n}else{this._x=s.accessor(n);if(!this._aggs[n]){this._aggs[n]=function(e){return t.mean(e)}}}return this}else{return this._x}};a.prototype.size=function e(t){return arguments.length?(this._size=typeof t==="function"||!t?t:s.accessor(t),this):this._size};a.prototype.sizeMax=function e(t){return arguments.length?(this._sizeMax=t,this):this._sizeMax};a.prototype.sizeMin=function e(t){return arguments.length?(this._sizeMin=t,this):this._sizeMin};a.prototype.sizeScale=function e(t){return arguments.length?(this._sizeScale=t,this):this._sizeScale};a.prototype.y=function e(n){if(arguments.length){if(typeof n==="function"){this._y=n}else{this._y=s.accessor(n);if(!this._aggs[n]){this._aggs[n]=function(e){return t.mean(e)}}}return this}else{return this._y}};return a}(a.Viz);e.Network=u;Object.defineProperty(e,"__esModule",{value:true})});