/*
  d3plus-network v0.1.9
  Javascript network visualizations built upon d3 modules.
  Copyright (c) 2017 D3plus - https://d3plus.org
  @license MIT
*/
if(typeof Object.assign!=="function"){Object.defineProperty(Object,"assign",{value:function t(e){"use strict";if(e===null){throw new TypeError("Cannot convert undefined or null to object")}var r=Object(e);for(var o=1;o<arguments.length;o++){var n=arguments[o];if(n!==null){for(var i in n){if(Object.prototype.hasOwnProperty.call(n,i)){r[i]=n[i]}}}}return r},writable:true,configurable:true})}if(!Array.prototype.includes){Object.defineProperty(Array.prototype,"includes",{value:function t(e,r){var o=Object(this);var n=o.length>>>0;if(n===0)return false;var i=r|0;var s=Math.max(i>=0?i:n-Math.abs(i),0);function a(t,e){return t===e||typeof t==="number"&&typeof e==="number"&&isNaN(t)&&isNaN(e)}while(s<n){if(a(o[s],e)){return true}s++}return false}})}(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3-array"),require("d3-brush"),require("d3-collection"),require("d3-selection"),require("d3-scale"),require("d3-zoom"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-viz")):typeof define==="function"&&define.amd?define("d3plus-network",["exports","d3-array","d3-brush","d3-collection","d3-selection","d3-scale","d3-zoom","d3plus-common","d3plus-shape","d3plus-viz"],e):e(t.d3plus={},t.d3Array,t.d3Brush,t.d3Collection,t.d3Selection,t.scales,t.d3Zoom,t.d3plusCommon,t.shapes,t.d3plusViz)})(this,function(t,e,r,o,n,i,s,a,u,h){"use strict";var l=function(t){function h(){var e=this;t.call(this);this._brushFilter=function(){return!n.event.button&&n.event.detail<2};this._handleConfig={fill:"#444"};this._handleSize=6;this._links=[];this._nodes=[];this._on["click.shape"]=function(t,r){e._tooltipClass.data([]).render();if(e._hover&&e._drawDepth>=e._groupBy.length-1){if(e._focus&&e._focus===t.id){e.active(false);e._on.mouseenter.bind(e)(t,r);e._focus=undefined;e._zoomToBounds(null)}else{var o=e._nodeGroupBy&&e._nodeGroupBy[e._drawDepth](t,r)?e._nodeGroupBy[e._drawDepth](t,r):e._id(t,r),n=e._linkLookup[o],i=e._nodeLookup[o];var s=[i.id],a=[i.x-i.r,i.x+i.r],u=[i.y-i.r,i.y+i.r];n.forEach(function(t){s.push(t.id);if(t.x-t.r<a[0]){a[0]=t.x-t.r}if(t.x+t.r>a[1]){a[1]=t.x+t.r}if(t.y-t.r<u[0]){u[0]=t.y-t.r}if(t.y+t.r>u[1]){u[1]=t.y+t.r}});e.active(function(t,r){if(t.source&&t.target){return t.source.id===i.id||t.target.id===i.id}else{return s.includes(e._ids(t,r)[e._drawDepth])}});e._focus=t.id;e._zoomToBounds([[a[0],u[0]],[a[1],u[1]]])}}};this._on["click.legend"]=function(t,r){var o=e._id(t);var n=e._ids(t);n=n[n.length-1];if(e._hover&&e._drawDepth>=e._groupBy.length-1){if(e._focus&&e._focus===o){e.active(false);e._on.mouseenter.bind(e)(t,r);e._focus=undefined;e._zoomToBounds(null)}else{var i=o.map(function(t){return e._nodeLookup[t]});var s=[n],a=[i[0].x-i[0].r,i[0].x+i[0].r],u=[i[0].y-i[0].r,i[0].y+i[0].r];i.forEach(function(t){s.push(t.id);if(t.x-t.r<a[0]){a[0]=t.x-t.r}if(t.x+t.r>a[1]){a[1]=t.x+t.r}if(t.y-t.r<u[0]){u[0]=t.y-t.r}if(t.y+t.r>u[1]){u[1]=t.y+t.r}});e.active(function(t,r){if(t.source&&t.target){return s.includes(t.source.id)&&s.includes(t.target.id)}else{var o=e._ids(t,r);return s.includes(o[o.length-1])}});e._focus=o;e._zoomToBounds([[a[0],u[0]],[a[1],u[1]]])}e._on["mousemove.legend"].bind(e)(t,r)}};this._selectionConfig={fill:"#777","stroke-width":0};this._sizeMin=5;this._sizeScale="sqrt";this._shape=a.constant("Circle");this._shapeConfig=a.assign(this._shapeConfig,{labelConfig:{textAnchor:"middle",verticalAlign:"middle"},Path:{fill:"none",label:false,stroke:"#eee",strokeWidth:1}});this._x=a.accessor("x");this._y=a.accessor("y");this._zoom=true;this._zoomBehavior=s.zoom();this._zoomBrush=r.brush().on("start",this._brushStart.bind(this)).on("brush",this._brushBrush.bind(this)).on("end",this._brushEnd.bind(this));this._zoomMax=16;this._zoomPan=true;this._zoomScroll=true}if(t)h.__proto__=t;h.prototype=Object.create(t&&t.prototype);h.prototype.constructor=h;h.prototype._brushBrush=function t(){this._brushStyle()};h.prototype._brushEnd=function t(){if(!n.event.sourceEvent){return}this._brushStyle()};h.prototype._brushStart=function t(){this._brushStyle()};h.prototype._brushStyle=function t(){this._brushGroup.selectAll(".selection").call(a.attrize,this._selectionConfig);this._brushGroup.selectAll(".handle").call(a.attrize,this._handleConfig)};h.prototype._zoomed=function t(){this._zoomGroup.attr("transform",n.event.transform)};h.prototype._zoomEvents=function t(e){if(e===void 0)e=false;if(e){this._brushGroup.style("display","inline");this._networkGroup.on(".zoom",null)}else if(this._zoom){this._brushGroup.style("display","none");this._networkGroup.call(this._zoomBehavior);if(!this._zoomScroll){this._networkGroup.on("mousewheel.zoom",null).on("MozMousePixelScroll.zoom",null).on("wheel.zoom",null)}if(!this._zoomPan){this._networkGroup.on("mousedown.zoom",null).on("mousemove.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null)}}else{this._networkGroup.on(".zoom",null)}};h.prototype._zoomToBounds=function t(e){if(e){var r=this._zoomBehavior.translateExtent()[1];var o=r[0];var n=r[1];var i=e[1][0]-e[0][0],a=e[1][1]-e[0][1],u=(e[0][0]+e[1][0])/2,h=(e[0][1]+e[1][1])/2;var l=Math.max(1,Math.min(this._zoomMax,.9/Math.max(i/o,a/n)));var c=[o/2-l*u,n/2-l*h];var d=s.zoomIdentity.translate(c[0],c[1]).scale(l);this._networkGroup.transition().duration(this._zoomBehavior.duration()).call(this._zoomBehavior.transform,d)}else{this._networkGroup.transition().duration(this._zoomBehavior.duration()).call(this._zoomBehavior.transform,s.zoomIdentity)}};h.prototype.render=function r(n){var s=this;t.prototype.render.call(this,n);var h=this._height-this._margin.top-this._margin.bottom,l="translate("+this._margin.left+", "+this._margin.top+")",c=this._transition,d=this._width-this._margin.left-this._margin.right;var f=this._filteredData.reduce(function(t,e,r){t[s._id(e,r)]=e;return t},{});var _=this._nodes.reduce(function(t,e,r){t[s._nodeGroupBy?s._nodeGroupBy[s._drawDepth](e,r):s._id(e,r)]=e;return t},{});_=Array.from(new Set(Object.keys(f).concat(Object.keys(_)))).map(function(t,e){var r=f[t],o=_[t];return{__d3plus__:true,data:r||o,i:e,id:t,fx:r!==undefined&&s._x(r)!==undefined?s._x(r):s._x(o),fy:r!==undefined&&s._y(r)!==undefined?s._y(r):s._y(o),node:o,r:s._size?r!==undefined&&s._size(r)!==undefined?s._size(r):s._size(o):s._sizeMin,shape:r!==undefined&&s._shape(r)!==undefined?s._shape(r):s._shape(o)}});var p=e.extent(_.map(function(t){return t.fx})),m=e.extent(_.map(function(t){return t.fy}));var y=i.scaleLinear().domain(p).range([0,d]),g=i.scaleLinear().domain(m).range([0,h]);var z=(p[1]-p[0])/(m[1]-m[0]),v=d/h;if(z>v){var x=h*v/z;g.range([(h-x)/2,h-(h-x)/2])}else{var b=d*z/v;y.range([(d-b)/2,d-(d-b)/2])}_.forEach(function(t){t.x=y(t.fx);t.y=g(t.fy)});var w=e.extent(_.map(function(t){return t.r}));var k=this._sizeMax||e.min(e.merge(_.map(function(t){return _.map(function(e){return t===e?null:u.pointDistance([t.x,t.y],[e.x,e.y])})})))/2;var G=i["scale"+this._sizeScale.charAt(0).toUpperCase()+this._sizeScale.slice(1)]().domain(w).range([w[0]===w[1]?k:e.min([k/2,this._sizeMin]),k]),B=y.domain(),M=g.domain();var S=B[1]-B[0],A=M[1]-M[0];_.forEach(function(t){var e=G(t.r);if(B[0]>y.invert(t.x-e)){B[0]=y.invert(t.x-e)}if(B[1]<y.invert(t.x+e)){B[1]=y.invert(t.x+e)}if(M[0]>g.invert(t.y-e)){M[0]=g.invert(t.y-e)}if(M[1]<g.invert(t.y+e)){M[1]=g.invert(t.y+e)}});var C=B[1]-B[0],E=M[1]-M[0];k*=e.min([S/C,A/E]);G.range([w[0]===w[1]?k:e.min([k/2,this._sizeMin]),k]);y.domain(B);g.domain(M);_.forEach(function(t){t.x=y(t.fx);t.fx=t.x;t.y=g(t.fy);t.fy=t.y;t.r=G(t.r);t.width=t.r*2;t.height=t.r*2});var O=this._nodeLookup=_.reduce(function(t,e){t[e.id]=e;return t},{});var P=_.map(function(t){return t.node});var j=this._links.map(function(t){return{source:typeof t.source==="number"?_[P.indexOf(s._nodes[t.source])]:O[t.source.id],target:typeof t.target==="number"?_[P.indexOf(s._nodes[t.target])]:O[t.target.id]}});this._linkLookup=j.reduce(function(t,e){if(!t[e.source.id]){t[e.source.id]=[]}t[e.source.id].push(e.target);if(!t[e.target.id]){t[e.target.id]=[]}t[e.target.id].push(e.source);return t},{});this._networkGroup=this._select.selectAll("svg.d3plus-network-svg").data([0]);this._networkGroup=this._networkGroup.enter().append("svg").attr("class","d3plus-network-svg").attr("opacity",0).attr("width",d).attr("height",h).style("background-color","transparent").merge(this._networkGroup);this._networkGroup.transition(this._transition).attr("opacity",1).attr("width",d).attr("height",h);var q=this._networkGroup.selectAll("rect.d3plus-network-hitArea").data([0]);q.enter().append("rect").attr("class","d3plus-network-hitArea").merge(q).attr("width",d).attr("height",h).attr("fill","transparent");this._zoomGroup=this._networkGroup.selectAll("g.d3plus-network-zoomGroup").data([0]);this._zoomGroup=this._zoomGroup.enter().append("g").attr("class","d3plus-network-zoomGroup").merge(this._zoomGroup);this._zoomBrush.extent([[0,0],[d,h]]).filter(this._brushFilter).handleSize(this._handleSize);var D=this._select.selectAll("g.brush").data([0]);this._brushGroup=D.enter().append("g").attr("class","brush").merge(D).call(this._zoomBrush);this._zoomBehavior.scaleExtent([1,this._zoomMax]).translateExtent([[0,0],[d,h]]).on("zoom",this._zoomed.bind(this));var L=this._zoomGroup;this._shapes.push((new u.Path).config(this._shapeConfig).config(this._shapeConfig.Path).d(function(t){return"M"+t.source.x+","+t.source.y+" "+t.target.x+","+t.target.y}).data(j).select(a.elem("g.d3plus-network-links",{parent:L,transition:c,enter:{transform:l},update:{transform:l}}).node()).render());var T={label:function(t){return s._drawLabel(t.data||t.node,t.i)},select:a.elem("g.d3plus-network-nodes",{parent:L,transition:c,enter:{transform:l},update:{transform:l}}).node()};o.nest().key(function(t){return t.shape}).entries(_).forEach(function(t){s._shapes.push((new u[t.key]).config(a.configPrep.bind(s)(s._shapeConfig,"shape",t.key)).config(T).data(t.values).render())});this._zoomEvents();return this};h.prototype.links=function t(e){return arguments.length?(this._links=e,this):this._links};h.prototype.nodeGroupBy=function t(e){var r=this;if(!arguments.length){return this._nodeGroupBy}if(!(e instanceof Array)){e=[e]}return this._nodeGroupBy=e.map(function(t){if(typeof t==="function"){return t}else{if(!r._aggs[t]){r._aggs[t]=function(t){var e=Array.from(new Set(t));return e.length===1?e[0]:e}}return a.accessor(t)}}),this};h.prototype.nodes=function t(e){return arguments.length?(this._nodes=e,this):this._nodes};h.prototype.size=function t(e){return arguments.length?(this._size=typeof e==="function"||!e?e:a.accessor(e),this):this._size};h.prototype.sizeMax=function t(e){return arguments.length?(this._sizeMax=e,this):this._sizeMax};h.prototype.sizeMin=function t(e){return arguments.length?(this._sizeMin=e,this):this._sizeMin};h.prototype.sizeScale=function t(e){return arguments.length?(this._sizeScale=e,this):this._sizeScale};h.prototype.x=function t(r){if(arguments.length){if(typeof r==="function"){this._x=r}else{this._x=a.accessor(r);if(!this._aggs[r]){this._aggs[r]=function(t){return e.mean(t)}}}return this}else{return this._x}};h.prototype.y=function t(r){if(arguments.length){if(typeof r==="function"){this._y=r}else{this._y=a.accessor(r);if(!this._aggs[r]){this._aggs[r]=function(t){return e.mean(t)}}}return this}else{return this._y}};h.prototype.zoom=function t(e){return arguments.length?(this._zoom=e,this):this._zoom};h.prototype.zoomMax=function t(e){return arguments.length?(this._zoomMax=e,this):this._zoomMax};h.prototype.zoomPan=function t(e){return arguments.length?(this._zoomPan=e,this):this._zoomPan};h.prototype.zoomScroll=function t(e){return arguments.length?(this._zoomScroll=e,this):this._zoomScroll};return h}(h.Viz);t.Network=l;Object.defineProperty(t,"__esModule",{value:true})});