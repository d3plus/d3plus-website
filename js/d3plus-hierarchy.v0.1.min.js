/*
  d3plus-hierarchy v0.1.0
  Nested, hierarchical, and cluster charts built on D3
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3-array"),require("d3-hierarchy"),require("d3-scale"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-viz"),require("d3-collection")):typeof define==="function"&&define.amd?define("d3plus-hierarchy",["exports","d3-array","d3-hierarchy","d3-scale","d3plus-common","d3plus-shape","d3plus-viz","d3-collection"],e):e(t.d3plus=t.d3plus||{},t.d3Array,t.d3Hierarchy,t.d3Scale,t.d3plusCommon,t.d3plusShape,t.d3plusViz,t.d3Collection)})(this,function(t,e,r,i,n,a,s,h){"use strict";var o=function(t,e){if(!(e instanceof Array))e=[e];var r=h.nest();for(var i=0;i<e.length;i++)r.key(e[i]);var n=r.entries(t);return l(n)};function l(t){return t.map(function(t){if(t.key&&t.values){if(t.values[0].key==="undefined")return t.values[0].values[0];else t.values=l(t.values)}return t})}var u=function(t){function s(){var e=this;t.call(this);this._orient="vertical";this._separation=function(t,e){return t.parent===e.parent?1:2};this._shapeConfig=Object.assign({},this._shapeConfig,{Circle:{fontColor:"#444",id:function(t,r){return e._ids(t,r).join("-")},label:function(t,r){if(e._label)return e._label(t.data,r);var i=e._ids(t,r).slice(0,t.depth);return i[i.length-1]},hitArea:function(t,r,i){return{width:e._labelWidths[t.depth-1],height:i.r*2+e._labelHeight,x:-e._labelWidths[t.depth-1]/2,y:t.children&&t.depth!==e._groupBy.length?-(i.r+e._labelHeight):-i.r}},labelBounds:function(t,r,i){var n=e._labelHeight,a=e._orient==="vertical"?"height":"width",s=e._labelWidths[t.depth-1],h=e._orient==="vertical"?"width":"height",o=e._orient==="vertical"?"x":"y",l=e._orient==="vertical"?"y":"x";var u;return u={},u[h]=s,u[a]=n,u[o]=-s/2,u[l]=t.children&&t.depth!==e._groupBy.length?-(i.r+n):i.r,u},r:n.constant(5),textAnchor:function(t){return e._orient==="vertical"?"middle":t.children&&t.depth!==e._groupBy.length?"end":"start"},verticalAlign:function(t){return e._orient==="vertical"?t.depth===1?"bottom":"top":"middle"}},Path:{d:function(t){var r=e._shapeConfig.Circle.r(t.data,t.i);var i=t.parent.x-t.x+(e._orient==="vertical"?0:r),n=t.parent.y-t.y+(e._orient==="vertical"?r:0),a=e._orient==="vertical"?0:-r,s=e._orient==="vertical"?-r:0;return e._orient==="vertical"?"M"+a+","+s+"C"+a+","+(s+n)/2+" "+i+","+(s+n)/2+" "+i+","+n:"M"+a+","+s+"C"+(a+i)/2+","+s+" "+(a+i)/2+","+n+" "+i+","+n},fill:"none",id:function(t,r){return e._ids(t,r).join("-")},stroke:"#ccc",strokeWidth:1}});this._tree=r.tree()}if(t)s.__proto__=t;s.prototype=Object.create(t&&t.prototype);s.prototype.constructor=s;s.prototype.render=function s(h){var l=this;t.prototype.render.call(this,h);var u=this._orient==="vertical"?this._height-this._margin.top-this._margin.bottom:this._width-this._margin.left-this._margin.right,d=this._orient==="vertical"?"left":"top",p=this,c="translate("+this._margin.left+", "+this._margin.top+")",_=this._orient==="horizontal"?this._height-this._margin.top-this._margin.bottom:this._width-this._margin.left-this._margin.right;var f=this._tree.separation(this._separation).size([_,u])(r.hierarchy({key:"root",values:o(this._filteredData,this._groupBy.slice(0,this._drawDepth+1))},function(t){return t.key&&t.values?t.values:null}).sort(this._sort)).descendants().filter(function(t){return t.depth<=l._groupBy.length&&t.parent});function g(t){return n.merge(t.values.map(function(t){return t.key&&t.values?g(t):t}),p._aggs)}f.forEach(function(t,e){if(t.data.key&&t.data.values)t.data=g(t.data);t.__d3plus__=true;t.i=e});var v=this._shapeConfig.Circle.r;var y=e.max(f,function(t){return t.depth===1?v(t.data,t.i):0});var m=e.max(f,function(t){return t.children?0:v(t.data,t.i)});var b=e.extent(f,function(t){return t.y});this._labelHeight=e.min([this._orient==="vertical"?50:100,(b[1]-y-m)/(this._groupBy.length+1)]);this._labelWidths=o(f,function(t){return t.depth}).map(function(t){return t.values.reduce(function(r,i,n){var a=n<t.values.length-1?t.values[n+1].x:_+l._margin[d],s=n?t.values[n-1].x:l._margin[d];return e.min([r,a-i.x,i.x-s])},_)});var x=i.scaleLinear().domain(b).range([y+this._labelHeight,u-m-this._labelHeight]);f.forEach(function(t){var e=x(t.y);if(l._orient==="horizontal"){t.y=t.x;t.x=e}else t.y=e});var w={parent:this._select,enter:{transform:c},update:{transform:c}};this._shapes.push((new a.Path).data(f.filter(function(t){return t.depth>1})).select(n.elem("g.d3plus-Tree-Links",w).node()).config(this._shapeConfigPrep("Path")).render());this._shapes.push((new a.Circle).data(f).select(n.elem("g.d3plus-Tree-Shapes",w).node()).config(this._shapeConfigPrep("Circle")).render());return this};s.prototype.orient=function t(e){return arguments.length?(this._orient=e,this):this._orient};s.prototype.separation=function t(e){return arguments.length?(this._separation=e,this):this._separation};return s}(s.Viz);var d=function(t){function e(){t.call(this);this._padding=1;this._shapeConfig=Object.assign({},this._shapeConfig,{Rect:{fontResize:true,height:function(t){return t.y1-t.y0},labelBounds:function(t,e,r){var i=r.height;var n=Math.min(50,i*.25);return[{width:r.width,height:i-n,x:-r.width/2,y:-i/2},{width:r.width,height:n,x:-r.width/2,y:i/2-n}]},textAnchor:["start","middle"],width:function(t){return t.x1-t.x0},verticalAlign:["top","bottom"]}});this._sort=function(t,e){return e.value-t.value};this._sum=n.accessor("value");this._tile=r.treemapSquarify;this._treemap=r.treemap().round(true)}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;e.prototype.render=function e(i){var s=this;t.prototype.render.call(this,i);var o=h.nest();for(var l=0;l<=this._drawDepth;l++)o.key(s._groupBy[l]);o=o.entries(this._filteredData);var u=this._treemap.padding(this._padding).size([this._width-this._margin.left-this._margin.right,this._height-this._margin.top-this._margin.bottom]).tile(this._tile)(r.hierarchy({values:o},function(t){return t.values}).sum(this._sum).sort(this._sort));var d=[],p=this;function c(t){for(var e=0;e<t.length;e++){var r=t[e];if(r.depth<=p._drawDepth)c(r.children);else{r.__d3plus__=true;r.id=r.data.key;r.data=n.merge(r.data.values);r.i=e;r.x=r.x0+(r.x1-r.x0)/2;r.y=r.y0+(r.y1-r.y0)/2;d.push(r)}}}if(u.children)c(u.children);var _=u.value;var f="translate("+this._margin.left+", "+this._margin.top+")";this._shapes.push((new a.Rect).data(d).label(function(t){return[s._drawLabel(t.data,t.i),Math.round(s._sum(t.data,t.i)/_*100)+"%"]}).select(n.elem("g.d3plus-Treemap",{parent:this._select,enter:{transform:f},update:{transform:f}}).node()).config(this._shapeConfigPrep("Rect")).render());return this};e.prototype.padding=function t(e){return arguments.length?(this._padding=typeof e==="function"?e:n.constant(e),this):this._padding};e.prototype.sort=function t(e){return arguments.length?(this._sort=e,this):this._sort};e.prototype.sum=function t(e){return arguments.length?(this._sum=typeof e==="function"?e:n.constant(e),this):this._sum};e.prototype.tile=function t(e){return arguments.length?(this._tile=e,this):this._tile};return e}(s.Viz);t.Tree=u;t.Treemap=d;Object.defineProperty(t,"__esModule",{value:true})});