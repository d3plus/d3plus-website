/*
  d3plus-viz v0.4.9
  Abstract ES6 class that drives d3plus visualizations.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,i){typeof exports==="object"&&typeof module!=="undefined"?i(exports,require("d3-array"),require("d3-color"),require("d3-collection"),require("d3-selection"),require("d3-transition"),require("d3plus-axis"),require("d3plus-color"),require("d3plus-common"),require("d3plus-legend"),require("d3plus-text"),require("d3plus-timeline"),require("d3plus-tooltip")):typeof define==="function"&&define.amd?define("d3plus-viz",["exports","d3-array","d3-color","d3-collection","d3-selection","d3-transition","d3plus-axis","d3plus-color","d3plus-common","d3plus-legend","d3plus-text","d3plus-timeline","d3plus-tooltip"],i):i(t.d3plus=t.d3plus||{},t.d3Array,t.d3Color,t.d3Collection,t.d3Selection,t.d3Transition,t.d3plusAxis,t.d3plusColor,t.d3plusCommon,t.d3plusLegend,t.d3plusText,t.d3plusTimeline,t.d3plusTooltip)})(this,function(t,i,e,n,s,r,o,h,a,l,u,d,p){"use strict";var _=function(t,e,s){if(s===void 0)s=[];if(s&&!(s instanceof Array)){s=[s]}var r=n.nest().key(e).entries(t);if(r.length<2){return{data:[],id:e}}var o,h;if(s.length){var l=r.length;var u=function(e){var u=r.map(function(t){return Array.from(new Set(t.values.map(function(t){return s[e](t)})))}),d=i.sum(u,function(t){return t.length}),p=new Set(i.merge(u)).size;if(d===l&&p===l||e===s.length-1){h=s[e];o=n.nest().key(h).entries(t).map(function(t){return a.merge(t.values)});return"break"}};for(var d=0;d<s.length;d++){var p=u(d);if(p==="break")break}}else{h=e;o=r.map(function(t){return a.merge(t.values)})}return{data:o,id:h}};function f(t,i){if(t.tagName===undefined||["BODY","HTML"].indexOf(t.tagName)>=0){var e=window["inner"+(i.charAt(0).toUpperCase()+i.slice(1))];var n=s.select(t);if(i==="width"){e-=parseFloat(n.style("margin-left"),10);e-=parseFloat(n.style("margin-right"),10);e-=parseFloat(n.style("padding-left"),10);e-=parseFloat(n.style("padding-right"),10)}else{e-=parseFloat(n.style("margin-top"),10);e-=parseFloat(n.style("margin-bottom"),10);e-=parseFloat(n.style("padding-top"),10);e-=parseFloat(n.style("padding-bottom"),10)}return e}else{var r=parseFloat(s.select(t).style(i),10);if(typeof r==="number"&&r>0){return r}else{return f(t.parentNode,i)}}}var g=function(t){return[f(t,"width"),f(t,"height")]};var c=function(t,i){this._select.style("cursor","auto");if(this._drawDepth<this._groupBy.length-1){var e=this._groupBy[this._drawDepth],n=e(t,i);this.highlight(false);if(this._tooltip){this._tooltipClass.data([]).render()}this._history.push({depth:this._depth,filter:this._filter});this.config({depth:this._drawDepth+1,filter:function(t,i){return e(t,i)===n}}).render()}};var m=function(t,i){var e=this;var n=this._ids(t,i);this.highlight(function(t,i){var s=e._ids(t,i);return n[n.length-1]===s[n.length-1]})};var y=function(t){if(this._tooltip){var i=this._drawDepth<this._groupBy.length-1;this._select.style("cursor",i?"pointer":"auto");this._tooltipClass.data([t]).footer(i?"Click to Expand":"").title(this._legendClass.label()).translate(s.mouse(s.select("html").node())).render()}};var v=function(t){if(this._tooltip){var i=this._drawDepth<this._groupBy.length-1;this._select.style("cursor",i?"pointer":"auto");this._tooltipClass.data([t]).footer(i?"Click to Expand":"").title(this._drawLabel).translate(s.mouse(s.select("html").node())).render()}};var C=function(){if(this._tooltip){this._tooltipClass.translate(s.mouse(s.select("html").node())).render()}};var w=function(){this.highlight(false);this._select.style("cursor","auto");if(this._tooltip){this._tooltipClass.data([]).render()}};var b=function(t){function f(){var i=this;t.call(this);this._aggs={};this._backClass=(new u.TextBox).on("click",function(){if(i._history.length){i.config(i._history.pop()).render()}else{i.depth(i._drawDepth-1).filter(false).render()}}).on("mousemove",function(){return i._backClass.select().style("cursor","pointer")});this._data=[];this._duration=600;this._highlightOpacity=.5;this._history=[];this._groupBy=[a.accessor("id")];this._legend=true;this._legendConfig={shapeConfig:{fontResize:false}};this._legendClass=new l.Legend;this._on={click:c.bind(this),mouseenter:m.bind(this),"mouseenter.legend":y.bind(this),"mouseenter.shape":v.bind(this),mousemove:C.bind(this),mouseleave:w.bind(this)};this._padding=5;this._shapes=[];this._shapeConfig={fill:function(t,e){return h.assign(i._groupBy[0](t,e))},opacity:a.constant(1),stroke:function(t,n){return e.color(h.assign(i._groupBy[0](t,n))).darker()},strokeWidth:a.constant(0)};this._timeline=true;this._timelineClass=(new d.Timeline).align("end").on("end",function(t){if(!(t instanceof Array)){t=[t,t]}t=t.map(Number);i._timelineClass.selection(t);i.timeFilter(function(e){var n=o.date(i._time(e)).getTime();return n>=t[0]&&n<=t[1]}).render()});this._timelineConfig={};this._tooltip=true;this._tooltipClass=(new p.Tooltip).pointerEvents("none");this._tooltipConfig={duration:50}}if(t)f.__proto__=t;f.prototype=Object.create(t&&t.prototype);f.prototype.constructor=f;f.prototype._shapeConfigPrep=function t(i){var e=this;if(i===void 0)i=false;var n={duration:this._duration};var s=function(t){if({}.hasOwnProperty.call(e._shapeConfig,t)){if(typeof e._shapeConfig[t]==="function"){n[t]=function(i,n,s){return e._shapeConfig[t](i.__d3plus__?i.data:i,i.__d3plus__?i.i:n,s)}}else{n[t]=e._shapeConfig[t]}}};for(var r in this._shapeConfig)s(r);n.on=Object.keys(this._on).filter(function(t){return!t.includes(".")||t.includes(".shape")}).reduce(function(t,i){t[i]=function(t,n){return e._on[i]?e._on[i](t.__d3plus__?t.data:t,t.__d3plus__?t.i:n):null};return t},{});if(i&&this._shapeConfig[i]){n=a.assign(n,this._shapeConfig[i])}return n};f.prototype._uiGroup=function t(i,e){if(e===void 0)e=true;return a.elem("g.d3plus-viz-"+i,{condition:e,enter:{transform:"translate(0, "+this._height/2+")"},exit:{opacity:0},parent:this._select,transition:this._transition,update:{opacity:1,transform:"translate(0, "+this._height/2+")"}})};f.prototype.render=function t(e){var h=this;this._margin={bottom:0,left:0,right:0,top:0};this._transition=r.transition().duration(this._duration);if(this._select===void 0||this._select.node().tagName.toLowerCase()!=="svg"){var l=this._select===void 0?s.select("body"):this._select;var u=g(l.node());var d=u[0];var p=u[1];if(!this._width){this.width(d)}if(!this._height){this.height(p)}d=this._width;p=this._height;this.select(l.append("svg").style("width",d+"px").style("height",p+"px").style("display","block").node())}if(!this._width||!this._height){var f=g(this._select.node());var c=f[0];var m=f[1];if(!this._width){this.width(c)}if(!this._height){this.height(m)}}var y=this;this._drawDepth=this._depth!==void 0?this._depth:this._groupBy.length-1;this._id=this._groupBy[this._drawDepth];this._ids=function(t,i){return h._groupBy.map(function(e){return e(t.__d3plus__?t.data:t,t.__d3plus__?t.i:i)}).filter(function(t){return t!==void 0&&t.constructor!==Array})};this._drawLabel=this._label||function(t,i){var e=y._ids(t,i).filter(function(t){return t&&t.constructor!==Array});return e[e.length-1]};this._legendData=[];this._filteredData=[];if(this._data.length){var v=this._timeFilter?this._data.filter(this._timeFilter):this._data;if(this._filter){v=v.filter(this._filter)}var C=n.nest();for(var w=0;w<=this._drawDepth;w++){C.key(h._groupBy[w])}C.rollup(function(t){return h._legendData.push(a.merge(t,h._aggs))}).entries(v);if(this._discrete&&"_"+this._discrete in this){C.key(this["_"+this._discrete])}C.rollup(function(t){return h._filteredData.push(a.merge(t,h._aggs))}).entries(v)}var b=this._time&&this._timeline;var k=b?Array.from(new Set(this._data.map(this._time))).map(o.date):[];b=b&&k.length>1;var x=this._uiGroup("timeline",b);if(b){var B=this._timelineClass.domain(i.extent(k)).duration(this._duration).height(this._height/2-this._margin.bottom).select(x.node()).ticks(k.sort()).width(this._width);if(B.selection()===void 0){var D=i.extent(Array.from(new Set(i.merge(this._filteredData.map(function(t){var i=h._time(t);return i instanceof Array?i:[i]})))).map(o.date));if(D.length===1){D=D[0]}B.selection(D)}B.config(this._timelineConfig).render();this._margin.bottom+=B.outerBounds().height+B.padding()*2}var A=this._uiGroup("legend",this._legend);if(this._legend){var F=_(this._legendData,this._shapeConfig.fill,this._groupBy);this._legendClass.id(F.id).duration(this._duration).data(F.data.length>1?F.data:[]).height(this._height/2-this._margin.bottom).label(this._label||F.id).select(A.node()).verticalAlign("bottom").width(this._width).shapeConfig(this._shapeConfig).shapeConfig({on:Object.keys(this._on).filter(function(t){return!t.includes(".")||t.includes(".legend")}).reduce(function(t,i){t[i]=h._on[i];return t},{})}).config(this._legendConfig).render();var q=this._legendClass.outerBounds();if(q.height){this._margin.bottom+=q.height+this._legendClass.padding()*2}}var O=a.elem("g.d3plus-viz-titles",{parent:this._select});this._backClass.data(this._history.length?[{text:"Back",x:this._padding*2,y:0}]:[]).select(O.node()).render();this._margin.top+=this._history.length?this._backClass.fontSize()()+this._padding:0;this._tooltipClass.config(this._tooltipConfig);if(e){setTimeout(e,this._duration+100)}return this};f.prototype.aggs=function t(i){return arguments.length?(this._aggs=a.assign(this._aggs,i),this):this._aggs};f.prototype.data=function t(i){return arguments.length?(this._data=i,this):this._data};f.prototype.depth=function t(i){return arguments.length?(this._depth=i,this):this._depth};f.prototype.discrete=function t(i){return arguments.length?(this._discrete=i,this):this._discrete};f.prototype.duration=function t(i){return arguments.length?(this._duration=i,this):this._duration};f.prototype.filter=function t(i){return arguments.length?(this._filter=i,this):this._filter};f.prototype.groupBy=function t(i){var e=this;if(!arguments.length){return this._groupBy}if(!(i instanceof Array)){i=[i]}return this._groupBy=i.map(function(t){if(typeof t==="function"){return t}else{if(!e._aggs[t]){e._aggs[t]=function(t){var i=Array.from(new Set(t));return i.length===1?i[0]:i}}return a.accessor(t)}}),this};f.prototype.height=function t(i){return arguments.length?(this._height=i,this):this._height};f.prototype.highlight=function t(e){var n=this;var s=i.merge(this._shapes.map(function(t){return t.data()}));s=s.concat(this._legendClass.data());var r=e?s.filter(e):[];var o=[];r.map(this._ids).forEach(function(t){for(var i=1;i<=t.length;i++){o.push(JSON.stringify(t.slice(0,i)))}});o=o.filter(function(t,i){return o.indexOf(t)===i});var h;if(o.length){h=function(t,i){return o.includes(JSON.stringify(n._ids(t,i)))}}this._shapes.forEach(function(t){return t.highlight(h)});if(this._legend){this._legendClass.highlight(h)}return this};f.prototype.label=function t(i){return arguments.length?(this._label=typeof i==="function"?i:a.constant(i),this):this._label};f.prototype.legend=function t(i){return arguments.length?(this._legend=i,this):this._legend};f.prototype.legendConfig=function t(i){return arguments.length?(this._legendConfig=i,this):this._legendConfig};f.prototype.select=function t(i){return arguments.length?(this._select=s.select(i),this):this._select};f.prototype.shape=function t(i){return arguments.length?(this._shape=typeof i==="function"?i:a.constant(i),this):this._shape};f.prototype.shapeConfig=function t(i){return arguments.length?(this._shapeConfig=a.assign(this._shapeConfig,i),this):this._shapeConfig};f.prototype.time=function t(i){if(arguments.length){if(typeof i==="function"){this._time=i}else{this._time=a.accessor(i);if(!this._aggs[i]){this._aggs[i]=function(t){var i=Array.from(new Set(t));return i.length===1?i[0]:i}}}return this}else{return this._time}};f.prototype.timeFilter=function t(i){return arguments.length?(this._timeFilter=i,this):this._timeFilter};f.prototype.timeline=function t(i){return arguments.length?(this._timeline=i,this):this._timeline};f.prototype.timelineConfig=function t(i){return arguments.length?(this._timelineConfig=a.assign(this._timelineConfig,i),this):this._timelineConfig};f.prototype.tooltip=function t(i){return arguments.length?(this._tooltip=i,this):this._tooltip};f.prototype.tooltipConfig=function t(i){return arguments.length?(this._tooltipConfig=a.assign(this._tooltipConfig,i),this):this._tooltipConfig};f.prototype.width=function t(i){return arguments.length?(this._width=i,this):this._width};return f}(a.BaseClass);t.Viz=b;Object.defineProperty(t,"__esModule",{value:true})});