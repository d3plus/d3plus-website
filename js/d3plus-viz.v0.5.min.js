/*
  d3plus-viz v0.5.4
  Abstract ES6 class that drives d3plus visualizations.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,i){typeof exports==="object"&&typeof module!=="undefined"?i(exports,require("d3-array"),require("d3-color"),require("d3-collection"),require("d3-selection"),require("d3-transition"),require("d3plus-axis"),require("d3plus-color"),require("d3plus-common"),require("d3plus-legend"),require("d3plus-text"),require("d3plus-timeline"),require("d3plus-tooltip")):typeof define==="function"&&define.amd?define("d3plus-viz",["exports","d3-array","d3-color","d3-collection","d3-selection","d3-transition","d3plus-axis","d3plus-color","d3plus-common","d3plus-legend","d3plus-text","d3plus-timeline","d3plus-tooltip"],i):i(t.d3plus=t.d3plus||{},t.d3Array,t.d3Color,t.d3Collection,t.d3Selection,t.d3Transition,t.d3plusAxis,t.d3plusColor,t.d3plusCommon,t.d3plusLegend,t.d3plusText,t.d3plusTimeline,t.d3plusTooltip)})(this,function(t,i,e,n,s,r,o,h,a,l,_,u,f){"use strict";var d=function(){var t=this._history.length;var i=a.elem("g.d3plus-viz-back",{parent:this._select,transition:this._transition,update:{transform:"translate("+this._margin.left+", "+this._margin.top+")"}}).node();this._backClass.data(t?[{text:a.locale.t("Back",{lng:this._locale}),x:this._padding*2,y:0}]:[]).select(i).config(this._backConfig).render();this._margin.top+=t?this._backClass.fontSize()()+this._padding:0};var g=function(t,e,s){if(s===void 0)s=[];if(s&&!(s instanceof Array)){s=[s]}var r=n.nest().key(e).entries(t);if(r.length<2){return{data:[],id:e}}var o,h;if(s.length){var l=r.length;var _=function(e){var _=r.map(function(t){return Array.from(new Set(t.values.map(function(t){return s[e](t)})))}),u=i.sum(_,function(t){return t.length}),f=new Set(i.merge(_)).size;if(u===l&&f===l||e===s.length-1){h=s[e];o=n.nest().key(h).entries(t).map(function(t){return a.merge(t.values)});return"break"}};for(var u=0;u<s.length;u++){var f=_(u);if(f==="break")break}}else{h=e;o=r.map(function(t){return a.merge(t.values)})}return{data:o,id:h}};var p=function(t){var i=this;if(t===void 0)t=[];this._legendData=[];if(t.length){var e=n.nest();for(var s=0;s<=this._drawDepth;s++){e.key(i._groupBy[s])}e.rollup(function(t){return i._legendData.push(a.merge(t,i._aggs))}).entries(t)}var r=a.elem("g.d3plus-viz-legend",{condition:this._legend,parent:this._select,transition:this._transition}).node();if(this._legend){var o=g(this._legendData,this._shapeConfig.fill,this._groupBy);this._legendClass.id(o.id).duration(this._duration).data(o.data.length>1?o.data:[]).height(this._height-this._margin.bottom).label(this._label||o.id).select(r).verticalAlign("bottom").width(this._width).shapeConfig(this._shapeConfig).shapeConfig({on:Object.keys(this._on).filter(function(t){return!t.includes(".")||t.includes(".legend")}).reduce(function(t,e){t[e]=i._on[e];return t},{})}).config(this._legendConfig).render();var h=this._legendClass.outerBounds();if(h.height){this._margin.bottom+=h.height+this._legendClass.padding()*2}}};var c=function(t){if(t===void 0)t=[];var e=this._time&&this._timeline;var n=e?Array.from(new Set(this._data.map(this._time))).map(o.date):[];e=e&&n.length>1;var s=a.elem("g.d3plus-viz-timeline",{condition:e,parent:this._select,transition:this._transition}).node();if(e){var r=this._timelineClass.domain(i.extent(n)).duration(this._duration).height(this._height-this._margin.bottom).select(s).ticks(n.sort(function(t,i){return+t-+i})).width(this._width);if(this._timelineSelection===void 0){var h=i.extent(t.map(this._time).map(o.date));this._timelineSelection=h[0]===h[1]?h[0]:h;r.selection(this._timelineSelection)}r.config(this._timelineConfig).render();this._margin.bottom+=r.outerBounds().height+r.padding()*2}};var m=function(t){if(t===void 0)t=[];var i=this._title?this._title(t):false;var e=a.elem("g.d3plus-viz-title",{enter:{transform:"translate("+this._margin.left+", "+this._margin.top+")"},parent:this._select,transition:this._transition,update:{transform:"translate("+this._margin.left+", "+this._margin.top+")"}}).node();this._titleClass.data(i?[{text:i}]:[]).select(e).width(this._width-this._margin.left-this._margin.right).config(this._titleConfig).render();this._margin.top+=i?e.getBBox().height+this._padding:0};var v=function(t){if(t===void 0)t=[];var e=typeof this._total==="function"?i.sum(t.map(this._total)):this._total===true&&this._size?i.sum(t.map(this._size)):false;var n=a.elem("g.d3plus-viz-total",{enter:{transform:"translate("+this._margin.left+", "+this._margin.top+")"},parent:this._select,transition:this._transition,update:{transform:"translate("+this._margin.left+", "+this._margin.top+")"}}).node();var s=typeof e==="number";this._totalClass.data(s?[{text:a.locale.t("Total",{lng:this._locale})+": "+e}]:[]).select(n).width(this._width-this._margin.left-this._margin.right).config(this._totalConfig).render();this._margin.top+=s?n.getBBox().height+this._padding:0};function y(t,i){if(t.tagName===undefined||["BODY","HTML"].indexOf(t.tagName)>=0){var e=window["inner"+(i.charAt(0).toUpperCase()+i.slice(1))];var n=s.select(t);if(i==="width"){e-=parseFloat(n.style("margin-left"),10);e-=parseFloat(n.style("margin-right"),10);e-=parseFloat(n.style("padding-left"),10);e-=parseFloat(n.style("padding-right"),10)}else{e-=parseFloat(n.style("margin-top"),10);e-=parseFloat(n.style("margin-bottom"),10);e-=parseFloat(n.style("padding-top"),10);e-=parseFloat(n.style("padding-bottom"),10)}return e}else{var r=parseFloat(s.select(t).style(i),10);if(typeof r==="number"&&r>0){return r}else{return y(t.parentNode,i)}}}var C=function(t){return[y(t,"width"),y(t,"height")]};var b=function(t,i){this._select.style("cursor","auto");if(this._drawDepth<this._groupBy.length-1){var e=this._groupBy[this._drawDepth],n=e(t,i);this.hover(false);if(this._tooltip){this._tooltipClass.data([]).render()}this._history.push({depth:this._depth,filter:this._filter});this.config({depth:this._drawDepth+1,filter:function(t,i){return e(t,i)===n}}).render()}};var w=function(t,i){var e=this;var n=this._ids(t,i);this.hover(function(t,i){var s=e._ids(t,i);return n[n.length-1]===s[n.length-1]})};var k=function(t,i,e){if(e===void 0)e={};if(this._tooltip){this._select.style("cursor","pointer");this._tooltipClass.data([t]).footer(this._drawDepth<this._groupBy.length-1?a.locale.t("Click to Expand",{lng:this._locale}):this._active&&this._active(t,i)?!this._focus||this._focus===this._id(t,i)?a.locale.t("Click to Remove Highlight",{lng:this._locale}):a.locale.t("Click to Highlight",{lng:this._locale}):a.locale.t("Click to Highlight",{lng:this._locale})).title(this._drawLabel).translate(s.mouse(s.select("html").node())).config(e).config(this._tooltipConfig).render()}};var x=function(t,i){var e=this;if(this._hover&&this._drawDepth>=this._groupBy.length-1){if(this._active&&this._active(t,i)){this.active(false);w.bind(this)(t,i)}else{var n=this._ids(t,i);this.active(function(t,i){var s=e._ids(t,i);return n[n.length-1]===s[n.length-1]})}k.bind(this)(t,i,{title:this._legendClass.label()})}};var B=function(t,i){var e=this;if(this._hover&&this._drawDepth>=this._groupBy.length-1){if(this._active&&this._active(t,i)){this.active(false);w.bind(this)(t,i)}else{var n=this._ids(t,i);this.active(function(t,i){var s=e._ids(t,i);return n[n.length-1]===s[n.length-1]})}k.bind(this)(t,i)}};var S=function(){this.hover(false);this._select.style("cursor","auto");if(this._tooltip){this._tooltipClass.data([]).render()}};var z=function(t,i){k.bind(this)(t,i,{title:this._legendClass.label()})};var F=function(t,i){k.bind(this)(t,i)};var D=function(t){function g(){var i=this;t.call(this);this._aggs={};this._backClass=(new _.TextBox).on("click",function(){if(i._history.length){i.config(i._history.pop()).render()}else{i.depth(i._drawDepth-1).filter(false).render()}}).on("mousemove",function(){return i._backClass.select().style("cursor","pointer")});this._backConfig={fontSize:10,resize:false};this._data=[];this._duration=600;this._history=[];this._groupBy=[a.accessor("id")];this._legend=true;this._legendConfig={shapeConfig:{fontResize:false}};this._legendClass=new l.Legend;this._locale="en-US";this._on={click:b.bind(this),"click.legend":x.bind(this),"click.shape":B.bind(this),mouseenter:w.bind(this),"mousemove.legend":z.bind(this),"mousemove.shape":F.bind(this),mouseleave:S.bind(this)};this._padding=5;this._shapeConfig={fill:function(t,e){return h.assign(i._groupBy[0](t,e))},opacity:a.constant(1),stroke:function(t,n){return e.color(h.assign(i._groupBy[0](t,n))).darker()},strokeWidth:a.constant(0)};this._timeline=true;this._timelineClass=(new u.Timeline).align("end").on("brush",function(t){if(JSON.stringify(t)!==JSON.stringify(i._timelineSelection)){i._timelineSelection=t;if(!(t instanceof Array)){t=[t,t]}t=t.map(Number);i.timeFilter(function(e){var n=o.date(i._time(e)).getTime();return n>=t[0]&&n<=t[1]}).render()}});this._timelineConfig={};this._titleClass=new _.TextBox;this._titleConfig={fontSize:12,resize:false,textAnchor:"middle"};this._tooltip=true;this._tooltipClass=new f.Tooltip;this._tooltipConfig={duration:50,pointerEvents:"none"};this._totalClass=new _.TextBox;this._totalConfig={fontSize:10,resize:false,textAnchor:"middle"}}if(t)g.__proto__=t;g.prototype=Object.create(t&&t.prototype);g.prototype.constructor=g;g.prototype._shapeConfigPrep=function t(i){var e=this;if(i===void 0)i=false;var n={duration:this._duration};var s=function(t){if({}.hasOwnProperty.call(e._shapeConfig,t)){if(typeof e._shapeConfig[t]==="function"){n[t]=function(i,n,s){return e._shapeConfig[t](i.__d3plus__?i.data:i,i.__d3plus__?i.i:n,s)}}else{n[t]=e._shapeConfig[t]}}};for(var r in this._shapeConfig)s(r);n.on=Object.keys(this._on).filter(function(t){return!t.includes(".")||t.includes(".shape")}).reduce(function(t,i){t[i]=function(t,n){return e._on[i]?e._on[i](t.__d3plus__?t.data:t,t.__d3plus__?t.i:n):null};return t},{});if(i&&this._shapeConfig[i]){n=a.assign(n,this._shapeConfig[i])}return n};g.prototype.render=function t(e){var h=this;this._margin={bottom:0,left:0,right:0,top:0};this._transition=r.transition().duration(this._duration);if(this._select===void 0||this._select.node().tagName.toLowerCase()!=="svg"){var l=this._select===void 0?s.select("body"):this._select;var _=C(l.node());var u=_[0];var f=_[1];if(!this._width){this.width(u)}if(!this._height){this.height(f)}u=this._width;f=this._height;this.select(l.append("svg").style("width",u+"px").style("height",f+"px").style("display","block").node())}if(!this._width||!this._height){var g=C(this._select.node());var y=g[0];var b=g[1];if(!this._width){this.width(y)}if(!this._height){this.height(b)}}var w=this;this._drawDepth=this._depth!==void 0?this._depth:this._groupBy.length-1;this._id=this._groupBy[this._drawDepth];this._ids=function(t,i){return h._groupBy.map(function(e){return e(t.__d3plus__?t.data:t,t.__d3plus__?t.i:i)}).filter(function(t){return t!==void 0&&t.constructor!==Array})};this._drawLabel=this._label||function(t,i){var e=w._ids(t,i).filter(function(t){return t&&t.constructor!==Array});return e[e.length-1]};if(this._time&&this._timeFilter===void 0){var k=this._data.map(this._time).map(o.date);var x=this._data[0],B=0;if(this._discrete&&"_"+this._discrete in this&&this["_"+this._discrete](x,B)===this._time(x,B)){this._timeFilter=function(){return true}}else{var S=+i.max(k);this._timeFilter=function(t,i){return+o.date(h._time(t,i))===S}}}this._filteredData=[];var z=[];if(this._data.length){z=this._timeFilter?this._data.filter(this._timeFilter):this._data;if(this._filter){z=z.filter(this._filter)}var F=n.nest();for(var D=0;D<=this._drawDepth;D++){F.key(h._groupBy[D])}if(this._discrete&&"_"+this._discrete in this){F.key(this["_"+this._discrete])}F.rollup(function(t){return h._filteredData.push(a.merge(t,h._aggs))}).entries(z)}c.bind(this)(z);p.bind(this)(z);d.bind(this)();m.bind(this)(z);v.bind(this)(z);this._shapes=[];if(e){setTimeout(e,this._duration+100)}return this};g.prototype.active=function t(i){this._active=i;this._shapes.forEach(function(t){return t.active(i)});if(this._legend){this._legendClass.active(i)}return this};g.prototype.aggs=function t(i){return arguments.length?(this._aggs=a.assign(this._aggs,i),this):this._aggs};g.prototype.backConfig=function t(i){return arguments.length?(this._backConfig=a.assign(this._backConfig,i),this):this._backConfig};g.prototype.data=function t(i){return arguments.length?(this._data=i,this):this._data};g.prototype.depth=function t(i){return arguments.length?(this._depth=i,this):this._depth};g.prototype.discrete=function t(i){return arguments.length?(this._discrete=i,this):this._discrete};g.prototype.duration=function t(i){return arguments.length?(this._duration=i,this):this._duration};g.prototype.filter=function t(i){return arguments.length?(this._filter=i,this):this._filter};g.prototype.groupBy=function t(i){var e=this;if(!arguments.length){return this._groupBy}if(!(i instanceof Array)){i=[i]}return this._groupBy=i.map(function(t){if(typeof t==="function"){return t}else{if(!e._aggs[t]){e._aggs[t]=function(t){var i=Array.from(new Set(t));return i.length===1?i[0]:i}}return a.accessor(t)}}),this};g.prototype.height=function t(i){return arguments.length?(this._height=i,this):this._height};g.prototype.hover=function t(e){var n=this;var s=this._hover=e;if(typeof e==="function"){var r=i.merge(this._shapes.map(function(t){return t.data()}));r=r.concat(this._legendClass.data());var o=e?r.filter(e):[];var h=[];o.map(this._ids).forEach(function(t){for(var i=1;i<=t.length;i++){h.push(JSON.stringify(t.slice(0,i)))}});h=h.filter(function(t,i){return h.indexOf(t)===i});if(h.length){s=function(t,i){return h.includes(JSON.stringify(n._ids(t,i)))}}}this._shapes.forEach(function(t){return t.hover(s)});if(this._legend){this._legendClass.hover(s)}return this};g.prototype.label=function t(i){return arguments.length?(this._label=typeof i==="function"?i:a.constant(i),this):this._label};g.prototype.legend=function t(i){return arguments.length?(this._legend=i,this):this._legend};g.prototype.legendConfig=function t(i){return arguments.length?(this._legendConfig=i,this):this._legendConfig};g.prototype.locale=function t(i){return arguments.length?(this._locale=i,this):this._locale};g.prototype.select=function t(i){return arguments.length?(this._select=s.select(i),this):this._select};g.prototype.shape=function t(i){return arguments.length?(this._shape=typeof i==="function"?i:a.constant(i),this):this._shape};g.prototype.shapeConfig=function t(i){return arguments.length?(this._shapeConfig=a.assign(this._shapeConfig,i),this):this._shapeConfig};g.prototype.time=function t(i){if(arguments.length){if(typeof i==="function"){this._time=i}else{this._time=a.accessor(i);if(!this._aggs[i]){this._aggs[i]=function(t){var i=Array.from(new Set(t));return i.length===1?i[0]:i}}}return this}else{return this._time}};g.prototype.timeFilter=function t(i){return arguments.length?(this._timeFilter=i,this):this._timeFilter};g.prototype.timeline=function t(i){return arguments.length?(this._timeline=i,this):this._timeline};g.prototype.timelineConfig=function t(i){return arguments.length?(this._timelineConfig=a.assign(this._timelineConfig,i),this):this._timelineConfig};g.prototype.title=function t(i){return arguments.length?(this._title=typeof i==="function"?i:a.constant(i),this):this._title};g.prototype.titleConfig=function t(i){return arguments.length?(this._titleConfig=a.assign(this._titleConfig,i),this):this._titleConfig};g.prototype.tooltip=function t(i){return arguments.length?(this._tooltip=i,this):this._tooltip};g.prototype.tooltipConfig=function t(i){return arguments.length?(this._tooltipConfig=a.assign(this._tooltipConfig,i),this):this._tooltipConfig};g.prototype.total=function t(i){return arguments.length?(this._total=typeof i==="function"?i:a.accessor(i),this):this._total};g.prototype.totalConfig=function t(i){return arguments.length?(this._totalConfig=a.assign(this._totalConfig,i),this):this._totalConfig};g.prototype.width=function t(i){return arguments.length?(this._width=i,this):this._width};return g}(a.BaseClass);t.Viz=D;Object.defineProperty(t,"__esModule",{value:true})});