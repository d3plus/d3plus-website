/*
  d3plus-legend v0.6.18
  An easy to use javascript chart legend.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,i){typeof exports==="object"&&typeof module!=="undefined"?i(exports,require("d3-array"),require("d3-selection"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-text")):typeof define==="function"&&define.amd?define("d3plus-legend",["exports","d3-array","d3-selection","d3plus-common","d3plus-shape","d3plus-text"],i):i(t.d3plus=t.d3plus||{},t.d3Array,t.d3Selection,t.d3plusCommon,t.shapes,t.d3plusText)})(this,function(t,i,e,n,h,a){"use strict";var r=function(t){function r(){var e=this;t.call(this);this._align="center";this._data=[];this._duration=600;this._height=200;this._id=n.accessor("id");this._label=n.accessor("id");this._lineData=[];this._outerBounds={width:0,height:0,x:0,y:0};this._padding=5;this._shape=n.constant("Rect");this._shapeConfig={duration:this._duration,fill:n.accessor("color"),fontColor:n.constant("#444"),fontFamily:(new h.Rect).fontFamily(),fontResize:false,fontSize:n.constant(10),height:n.constant(10),hitArea:function(t){var n=e._lineData[e._data.indexOf(t)],h=i.max([n.height,n.shapeHeight]);return{width:n.width+n.shapeWidth+(n.width?e._padding:0),height:h,x:-n.shapeWidth/2,y:-h/2}},labelBounds:function(t,i,n){var h=e._lineData[t.i],a=n.r!==void 0?n.r:n.width/2;return{width:h.width,height:h.height,x:a+e._padding,y:-h.height/2}},opacity:1,r:n.constant(5),width:n.constant(10),x:function(t,i){var n=e._shapeConfig.width;var h=e._lineData[i].y;var a=e._align==="left"?0:e._align==="center"?(e._outerBounds.width-e._rowWidth(e._lineData.filter(function(t){return h===t.y})))/2:e._outerBounds.width-e._rowWidth(e._lineData.filter(function(t){return h===t.y}));return e._rowWidth(e._lineData.slice(0,i).filter(function(t){return h===t.y}))+e._padding+e._outerBounds.x+n(t,i)/2+a},y:function(t,n){var h=e._shapeConfig.height;var a=e._lineData[n];return a.y+e._titleHeight+e._outerBounds.y+i.max(e._lineData.filter(function(t){return a.y===t.y}).map(function(t){return t.height}).concat(e._data.map(function(t,i){return h(t,i)})))/2}};this._titleConfig={fontFamily:"Verdana",fontSize:12,lineHeight:13};this._verticalAlign="middle";this._width=400}if(t)r.__proto__=t;r.prototype=Object.create(t&&t.prototype);r.prototype.constructor=r;r.prototype._fetchConfig=function t(i,e,n){return typeof this._shapeConfig[i]==="function"?this._shapeConfig[i](e,n):this._shapeConfig[i]};r.prototype._rowHeight=function t(e){return i.max(e.map(function(t){return t.height}).concat(e.map(function(t){return t.shapeHeight})))+this._padding};r.prototype._rowWidth=function t(e){var n=this;return i.sum(e.map(function(t){return t.shapeWidth+t.width+n._padding*(t.width?2:1)}))-this._padding};r.prototype.render=function t(r){var s=this;if(this._select===void 0)this.select(e.select("body").append("svg").attr("width",this._width+"px").attr("height",this._height+"px").node());if(this._lineHeight===void 0)this._lineHeight=function(t,i){return s._fetchConfig("fontSize",t,i)*1.1};this._group=n.elem("g.d3plus-Legend",{parent:this._select});var o=this._height;this._titleHeight=0;if(this._title){var d=this._titleConfig.fontFamily,l=this._titleConfig.lineHeight,u=this._titleConfig.fontSize;var f=a.textWrap().fontFamily(d).fontSize(u).lineHeight(l).width(this._width).height(this._height)(this._title);this._titleHeight=l+f.lines.length+this._padding;o-=this._titleHeight}this._lineData=this._data.map(function(t,e){var n=s._fetchConfig("fontFamily",t,e),h=s._lineHeight(t,e),r=s._fetchConfig("fontSize",t,e),d=s._fetchConfig("width",t,e);var l=o-(s._data.length+1)*s._padding,u=s._width;var f=a.textWrap().fontFamily(n).fontSize(r).lineHeight(h).width(u).height(l)(s._label(t,e));f.width=Math.ceil(i.max(f.lines.map(function(t){return a.textWidth(t,{"font-family":n,"font-size":r})})))+r;f.height=Math.ceil(f.lines.length*(h+1));f.og={height:f.height,width:f.width};f.data=t;f.f=n;f.s=r;f.lh=h;f.y=0;f.id=s._id(t,e);f.i=e;f.shapeWidth=d;f.shapeHeight=s._fetchConfig("height",t,e);return f});var _;var g=this._width-this._padding*2;_=i.sum(this._lineData.map(function(t){return t.shapeWidth+s._padding*2+t.width}))-this._padding;if(_>g){var p=1,c=[];var w=i.max(this._lineData.map(function(t){return t.words.length}));this._wrapLines=function(){var t=this;p++;if(p>w)return;var e=p===1?this._lineData.slice():this._lineData.filter(function(i){return i.width+i.shapeWidth+t._padding*(i.width?2:1)>g&&i.words.length>=p}).sort(function(t,i){return i.sentence.length-t.sentence.length});if(e.length&&o>e[0].height*p){var n=false;var h=function(t){var h=e[t];var r=h.og.height*p,s=h.og.width*(1.5*(1/p));var o=a.textWrap().fontFamily(h.f).fontSize(h.s).lineHeight(h.lh).width(s).height(r)(h.sentence);if(!o.truncated){h.width=Math.ceil(i.max(o.lines.map(function(t){return a.textWidth(t,{"font-family":h.f,"font-size":h.s})})))+h.s;h.height=o.lines.length*(h.lh+1)}else{n=true;return"break"}};for(var r=0;r<e.length;r++){var s=h(r);if(s==="break")break}if(!n)this._wrapRows()}else{c=[];return}};this._wrapRows=function(){var t=this;c=[];var e=1,n=0;for(var h=0;h<this._lineData.length;h++){var a=t._lineData[h],r=a.width+t._padding*(a.width?2:1)+a.shapeWidth;if(i.sum(c.map(function(t){return i.max(t,function(t){return i.max([t.height,t.shapeHeight])})}))>o){c=[];break}if(n+r<g){n+=r}else if(r>g){c=[];t._wrapLines();break}else{n=r;e++}if(!c[e-1])c[e-1]=[];c[e-1].push(a)}};this._wrapRows();if(!c.length||i.sum(c,this._rowHeight.bind(this))+this._padding>o){_=i.sum(this._lineData.map(function(t){return t.shapeWidth+s._padding*1}))-this._padding;for(var y=0;y<this._lineData.length;y++){s._lineData[y].width=0;s._lineData[y].height=0}this._wrapRows()}if(c.length&&i.sum(c,this._rowHeight.bind(this))+this._padding<o){c.forEach(function(t,e){t.forEach(function(t){if(e){t.y=i.sum(c.slice(0,e),s._rowHeight.bind(s))}})});_=i.max(c,function(t){return i.sum(t,function(t){return t.shapeWidth+s._padding*(t.width?2:1)+t.width})})-this._padding}}var m=i.max(this._lineData,function(t,e){return i.max([t.height,s._fetchConfig("height",t.data,e)])+t.y})+this._titleHeight,v=_;this._outerBounds.width=v;this._outerBounds.height=m;var x=this._padding,C=this._padding;if(this._align==="center")x=(this._width-v)/2;else if(this._align==="right")x=this._width-this._padding-v;if(this._verticalAlign==="middle")C=(this._height-m)/2;else if(this._verticalAlign==="bottom")C=this._height-this._padding-m;this._outerBounds.x=x;this._outerBounds.y=C;(new a.TextBox).data(this._title?[{text:this._title}]:[]).duration(this._duration).select(this._group.node()).textAnchor({left:"start",center:"middle",right:"end"}[this._align]).width(this._width-this._padding*2).x(this._padding).y(this._outerBounds.y).config(this._titleConfig).render();this._shapes=[];var b=this._shapeConfig,H={id:function(t){return t.id},label:function(t){return t.label},lineHeight:function(t){return t.lH}};var D=this._data.map(function(t,i){var e={__d3plus__:true,data:t,i:i,id:s._id(t,i),label:s._lineData[i].width?s._label(t,i):false,lH:s._lineHeight(t,i),shape:s._shape(t,i)};var n=function(n){if(n!=="labelBounds"&&{}.hasOwnProperty.call(b,n)){if(typeof b[n]==="function"){e[n]=b[n](t,i);H[n]=function(t){return t[n]}}else if(n==="on"){H[n]={};var h=function(t){if({}.hasOwnProperty.call(b[n],t)){H[n][t]=function(i){if(!b[n][t])return;b[n][t].bind(this)(i.data,i.i)}}};for(var a in b[n])h(a)}}};for(var h in b)n(h);return e});["Circle","Rect"].forEach(function(t){(new h[t]).data(D.filter(function(i){return i.shape===t})).duration(s._duration).labelPadding(0).select(s._group.node()).verticalAlign("top").config(Object.assign({},b,H)).render()});if(r)setTimeout(r,this._duration+100);return this};r.prototype.align=function t(i){return arguments.length?(this._align=i,this):this._align};r.prototype.data=function t(i){return arguments.length?(this._data=i,this):this._data};r.prototype.duration=function t(i){return arguments.length?(this._duration=i,this):this._duration};r.prototype.height=function t(i){return arguments.length?(this._height=i,this):this._height};r.prototype.id=function t(i){return arguments.length?(this._id=i,this):this._id};r.prototype.label=function t(i){return arguments.length?(this._label=typeof i==="function"?i:n.constant(i),this):this._label};r.prototype.outerBounds=function t(){return this._outerBounds};r.prototype.padding=function t(i){return arguments.length?(this._padding=i,this):this._padding};r.prototype.select=function t(i){return arguments.length?(this._select=e.select(i),this):this._select};r.prototype.shape=function t(i){return arguments.length?(this._shape=typeof i==="function"?i:n.constant(i),this):this._shape};r.prototype.shapeConfig=function t(i){return arguments.length?(this._shapeConfig=Object.assign(this._shapeConfig,i),this):this._shapeConfig};r.prototype.title=function t(i){return arguments.length?(this._title=i,this):this._title};r.prototype.titleConfig=function t(i){return arguments.length?(this._titleConfig=Object.assign(this._titleConfig,i),this):this._titleConfig};r.prototype.verticalAlign=function t(i){return arguments.length?(this._verticalAlign=i,this):this._verticalAlign};r.prototype.width=function t(i){return arguments.length?(this._width=i,this):this._width};return r}(n.BaseClass);t.Legend=r;Object.defineProperty(t,"__esModule",{value:true})});