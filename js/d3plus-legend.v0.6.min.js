/*
  d3plus-legend v0.6.4
  An easy to use javascript chart legend.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("d3-array"),require("d3-collection"),require("d3-selection"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-text")):"function"==typeof define&&define.amd?define("d3plus-legend",["exports","d3-array","d3-collection","d3-selection","d3plus-common","d3plus-shape","d3plus-text"],i):i(t.d3plus=t.d3plus||{},t.d3Array,t.d3Collection,t.d3Selection,t.d3plusCommon,t.d3plus,t.d3plusText)}(this,function(t,i,e,n,h,a,s){"use strict";var r=function(t){function r(){var e=this;t.call(this);var n=new a.Shape;this._align="center",this._data=[],this._duration=600,this._height=200,this._id=h.accessor("id"),this._label=h.accessor("id"),this._lineData=[],this._outerBounds={width:0,height:0,x:0,y:0},this._padding=5,this._shape=h.constant("Rect"),this._shapeConfig={duration:this._duration,fill:h.accessor("color"),fontColor:h.constant("#444"),fontFamily:n.fontFamily(),fontSize:h.constant(10),height:h.constant(10),hitArea:function(t){var n=e._lineData[e._data.indexOf(t)],h=i.max([n.height,n.shapeHeight]);return{width:n.width+n.shapeWidth+(n.width?e._padding:0),height:h,x:-n.shapeWidth/2,y:-h/2}},labelBounds:function(t,i,n){var h=e._lineData[t.i],a=void 0!==n.r?n.r:n.width/2;return{width:h.width,height:h.height,x:a+e._padding,y:-h.height/2}},opacity:1,r:h.constant(5),width:h.constant(10),x:function(t,i){var n=e._shapeConfig.width,h=e._lineData[i].y,a="left"===e._align?0:"center"===e._align?(e._outerBounds.width-e._rowWidth(e._lineData.filter(function(t){return h===t.y})))/2:e._outerBounds.width-e._rowWidth(e._lineData.filter(function(t){return h===t.y}));return e._rowWidth(e._lineData.slice(0,i).filter(function(t){return h===t.y}))+e._padding+e._outerBounds.x+n(t,i)/2+a},y:function(t,n){var h=e._shapeConfig.height,a=e._lineData[n];return a.y+e._titleHeight+e._outerBounds.y+i.max(e._lineData.filter(function(t){return a.y===t.y}).map(function(t){return t.height}).concat(e._data.map(function(t,i){return h(t,i)})))/2}},this._titleConfig={fontFamily:"Verdana",fontSize:12,lineHeight:13},this._verticalAlign="middle",this._width=400}return t&&(r.__proto__=t),r.prototype=Object.create(t&&t.prototype),r.prototype.constructor=r,r.prototype._rowHeight=function(t){return i.max(t.map(function(t){return t.height}).concat(t.map(function(t){return t.shapeHeight})))+this._padding},r.prototype._rowWidth=function(t){var e=this;return i.sum(t.map(function(t){return t.shapeWidth+t.width+e._padding*(t.width?2:1)}))-this._padding},r.prototype.render=function(t){var e=this;void 0===this._select&&this.select(n.select("body").append("svg").attr("width",this._width+"px").attr("height",this._height+"px").node()),void 0===this._lineHeight&&(this._lineHeight=function(t,i){return 1.1*e._shapeConfig.fontSize(t,i)}),this._group=h.elem("g.d3plus-Legend",{parent:this._select});var a=this._height;if(this._titleHeight=0,this._title){var r=this._titleConfig.fontFamily,o=this._titleConfig.lineHeight,d=this._titleConfig.fontSize,l=s.textWrap().fontFamily(r).fontSize(d).lineHeight(o).width(this._width).height(this._height)(this._title);this._titleHeight=o+l.lines.length+this._padding,a-=this._titleHeight}this._lineData=this._data.map(function(t,n){var h=e._shapeConfig.width(t,n),r=e._shapeConfig.fontFamily(t,n),o=e._lineHeight(t,n),d=e._shapeConfig.fontSize(t,n),l=a-(e._data.length+1)*e._padding,u=e._width,_=s.textWrap().fontFamily(r).fontSize(d).lineHeight(o).width(u).height(l)(e._label(t,n));return _.width=Math.ceil(i.max(_.lines.map(function(t){return s.textWidth(t,{"font-family":r,"font-size":d})})))+d,_.height=Math.ceil(_.lines.length*(o+1)),_.og={height:_.height,width:_.width},_.data=t,_.f=r,_.s=d,_.lh=o,_.y=0,_.id=e._id(t,n),_.i=n,_.shapeWidth=h,_.shapeHeight=e._shapeConfig.height(t,n),_});var u,_=this._width-2*this._padding;if(u=i.sum(this._lineData.map(function(t){return t.shapeWidth+2*e._padding+t.width}))-this._padding,u>_){var p=1,g=[],f=i.max(this._lineData.map(function(t){return t.words.length}));if(this._wrapLines=function(){var t=this;if(p++,!(p>f)){var e=1===p?this._lineData.slice():this._lineData.filter(function(i){return i.width+i.shapeWidth+t._padding*(i.width?2:1)>_&&i.words.length>=p}).sort(function(t,i){return i.sentence.length-t.sentence.length});if(!(e.length&&a>e[0].height*p))return void(g=[]);for(var n=!1,h=function(t){var h=e[t],a=h.og.height*p,r=h.og.width*(1.5*(1/p)),o=s.textWrap().fontFamily(h.f).fontSize(h.s).lineHeight(h.lh).width(r).height(a)(h.sentence);return o.truncated?(n=!0,"break"):(h.width=Math.ceil(i.max(o.lines.map(function(t){return s.textWidth(t,{"font-family":h.f,"font-size":h.s})})))+h.s,void(h.height=o.lines.length*(h.lh+1)))},r=0;r<e.length;r++){var o=h(r);if("break"===o)break}n||this._wrapRows()}},this._wrapRows=function(){var t=this;g=[];for(var e=1,n=0,h=0;h<this._lineData.length;h++){var s=t._lineData[h],r=s.width+t._padding*(s.width?2:1)+s.shapeWidth;if(i.sum(g.map(function(t){return i.max(t,function(t){return i.max([t.height,t.shapeHeight])})}))>a){g=[];break}if(n+r<_)n+=r;else{if(r>_){g=[],t._wrapLines();break}n=r,e++}g[e-1]||(g[e-1]=[]),g[e-1].push(s)}},this._wrapRows(),!g.length||i.sum(g,this._rowHeight.bind(this))+this._padding>a){u=i.sum(this._lineData.map(function(t){return t.shapeWidth+1*e._padding}))-this._padding;for(var c=0;c<this._lineData.length;c++)e._lineData[c].width=0,e._lineData[c].height=0;this._wrapRows()}g.length&&i.sum(g,this._rowHeight.bind(this))+this._padding<a&&(g.forEach(function(t,n){t.forEach(function(t){n&&(t.y=i.sum(g.slice(0,n),e._rowHeight.bind(e)))})}),u=i.max(g,function(t){return i.sum(t,function(t){return t.shapeWidth+e._padding*(t.width?2:1)+t.width})})-this._padding)}var w=i.max(this._lineData,function(t,n){return i.max([t.height,e._shapeConfig.height(t.data,n)])+t.y})+this._titleHeight,y=u;this._outerBounds.width=y,this._outerBounds.height=w;var m=this._padding,v=this._padding;return"center"===this._align?m=(this._width-y)/2:"right"===this._align&&(m=this._width-this._padding-y),"middle"===this._verticalAlign?v=(this._height-w)/2:"bottom"===this._verticalAlign&&(v=this._height-this._padding-w),this._outerBounds.x=m,this._outerBounds.y=v,(new s.TextBox).data(this._title?[{text:this._title}]:[]).duration(this._duration).select(this._group.node()).textAnchor({left:"start",center:"middle",right:"end"}[this._align]).width(this._width-2*this._padding).x(this._padding).y(this._outerBounds.y).config(this._titleConfig).render(),this._shapes={},this.update(),t&&setTimeout(t,this._duration+100),this},r.prototype.align=function(t){return arguments.length?(this._align=t,this):this._align},r.prototype.data=function(t){return arguments.length?(this._data=t,this):this._data},r.prototype.duration=function(t){return arguments.length?(this._duration=t,this):this._duration},r.prototype.height=function(t){return arguments.length?(this._height=t,this):this._height},r.prototype.id=function(t){return arguments.length?(this._id=t,this):this._id},r.prototype.label=function(t){return arguments.length?(this._label="function"==typeof t?t:h.constant(t),this):this._label},r.prototype.outerBounds=function(){return this._outerBounds},r.prototype.padding=function(t){return arguments.length?(this._padding=t,this):this._padding},r.prototype.select=function(t){return arguments.length?(this._select=n.select(t),this):this._select},r.prototype.shape=function(t){return arguments.length?(this._shape="function"==typeof t?t:h.constant(t),this):this._shape},r.prototype.shapeConfig=function(t){return arguments.length?(this._shapeConfig=Object.assign(this._shapeConfig,t),this):this._shapeConfig},r.prototype.title=function(t){return arguments.length?(this._title=t,this):this._title},r.prototype.titleConfig=function(t){return arguments.length?(this._titleConfig=Object.assign(this._titleConfig,t),this):this._titleConfig},r.prototype.update=function(t){var i=this,n=this._shapeConfig,h={id:function(t){return t.id},label:function(t){return t.label},lineHeight:function(t){return t.lH}},s=this._data.map(function(t,e){var a={data:t,i:e,id:i._id(t,e),label:!!i._lineData[e].width&&i._label(t,e),lH:i._lineHeight(t,e),shape:i._shape(t,e)},s=function(i){if("labelBounds"!==i&&{}.hasOwnProperty.call(n,i))if("function"==typeof n[i])a[i]=n[i](t,e),h[i]=function(t){return t[i]};else if("on"===i){h[i]={};var s=function(t){({}).hasOwnProperty.call(n[i],t)&&(h[i][t]=function(e){n[i][t].bind(this)(e.data,e.i)})};for(var r in n[i])s(r)}};for(var r in n)s(r);return a});return e.nest().key(function(t){return t.shape}).entries(s).forEach(function(e){var s=i._shapes[e.key]=(i._shapes[e.key]||new a[e.key]).data(e.values).duration(i._duration).labelPadding(0).select(i._group.node()).verticalAlign("top").config(Object.assign({},n,h));t?s.fill("red").update(t):s.render()}),this},r.prototype.verticalAlign=function(t){return arguments.length?(this._verticalAlign=t,this):this._verticalAlign},r.prototype.width=function(t){return arguments.length?(this._width=t,this):this._width},r}(h.BaseClass);t.Legend=r,Object.defineProperty(t,"__esModule",{value:!0})});