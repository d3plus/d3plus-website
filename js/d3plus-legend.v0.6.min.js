/*
  d3plus-legend v0.6.0
  An easy to use javascript chart legend.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("d3-array"),require("d3-collection"),require("d3-selection"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-text")):"function"==typeof define&&define.amd?define("d3plus-legend",["exports","d3-array","d3-collection","d3-selection","d3plus-common","d3plus-shape","d3plus-text"],i):i(t.d3plus=t.d3plus||{},t.d3Array,t.d3Collection,t.d3Selection,t.d3plusCommon,t.d3plus,t.d3plusText)}(this,function(t,i,e,n,h,a,s){"use strict";var r=function(t){function r(){var e=this;t.call(this);var n=new a.Shape;this._align="center",this._data=[],this._duration=600,this._height=200,this._id=h.accessor("id"),this._label=h.accessor("id"),this._lineData=[],this._outerBounds={width:0,height:0,x:0,y:0},this._padding=5,this._shape=h.constant("Rect"),this._shapeConfig={duration:this._duration,fill:h.accessor("color"),fontColor:h.constant("#444"),fontFamily:n.fontFamily(),fontSize:h.constant(10),height:h.constant(10),hitArea:function(t){var n=e._lineData[e._data.indexOf(t)],h=i.max([n.height,n.shapeHeight]);return{width:n.width+n.shapeWidth+(n.width?e._padding:0),height:h,x:-n.shapeWidth/2,y:-h/2}},labelBounds:function(t,i,n){var h=e._lineData[t.i],a=void 0!==n.r?n.r:n.width/2;return{width:h.width,height:h.height,x:a+e._padding,y:-h.height/2}},opacity:1,r:h.constant(5),width:h.constant(10),x:function(t,i){var n=e._shapeConfig.width,h=e._lineData[i].y,a="left"===e._align?0:"center"===e._align?(e._outerBounds.width-e._rowWidth(e._lineData.filter(function(t){return h===t.y})))/2:e._outerBounds.width-e._rowWidth(e._lineData.filter(function(t){return h===t.y}));return e._rowWidth(e._lineData.slice(0,i).filter(function(t){return h===t.y}))+e._padding+e._outerBounds.x+n(t,i)/2+a},y:function(t,n){var h=e._shapeConfig.height,a=e._lineData[n];return a.y+e._titleHeight+e._outerBounds.y+i.max(e._lineData.filter(function(t){return a.y===t.y}).map(function(t){return t.height}).concat(e._data.map(function(t,i){return h(t,i)})))/2}},this._titleConfig={fontFamily:"Verdana",fontSize:12,lineHeight:13},this._verticalAlign="middle",this._width=400}return t&&(r.__proto__=t),r.prototype=Object.create(t&&t.prototype),r.prototype.constructor=r,r.prototype._rowHeight=function(t){return i.max(t.map(function(t){return t.height}).concat(t.map(function(t){return t.shapeHeight})))+this._padding},r.prototype._rowWidth=function(t){var e=this;return i.sum(t.map(function(t){return t.shapeWidth+t.width+e._padding*(t.width?2:1)}))-this._padding},r.prototype.render=function(t){var r=this;void 0===this._select&&this.select(n.select("body").append("svg").attr("width",this._width+"px").attr("height",this._height+"px").node()),void 0===this._lineHeight&&(this._lineHeight=function(t,i){return 1.1*r._shapeConfig.fontSize(t,i)});var o=h.elem("g.d3plus-Legend",{parent:this._select}),d=this._height;if(this._titleHeight=0,this._title){var l=this._titleConfig.fontFamily,u=this._titleConfig.lineHeight,_=this._titleConfig.fontSize,g=s.textWrap().fontFamily(l).fontSize(_).lineHeight(u).width(this._width).height(this._height)(this._title);this._titleHeight=u+g.lines.length+this._padding,d-=this._titleHeight}this._lineData=this._data.map(function(t,e){var n=r._shapeConfig.width(t,e),h=r._shapeConfig.fontFamily(t,e),a=r._lineHeight(t,e),o=r._shapeConfig.fontSize(t,e),l=d-(r._data.length+1)*r._padding,u=r._width,_=s.textWrap().fontFamily(h).fontSize(o).lineHeight(a).width(u).height(l)(r._label(t,e));return _.width=Math.ceil(i.max(_.lines.map(function(t){return s.textWidth(t,{"font-family":h,"font-size":o})})))+o,_.height=Math.ceil(_.lines.length*(a+1)),_.og={height:_.height,width:_.width},_.data=t,_.f=h,_.s=o,_.lh=a,_.y=0,_.id=r._id(t,e),_.i=e,_.shapeWidth=n,_.shapeHeight=r._shapeConfig.height(t,e),_});var p,f=this._width-2*this._padding;if(p=i.sum(this._lineData.map(function(t){return t.shapeWidth+2*r._padding+t.width}))-this._padding,p>f){var c=1,w=[],y=i.max(this._lineData.map(function(t){return t.words.length}));if(this._wrapLines=function(){var t=this;if(c++,!(c>y)){var e=1===c?this._lineData.slice():this._lineData.filter(function(i){return i.width+i.shapeWidth+t._padding*(i.width?2:1)>f&&i.words.length>=c}).sort(function(t,i){return i.sentence.length-t.sentence.length});if(!(e.length&&d>e[0].height*c))return void(w=[]);for(var n=!1,h=function(t){var h=e[t],a=h.og.height*c,r=h.og.width*(1.5*(1/c)),o=s.textWrap().fontFamily(h.f).fontSize(h.s).lineHeight(h.lh).width(r).height(a)(h.sentence);return o.truncated?(n=!0,"break"):(h.width=Math.ceil(i.max(o.lines.map(function(t){return s.textWidth(t,{"font-family":h.f,"font-size":h.s})})))+h.s,void(h.height=o.lines.length*(h.lh+1)))},a=0;a<e.length;a++){var r=h(a);if("break"===r)break}n||this._wrapRows()}},this._wrapRows=function(){var t=this;w=[];for(var e=1,n=0,h=0;h<this._lineData.length;h++){var a=t._lineData[h],s=a.width+t._padding*(a.width?2:1)+a.shapeWidth;if(i.sum(w.map(function(t){return i.max(t,function(t){return i.max([t.height,t.shapeHeight])})}))>d){w=[];break}if(n+s<f)n+=s;else{if(s>f){w=[],t._wrapLines();break}n=s,e++}w[e-1]||(w[e-1]=[]),w[e-1].push(a)}},this._wrapRows(),!w.length||i.sum(w,this._rowHeight.bind(this))+this._padding>d){p=i.sum(this._lineData.map(function(t){return t.shapeWidth+1*r._padding}))-this._padding;for(var m=0;m<this._lineData.length;m++)r._lineData[m].width=0,r._lineData[m].height=0;this._wrapRows()}w.length&&i.sum(w,this._rowHeight.bind(this))+this._padding<d&&(w.forEach(function(t,e){t.forEach(function(t){e&&(t.y=i.sum(w.slice(0,e),r._rowHeight.bind(r)))})}),p=i.max(w,function(t){return i.sum(t,function(t){return t.shapeWidth+r._padding*(t.width?2:1)+t.width})})-this._padding)}var v=i.max(this._lineData,function(t,e){return i.max([t.height,r._shapeConfig.height(t.data,e)])+t.y})+this._titleHeight,x=p;this._outerBounds.width=x,this._outerBounds.height=v;var b=this._padding,C=this._padding;"center"===this._align?b=(this._width-x)/2:"right"===this._align&&(b=this._width-this._padding-x),"middle"===this._verticalAlign?C=(this._height-v)/2:"bottom"===this._verticalAlign&&(C=this._height-this._padding-v),this._outerBounds.x=b,this._outerBounds.y=C,(new s.TextBox).data(this._title?[{text:this._title}]:[]).duration(this._duration).select(o.node()).textAnchor({left:"start",center:"middle",right:"end"}[this._align]).width(this._width-2*this._padding).x(this._padding).y(this._outerBounds.y).config(this._titleConfig).render();var H=this._shapeConfig,D={id:function(t){return t.id},label:function(t){return t.label},lineHeight:function(t){return t.lH}},W=this._data.map(function(t,i){var e={data:t,i:i,id:r._id(t,i),label:!!r._lineData[i].width&&r._label(t,i),lH:r._lineHeight(t,i),shape:r._shape(t,i)},n=function(n){if("labelBounds"!==n&&{}.hasOwnProperty.call(H,n))if("function"==typeof H[n])e[n]=H[n](t,i),D[n]=function(t){return t[n]};else if("on"===n){D[n]={};var h=function(t){({}).hasOwnProperty.call(H[n],t)&&(D[n][t]=function(i){return H[n][t](i.data,i.i)})};for(var a in H[n])h(a)}};for(var h in H)n(h);return e});return e.nest().key(function(t){return t.shape}).entries(W).forEach(function(t){(new a[t.key]).data(t.values).duration(r._duration).labelPadding(0).select(o.node()).verticalAlign("top").config(H).config(D).render()}),t&&setTimeout(t,this._duration+100),this},r.prototype.align=function(t){return arguments.length?(this._align=t,this):this._align},r.prototype.data=function(t){return arguments.length?(this._data=t,this):this._data},r.prototype.duration=function(t){return arguments.length?(this._duration=t,this):this._duration},r.prototype.height=function(t){return arguments.length?(this._height=t,this):this._height},r.prototype.id=function(t){return arguments.length?(this._id=t,this):this._id},r.prototype.label=function(t){return arguments.length?(this._label="function"==typeof t?t:h.constant(t),this):this._label},r.prototype.outerBounds=function(){return this._outerBounds},r.prototype.padding=function(t){return arguments.length?(this._padding=t,this):this._padding},r.prototype.select=function(t){return arguments.length?(this._select=n.select(t),this):this._select},r.prototype.shape=function(t){return arguments.length?(this._shape="function"==typeof t?t:h.constant(t),this):this._shape},r.prototype.shapeConfig=function(t){return arguments.length?(this._shapeConfig=Object.assign(this._shapeConfig,t),this):this._shapeConfig},r.prototype.title=function(t){return arguments.length?(this._title=t,this):this._title},r.prototype.titleConfig=function(t){return arguments.length?(this._titleConfig=Object.assign(this._titleConfig,t),this):this._titleConfig},r.prototype.verticalAlign=function(t){return arguments.length?(this._verticalAlign=t,this):this._verticalAlign},r.prototype.width=function(t){return arguments.length?(this._width=t,this):this._width},r}(h.BaseClass);t.Legend=r,Object.defineProperty(t,"__esModule",{value:!0})});