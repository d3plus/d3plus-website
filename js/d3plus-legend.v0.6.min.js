/*
  d3plus-legend v0.6.13
  An easy to use javascript chart legend.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("d3-array"),require("d3-selection"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-text")):"function"==typeof define&&define.amd?define("d3plus-legend",["exports","d3-array","d3-selection","d3plus-common","d3plus-shape","d3plus-text"],i):i(t.d3plus=t.d3plus||{},t.d3Array,t.d3Selection,t.d3plusCommon,t.shapes,t.d3plusText)}(this,function(t,i,e,n,h,a){"use strict";var s=function(t){function s(){var e=this;t.call(this),this._align="center",this._data=[],this._duration=600,this._height=200,this._id=n.accessor("id"),this._label=n.accessor("id"),this._lineData=[],this._outerBounds={width:0,height:0,x:0,y:0},this._padding=5,this._shape=n.constant("Rect"),this._shapeConfig={duration:this._duration,fill:n.accessor("color"),fontColor:n.constant("#444"),fontFamily:(new h.Rect).fontFamily(),fontResize:!1,fontSize:n.constant(10),height:n.constant(10),hitArea:function(t){var n=e._lineData[e._data.indexOf(t)],h=i.max([n.height,n.shapeHeight]);return{width:n.width+n.shapeWidth+(n.width?e._padding:0),height:h,x:-n.shapeWidth/2,y:-h/2}},labelBounds:function(t,i,n){var h=e._lineData[t.i],a=void 0!==n.r?n.r:n.width/2;return{width:h.width,height:h.height,x:a+e._padding,y:-h.height/2}},opacity:1,r:n.constant(5),width:n.constant(10),x:function(t,i){var n=e._shapeConfig.width,h=e._lineData[i].y,a="left"===e._align?0:"center"===e._align?(e._outerBounds.width-e._rowWidth(e._lineData.filter(function(t){return h===t.y})))/2:e._outerBounds.width-e._rowWidth(e._lineData.filter(function(t){return h===t.y}));return e._rowWidth(e._lineData.slice(0,i).filter(function(t){return h===t.y}))+e._padding+e._outerBounds.x+n(t,i)/2+a},y:function(t,n){var h=e._shapeConfig.height,a=e._lineData[n];return a.y+e._titleHeight+e._outerBounds.y+i.max(e._lineData.filter(function(t){return a.y===t.y}).map(function(t){return t.height}).concat(e._data.map(function(t,i){return h(t,i)})))/2}},this._titleConfig={fontFamily:"Verdana",fontSize:12,lineHeight:13},this._verticalAlign="middle",this._width=400}return t&&(s.__proto__=t),s.prototype=Object.create(t&&t.prototype),s.prototype.constructor=s,s.prototype._rowHeight=function(t){return i.max(t.map(function(t){return t.height}).concat(t.map(function(t){return t.shapeHeight})))+this._padding},s.prototype._rowWidth=function(t){var e=this;return i.sum(t.map(function(t){return t.shapeWidth+t.width+e._padding*(t.width?2:1)}))-this._padding},s.prototype.render=function(t){var s=this;void 0===this._select&&this.select(e.select("body").append("svg").attr("width",this._width+"px").attr("height",this._height+"px").node()),void 0===this._lineHeight&&(this._lineHeight=function(t,i){return 1.1*s._shapeConfig.fontSize(t,i)}),this._group=n.elem("g.d3plus-Legend",{parent:this._select});var r=this._height;if(this._titleHeight=0,this._title){var o=this._titleConfig.fontFamily,d=this._titleConfig.lineHeight,l=this._titleConfig.fontSize,u=a.textWrap().fontFamily(o).fontSize(l).lineHeight(d).width(this._width).height(this._height)(this._title);this._titleHeight=d+u.lines.length+this._padding,r-=this._titleHeight}this._lineData=this._data.map(function(t,e){var n=s._shapeConfig.width(t,e),h=s._shapeConfig.fontFamily(t,e),o=s._lineHeight(t,e),d=s._shapeConfig.fontSize(t,e),l=r-(s._data.length+1)*s._padding,u=s._width,_=a.textWrap().fontFamily(h).fontSize(d).lineHeight(o).width(u).height(l)(s._label(t,e));return _.width=Math.ceil(i.max(_.lines.map(function(t){return a.textWidth(t,{"font-family":h,"font-size":d})})))+d,_.height=Math.ceil(_.lines.length*(o+1)),_.og={height:_.height,width:_.width},_.data=t,_.f=h,_.s=d,_.lh=o,_.y=0,_.id=s._id(t,e),_.i=e,_.shapeWidth=n,_.shapeHeight=s._shapeConfig.height(t,e),_});var _,g=this._width-2*this._padding;if(_=i.sum(this._lineData.map(function(t){return t.shapeWidth+2*s._padding+t.width}))-this._padding,_>g){var p=1,f=[],c=i.max(this._lineData.map(function(t){return t.words.length}));if(this._wrapLines=function(){var t=this;if(p++,!(p>c)){var e=1===p?this._lineData.slice():this._lineData.filter(function(i){return i.width+i.shapeWidth+t._padding*(i.width?2:1)>g&&i.words.length>=p}).sort(function(t,i){return i.sentence.length-t.sentence.length});if(!(e.length&&r>e[0].height*p))return void(f=[]);for(var n=!1,h=function(t){var h=e[t],s=h.og.height*p,r=h.og.width*(1.5*(1/p)),o=a.textWrap().fontFamily(h.f).fontSize(h.s).lineHeight(h.lh).width(r).height(s)(h.sentence);return o.truncated?(n=!0,"break"):(h.width=Math.ceil(i.max(o.lines.map(function(t){return a.textWidth(t,{"font-family":h.f,"font-size":h.s})})))+h.s,void(h.height=o.lines.length*(h.lh+1)))},s=0;s<e.length;s++){var o=h(s);if("break"===o)break}n||this._wrapRows()}},this._wrapRows=function(){var t=this;f=[];for(var e=1,n=0,h=0;h<this._lineData.length;h++){var a=t._lineData[h],s=a.width+t._padding*(a.width?2:1)+a.shapeWidth;if(i.sum(f.map(function(t){return i.max(t,function(t){return i.max([t.height,t.shapeHeight])})}))>r){f=[];break}if(n+s<g)n+=s;else{if(s>g){f=[],t._wrapLines();break}n=s,e++}f[e-1]||(f[e-1]=[]),f[e-1].push(a)}},this._wrapRows(),!f.length||i.sum(f,this._rowHeight.bind(this))+this._padding>r){_=i.sum(this._lineData.map(function(t){return t.shapeWidth+1*s._padding}))-this._padding;for(var w=0;w<this._lineData.length;w++)s._lineData[w].width=0,s._lineData[w].height=0;this._wrapRows()}f.length&&i.sum(f,this._rowHeight.bind(this))+this._padding<r&&(f.forEach(function(t,e){t.forEach(function(t){e&&(t.y=i.sum(f.slice(0,e),s._rowHeight.bind(s)))})}),_=i.max(f,function(t){return i.sum(t,function(t){return t.shapeWidth+s._padding*(t.width?2:1)+t.width})})-this._padding)}var y=i.max(this._lineData,function(t,e){return i.max([t.height,s._shapeConfig.height(t.data,e)])+t.y})+this._titleHeight,m=_;this._outerBounds.width=m,this._outerBounds.height=y;var v=this._padding,x=this._padding;"center"===this._align?v=(this._width-m)/2:"right"===this._align&&(v=this._width-this._padding-m),"middle"===this._verticalAlign?x=(this._height-y)/2:"bottom"===this._verticalAlign&&(x=this._height-this._padding-y),this._outerBounds.x=v,this._outerBounds.y=x,(new a.TextBox).data(this._title?[{text:this._title}]:[]).duration(this._duration).select(this._group.node()).textAnchor({left:"start",center:"middle",right:"end"}[this._align]).width(this._width-2*this._padding).x(this._padding).y(this._outerBounds.y).config(this._titleConfig).render(),this._shapes=[];var b=this._shapeConfig,C={id:function(t){return t.id},label:function(t){return t.label},lineHeight:function(t){return t.lH}},H=this._data.map(function(t,i){var e={data:t,i:i,id:s._id(t,i),label:!!s._lineData[i].width&&s._label(t,i),lH:s._lineHeight(t,i),shape:s._shape(t,i)},n=function(n){if("labelBounds"!==n&&{}.hasOwnProperty.call(b,n))if("function"==typeof b[n])e[n]=b[n](t,i),C[n]=function(t){return t[n]};else if("on"===n){C[n]={};var h=function(t){({}).hasOwnProperty.call(b[n],t)&&(C[n][t]=function(i){b[n][t]&&b[n][t].bind(this)(i.data,i.i)})};for(var a in b[n])h(a)}};for(var h in b)n(h);return e});return["Circle","Rect"].forEach(function(t){(new h[t]).data(H.filter(function(i){return i.shape===t})).duration(s._duration).labelPadding(0).select(s._group.node()).verticalAlign("top").config(Object.assign({},b,C)).render()}),t&&setTimeout(t,this._duration+100),this},s.prototype.align=function(t){return arguments.length?(this._align=t,this):this._align},s.prototype.data=function(t){return arguments.length?(this._data=t,this):this._data},s.prototype.duration=function(t){return arguments.length?(this._duration=t,this):this._duration},s.prototype.height=function(t){return arguments.length?(this._height=t,this):this._height},s.prototype.id=function(t){return arguments.length?(this._id=t,this):this._id},s.prototype.label=function(t){return arguments.length?(this._label="function"==typeof t?t:n.constant(t),this):this._label},s.prototype.outerBounds=function(){return this._outerBounds},s.prototype.padding=function(t){return arguments.length?(this._padding=t,this):this._padding},s.prototype.select=function(t){return arguments.length?(this._select=e.select(t),this):this._select},s.prototype.shape=function(t){return arguments.length?(this._shape="function"==typeof t?t:n.constant(t),this):this._shape},s.prototype.shapeConfig=function(t){return arguments.length?(this._shapeConfig=Object.assign(this._shapeConfig,t),this):this._shapeConfig},s.prototype.title=function(t){return arguments.length?(this._title=t,this):this._title},s.prototype.titleConfig=function(t){return arguments.length?(this._titleConfig=Object.assign(this._titleConfig,t),this):this._titleConfig},s.prototype.verticalAlign=function(t){return arguments.length?(this._verticalAlign=t,this):this._verticalAlign},s.prototype.width=function(t){return arguments.length?(this._width=t,this):this._width},s}(n.BaseClass);t.Legend=s,Object.defineProperty(t,"__esModule",{value:!0})});