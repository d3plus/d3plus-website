/*
  d3plus-viz v0.1.0
  Abstract ES6 class that drives d3plus visualizations.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-color"),require("d3-collection"),require("d3-selection"),require("d3-transition"),require("d3plus-color"),require("d3plus-common"),require("d3plus-legend"),require("d3plus-tooltip"),require("d3plus-text"),require("d3-array")):"function"==typeof define&&define.amd?define("d3plus-viz",["exports","d3-color","d3-collection","d3-selection","d3-transition","d3plus-color","d3plus-common","d3plus-legend","d3plus-tooltip","d3plus-text","d3-array"],e):e(t.d3plus=t.d3plus||{},t.d3Color,t.d3Collection,t.d3Selection,t.d3Transition,t.d3plusColor,t.d3plusCommon,t.d3plusLegend,t.d3plusTooltip,t.d3plusText,t.d3Array)}(this,function(t,e,i,n,r,o,s,h,l,a,d){"use strict";function p(t,e,n){void 0===n&&(n=[]),!n||n instanceof Array||(n=[n]);var r,o,h=i.nest().key(e).entries(t);if(n.length)for(var l=h.length,a=function(e){var a=h.map(function(t){return Array.from(new Set(t.values.map(function(t){return n[e](t)})))}),p=d.sum(a,function(t){return t.length}),u=new Set(d.merge(a)).size;if(p===l&&u===l||e===n.length-1)return o=n[e],r=i.nest().key(o).entries(t).map(function(t){return s.merge(t.values)}),"break"},p=0;p<n.length;p++){var u=a(p);if("break"===u)break}else o=e,r=h.map(function(t){return s.merge(t.values)});return{data:r,id:o}}function u(t,e){if(void 0===t.tagName||["BODY","HTML"].indexOf(t.tagName)>=0){var i=window["inner"+(e.charAt(0).toUpperCase()+e.slice(1))],r=n.select(t);return"width"===e?(i-=parseFloat(r.style("margin-left"),10),i-=parseFloat(r.style("margin-right"),10),i-=parseFloat(r.style("padding-left"),10),i-=parseFloat(r.style("padding-right"),10)):(i-=parseFloat(r.style("margin-top"),10),i-=parseFloat(r.style("margin-bottom"),10),i-=parseFloat(r.style("padding-top"),10),i-=parseFloat(r.style("padding-bottom"),10)),i}var o=parseFloat(n.select(t).style(e),10);return"number"==typeof o&&o>0?o:u(t.parentNode,e)}function _(t){return[u(t,"width"),u(t,"height")]}var c={color:e.color,mouse:n.mouse,nest:i.nest,select:n.select},g=function(t){function e(){var e=this;t.call(this),this._backClass=(new a.TextBox).on("click",function(){e._history.length?e.config(e._history.pop()).render():e.depth(e._drawDepth-1).filter(!1).render()}),this._duration=600,this._history=[],this._groupBy=[s.accessor("id")],this._highlight=!1,this._legend={},this._legendClass=new h.Legend,this._on={click:function(t,i){if(e._drawDepth<e._groupBy.length-1){var n=e._groupBy[e._drawDepth],r=e._id(t,i);e._highlight=!1,e._tooltip&&e._tooltipClass.data([])(),e._history.push({depth:e._depth,filter:e._filter}),e.config({depth:e._drawDepth+1,filter:function(t,e){return n(t,e)===r}}).render()}},mouseenter:function(t,i){var n=e._id(t,i);e._highlight=function(t,i){var r=e._id(t,i);return r.constructor===Array&&n.constructor!==Array?r.includes(n):r.constructor!==Array&&n.constructor===Array?n.includes(r):r===n},e._tooltip&&e._tooltipClass.data([t]).footer(e._drawDepth<e._groupBy.length-1?"Click to Expand":"").translate(c.mouse(c.select("html").node()))(),e.update(100)},mousemove:function(){var t=e._tooltipClass.duration();e._tooltip&&e._tooltipClass.duration(0).translate(c.mouse(c.select("html").node()))().duration(t)},mouseleave:function(){e._highlight=!1,e._tooltip&&e._tooltipClass.data([])(),e.update(100)}},this._padding=5,this._shapes=[],this._shapeConfig={fill:function(t,i){return o.assign(e._id(t,i))},opacity:function(t,i){return e._highlight?e._highlight(t,i)?1:.25:1},stroke:function(t,i){return c.color(o.assign(e._id(t,i))).darker()},strokeWidth:function(t,i){return e._highlight&&e._highlight(t,i)?1:0}},this._tooltip={},this._tooltipClass=l.tooltip().pointerEvents("none")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.render=function(t){var e=this;if(this._margin={bottom:0,left:0,right:0,top:0},this._transition=r.transition().duration(this._duration),void 0===this._select){var i=_(c.select("body").node()),n=i[0],o=i[1];this.width(n).height(o),this.select(c.select("body").append("svg").style("width",n+"px").style("height",o+"px").style("display","block").node())}if(!this._width||!this._height){var h=_(this._select.node()),l=h[0],a=h[1];this._width||this.width(l),this._height||this.height(a)}var d=this;this._drawDepth=void 0!==this._depth?this._depth:this._groupBy.length-1,this._id=this._groupBy[this._drawDepth],this._drawLabel=this._label||function(t,e){var i=d._id(t,e);if(i.constructor!==Array)return i;for(var n=d._drawDepth;n>=0&&(i=d._groupBy[n](t,e),i.constructor===Array);n--);return i},this._filteredData=[];for(var u=c.nest().rollup(function(t){return e._filteredData.push(s.merge(t))}),g=0;g<=this._drawDepth;g++)u.key(e._groupBy[g]);u.entries(this._filter?this._data.filter(this._filter):this._data);var f=s.elem("g.d3plus-plot-legend",{condition:this._legend,enter:{transform:"translate(0,"+this._height/2+")"},exit:{opacity:0},parent:this._select,transition:this._transition,update:{opacity:1,transform:"translate(0,"+this._height/2+")"}});if(this._legend){var y=p(this._filteredData,this._shapeConfig.fill,this._groupBy);this._legendClass.id(function(t,e){return y.id(t,e)}).duration(this._duration).data(y.data).height(this._height/2).label(this._drawLabel).select(f.node()).verticalAlign("bottom").width(this._width).shapeConfig(this._shapeConfig).shapeConfig({on:Object.keys(this._on).filter(function(t){return!t.includes(".")||t.includes(".legend")}).reduce(function(t,i){return t[i]=e._on[i],t},{})}).config(this._legend.constructor===Object?this._legend:{}).render(),this._margin.bottom=this._legendClass.outerBounds().height+4*this._legendClass.padding()}var m=s.elem("g.d3plus-plot-titles",{parent:this._select});return this._backClass.data(this._history.length?[{text:"Back",x:2*this._padding,y:0}]:[]).select(m.node()).render(),this._margin.top+=this._history.length?this._backClass.fontSize()()+this._padding:0,this._tooltipClass.title(this._drawLabel),this._tooltip.constructor===Object&&this._tooltipClass.config(this._tooltip),t&&setTimeout(t,this._duration+100),this},e.prototype.data=function(t){return arguments.length?(this._data=t,this):this._data},e.prototype.depth=function(t){return arguments.length?(this._depth=t,this):this._depth},e.prototype.duration=function(t){return arguments.length?(this._duration=t,this):this._duration},e.prototype.filter=function(t){return arguments.length?(this._filter=t,this):this._filter},e.prototype.groupBy=function(t){return arguments.length?(t instanceof Array||(t=[t]),this._groupBy=t.map(function(t){return"function"==typeof t?t:s.accessor(t)}),this):this._groupBy},e.prototype.height=function(t){return arguments.length?(this._height=t,this):this._height},e.prototype.highlight=function(t){return arguments.length?(this._highlight=t,this):this._highlight},e.prototype.label=function(t){return arguments.length?(this._label="function"==typeof t?t:s.constant(t),this):this._label},e.prototype.legend=function(t){return arguments.length?(this._legend=t,this):this._legend},e.prototype.on=function(t,e){return 2===arguments.length?(this._on[t]=e,this):arguments.length?this._on[t]:this._on},e.prototype.select=function(t){return arguments.length?(this._select=c.select(t),this):this._select},e.prototype.shape=function(t){return arguments.length?(this._shape="function"==typeof t?t:s.constant(t),this):this._shape},e.prototype.shapeConfig=function(t){return arguments.length?(this._shapeConfig=Object.assign(this._shapeConfig,t),this):this._shapeConfig},e.prototype.tooltip=function(t){return arguments.length?(this._tooltip=t,this):this._tooltip},e.prototype.update=function(t){var e=this;void 0===t&&(t=0),this._legendClass.shapeConfig({duration:t}).render().shapeConfig({duration:this._duration});for(var i=0;i<this._shapes.length;i++)e._shapes[i].duration(t).render().duration(e._duration);return this},e.prototype.width=function(t){return arguments.length?(this._width=t,this):this._width},e}(s.BaseClass);t.Viz=g,Object.defineProperty(t,"__esModule",{value:!0})});