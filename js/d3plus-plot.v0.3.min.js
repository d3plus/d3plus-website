/*
  d3plus-plot v0.3.12
  A reusable javascript x/y plot built on D3.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3plus-common"),require("d3-array"),require("d3-collection"),require("d3-scale"),require("d3-shape"),require("d3-selection"),require("d3plus-axis"),require("d3plus-color"),require("d3plus-shape"),require("d3plus-viz")):typeof define==="function"&&define.amd?define("d3plus-plot",["exports","d3plus-common","d3-array","d3-collection","d3-scale","d3-shape","d3-selection","d3plus-axis","d3plus-color","d3plus-shape","d3plus-viz"],e):e(t.d3plus=t.d3plus||{},t.d3plusCommon,t.d3Array,t.d3Collection,t.scales,t.d3Shape,t.d3Selection,t.d3plusAxis,t.d3plusColor,t.shapes,t.d3plusViz)})(this,function(t,e,i,n,r,s,a,o,c,f,h){"use strict";var u=function(t,e,i,n){var r=e.domain().slice(),s=e.range(),a=i.domain().slice(),o=i.range();t.forEach(function(t){var c=n.r(t.data,t.i);if(e(t.x)-s[0]<c*2){var f=e.invert(e(t.x)-c*2);if(f<r[0])r[0]=f}if(s[1]-e(t.x)<c*2){var h=e.invert(e(t.x)+c*2);if(h>r[1])r[1]=h}if(i(t.y)-o[0]<c*2){var u=i.invert(i(t.y)-c*2);if(u>a[0])a[0]=u}if(o[1]-i(t.y)<c*2){var d=i.invert(i(t.y)+c*2);if(d<a[1])a[1]=d}});e.domain(r);i.domain(a);return[e,i]};var d=function(t,e,i,n){var r=e.domain().slice(),s=e.range(),a=i.domain().slice(),o=i.range();t.forEach(function(t){var c=n.height(t.data,t.i),f=n.width(t.data,t.i);if(e(t.x)-s[0]<f){var h=e.invert(e(t.x)-f);if(h<r[0])r[0]=h}if(s[1]-e(t.x)<f){var u=e.invert(e(t.x)+f);if(u>r[1])r[1]=u}if(i(t.y)-o[0]<c){var d=i.invert(i(t.y)-c);if(d>a[0])a[0]=d}if(o[1]-i(t.y)<c){var l=i.invert(i(t.y)+c);if(l<a[1])a[1]=l}});e.domain(r);i.domain(a);return[e,i]};var l=function(t,e,n){var r=this;var s=this._discrete==="x"?n:e;var a=s.domain().slice();if(this._discrete==="x")a.reverse();var o=t.map(function(t){return t[r._discrete==="x"?"y":"x"]});var c=s.invert(s(i.max(o))+(this._discrete==="x"?-10:10));if(c>a[1])a[1]=c;if(this._discrete==="x")a.reverse();s.domain(a);return[e,n]};var _=function(t){function h(){var i=this;t.call(this);this._buffer={Circle:u,Line:l,Rect:d};this._shape=e.constant("Circle");this._shapeConfig=Object.assign(this._shapeConfig,{Circle:{r:e.constant(5)},Line:{fill:e.constant("none"),label:false,stroke:function(t,e){return c.assign(i._id(t,e))},strokeWidth:e.constant(1)},Rect:{height:e.constant(10),width:e.constant(10)}});this._stackOffset=s.stackOffsetNone;this._stackOrder=s.stackOrderNone;this._x=e.accessor("x");this._xAxis=(new o.AxisBottom).align("end");this._xTest=(new o.AxisBottom).align("end").gridSize(0);this._xConfig={title:"X Axis"};this._y=e.accessor("y");this._yAxis=(new o.AxisLeft).align("start");this._yTest=(new o.AxisLeft).align("start").gridSize(0);this._yConfig={title:"Y Axis"}}if(t)h.__proto__=t;h.prototype=Object.create(t&&t.prototype);h.prototype.constructor=h;h.prototype.render=function c(h){var u=this;t.prototype.render.call(this,h);var d=this._filteredData.map(function(t,e){return{data:t,i:e,id:u._id(t,e),shape:u._shape(t,e),x:u._x(t,e),y:u._y(t,e)}});var l=this._height-this._margin.top-this._margin.bottom,_=this._discrete?this._discrete==="x"?"y":"x":undefined,p=this._select,y=this,x="translate("+this._margin.left+", "+this._margin.top+")",g=this._transition,m=this._width-this._margin.left-this._margin.right;var v=this._time&&d[0].x===this._time(d[0].data,d[0].i),k=this._time&&d[0].y===this._time(d[0].data,d[0].i);if(v||k){d.forEach(function(t){if(v)t.x=o.date(t.x);if(k)t.y=o.date(t.y)})}var b,O,A;if(this._stacked){A=Array.from(new Set(d.map(function(t){return t.id})));O=n.nest().key(function(t){return Number(t[u._discrete])}).entries(d).sort(function(t,e){return t.key-e.key}).map(function(t){return t.values});O.forEach(function(t){var e=Array.from(new Set(t.map(function(t){return t.id})));if(e.length<A.length){A.forEach(function(i){if(!e.includes(i)){var n=d.filter(function(t){return t.id===i})[0];if(n.shape==="Area"){var r={data:n.data,id:i,shape:n.shape};r[u._discrete]=t[0][u._discrete];r[_]=0;d.push(r)}}})}});d.sort(function(t,e){return t[u._discrete]-e[u._discrete]});O=s.stack().keys(A).offset(this._stackOffset).order(this._stackOrder).value(function(t,e){var i=t.filter(function(t){return t.id===e});return i.length?i[0][_]:0})(O);b={};b[this._discrete]=i.extent(d,function(t){return t[u._discrete]});b[_]=[i.min(O.map(function(t){return i.min(t.map(function(t){return t[1]}))})),i.max(O.map(function(t){return i.max(t.map(function(t){return t[1]}))}))]}else b={x:i.extent(d,function(t){return t.x}),y:i.extent(d,function(t){return t.y})};var C=this._xDomain?this._xDomain.slice():b.x;if(C[0]===void 0)C[0]=b.x[0];if(C[1]===void 0)C[1]=b.x[1];if(v)C=C.map(o.date);var w=this._yDomain?this._yDomain.slice():b.y;if(w[0]===void 0)w[0]=b.y[0];if(w[1]===void 0)w[1]=b.y[1];if(k)w=w.map(o.date);b={x:C,y:w};if(_&&this._baseline!==void 0){var S=this._baseline;if(b[_][0]>S)b[_][0]=S;else if(b[_][1]<S)b[_][1]=S}var j=r["scale"+(v?"Time":"Linear")]().domain(b.x).range([0,m]),D=r["scale"+(k?"Time":"Linear")]().domain(b.y.reverse()).range([0,l]);var q=n.nest().key(function(t){return t.shape}).entries(d);q.forEach(function(t){if(u._buffer[t.key]){var e=u._buffer[t.key].bind(u)(t.values,j,D,u._shapeConfig[t.key]);j=e[0];D=e[1]}});C=j.domain();w=D.domain();var L=this._discrete==="x"&&!v?Array.from(new Set(d.map(function(t){return t.x}))):undefined,T=this._discrete==="y"&&!k?Array.from(new Set(d.map(function(t){return t.y}))):undefined;this._yTest.domain(w).height(l).scale(k?"time":"linear").select(e.elem("g.d3plus-plot-test",{enter:{opacity:0},parent:this._select}).node()).ticks(T).width(m).config(this._yConfig).render();var E=this._yTest.outerBounds();var z=E.width?E.width+this._yTest.padding():undefined;this._xTest.domain(C).height(l).range([z,undefined]).scale(v?"time":"linear").select(e.elem("g.d3plus-plot-test",{enter:{opacity:0},parent:this._select}).node()).ticks(L).width(m).config(this._xConfig).render();this._xAxis.domain(C).height(l).range([z,undefined]).scale(v?"time":"linear").select(e.elem("g.d3plus-plot-x-axis",{parent:p,transition:g,enter:{transform:x},update:{transform:x}}).node()).ticks(L).width(m).config(this._xConfig).render();j=this._xAxis._d3Scale;this._yAxis.domain(w).height(l).range([this._xAxis.outerBounds().y,this._xTest.outerBounds().y]).scale(k?"time":"linear").select(e.elem("g.d3plus-plot-y-axis",{parent:p,transition:g,enter:{transform:x},update:{transform:x}}).node()).ticks(T).width(j.range()[1]+this._xAxis.padding()).config(this._yConfig).render();D=this._yAxis._d3Scale;var B={duration:this._duration,label:function(t){return u._drawLabel(t.data,t.i)},select:e.elem("g.d3plus-plot-shapes",{parent:p,transition:g,enter:{transform:x},update:{transform:x}}).node(),x:function(t){return j(t.x)},y:function(t){return D(t.y)}};function P(t){var e={};var i=function(i){if({}.hasOwnProperty.call(t,i)&&!f[i]){e[i]=typeof t[i]==="function"?function(e){return t[i](e.data,e.i)}:t[i]}};for(var n in t)i(n);return e}B=Object.assign(B,P(this._shapeConfig));var N={x0:this._discrete==="x"?B.x:j(0),x1:this._discrete==="x"?null:B.x,y0:this._discrete==="y"?B.y:D(0),y1:this._discrete==="y"?null:B.y};if(this._stacked){var R=_==="x"?j:D;N[""+_]=N[_+"0"]=function(t,e){var i=A.indexOf(t.id);return i>=0?R(O[i][e][0]):R(0)};N[_+"1"]=function(t,e){var i=A.indexOf(t.id);return i>=0?R(O[i][e][1]):R(0)}}B=Object.assign(B,N);function U(t){if(!this)return false;if(t.nested&&t.values){var i=y._discrete,n=a.mouse(y._select.node())[i==="x"?0:1],r=t.values.map(function(t){return B[i](t)});t=t.values[r.indexOf(e.closest(n,r))]}return this(t.data,t.i)}var V=Object.keys(this._on);q.forEach(function(t){var e=(new f[t.key]).config(B).data(t.values);var i=V.filter(function(e){return e.includes("."+t.key)}),n=V.filter(function(t){return!t.includes(".")}),r=V.filter(function(t){return t.includes(".shape")});for(var s=0;s<n.length;s++)e.on(n[s],U.bind(u._on[n[s]]));for(var a=0;a<r.length;a++)e.on(r[a],U.bind(u._on[r[a]]));for(var o=0;o<i.length;o++)e.on(i[o],U.bind(u._on[i[o]]));e.config(u._shapeConfig[t.key]?P(u._shapeConfig[t.key]):{}).render();u._shapes.push(e)});return this};h.prototype.baseline=function t(e){return arguments.length?(this._baseline=e,this):this._baseline};h.prototype.stacked=function t(e){return arguments.length?(this._stacked=e,this):this._stacked};h.prototype.stackOffset=function t(e){return arguments.length?(this._stackOffset=typeof e==="function"?e:s["stackOffset"+(e.charAt(0).toUpperCase()+e.slice(1))],this):this._stackOffset};h.prototype.stackOrder=function t(e){return arguments.length?(this._stackOrder=typeof e==="function"?e:s["stackOrder"+(e.charAt(0).toUpperCase()+e.slice(1))],this):this._stackOrder};h.prototype.x=function t(i){if(arguments.length){if(typeof i==="function")this._x=i;else{this._x=e.accessor(i);if(!this._aggs[i]&&this._discrete==="x"){this._aggs[i]=function(t){var e=Array.from(new Set(t));return e.length===1?e[0]:e}}}return this}else return this._x};h.prototype.xConfig=function t(e){return arguments.length?(this._xConfig=Object.assign(this._xConfig,e),this):this._xConfig};h.prototype.xDomain=function t(e){return arguments.length?(this._xDomain=e,this):this._xDomain};h.prototype.y=function t(i){if(arguments.length){if(typeof i==="function")this._y=i;else{this._y=e.accessor(i);if(!this._aggs[i]&&this._discrete==="y"){this._aggs[i]=function(t){var e=Array.from(new Set(t));return e.length===1?e[0]:e}}}return this}else return this._y};h.prototype.yConfig=function t(e){return arguments.length?(this._yConfig=Object.assign(this._yConfig,e),this):this._yConfig};h.prototype.yDomain=function t(e){return arguments.length?(this._yDomain=e,this):this._yDomain};return h}(h.Viz);var p=function(t){function i(){t.call(this);this._baseline=0;this._discrete="x";this._shape=e.constant("Area");this.x("x")}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;return i}(_);var y=function(t){function i(){t.call(this);this._discrete="x";this._shape=e.constant("Line");this.x("x")}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;return i}(_);var x=function(t){function e(){t.call(this);this._stacked=true}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;return e}(p);t.AreaPlot=p;t.LinePlot=y;t.Plot=_;t.StackedArea=x;Object.defineProperty(t,"__esModule",{value:true})});