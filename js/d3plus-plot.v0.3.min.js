/*
  d3plus-plot v0.3.11
  A reusable javascript x/y plot built on D3.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3plus-common"),require("d3-array"),require("d3-collection"),require("d3-scale"),require("d3-shape"),require("d3-selection"),require("d3plus-axis"),require("d3plus-color"),require("d3plus-shape"),require("d3plus-viz")):"function"==typeof define&&define.amd?define("d3plus-plot",["exports","d3plus-common","d3-array","d3-collection","d3-scale","d3-shape","d3-selection","d3plus-axis","d3plus-color","d3plus-shape","d3plus-viz"],e):e(t.d3plus=t.d3plus||{},t.d3plusCommon,t.d3Array,t.d3Collection,t.scales,t.d3Shape,t.d3Selection,t.d3plusAxis,t.d3plusColor,t.shapes,t.d3plusViz)}(this,function(t,e,i,n,r,s,o,a,c,h,u){"use strict";var d=function(t,e,i,n){var r=e.domain().slice(),s=e.range(),o=i.domain().slice(),a=i.range();return t.forEach(function(t){var c=n.r(t.data,t.i);if(e(t.x)-s[0]<2*c){var h=e.invert(e(t.x)-2*c);h<r[0]&&(r[0]=h)}if(s[1]-e(t.x)<2*c){var u=e.invert(e(t.x)+2*c);u>r[1]&&(r[1]=u)}if(i(t.y)-a[0]<2*c){var d=i.invert(i(t.y)-2*c);d>o[0]&&(o[0]=d)}if(a[1]-i(t.y)<2*c){var f=i.invert(i(t.y)+2*c);f<o[1]&&(o[1]=f)}}),e.domain(r),i.domain(o),[e,i]},f=function(t,e,i,n){var r=e.domain().slice(),s=e.range(),o=i.domain().slice(),a=i.range();return t.forEach(function(t){var c=n.height(t.data,t.i),h=n.width(t.data,t.i);if(e(t.x)-s[0]<h){var u=e.invert(e(t.x)-h);u<r[0]&&(r[0]=u)}if(s[1]-e(t.x)<h){var d=e.invert(e(t.x)+h);d>r[1]&&(r[1]=d)}if(i(t.y)-a[0]<c){var f=i.invert(i(t.y)-c);f>o[0]&&(o[0]=f)}if(a[1]-i(t.y)<c){var l=i.invert(i(t.y)+c);l<o[1]&&(o[1]=l)}}),e.domain(r),i.domain(o),[e,i]},l=function(t,e,n){var r=this,s="x"===this._discrete?n:e,o=s.domain().slice();"x"===this._discrete&&o.reverse();var a=t.map(function(t){return t["x"===r._discrete?"y":"x"]}),c=s.invert(s(i.max(a))+("x"===this._discrete?-10:10));return c>o[1]&&(o[1]=c),"x"===this._discrete&&o.reverse(),s.domain(o),[e,n]},_=function(t){function u(){var i=this;t.call(this),this._buffer={Circle:d,Line:l,Rect:f},this._shape=e.constant("Circle"),this._shapeConfig=Object.assign(this._shapeConfig,{Circle:{r:e.constant(5)},Line:{fill:e.constant("none"),label:!1,stroke:function(t,e){return c.assign(i._id(t,e))},strokeWidth:e.constant(1)},Rect:{height:e.constant(10),width:e.constant(10)}}),this._stackOffset=s.stackOffsetNone,this._stackOrder=s.stackOrderNone,this._x=e.accessor("x"),this._xAxis=(new a.AxisBottom).align("end"),this._xTest=(new a.AxisBottom).align("end").gridSize(0),this._xConfig={title:"X Axis"},this._y=e.accessor("y"),this._yAxis=(new a.AxisLeft).align("start"),this._yTest=(new a.AxisLeft).align("start").gridSize(0),this._yConfig={title:"Y Axis"}}return t&&(u.__proto__=t),u.prototype=Object.create(t&&t.prototype),u.prototype.constructor=u,u.prototype.render=function(c){function u(t){var e={},i=function(i){({}).hasOwnProperty.call(t,i)&&!h[i]&&(e[i]="function"==typeof t[i]?function(e){return t[i](e.data,e.i)}:t[i])};for(var n in t)i(n);return e}function d(t){if(!this)return!1;if(t.nested&&t.values){var i=x._discrete,n=o.mouse(x._select.node())["x"===i?0:1],r=t.values.map(function(t){return P[i](t)});t=t.values[r.indexOf(e.closest(n,r))]}return this(t.data,t.i)}var f=this;t.prototype.render.call(this,c);var l=this._filteredData.map(function(t,e){return{data:t,i:e,id:f._id(t,e),shape:f._shape(t,e),x:f._x(t,e),y:f._y(t,e)}}),_=this._height-this._margin.top-this._margin.bottom,p=this._discrete?"x"===this._discrete?"y":"x":void 0,y=this._select,x=this,g="translate("+this._margin.left+", "+this._margin.top+")",m=this._transition,v=this._width-this._margin.left-this._margin.right,k=this._time&&l[0].x===this._time(l[0].data,l[0].i),b=this._time&&l[0].y===this._time(l[0].data,l[0].i);(k||b)&&l.forEach(function(t){k&&(t.x=a.date(t.x)),b&&(t.y=a.date(t.y))});var O,A,C;this._stacked?(C=Array.from(new Set(l.map(function(t){return t.id}))),A=n.nest().key(function(t){return Number(t[f._discrete])}).entries(l).sort(function(t,e){return t.key-e.key}).map(function(t){return t.values}),A.forEach(function(t){var e=Array.from(new Set(t.map(function(t){return t.id})));e.length<C.length&&C.forEach(function(i){if(!e.includes(i)){var n=l.filter(function(t){return t.id===i})[0];if("Area"===n.shape){var r={data:n.data,id:i,shape:n.shape};r[f._discrete]=t[0][f._discrete],r[p]=0,l.push(r)}}})}),l.sort(function(t,e){return t[f._discrete]-e[f._discrete]}),A=s.stack().keys(C).offset(this._stackOffset).order(this._stackOrder).value(function(t,e){var i=t.filter(function(t){return t.id===e});return i.length?i[0][p]:0})(A),O={},O[this._discrete]=i.extent(l,function(t){return t[f._discrete]}),O[p]=[i.min(A.map(function(t){return i.min(t.map(function(t){return t[1]}))})),i.max(A.map(function(t){return i.max(t.map(function(t){return t[1]}))}))]):O={x:i.extent(l,function(t){return t.x}),y:i.extent(l,function(t){return t.y})};var w=this._xDomain?this._xDomain.slice():O.x;void 0===w[0]&&(w[0]=O.x[0]),void 0===w[1]&&(w[1]=O.x[1]),k&&(w=w.map(a.date));var S=this._yDomain?this._yDomain.slice():O.y;if(void 0===S[0]&&(S[0]=O.y[0]),void 0===S[1]&&(S[1]=O.y[1]),b&&(S=S.map(a.date)),O={x:w,y:S},p&&void 0!==this._baseline){var j=this._baseline;O[p][0]>j?O[p][0]=j:O[p][1]<j&&(O[p][1]=j)}var D=r["scale"+(k?"Time":"Linear")]().domain(O.x).range([0,v]),q=r["scale"+(b?"Time":"Linear")]().domain(O.y.reverse()).range([0,_]),L=n.nest().key(function(t){return t.shape}).entries(l);L.forEach(function(t){if(f._buffer[t.key]){var e=f._buffer[t.key].bind(f)(t.values,D,q,f._shapeConfig[t.key]);D=e[0],q=e[1]}}),w=D.domain(),S=q.domain();var T="x"!==this._discrete||k?void 0:Array.from(new Set(l.map(function(t){return t.x}))),E="y"!==this._discrete||b?void 0:Array.from(new Set(l.map(function(t){return t.y})));this._yTest.domain(S).height(_).scale(b?"time":"linear").select(e.elem("g.d3plus-plot-test",{enter:{opacity:0},parent:this._select}).node()).ticks(E).width(v).config(this._yConfig).render();var z=this._yTest.outerBounds(),B=z.width?z.width+this._yTest.padding():void 0;this._xTest.domain(w).height(_).range([B,void 0]).scale(k?"time":"linear").select(e.elem("g.d3plus-plot-test",{enter:{opacity:0},parent:this._select}).node()).ticks(T).width(v).config(this._xConfig).render(),this._xAxis.domain(w).height(_).range([B,void 0]).scale(k?"time":"linear").select(e.elem("g.d3plus-plot-x-axis",{parent:y,transition:m,enter:{transform:g},update:{transform:g}}).node()).ticks(T).width(v).config(this._xConfig).render(),D=this._xAxis._d3Scale,this._yAxis.domain(S).height(_).range([this._xAxis.outerBounds().y,this._xTest.outerBounds().y]).scale(b?"time":"linear").select(e.elem("g.d3plus-plot-y-axis",{parent:y,transition:m,enter:{transform:g},update:{transform:g}}).node()).ticks(E).width(D.range()[1]+this._xAxis.padding()).config(this._yConfig).render(),q=this._yAxis._d3Scale;var P={duration:this._duration,label:function(t){return f._drawLabel(t.data,t.i)},select:e.elem("g.d3plus-plot-shapes",{parent:y,transition:m,enter:{transform:g},update:{transform:g}}).node(),x:function(t){return D(t.x)},y:function(t){return q(t.y)}};P=Object.assign(P,u(this._shapeConfig));var N={x0:"x"===this._discrete?P.x:D(0),x1:"x"===this._discrete?null:P.x,y0:"y"===this._discrete?P.y:q(0),y1:"y"===this._discrete?null:P.y};if(this._stacked){var R="x"===p?D:q;N[""+p]=N[p+"0"]=function(t,e){var i=C.indexOf(t.id);return R(i>=0?A[i][e][0]:0)},N[p+"1"]=function(t,e){var i=C.indexOf(t.id);return R(i>=0?A[i][e][1]:0)}}P=Object.assign(P,N);var U=Object.keys(this._on);return L.forEach(function(t){for(var e=(new h[t.key]).config(P).data(t.values),i=U.filter(function(e){return e.includes("."+t.key)}),n=U.filter(function(t){return!t.includes(".")}),r=U.filter(function(t){return t.includes(".shape")}),s=0;s<n.length;s++)e.on(n[s],d.bind(f._on[n[s]]));for(var o=0;o<r.length;o++)e.on(r[o],d.bind(f._on[r[o]]));for(var a=0;a<i.length;a++)e.on(i[a],d.bind(f._on[i[a]]));e.config(f._shapeConfig[t.key]?u(f._shapeConfig[t.key]):{}).render(),f._shapes.push(e)}),this},u.prototype.baseline=function(t){return arguments.length?(this._baseline=t,this):this._baseline},u.prototype.stacked=function(t){return arguments.length?(this._stacked=t,this):this._stacked},u.prototype.stackOffset=function(t){return arguments.length?(this._stackOffset="function"==typeof t?t:s["stackOffset"+(t.charAt(0).toUpperCase()+t.slice(1))],this):this._stackOffset},u.prototype.stackOrder=function(t){return arguments.length?(this._stackOrder="function"==typeof t?t:s["stackOrder"+(t.charAt(0).toUpperCase()+t.slice(1))],this):this._stackOrder},u.prototype.x=function(t){return arguments.length?("function"==typeof t?this._x=t:(this._x=e.accessor(t),this._aggs[t]||"x"!==this._discrete||(this._aggs[t]=function(t){var e=Array.from(new Set(t));return 1===e.length?e[0]:e})),this):this._x},u.prototype.xConfig=function(t){return arguments.length?(this._xConfig=Object.assign(this._xConfig,t),this):this._xConfig},u.prototype.xDomain=function(t){return arguments.length?(this._xDomain=t,this):this._xDomain},u.prototype.y=function(t){return arguments.length?("function"==typeof t?this._y=t:(this._y=e.accessor(t),this._aggs[t]||"y"!==this._discrete||(this._aggs[t]=function(t){var e=Array.from(new Set(t));return 1===e.length?e[0]:e})),this):this._y},u.prototype.yConfig=function(t){return arguments.length?(this._yConfig=Object.assign(this._yConfig,t),this):this._yConfig},u.prototype.yDomain=function(t){return arguments.length?(this._yDomain=t,this):this._yDomain},u}(u.Viz),p=function(t){function i(){t.call(this),this._baseline=0,this._discrete="x",this._shape=e.constant("Area"),this.x("x")}return t&&(i.__proto__=t),i.prototype=Object.create(t&&t.prototype),i.prototype.constructor=i,i}(_),y=function(t){function i(){t.call(this),this._discrete="x",this._shape=e.constant("Line"),this.x("x")}return t&&(i.__proto__=t),i.prototype=Object.create(t&&t.prototype),i.prototype.constructor=i,i}(_),x=function(t){function e(){t.call(this),this._stacked=!0}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(p);t.AreaPlot=p,t.LinePlot=y,t.Plot=_,t.StackedArea=x,Object.defineProperty(t,"__esModule",{value:!0})});