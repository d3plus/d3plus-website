/*
  d3plus-plot v0.3.1
  A reusable javascript x/y plot built on D3.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3plus-common"),require("d3-array"),require("d3-collection"),require("d3-scale"),require("d3-shape"),require("d3-selection"),require("d3plus-axis"),require("d3plus-color"),require("d3plus-shape"),require("d3plus-viz")):"function"==typeof define&&define.amd?define("d3plus-plot",["exports","d3plus-common","d3-array","d3-collection","d3-scale","d3-shape","d3-selection","d3plus-axis","d3plus-color","d3plus-shape","d3plus-viz"],e):e(t.d3plus=t.d3plus||{},t.d3plusCommon,t.d3Array,t.d3Collection,t.scales,t.d3Shape,t.d3Selection,t.d3plusAxis,t.d3plusColor,t.shapes,t.d3plusViz)}(this,function(t,e,i,n,r,s,o,a,c,h,u){"use strict";var d=function(t,e,i,n){var r=e.domain().slice(),s=e.range(),o=i.domain().slice(),a=i.range();return t.forEach(function(t){var c=n.r(t.data,t.i);if(e(t.x)-s[0]<2*c){var h=e.invert(e(t.x)-2*c);h<r[0]&&(r[0]=h)}if(s[1]-e(t.x)<2*c){var u=e.invert(e(t.x)+2*c);u>r[1]&&(r[1]=u)}if(i(t.y)-a[0]<2*c){var d=i.invert(i(t.y)-2*c);d>o[0]&&(o[0]=d)}if(a[1]-i(t.y)<2*c){var l=i.invert(i(t.y)+2*c);l<o[1]&&(o[1]=l)}}),e.domain(r),i.domain(o),[e,i]},l=function(t,e,i,n){var r=e.domain().slice(),s=e.range(),o=i.domain().slice(),a=i.range();return t.forEach(function(t){var c=n.height(t.data,t.i),h=n.width(t.data,t.i);if(e(t.x)-s[0]<h){var u=e.invert(e(t.x)-h);u<r[0]&&(r[0]=u)}if(s[1]-e(t.x)<h){var d=e.invert(e(t.x)+h);d>r[1]&&(r[1]=d)}if(i(t.y)-a[0]<c){var l=i.invert(i(t.y)-c);l>o[0]&&(o[0]=l)}if(a[1]-i(t.y)<c){var f=i.invert(i(t.y)+c);f<o[1]&&(o[1]=f)}}),e.domain(r),i.domain(o),[e,i]},f=function(t,e,n){var r=this,s="x"===this._discrete?n:e,o=s.domain().slice();"x"===this._discrete&&o.reverse();var a=t.map(function(t){return t["x"===r._discrete?"y":"x"]}),c=s.invert(s(i.max(a))+("x"===this._discrete?-10:10));return c>o[1]&&(o[1]=c),"x"===this._discrete&&o.reverse(),s.domain(o),[e,n]},p=function(t){function u(){var i=this;t.call(this),this._buffer={Circle:d,Line:f,Rect:l},this._shape=e.constant("Circle"),this._shapeConfig=Object.assign(this._shapeConfig,{Circle:{r:e.constant(5)},Line:{fill:e.constant("none"),label:!1,stroke:function(t,e){return c.assign(i._id(t,e))},strokeWidth:e.constant(1)},Rect:{height:e.constant(10),width:e.constant(10)}}),this._x=e.accessor("x"),this._xAxis=(new a.AxisBottom).align("end"),this._xTest=(new a.AxisBottom).align("end").gridSize(0),this._xConfig={title:"X Axis"},this._y=e.accessor("y"),this._yAxis=(new a.AxisLeft).align("start"),this._yTest=(new a.AxisLeft).align("start").gridSize(0),this._yConfig={title:"Y Axis"}}return t&&(u.__proto__=t),u.prototype=Object.create(t&&t.prototype),u.prototype.constructor=u,u.prototype.render=function(c){function u(t){if(t.nested&&t.values){var i=g._discrete,n=o.mouse(g._select.node())["x"===i?0:1],r=t.values.map(function(t){return B[i](t)});t=t.values[r.indexOf(e.closest(n,r))]}return this(t.data,t.i)}var d=this;t.prototype.render.call(this,c);var l,f,p,_=this._filteredData.map(function(t,e){return{data:t,i:e,id:d._id(t,e),shape:d._shape(t,e),x:d._x(t,e),y:d._y(t,e)}}),y=this._height-this._margin.top-this._margin.bottom,x=this._discrete?"x"===this._discrete?"y":"x":void 0,m=this._select,g=this,v="translate("+this._margin.left+", "+this._margin.top+")",b=this._transition,k=this._width-this._margin.left-this._margin.right;this._stacked?(p=Array.from(new Set(_.map(function(t){return t.id}))),f=s.stack().keys(p).value(function(t,e){return t.filter(function(t){return t.id===e})[0][x]})(n.nest().key(function(t){return t[d._discrete]}).entries(_).map(function(t){return t.values})),l={},l[this._discrete]=i.extent(_,function(t){return t[d._discrete]}),l[x]=[i.min(f.map(function(t){return i.min(t.map(function(t){return t[1]}))})),i.max(f.map(function(t){return i.max(t.map(function(t){return t[1]}))}))]):l={x:i.extent(_,function(t){return t.x}),y:i.extent(_,function(t){return t.y})};var C=this._time&&this._x(_[0],0)===this._time(_[0],0),A=this._time&&this._y(_[0],0)===this._time(_[0],0);(C||A)&&_.forEach(function(t){C&&(t.x=a.date(t.x)),A&&(t.y=a.date(t.y))});var w=this._xDomain?this._xDomain.slice():l.x;void 0===w[0]&&(w[0]=l.x[0]),void 0===w[1]&&(w[1]=l.x[1]),C&&(w=w.map(a.date));var O=this._yDomain?this._yDomain.slice():l.y;if(void 0===O[0]&&(O[0]=l.y[0]),void 0===O[1]&&(O[1]=l.y[1]),A&&(O=O.map(a.date)),l={x:w,y:O},x&&void 0!==this._baseline){var j=this._baseline;l[x][0]>j?l[x][0]=j:l[x][1]<j&&(l[x][1]=j)}var D=r["scale"+(C?"Time":"Linear")]().domain(l.x).range([0,k]),q=r["scale"+(A?"Time":"Linear")]().domain(l.y.reverse()).range([0,y]),S=n.nest().key(function(t){return t.shape}).entries(_);S.forEach(function(t){if(d._buffer[t.key]){var e=d._buffer[t.key].bind(d)(t.values,D,q,d._shapeConfig[t.key]);D=e[0],q=e[1]}}),w=D.domain(),O=q.domain();var L="x"!==this._discrete||C?void 0:Array.from(new Set(_.map(function(t){return t.x}))),T="y"!==this._discrete||A?void 0:Array.from(new Set(_.map(function(t){return t.y})));this._yTest.domain(O).height(y).scale(A?"time":"linear").select(e.elem("g.d3plus-plot-test",{enter:{opacity:0},parent:this._select}).node()).ticks(T).width(k).config(this._yConfig).render();var z=this._yTest.outerBounds().width+this._yTest.padding();this._xTest.domain(w).height(y).range([z,void 0]).scale(C?"time":"linear").select(e.elem("g.d3plus-plot-test",{enter:{opacity:0},parent:this._select}).node()).ticks(L).width(k).config(this._xConfig).render(),this._xAxis.domain(w).height(y).range([z,void 0]).scale(C?"time":"linear").select(e.elem("g.d3plus-plot-x-axis",{parent:m,transition:b,enter:{transform:v},update:{transform:v}}).node()).ticks(L).width(k).config(this._xConfig).render(),D=this._xAxis._d3Scale,this._yAxis.domain(O).height(y).range([this._xAxis.outerBounds().y,this._xTest.outerBounds().y]).scale(A?"time":"linear").select(e.elem("g.d3plus-plot-y-axis",{parent:m,transition:b,enter:{transform:v},update:{transform:v}}).node()).ticks(T).width(D.range()[1]+this._xAxis.padding()).config(this._yConfig).render(),q=this._yAxis._d3Scale;var B={duration:this._duration,fill:function(t){return d._shapeConfig.fill(t.data,t.i)},label:function(t){return d._drawLabel(t.data,t.i)},opacity:function(t){return d._shapeConfig.opacity(t.data,t.i)},select:e.elem("g.d3plus-plot-shapes",{parent:m,transition:b}).node(),stroke:function(t){return d._shapeConfig.stroke(t.data,t.i)},strokeWidth:function(t){return d._shapeConfig.strokeWidth(t.data,t.i)},x:function(t){return D(t.x)},y:function(t){return q(t.y)}},E={x0:"x"===this._discrete?B.x:D(0),x1:"x"===this._discrete?null:B.x,y0:"y"===this._discrete?B.y:q(0),y1:"y"===this._discrete?null:B.y};this._stacked&&(E[x+"0"]=function(t,e){return("x"===x?D:q)(f[p.indexOf(t.id)][e][0])},E[x+"1"]=function(t,e){return("x"===x?D:q)(f[p.indexOf(t.id)][e][1])}),B=Object.assign(B,E);var P=Object.keys(this._on);return S.forEach(function(t){for(var e=(new h[t.key]).config(B).data(t.values),i=P.filter(function(e){return e.includes("."+t.key)}),n=P.filter(function(t){return!t.includes(".")}),r=P.filter(function(t){return t.includes(".shape")}),s=0;s<n.length;s++)e.on(n[s],u.bind(d._on[n[s]]));for(var o=0;o<r.length;o++)e.on(r[o],u.bind(d._on[r[o]]));for(var a=0;a<i.length;a++)e.on(i[a],u.bind(d._on[i[a]]));e.config(d._shapeConfig[t.key]||{}).render(),d._shapes.push(e)}),this},u.prototype.baseline=function(t){return arguments.length?(this._baseline=t,this):this._baseline},u.prototype.stacked=function(t){return arguments.length?(this._stacked=t,this):this._stacked},u.prototype.x=function(t){return arguments.length?(this._x="function"==typeof t?t:e.constant(t),this):this._x},u.prototype.xConfig=function(t){return arguments.length?(this._xConfig=Object.assign(this._xConfig,t),this):this._xConfig},u.prototype.xDomain=function(t){return arguments.length?(this._xDomain=t,this):this._xDomain},u.prototype.y=function(t){return arguments.length?(this._y="function"==typeof t?t:e.constant(t),this):this._y},u.prototype.yConfig=function(t){return arguments.length?(this._yConfig=Object.assign(this._yConfig,t),this):this._yConfig},u.prototype.yDomain=function(t){return arguments.length?(this._yDomain=t,this):this._yDomain},u}(u.Viz),_=function(t){function i(){t.call(this),this._baseline=0,this._discrete="x",this._shape=e.constant("Area")}return t&&(i.__proto__=t),i.prototype=Object.create(t&&t.prototype),i.prototype.constructor=i,i}(p),y=function(t){function i(){t.call(this),this._discrete="x",this._shape=e.constant("Line")}return t&&(i.__proto__=t),i.prototype=Object.create(t&&t.prototype),i.prototype.constructor=i,i}(p),x=function(t){function e(){t.call(this),this._stacked=!0}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(_);t.AreaPlot=_,t.LinePlot=y,t.Plot=p,t.StackedArea=x,Object.defineProperty(t,"__esModule",{value:!0})});