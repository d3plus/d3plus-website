/*
  d3plus-plot v0.3.4
  A reusable javascript x/y plot built on D3.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3plus-common"),require("d3-array"),require("d3-collection"),require("d3-scale"),require("d3-shape"),require("d3-selection"),require("d3plus-axis"),require("d3plus-color"),require("d3plus-shape"),require("d3plus-viz")):"function"==typeof define&&define.amd?define("d3plus-plot",["exports","d3plus-common","d3-array","d3-collection","d3-scale","d3-shape","d3-selection","d3plus-axis","d3plus-color","d3plus-shape","d3plus-viz"],e):e(t.d3plus=t.d3plus||{},t.d3plusCommon,t.d3Array,t.d3Collection,t.scales,t.d3Shape,t.d3Selection,t.d3plusAxis,t.d3plusColor,t.shapes,t.d3plusViz)}(this,function(t,e,i,n,r,s,o,a,c,h,u){"use strict";var d=function(t,e,i,n){var r=e.domain().slice(),s=e.range(),o=i.domain().slice(),a=i.range();return t.forEach(function(t){var c=n.r(t.data,t.i);if(e(t.x)-s[0]<2*c){var h=e.invert(e(t.x)-2*c);h<r[0]&&(r[0]=h)}if(s[1]-e(t.x)<2*c){var u=e.invert(e(t.x)+2*c);u>r[1]&&(r[1]=u)}if(i(t.y)-a[0]<2*c){var d=i.invert(i(t.y)-2*c);d>o[0]&&(o[0]=d)}if(a[1]-i(t.y)<2*c){var l=i.invert(i(t.y)+2*c);l<o[1]&&(o[1]=l)}}),e.domain(r),i.domain(o),[e,i]},l=function(t,e,i,n){var r=e.domain().slice(),s=e.range(),o=i.domain().slice(),a=i.range();return t.forEach(function(t){var c=n.height(t.data,t.i),h=n.width(t.data,t.i);if(e(t.x)-s[0]<h){var u=e.invert(e(t.x)-h);u<r[0]&&(r[0]=u)}if(s[1]-e(t.x)<h){var d=e.invert(e(t.x)+h);d>r[1]&&(r[1]=d)}if(i(t.y)-a[0]<c){var l=i.invert(i(t.y)-c);l>o[0]&&(o[0]=l)}if(a[1]-i(t.y)<c){var f=i.invert(i(t.y)+c);f<o[1]&&(o[1]=f)}}),e.domain(r),i.domain(o),[e,i]},f=function(t,e,n){var r=this,s="x"===this._discrete?n:e,o=s.domain().slice();"x"===this._discrete&&o.reverse();var a=t.map(function(t){return t["x"===r._discrete?"y":"x"]}),c=s.invert(s(i.max(a))+("x"===this._discrete?-10:10));return c>o[1]&&(o[1]=c),"x"===this._discrete&&o.reverse(),s.domain(o),[e,n]},_=function(t){function u(){var i=this;t.call(this),this._buffer={Circle:d,Line:f,Rect:l},this._shape=e.constant("Circle"),this._shapeConfig=Object.assign(this._shapeConfig,{Circle:{r:e.constant(5)},Line:{fill:e.constant("none"),label:!1,stroke:function(t,e){return c.assign(i._id(t,e))},strokeWidth:e.constant(1)},Rect:{height:e.constant(10),width:e.constant(10)}}),this._x=e.accessor("x"),this._xAxis=(new a.AxisBottom).align("end"),this._xTest=(new a.AxisBottom).align("end").gridSize(0),this._xConfig={title:"X Axis"},this._y=e.accessor("y"),this._yAxis=(new a.AxisLeft).align("start"),this._yTest=(new a.AxisLeft).align("start").gridSize(0),this._yConfig={title:"Y Axis"}}return t&&(u.__proto__=t),u.prototype=Object.create(t&&t.prototype),u.prototype.constructor=u,u.prototype.render=function(c){function u(t){var e={},i=function(i){({}).hasOwnProperty.call(t,i)&&!h[i]&&(e[i]="function"==typeof t[i]?function(e){return t[i](e.data,e.i)}:t[i])};for(var n in t)i(n);return e}function d(t){if(t.nested&&t.values){var i=v._discrete,n=o.mouse(v._select.node())["x"===i?0:1],r=t.values.map(function(t){return E[i](t)});t=t.values[r.indexOf(e.closest(n,r))]}return this(t.data,t.i)}var l=this;t.prototype.render.call(this,c);var f,_,p,y=this._filteredData.map(function(t,e){return{data:t,i:e,id:l._id(t,e),shape:l._shape(t,e),x:l._x(t,e),y:l._y(t,e)}}),x=this._height-this._margin.top-this._margin.bottom,g=this._discrete?"x"===this._discrete?"y":"x":void 0,m=this._select,v=this,b="translate("+this._margin.left+", "+this._margin.top+")",C=this._transition,k=this._width-this._margin.left-this._margin.right;this._stacked?(p=Array.from(new Set(y.map(function(t){return t.id}))),_=s.stack().keys(p).value(function(t,e){var i=t.filter(function(t){return t.id===e});return i.length?i[0][g]:0})(n.nest().key(function(t){return t[l._discrete]}).entries(y).map(function(t){return t.values})),f={},f[this._discrete]=i.extent(y,function(t){return t[l._discrete]}),f[g]=[i.min(_.map(function(t){return i.min(t.map(function(t){return t[1]}))})),i.max(_.map(function(t){return i.max(t.map(function(t){return t[1]}))}))]):f={x:i.extent(y,function(t){return t.x}),y:i.extent(y,function(t){return t.y})};var A=this._time&&this._x(y[0],0)===this._time(y[0],0),w=this._time&&this._y(y[0],0)===this._time(y[0],0);(A||w)&&y.forEach(function(t){A&&(t.x=a.date(t.x)),w&&(t.y=a.date(t.y))});var O=this._xDomain?this._xDomain.slice():f.x;void 0===O[0]&&(O[0]=f.x[0]),void 0===O[1]&&(O[1]=f.x[1]),A&&(O=O.map(a.date));var j=this._yDomain?this._yDomain.slice():f.y;if(void 0===j[0]&&(j[0]=f.y[0]),void 0===j[1]&&(j[1]=f.y[1]),w&&(j=j.map(a.date)),f={x:O,y:j},g&&void 0!==this._baseline){var S=this._baseline;f[g][0]>S?f[g][0]=S:f[g][1]<S&&(f[g][1]=S)}var D=r["scale"+(A?"Time":"Linear")]().domain(f.x).range([0,k]),q=r["scale"+(w?"Time":"Linear")]().domain(f.y.reverse()).range([0,x]),L=n.nest().key(function(t){return t.shape}).entries(y);L.forEach(function(t){if(l._buffer[t.key]){var e=l._buffer[t.key].bind(l)(t.values,D,q,l._shapeConfig[t.key]);D=e[0],q=e[1]}}),O=D.domain(),j=q.domain();var T="x"!==this._discrete||A?void 0:Array.from(new Set(y.map(function(t){return t.x}))),z="y"!==this._discrete||w?void 0:Array.from(new Set(y.map(function(t){return t.y})));this._yTest.domain(j).height(x).scale(w?"time":"linear").select(e.elem("g.d3plus-plot-test",{enter:{opacity:0},parent:this._select}).node()).ticks(z).width(k).config(this._yConfig).render();var B=this._yTest.outerBounds().width+this._yTest.padding();this._xTest.domain(O).height(x).range([B,void 0]).scale(A?"time":"linear").select(e.elem("g.d3plus-plot-test",{enter:{opacity:0},parent:this._select}).node()).ticks(T).width(k).config(this._xConfig).render(),this._xAxis.domain(O).height(x).range([B,void 0]).scale(A?"time":"linear").select(e.elem("g.d3plus-plot-x-axis",{parent:m,transition:C,enter:{transform:b},update:{transform:b}}).node()).ticks(T).width(k).config(this._xConfig).render(),D=this._xAxis._d3Scale,this._yAxis.domain(j).height(x).range([this._xAxis.outerBounds().y,this._xTest.outerBounds().y]).scale(w?"time":"linear").select(e.elem("g.d3plus-plot-y-axis",{parent:m,transition:C,enter:{transform:b},update:{transform:b}}).node()).ticks(z).width(D.range()[1]+this._xAxis.padding()).config(this._yConfig).render(),q=this._yAxis._d3Scale;var E={duration:this._duration,label:function(t){return l._drawLabel(t.data,t.i)},select:e.elem("g.d3plus-plot-shapes",{parent:m,transition:C,enter:{transform:b},update:{transform:b}}).node(),x:function(t){return D(t.x)},y:function(t){return q(t.y)}};E=Object.assign(E,u(this._shapeConfig));var P={x0:"x"===this._discrete?E.x:D(0),x1:"x"===this._discrete?null:E.x,y0:"y"===this._discrete?E.y:q(0),y1:"y"===this._discrete?null:E.y};if(this._stacked){var R="x"===g?D:q;P[g+"0"]=function(t,e){var i=p.indexOf(t.id);return R(i>=0?_[i][e][0]:0)},P[g+"1"]=function(t,e){var i=p.indexOf(t.id);return R(i>=0?_[i][e][1]:0)}}E=Object.assign(E,P);var V=Object.keys(this._on);return L.forEach(function(t){for(var e=(new h[t.key]).config(E).data(t.values),i=V.filter(function(e){return e.includes("."+t.key)}),n=V.filter(function(t){return!t.includes(".")}),r=V.filter(function(t){return t.includes(".shape")}),s=0;s<n.length;s++)e.on(n[s],d.bind(l._on[n[s]]));for(var o=0;o<r.length;o++)e.on(r[o],d.bind(l._on[r[o]]));for(var a=0;a<i.length;a++)e.on(i[a],d.bind(l._on[i[a]]));e.config(l._shapeConfig[t.key]?u(l._shapeConfig[t.key]):{}).render(),l._shapes.push(e)}),this},u.prototype.baseline=function(t){return arguments.length?(this._baseline=t,this):this._baseline},u.prototype.stacked=function(t){return arguments.length?(this._stacked=t,this):this._stacked},u.prototype.x=function(t){return arguments.length?("function"==typeof t?this._x=t:(this._x=e.accessor(t),this._aggs[t]||"x"!==this._discrete||(this._aggs[t]=function(t){var e=Array.from(new Set(t));return 1===e.length?e[0]:e})),this):this._x},u.prototype.xConfig=function(t){return arguments.length?(this._xConfig=Object.assign(this._xConfig,t),this):this._xConfig},u.prototype.xDomain=function(t){return arguments.length?(this._xDomain=t,this):this._xDomain},u.prototype.y=function(t){return arguments.length?("function"==typeof t?this._y=t:(this._y=e.accessor(t),this._aggs[t]||"y"!==this._discrete||(this._aggs[t]=function(t){var e=Array.from(new Set(t));return 1===e.length?e[0]:e})),this):this._y},u.prototype.yConfig=function(t){return arguments.length?(this._yConfig=Object.assign(this._yConfig,t),this):this._yConfig},u.prototype.yDomain=function(t){return arguments.length?(this._yDomain=t,this):this._yDomain},u}(u.Viz),p=function(t){function i(){t.call(this),this._baseline=0,this._discrete="x",this._shape=e.constant("Area"),this.x("x")}return t&&(i.__proto__=t),i.prototype=Object.create(t&&t.prototype),i.prototype.constructor=i,i}(_),y=function(t){function i(){t.call(this),this._discrete="x",this._shape=e.constant("Line"),this.x("x")}return t&&(i.__proto__=t),i.prototype=Object.create(t&&t.prototype),i.prototype.constructor=i,i}(_),x=function(t){function e(){t.call(this),this._stacked=!0}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(p);t.AreaPlot=p,t.LinePlot=y,t.Plot=_,t.StackedArea=x,Object.defineProperty(t,"__esModule",{value:!0})});