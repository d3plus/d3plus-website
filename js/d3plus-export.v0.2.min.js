/*
  d3plus-export v0.2.1
  Export methods for transforming and downloading SVG.
  Copyright (c) 2017 D3plus - https://d3plus.org
  @license MIT
*/
(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?t(exports,require("html2canvas"),require("canvg-browser"),require("d3-selection"),require("canvas-toBlob"),require("file-saver")):typeof define==="function"&&define.amd?define("d3plus-export",["exports","html2canvas","canvg-browser","d3-selection","canvas-toBlob","file-saver"],t):t(e.d3plus=e.d3plus||{},e.html2canvas,e.canvg,e.d3Selection,null,e.fileSaver)})(this,function(e,t,a,i,s,r){"use strict";t="default"in t?t["default"]:t;a="default"in a?a["default"]:a;var l={background:false,callback:function(){},exclude:[],padding:0,scale:1};var n={ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true};var c=function(e,s){if(!e){return}if(!(e instanceof Array)){e=[e]}s=Object.assign({},l,s);var r=new RegExp(/(MSIE|Trident\/|Edge\/)/i).test(navigator.userAgent);var c=window?window.devicePixelRatio||1:1;function o(e){var t=e.attr("stroke-width");e.attr("stroke-width",!t?0:t*c)}var d=e[0];if(d.constructor===Object){d=d.element}var h=s.height||parseFloat(i.select(d).style("height")),g=s.width||parseFloat(i.select(d).style("width"));var f,v,u=0,p=0;if(d.getBoundingClientRect){var y=d.getBoundingClientRect();u=y.left;p=y.top}else{u=d.offsetLeft;p=d.offsetTop}var m=document.createElement("canvas");m.width=(g+s.padding*2)*s.scale*c;m.height=(h+s.padding*2)*s.scale*c;m.style.width=(g+s.padding*2)*s.scale;m.style.height=(h+s.padding*2)*s.scale;var w=m.getContext("2d");w.scale(s.scale*c,s.scale*c);w.clearRect(0,0,m.width/2,m.height/2);if(s.background){w.beginPath();w.rect(0,0,m.width/2,m.height/2);w.fillStyle=s.background;w.fill()}var x=[];function b(e){if(s.exclude.includes(this)){return}var a=Object.assign({},e);if(this.tagName){var r=i.select(this).attr("opacity")||i.select(this).style("opacity");var l=i.select(this).style("display");var n=i.select(this).style("visibility");if(l==="none"||n==="hidden"||r&&r===0){return}var d=i.select(this).attr("transform"),y=this.tagName.toLowerCase();if(y==="g"&&d){var m=d.match(/scale\(([^a-z]+)\)/i);if(m){a.scale*=Math.round(parseFloat(m[1]))}var w=d.match(/translate\(([^a-z]+)\)/i);if(w){var b=w[1].replace(/([^a-z]),*\s([^a-z])/gi,"$1,$2").split(",").map(function(e){return Math.round(parseFloat(e)*a.scale)});var M=b[0];var j=b[1];a.x+=M;a.y+=j}}if(y==="svg"){var z=i.select(this).attr("x");z=z?Math.round(parseFloat(z))*a.scale:0;a.x+=z;var O=i.select(this).attr("y");O=O?Math.round(parseFloat(O))*a.scale:0;a.y+=O;a.clip={height:Math.round(parseFloat(i.select(this).attr("height")||i.select(this).style("height"))),width:Math.round(parseFloat(i.select(this).attr("width")||i.select(this).style("width"))),x:z,y:O}}else{var F=i.select(this).attr("x");if(F){a.x+=parseFloat(F)*a.scale}var E=i.select(this).attr("y");if(E){a.y+=parseFloat(E)*a.scale}}}var T=(this.tagName||"").toLowerCase();if(!T.length){var A=(this.wholeText||"").replace(/\s/g,"");if(A.length){var C=this.nodeValue.replace(/^\s*/,"").replace(/^\n/,"").replace(/^\s*/,"").replace(/\n$/,"").replace(/\s*$/,"").replace(/\n$/,"");x.push({type:"text",style:this.parentNode,value:C,x:a.x,y:a.y})}}else if(T==="defs"){return}else if(T==="text"){var R=this.cloneNode(true);i.select(R).call(o);x.push(Object.assign({},a,{type:"svg",value:R}))}else if(["div","foreignobject","span"].includes(T)&&!i.select(this).selectAll("svg").size()){var S={height:h,loaded:false,type:"html",width:g,x:f-u,y:v-p};var L=document.createElement("canvas");L.width=(g+s.padding*2)*s.scale*c;L.height=(h+s.padding*2)*s.scale*c;var N=L.getContext("2d");N.scale(s.scale*c,s.scale*c);x.push(S);t(this,{allowTaint:true,background:undefined,canvas:L,height:h,letterRendering:true,taintTest:false,width:g}).then(function(e){S.value=e;S.loaded=true})}else if(this.childNodes.length>0){if(T==="svg"){var B=this.getBoundingClientRect();a.x+=B.left-u;a.y+=B.top-p}k(this,a)}else if(["image","img"].includes(T)){var $=i.select(this).attr("href")||i.select(this).attr("xlink:href");if($.length){var q=parseFloat(i.select(this).attr("height"))*a.scale,I=parseFloat(i.select(this).attr("width"))*a.scale;var P={clip:a.clip,height:q,loaded:false,type:"img",width:I,x:a.x,y:a.y};x.push(P);var X=new Image;X.crossOrigin="Anonymous";X.onload=function(){var e=document.createElement("canvas");var t=e.getContext("2d");e.height=q*c;e.width=I*c;t.drawImage(this,0,0,I*c,q*c);var a=document.createElement("img");a.src=e.toDataURL("image/png");P.value=a;P.loaded=true};X.src=$}}else if(T!=="g"){var D=this.cloneNode(true);i.select(D).call(o);x.push(Object.assign({},a,{type:"svg",value:D}));var H=i.select(D).attr("fill");if(H&&H.indexOf("url")===0){var Y=i.select(D).attr("transform");if(Y){var _=Y.match(/scale\(([^a-z]+)\)/i);if(_){a.scale*=Math.round(parseFloat(_[1]))}var U=Y.match(/translate\(([^a-z]+)\)/i);if(U){var V=U[1].replace(/([^a-z]),*\s([^a-z])/gi,"$1,$2").split(",").map(function(e){return Math.round(parseFloat(e)*a.scale)});var G=V[0];var J=V[1];a.x+=G;a.y+=J}}k(i.select(H.slice(4,-1)).node(),a)}}}function k(e,t){i.selectAll(e.childNodes).each(function(){b.bind(this)(t)})}for(var M=0;M<e.length;M++){var j=e[M],z={scale:1,x:0,y:0};if(j.constructor===Object){z=Object.assign(z,j);j=j.element}f=z.x;v=z.y;b.bind(j)(z)}function O(){var e=true;for(var t=0;t<x.length;t++){if(x[t].loaded===false){e=false;break}}if(e){F()}else{setTimeout(O,500)}}O();function F(){for(var e=0;e<x.length;e++){var t=x[e];var l=t.clip;switch(t.type){case"img":w.save();w.beginPath();w.translate(s.padding,s.padding);w.rect(l?l.x:0,l?l.y:0,l?l.width:g,l?l.height:h);w.clip();w.drawImage(t.value,t.x,t.y,t.width,t.height);w.restore();break;case"html":w.save();w.beginPath();w.translate(s.padding,s.padding);w.drawImage(t.value,t.x,t.y,t.width,t.height);w.restore();break;case"text":var c=i.select(t.style);var o=t.value.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");var d=c.style("color"),f=c.style("font-size");var v=c.style("font-family").split(",")[0];if(v.indexOf("'")!==0){v="'"+v+"'"}var u="<text stroke='none' dy='"+f+"' fill='"+d+"' font-family="+v+" font-size='"+f+"'>"+o+"</text>";w.save();w.translate(s.padding,s.padding);a(m,u,Object.assign({offsetX:t.x,offsetY:t.y},n));w.restore();break;case"svg":var p=r?(new XMLSerializer).serializeToString(t.value):t.value.outerHTML;w.save();w.translate(s.padding,s.padding);w.rect(l?l.x:0,l?l.y:0,l?l.width:g,l?l.height:h);w.clip();a(m,p,Object.assign({offsetX:t.x,offsetY:t.y},n));w.restore();break;default:console.warn("uncaught",t);break}}s.callback(m)}};var o={filename:"download",type:"png"};var d=function(e,t,a){if(t===void 0)t={};if(a===void 0)a={};if(!e){return}t=Object.assign({},o,t);var i=new RegExp(/(MSIE|Trident\/|Edge\/)/i).test(navigator.userAgent);if(!(e instanceof Array)&&t.type==="svg"){var s=i?(new XMLSerializer).serializeToString(e):e.outerHTML;r.saveAs(new Blob([s],{type:"application/svg+xml"}),t.filename+".svg")}c(e,Object.assign({},a,{callback:function(e){if(a.callback){a.callback(e)}if(["jpg","png"].includes(t.type)){e.toBlob(function(e){return r.saveAs(e,t.filename)})}}}))};e.dom2canvas=c;e.saveElement=d;Object.defineProperty(e,"__esModule",{value:true})});