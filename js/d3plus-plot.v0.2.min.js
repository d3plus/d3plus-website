/*
  d3plus-plot v0.2.0
  A reusable javascript x/y plot built on D3.
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3plus-common"),require("d3-array"),require("d3-collection"),require("d3-scale"),require("d3-shape"),require("d3-selection"),require("d3plus-axis"),require("d3plus-color"),require("d3plus-shape"),require("d3plus-viz")):"function"==typeof define&&define.amd?define("d3plus-plot",["exports","d3plus-common","d3-array","d3-collection","d3-scale","d3-shape","d3-selection","d3plus-axis","d3plus-color","d3plus-shape","d3plus-viz"],e):e(t.d3plus=t.d3plus||{},t.d3plusCommon,t.d3Array,t.d3Collection,t.scales,t.d3Shape,t.d3Selection,t.d3plusAxis,t.d3plusColor,t.shapes,t.d3plusViz)}(this,function(t,e,i,n,r,s,o,a,c,u,d){"use strict";function h(t,e,i,n){var r=e.domain().slice(),s=e.range(),o=i.domain().slice(),a=i.range();return t.forEach(function(t){var c=n.r(t.data,t.i);if(e(t.x)-s[0]<2*c){var u=e.invert(e(t.x)-2*c);u<r[0]&&(r[0]=u)}if(s[1]-e(t.x)<2*c){var d=e.invert(e(t.x)+2*c);d>r[1]&&(r[1]=d)}if(i(t.y)-a[0]<2*c){var h=i.invert(i(t.y)-2*c);h>o[0]&&(o[0]=h)}if(a[1]-i(t.y)<2*c){var l=i.invert(i(t.y)+2*c);l<o[1]&&(o[1]=l)}}),e.domain(r),i.domain(o),[e,i]}function l(t,e,i,n){var r=e.domain().slice(),s=e.range(),o=i.domain().slice(),a=i.range();return t.forEach(function(t){var c=n.height(t.data,t.i),u=n.width(t.data,t.i);if(e(t.x)-s[0]<u){var d=e.invert(e(t.x)-u);d<r[0]&&(r[0]=d)}if(s[1]-e(t.x)<u){var h=e.invert(e(t.x)+u);h>r[1]&&(r[1]=h)}if(i(t.y)-a[0]<c){var l=i.invert(i(t.y)-c);l>o[0]&&(o[0]=l)}if(a[1]-i(t.y)<c){var f=i.invert(i(t.y)+c);f<o[1]&&(o[1]=f)}}),e.domain(r),i.domain(o),[e,i]}var f=function(t){function d(){var i=this;t.call(this),this._buffer={Circle:h,Rect:l},this._shape=e.constant("Circle"),this._shapeConfig=Object.assign(this._shapeConfig,{Circle:{r:e.constant(5)},Line:{fill:e.constant("none"),label:!1,stroke:function(t,e){return c.assign(i._id(t,e))},strokeWidth:e.constant(1)},Rect:{height:e.constant(10),width:e.constant(10)}}),this._x=e.accessor("x"),this._xAxis=(new a.AxisBottom).align("end"),this._xTest=(new a.AxisBottom).align("end").gridSize(0),this._xConfig={title:"X Axis"},this._y=e.accessor("y"),this._yAxis=(new a.AxisLeft).align("start"),this._yTest=(new a.AxisLeft).align("start").gridSize(0),this._yConfig={title:"Y Axis"}}return t&&(d.__proto__=t),d.prototype=Object.create(t&&t.prototype),d.prototype.constructor=d,d.prototype.render=function(a){function c(t){if(t.nested&&t.values){var i=m._discrete,n=o.mouse(m._select.node())["x"===i?0:1],r=t.values.map(function(t){return q[i](t)});t=t.values[r.indexOf(e.closest(n,r))]}return this(t.data,t.i)}var d=this;t.prototype.render.call(this,a);var h,l,f,p=this._filteredData.map(function(t,e){return{data:t,i:e,id:d._id(t,e),shape:d._shape(t,e),x:d._x(t,e),y:d._y(t,e)}}),_=this._height-this._margin.top-this._margin.bottom,y=this._discrete?"x"===this._discrete?"y":"x":void 0,x=this._select,m=this,g="translate("+this._margin.left+", "+this._margin.top+")",v=this._transition,k=this._width-this._margin.left-this._margin.right;this._stacked?(f=Array.from(new Set(p.map(function(t){return t.id}))),l=s.stack().keys(f).value(function(t,e){return t.filter(function(t){return t.id===e})[0][y]})(n.nest().key(function(t){return t[d._discrete]}).entries(p).map(function(t){return t.values})),h={},h[this._discrete]=i.extent(p,function(t){return t[d._discrete]}),h[y]=[i.min(l.map(function(t){return i.min(t.map(function(t){return t[1]}))})),i.max(l.map(function(t){return i.max(t.map(function(t){return t[1]}))}))]):h={x:i.extent(p,function(t){return t.x}),y:i.extent(p,function(t){return t.y})};var b=this._xDomain?this._xDomain.slice():h.x;void 0===b[0]&&(b[0]=h.x[0]),void 0===b[1]&&(b[1]=h.x[1]);var A=this._yDomain?this._yDomain.slice():h.y;if(void 0===A[0]&&(A[0]=h.y[0]),void 0===A[1]&&(A[1]=h.y[1]),h={x:b,y:A},y&&void 0!==this._baseline){var C=this._baseline;h[y][0]>C?h[y][0]=C:h[y][1]<C&&(h[y][1]=C)}var w=r.scaleLinear().domain(h.x).range([0,k]),S=r.scaleLinear().domain(h.y.reverse()).range([0,_]),D=n.nest().key(function(t){return t.shape}).entries(p);D.forEach(function(t){if(d._buffer[t.key]){var e=d._buffer[t.key](t.values,w,S,d._shapeConfig[t.key]);w=e[0],S=e[1]}}),this._yTest.domain(S.domain()).height(_).select(e.elem("g.d3plus-plot-test",{enter:{opacity:0},parent:this._select}).node()).ticks("y"===this._discrete?Array.from(new Set(p.map(function(t){return t.y}))):void 0).width(k).config(this._yConfig).render();var O=this._yTest.outerBounds().width+this._yTest.padding();this._xTest.domain(w.domain()).height(_).range([O,void 0]).select(e.elem("g.d3plus-plot-test",{enter:{opacity:0},parent:this._select}).node()).ticks("x"===this._discrete?Array.from(new Set(p.map(function(t){return t.x}))):void 0).width(k).config(this._xConfig).render(),this._xAxis.domain(w.domain()).height(_).range([O,void 0]).select(e.elem("g.d3plus-plot-x-axis",{parent:x,transition:v,enter:{transform:g},update:{transform:g}}).node()).ticks("x"===this._discrete?Array.from(new Set(p.map(function(t){return t.x}))):void 0).width(k).config(this._xConfig).render(),w=this._xAxis._d3Scale,this._yAxis.domain(S.domain()).height(_).range([this._xAxis.outerBounds().y,this._xTest.outerBounds().y]).select(e.elem("g.d3plus-plot-y-axis",{parent:x,transition:v,enter:{transform:g},update:{transform:g}}).node()).ticks("y"===this._discrete?Array.from(new Set(p.map(function(t){return t.y}))):void 0).width(w.range()[1]+this._xAxis.padding()).config(this._yConfig).render(),S=this._yAxis._d3Scale;var q={duration:this._duration,fill:function(t){return d._shapeConfig.fill(t.data,t.i)},label:function(t){return d._drawLabel(t.data,t.i)},opacity:function(t){return d._shapeConfig.opacity(t.data,t.i)},select:e.elem("g.d3plus-plot-shapes",{parent:x,transition:v}).node(),stroke:function(t){return d._shapeConfig.stroke(t.data,t.i)},strokeWidth:function(t){return d._shapeConfig.strokeWidth(t.data,t.i)},x:function(t){return w(t.x)},y:function(t){return S(t.y)}},j={x0:"x"===this._discrete?q.x:w(0),x1:"x"===this._discrete?null:q.x,y0:"y"===this._discrete?q.y:S(0),y1:"y"===this._discrete?null:q.y};this._stacked&&(j[y+"0"]=function(t,e){return("x"===y?w:S)(l[f.indexOf(t.id)][e][0])},j[y+"1"]=function(t,e){return("x"===y?w:S)(l[f.indexOf(t.id)][e][1])}),q=Object.assign(q,j);var L=Object.keys(this._on);return D.forEach(function(t){for(var e=(new u[t.key]).config(q).data(t.values),i=L.filter(function(e){return e.includes("."+t.key)}),n=L.filter(function(t){return!t.includes(".")}),r=L.filter(function(t){return t.includes(".shape")}),s=0;s<n.length;s++)e.on(n[s],c.bind(d._on[n[s]]));for(var o=0;o<r.length;o++)e.on(r[o],c.bind(d._on[r[o]]));for(var a=0;a<i.length;a++)e.on(i[a],c.bind(d._on[i[a]]));e.config(d._shapeConfig[t.key]||{}).render(),d._shapes.push(e)}),this},d.prototype.baseline=function(t){return arguments.length?(this._baseline=t,this):this._baseline},d.prototype.stacked=function(t){return arguments.length?(this._stacked=t,this):this._stacked},d.prototype.x=function(t){return arguments.length?(this._x="function"==typeof t?t:e.constant(t),this):this._x},d.prototype.xDomain=function(t){return arguments.length?(this._xDomain=t,this):this._xDomain},d.prototype.y=function(t){return arguments.length?(this._y="function"==typeof t?t:e.constant(t),this):this._y},d.prototype.yDomain=function(t){return arguments.length?(this._yDomain=t,this):this._yDomain},d}(d.Viz),p=function(t){function i(){t.call(this),this.discrete("x"),this._shape=e.constant("Area")}return t&&(i.__proto__=t),i.prototype=Object.create(t&&t.prototype),i.prototype.constructor=i,i.prototype.discrete=function(t){return arguments.length?(this._discrete=t,this._baseline=0,this):this._discrete},i}(f),_=function(t){function i(){t.call(this),this._discrete="x",this._shape=e.constant("Line")}return t&&(i.__proto__=t),i.prototype=Object.create(t&&t.prototype),i.prototype.constructor=i,i}(f),y=function(t){function e(){t.call(this),this._stacked=!0}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(p);t.Area=p,t.LinePlot=_,t.Plot=f,t.StackedArea=y,Object.defineProperty(t,"__esModule",{value:!0})});