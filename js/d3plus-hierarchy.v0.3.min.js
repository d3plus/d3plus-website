/*
  d3plus-hierarchy v0.3.3
  Nested, hierarchical, and cluster charts built on D3
  Copyright (c) 2017 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("d3-array"),require("d3-shape"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-viz"),require("d3-hierarchy"),require("d3-scale"),require("d3-collection")):typeof define==="function"&&define.amd?define("d3plus-hierarchy",["exports","d3-array","d3-shape","d3plus-common","d3plus-shape","d3plus-viz","d3-hierarchy","d3-scale","d3-collection"],e):e(t.d3plus=t.d3plus||{},t.d3Array,t.d3Shape,t.d3plusCommon,t.d3plusShape,t.d3plusViz,t.d3Hierarchy,t.d3Scale,t.d3Collection)})(this,function(t,e,i,r,n,a,s,o,h){"use strict";var u=function(t){function a(){var e=this;t.call(this);this._shapeConfig=r.assign({},this._shapeConfig,{Path:{fontResize:true,id:function(t){return e._ids(t).join("-")},label:function(t){return e._drawLabel(t.data,t.i)},x:0,y:0}});this._innerRadius=0;this._padPixel=0;this._pie=i.pie();this._sort=function(t,e){return e.value-t.value};this._value=r.accessor("value")}if(t)a.__proto__=t;a.prototype=Object.create(t&&t.prototype);a.prototype.constructor=a;a.prototype._draw=function a(s){t.prototype._draw.call(this,s);var o=this._height-this._margin.top-this._margin.bottom,h=this._width-this._margin.left-this._margin.right;var u=e.min([h,o])/2;var l=this._pie.padAngle(this._padAngle||this._padPixel/u).sort(this._sort).value(this._value)(this._filteredData);l.forEach(function(t,e){t.__d3plus__=true;t.i=e});var p=i.arc().innerRadius(this._innerRadius).outerRadius(u);var _="translate("+h/2+", "+o/2+")";this._shapes.push((new n.Path).data(l).d(p).select(r.elem("g.d3plus-Pie",{parent:this._select,enter:{transform:_},update:{transform:_}}).node()).config(this._shapeConfigPrep("Path")).render());return this};a.prototype.innerRadius=function t(e){return arguments.length?(this._innerRadius=e,this):this._innerRadius};a.prototype.padAngle=function t(e){return arguments.length?(this._padAngle=e,this):this._padAngle};a.prototype.padPixel=function t(e){return arguments.length?(this._padPixel=e,this):this._padPixel};a.prototype.sort=function t(e){return arguments.length?(this._sort=e,this):this._sort};a.prototype.value=function t(e){return arguments.length?(this._value=typeof e==="function"?e:r.constant(e),this):this._value};return a}(a.Viz);var l=function(t){function i(){var i=this;t.call(this);this._innerRadius=function(){return e.min([i._width-i._margin.left-i._margin.right,i._height-i._margin.top-i._margin.bottom])/4};this._padPixel=5}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;return i}(u);var p=function(t,e){if(!(e instanceof Array)){e=[e]}var i=h.nest();for(var r=0;r<e.length;r++){i.key(e[r])}var n=i.entries(t);return _(n)};function _(t){return t.map(function(t){if(t.key&&t.values){if(t.values[0].key==="undefined"){return t.values[0].values[0]}else{t.values=_(t.values)}}return t})}var d=function(t){function i(){var e=this;t.call(this);this._orient="vertical";this._separation=function(t,e){return t.parent===e.parent?1:2};var i={id:function(t,i){return e._ids(t,i).join("-")},label:function(t,i){if(e._label){return e._label(t.data,i)}var r=e._ids(t,i).slice(0,t.depth);return r[r.length-1]},hitArea:function(t,i,r){var n=e._labelHeight,a=e._labelWidths[t.depth-1];return{width:e._orient==="vertical"?a:r.r*2+a,height:e._orient==="horizontal"?n:r.r*2+n,x:e._orient==="vertical"?-a/2:t.children&&t.depth!==e._groupBy.length?-(r.r+a):-r.r,y:e._orient==="horizontal"?-n/2:t.children&&t.depth!==e._groupBy.length?-(r.r+e._labelHeight):-r.r}},labelBounds:function(t,i,r){var n=e._labelHeight,a=e._orient==="vertical"?"height":"width",s=e._labelWidths[t.depth-1],o=e._orient==="vertical"?"width":"height",h=e._orient==="vertical"?"x":"y",u=e._orient==="vertical"?"y":"x";return l={},l[o]=s,l[a]=n,l[h]=-s/2,l[u]=t.children&&t.depth!==e._groupBy.length?-(r.r+n):r.r,l;var l},textAnchor:function(t){return e._orient==="vertical"?"middle":t.children&&t.depth!==e._groupBy.length?"end":"start"},verticalAlign:function(t){return e._orient==="vertical"?t.depth===1?"bottom":"top":"middle"}};this._shape=r.constant("Circle");this._shapeConfig=r.assign({},this._shapeConfig,{Circle:i,fontColor:"#444",Path:{d:function(t){var i=e._shapeConfig.Circle.r||e._shapeConfig.r;if(typeof i==="function"){i=i(t.data,t.i)}var r=t.parent.x-t.x+(e._orient==="vertical"?0:i),n=t.parent.y-t.y+(e._orient==="vertical"?i:0),a=e._orient==="vertical"?0:-i,s=e._orient==="vertical"?-i:0;return e._orient==="vertical"?"M"+a+","+s+"C"+a+","+(s+n)/2+" "+r+","+(s+n)/2+" "+r+","+n:"M"+a+","+s+"C"+(a+r)/2+","+s+" "+(a+r)/2+","+n+" "+r+","+n},fill:"none",id:function(t,i){return e._ids(t,i).join("-")},stroke:"#ccc",strokeWidth:1},r:r.constant(5),width:r.constant(10),height:r.constant(10)});this._tree=s.tree()}if(t)i.__proto__=t;i.prototype=Object.create(t&&t.prototype);i.prototype.constructor=i;i.prototype._draw=function i(a){var h=this;t.prototype._draw.call(this,a);var u=this._orient==="vertical"?this._height-this._margin.top-this._margin.bottom:this._width-this._margin.left-this._margin.right,l=this._orient==="vertical"?"left":"top",_=this,d="translate("+this._margin.left+", "+this._margin.top+")",c=this._orient==="horizontal"?this._height-this._margin.top-this._margin.bottom:this._width-this._margin.left-this._margin.right;var f=this._tree.separation(this._separation).size([c,u])(s.hierarchy({key:"root",values:p(this._filteredData,this._groupBy.slice(0,this._drawDepth+1))},function(t){return t.key&&t.values?t.values:null}).sort(this._sort)).descendants().filter(function(t){return t.depth<=h._groupBy.length&&t.parent});function g(t){return r.merge(t.values.map(function(t){return t.key&&t.values?g(t):t}),_._aggs)}f.forEach(function(t,e){if(t.data.key&&t.data.values){t.data=g(t.data)}t.__d3plus__=true;t.i=e});var v=this._shapeConfig.Circle.r||this._shapeConfig.r;if(typeof v!=="function"){v=r.constant(v)}var y=e.max(f,function(t){return t.depth===1?v(t.data,t.i):0});var m=e.max(f,function(t){return t.children?0:v(t.data,t.i)});var x=e.extent(f,function(t){return t.y});this._labelHeight=e.min([this._orient==="vertical"?50:100,(x[1]-y-m)/(this._groupBy.length+1)]);this._labelWidths=p(f,function(t){return t.depth}).map(function(t){return t.values.reduce(function(i,r,n){var a=n<t.values.length-1?t.values[n+1].x:c+h._margin[l],s=n?t.values[n-1].x:h._margin[l];return e.min([i,a-r.x,r.x-s])},c)});var b=o.scaleLinear().domain(x).range([y+this._labelHeight,u-m-this._labelHeight]);f.forEach(function(t){var e=b(t.y);if(h._orient==="horizontal"){t.y=t.x;t.x=e}else{t.y=e}});var w={parent:this._select,enter:{transform:d},update:{transform:d}};this._shapes.push((new n.Path).data(f.filter(function(t){return t.depth>1})).select(r.elem("g.d3plus-Tree-Links",w).node()).config(this._shapeConfigPrep("Path")).render());this._shapes.push((new n.Circle).data(f).select(r.elem("g.d3plus-Tree-Shapes",w).node()).config(this._shapeConfigPrep("Circle")).render());return this};i.prototype.orient=function t(e){return arguments.length?(this._orient=e,this):this._orient};i.prototype.separation=function t(e){return arguments.length?(this._separation=e,this):this._separation};return i}(a.Viz);var c=function(t){function e(){t.call(this);this._padding=1;this._shapeConfig=r.assign({},this._shapeConfig,{fontResize:true,Rect:{height:function(t){return t.y1-t.y0},labelBounds:function(t,e,i){var r=i.height;var n=Math.min(50,r*.25);return[{width:i.width,height:r-n,x:-i.width/2,y:-r/2},{width:i.width,height:n,x:-i.width/2,y:r/2-n}]},width:function(t){return t.x1-t.x0}},textAnchor:["start","middle"],verticalAlign:["top","bottom"]});this._sort=function(t,e){return e.value-t.value};this._sum=r.accessor("value");this._tile=s.treemapSquarify;this._treemap=s.treemap().round(true)}if(t)e.__proto__=t;e.prototype=Object.create(t&&t.prototype);e.prototype.constructor=e;e.prototype._draw=function e(i){var a=this;t.prototype._draw.call(this,i);var o=h.nest();for(var u=0;u<=this._drawDepth;u++){o.key(a._groupBy[u])}o=o.entries(this._filteredData);var l=this._treemap.padding(this._padding).size([this._width-this._margin.left-this._margin.right,this._height-this._margin.top-this._margin.bottom]).tile(this._tile)(s.hierarchy({values:o},function(t){return t.values}).sum(this._sum).sort(this._sort));var p=[],_=this;function d(t){for(var e=0;e<t.length;e++){var i=t[e];if(i.depth<=_._drawDepth){d(i.children)}else{i.__d3plus__=true;i.id=i.data.key;i.data=r.merge(i.data.values);i.i=e;i.x=i.x0+(i.x1-i.x0)/2;i.y=i.y0+(i.y1-i.y0)/2;p.push(i)}}}if(l.children){d(l.children)}var c=l.value;var f="translate("+this._margin.left+", "+this._margin.top+")";this._shapes.push((new n.Rect).data(p).label(function(t){return[a._drawLabel(t.data,t.i),Math.round(a._sum(t.data,t.i)/c*100)+"%"]}).select(r.elem("g.d3plus-Treemap",{parent:this._select,enter:{transform:f},update:{transform:f}}).node()).config(this._shapeConfigPrep("Rect")).render());return this};e.prototype.padding=function t(e){return arguments.length?(this._padding=typeof e==="function"?e:r.constant(e),this):this._padding};e.prototype.sort=function t(e){return arguments.length?(this._sort=e,this):this._sort};e.prototype.sum=function t(e){return arguments.length?(this._sum=typeof e==="function"?e:r.constant(e),this):this._sum};e.prototype.tile=function t(e){return arguments.length?(this._tile=e,this):this._tile};return e}(a.Viz);t.Donut=l;t.Pie=u;t.Tree=d;t.Treemap=c;Object.defineProperty(t,"__esModule",{value:true})});