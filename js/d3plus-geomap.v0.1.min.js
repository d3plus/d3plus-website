/*
  d3plus-geomap v0.1.0
  A reusable geo map built on D3 and Topojson
  Copyright (c) 2016 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,o){typeof exports==="object"&&typeof module!=="undefined"?o(exports,require("d3-array"),require("d3-geo"),require("d3-scale"),require("d3-selection"),require("d3-tile"),require("d3-zoom"),require("world-atlas/world/110m.json"),require("topojson-client"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-viz")):typeof define==="function"&&define.amd?define("d3plus-geomap",["exports","d3-array","d3-geo","d3-scale","d3-selection","d3-tile","d3-zoom","world-atlas/world/110m.json","topojson-client","d3plus-common","d3plus-shape","d3plus-viz"],o):o(t.d3plus=t.d3plus||{},t.d3Array,t.d3Geo,t.scales,t.d3Selection,t.d3Tile,t.d3Zoom,t.topo,t.topojsonClient,t.d3plusCommon,t.d3plusShape,t.d3plusViz)})(this,function(t,o,e,i,n,r,s,a,p,h,l,u){"use strict";a="default"in a?a["default"]:a;var c=function(t){function u(){t.call(this);this._ocean="#cdd1d3";this._padding=20;this._point=h.accessor("point");this._pointSize=h.constant(1);this._pointSizeMax=10;this._pointSizeMin=5;this._pointSizeScale="linear";this._projection=e.geoMercator();this._rotate=[0,0];this._shape=h.constant("Circle");this._shapeConfig=Object.assign({},this._shapeConfig,{Path:{fill:"rgba(230, 230, 230, 0.25)",stroke:"rgba(40, 40, 40, 0.25)",strokeWidth:1}});this._tiles=true;this._tileGen=r.tile();this._tileUrl="https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png";this._topojson=a;this._topojsonFilter=function(t){return!["010"].includes(t.id)};this._topojsonKey="countries";this._zoom=true;this._zoomBehavior=s.zoom();this._zoomBrush=false;this._zoomFactor=2;this._zoomPan=true;this._zoomReset=true;this._zoomScroll=true;this._zoomSet=false}if(t)u.__proto__=t;u.prototype=Object.create(t&&t.prototype);u.prototype.constructor=u;u.prototype._renderTiles=function t(){var o=this;var e=2*Math.PI,i=s.zoomTransform(this._geomapGroup.node());var n=[];if(this._tiles){n=this._tileGen.extent(this._zoomBehavior.translateExtent()).scale(this._projection.scale()*e*i.k).translate(i.apply(this._projection.translate()))();this._tileGroup.attr("transform","scale("+n.scale+")translate("+n.translate+")")}var r=this._tileGroup.selectAll("image.tile").data(n,function(t){return t.join("-")});r.exit().remove();r.enter().append("image").attr("class","tile").attr("xlink:href",function(t){return o._tileUrl.replace("{s}",["a","b","c"][Math.random()*3|0]).replace("{z}",t[2]).replace("{x}",t[0]).replace("{y}",t[1])}).attr("width",1).attr("height",1).attr("x",function(t){return t[0]}).attr("y",function(t){return t[1]})};u.prototype._zoomed=function t(){this._zoomGroup.attr("transform",n.event.transform);this._renderTiles()};u.prototype._zoomEvents=function t(){if(this._zoomBrush){this._geomapGroup.on(".zoom",null)}else if(this._zoom){this._geomapGroup.call(this._zoomBehavior);if(!this._zoomScroll){this._geomapGroup.on("mousewheel.zoom",null).on("MozMousePixelScroll.zoom",null).on("wheel.zoom",null)}if(!this._zoomPan){this._geomapGroup.on("mousedown.zoom",null).on("mousemove.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null)}}else{this._geomapGroup.on(".zoom",null)}};u.prototype.render=function n(r){var s=this;t.prototype.render.call(this,r);var a=this._height-this._margin.top-this._margin.bottom,h=this._width-this._margin.left-this._margin.right;this._geomapGroup=this._select.selectAll("svg.d3plus-geomap-geomapGroup").data([0]);this._geomapGroup=this._geomapGroup.enter().append("svg").attr("class","d3plus-geomap-geomapGroup").attr("opacity",0).attr("width",h).attr("height",a).style("background-color",this._ocean||"transparent").merge(this._geomapGroup);this._geomapGroup.transition(this._transition).attr("opacity",1).attr("width",h).attr("height",a);var u=this._geomapGroup.selectAll("rect.d3plus-geomap-ocean").data([0]);u.enter().append("rect").attr("class","d3plus-geomap-ocean").merge(u).attr("width",h).attr("height",a).attr("fill",this._ocean||"transparent");this._tileGroup=this._geomapGroup.selectAll("g.d3plus-geomap-tileGroup").data([0]);this._tileGroup=this._tileGroup.enter().append("g").attr("class","d3plus-geomap-tileGroup").merge(this._tileGroup);this._zoomGroup=this._geomapGroup.selectAll("g.d3plus-geomap-zoomGroup").data([0]);this._zoomGroup=this._zoomGroup.enter().append("g").attr("class","d3plus-geomap-zoomGroup").merge(this._zoomGroup);var c=this._zoomGroup.selectAll("g.d3plus-geomap-paths").data([0]);c=c.enter().append("g").attr("class","d3plus-geomap-paths").merge(c);var _=this._topojson?p.feature(this._topojson,this._topojson.objects[this._topojsonKey]):{type:"FeatureCollection",features:[]};if(this._topojsonFilter)_.features=_.features.filter(this._topojsonFilter);var d=this._padding;if(!this._zoomSet){var m=this._bounds?{type:"FeatureCollection",features:_.features.filter(this._bounds)}:_;this._projection=this._projection.fitExtent([[d,d],[h-d*2,a-d*2]],m);this._zoomBehavior.scaleExtent([1,16]).translateExtent([[0,0],[h,a]]).on("zoom",this._zoomed.bind(this))}var f=this._path=e.geoPath().projection(this._projection);this._shapes.push((new l.Path).config(this._shapeConfig.Path).data(_.features).d(f).select(c.node()).x(0).y(0).render());var g=this._zoomGroup.selectAll("g.d3plus-geomap-pins").data([0]);g=g.enter().append("g").attr("class","d3plus-geomap-pins").merge(g);var z=this._filteredData.filter(function(t,o){return s._shape(t,o)!=="Path"});var y=i["scale"+this._pointSizeScale.charAt(0).toUpperCase()+this._pointSizeScale.slice(1)]().domain(o.extent(z,function(t,o){return s._pointSize(t,o)})).range([this._pointSizeMin,this._pointSizeMax]);var j=(new l.Circle).config(this._shapeConfig).config(this._shapeConfig.Circle||{}).data(z).r(function(t,o){return y(s._pointSize(t,o))}).select(g.node()).x(function(t,o){return s._projection(s._point(t,o))[0]}).y(function(t,o){return s._projection(s._point(t,o))[1]});var v=Object.keys(this._on);var G=v.filter(function(t){return t.includes(".Circle")}),S=v.filter(function(t){return!t.includes(".")}),x=v.filter(function(t){return t.includes(".shape")});for(var b=0;b<S.length;b++)j.on(S[b],s._on[S[b]]);for(var M=0;M<x.length;M++)j.on(x[M],s._on[x[M]]);for(var w=0;w<G.length;w++)j.on(G[w],s._on[G[w]]);this._shapes.push(j.render());this._zoomEvents();this._renderTiles();return this};u.prototype.bounds=function t(o){if(arguments.length){if(typeof o==="function")return this._bounds=o,this;if(!(o instanceof Array))o=[o];return this._bounds=function(t){return o.includes(t.id)},this}return this._bounds};u.prototype.ocean=function t(o){return arguments.length?(this._ocean=o,this):this._ocean};u.prototype.padding=function t(o){return arguments.length?(this._padding=o,this):this._padding};u.prototype.point=function t(o){return arguments.length?(this._point=typeof o==="function"?o:h.constant(o),this):this._point};u.prototype.pointSize=function t(o){return arguments.length?(this._pointSize=typeof o==="function"?o:h.constant(o),this):this._pointSize};u.prototype.pointSizeMax=function t(o){return arguments.length?(this._pointSizeMax=o,this):this._pointSizeMax};u.prototype.pointSizeMin=function t(o){return arguments.length?(this._pointSizeMin=o,this):this._pointSizeMin};u.prototype.tiles=function t(o){return arguments.length?(this._tiles=o,this):this._tiles};u.prototype.topojson=function t(o){return arguments.length?(this._topojson=o,this):this._topojson};u.prototype.topojsonFilter=function t(o){if(arguments.length){if(typeof o==="function")return this._topojsonFilter=o,this;if(!(o instanceof Array))o=[o];return this._topojsonFilter=function(t){return o.includes(t.id)},this}return this._topojsonFilter};u.prototype.topojsonKey=function t(o){return arguments.length?(this._topojsonKey=o,this):this._topojsonKey};u.prototype.zoom=function t(o){return arguments.length?(this._zoom=o,this):this._zoom};return u}(u.Viz);t.Geomap=c;Object.defineProperty(t,"__esModule",{value:true})});