/*
  d3plus-legend v0.7.5
  An easy to use javascript chart legend.
  Copyright (c) 2017 D3plus - https://d3plus.org
  @license MIT
*/
(function(t,i){typeof exports==="object"&&typeof module!=="undefined"?i(exports,require("d3-array"),require("d3-selection"),require("d3plus-common"),require("d3plus-shape"),require("d3plus-text")):typeof define==="function"&&define.amd?define("d3plus-legend",["exports","d3-array","d3-selection","d3plus-common","d3plus-shape","d3plus-text"],i):i(t.d3plus=t.d3plus||{},t.d3Array,t.d3Selection,t.d3plusCommon,t.shapes,t.d3plusText)})(this,function(t,i,e,n,h,r){"use strict";var s=function(t){function s(){var e=this;t.call(this);this._align="center";this._data=[];this._direction="row";this._duration=600;this._height=200;this._id=n.accessor("id");this._label=n.accessor("id");this._lineData=[];this._outerBounds={width:0,height:0,x:0,y:0};this._padding=5;this._shape=n.constant("Rect");this._shapeConfig={duration:this._duration,fill:n.accessor("color"),fontColor:n.constant("#444"),fontFamily:(new h.Rect).fontFamily(),fontResize:false,fontSize:n.constant(10),height:n.constant(10),hitArea:function(t){var n=e._lineData[e._data.indexOf(t)],h=i.max([n.height,n.shapeHeight]);return{width:n.width+n.shapeWidth,height:h,x:-n.shapeWidth/2,y:-h/2}},labelBounds:function(t,i,n){var h=e._lineData[t.i],r=n.r!==void 0?n.r:n.width/2;return{width:h.width,height:h.height,x:r+e._padding,y:-h.height/2}},opacity:1,r:n.constant(5),width:n.constant(10),x:function(t,i){var n=e._shapeConfig.width;var h=e._lineData[i].y;var r=e._align==="left"||e._align==="right"&&e._direction==="column"?0:e._align==="center"?(e._outerBounds.width-e._rowWidth(e._lineData.filter(function(t){return h===t.y})))/2:e._outerBounds.width-e._rowWidth(e._lineData.filter(function(t){return h===t.y}));var s=e._lineData.slice(0,i).filter(function(t){return h===t.y});return e._rowWidth(s)+e._padding*(s.length?2:0)+e._outerBounds.x+n(t,i)/2+r},y:function(t,n){var h=e._shapeConfig.height;var r=e._lineData[n];return r.y+e._titleHeight+e._outerBounds.y+i.max(e._lineData.filter(function(t){return r.y===t.y}).map(function(t){return t.height}).concat(e._data.map(function(t,i){return h(t,i)})))/2}};this._titleConfig={fontFamily:"Verdana",fontSize:12,lineHeight:13};this._verticalAlign="middle";this._width=400}if(t)s.__proto__=t;s.prototype=Object.create(t&&t.prototype);s.prototype.constructor=s;s.prototype._fetchConfig=function t(i,e,n){return typeof this._shapeConfig[i]==="function"?this._shapeConfig[i](e,n):this._shapeConfig[i]};s.prototype._rowHeight=function t(e){return i.max(e.map(function(t){return t.height}).concat(e.map(function(t){return t.shapeHeight})))+this._padding};s.prototype._rowWidth=function t(e){var n=this;return i.sum(e.map(function(t,i){var h=n._padding*(i===e.length-1?0:t.width?2:1);return t.shapeWidth+t.width+h}))};s.prototype.render=function t(s){var a=this;if(this._select===void 0){this.select(e.select("body").append("svg").attr("width",this._width+"px").attr("height",this._height+"px").node())}if(this._lineHeight===void 0){this._lineHeight=function(t,i){return a._fetchConfig("fontSize",t,i)*1.1}}this._group=n.elem("g.d3plus-Legend",{parent:this._select});var o=this._height;this._titleHeight=0;if(this._title){var l=this._titleConfig.fontFamily,d=this._titleConfig.lineHeight,u=this._titleConfig.fontSize;var _=r.textWrap().fontFamily(l).fontSize(u).lineHeight(d).width(this._width).height(this._height)(this._title);this._titleHeight=d+_.lines.length+this._padding;o-=this._titleHeight}this._lineData=this._data.map(function(t,e){var n=a._fetchConfig("fontFamily",t,e),h=a._lineHeight(t,e),s=a._fetchConfig("fontSize",t,e),l=a._fetchConfig("width",t,e);var d=o-(a._data.length+1)*a._padding,u=a._width;var _=r.textWrap().fontFamily(n).fontSize(s).lineHeight(h).width(u).height(d)(a._label(t,e));_.width=Math.ceil(i.max(_.lines.map(function(t){return r.textWidth(t,{"font-family":n,"font-size":s})})))+s*.75;_.height=Math.ceil(_.lines.length*(h+1));_.og={height:_.height,width:_.width};_.data=t;_.f=n;_.s=s;_.lh=h;_.y=0;_.id=a._id(t,e);_.i=e;_.shapeWidth=l;_.shapeHeight=a._fetchConfig("height",t,e);return _});var f;var g=this._width-this._padding*2;f=this._rowWidth(this._lineData);if(this._direction==="column"||f>g){var c=1,p=[];var w=i.max(this._lineData.map(function(t){return t.words.length}));this._wrapLines=function(){var t=this;c++;if(c>w){return}var e=c===1?this._lineData.slice():this._lineData.filter(function(i){return i.width+i.shapeWidth+t._padding*(i.width?2:1)>g&&i.words.length>=c}).sort(function(t,i){return i.sentence.length-t.sentence.length});if(e.length&&o>e[0].height*c){var n=false;var h=function(t){var h=e[t];var s=h.og.height*c,a=h.og.width*(1.5*(1/c));var o=r.textWrap().fontFamily(h.f).fontSize(h.s).lineHeight(h.lh).width(a).height(s)(h.sentence);if(!o.truncated){h.width=Math.ceil(i.max(o.lines.map(function(t){return r.textWidth(t,{"font-family":h.f,"font-size":h.s})})))+h.s;h.height=o.lines.length*(h.lh+1)}else{n=true;return"break"}};for(var s=0;s<e.length;s++){var a=h(s);if(a==="break")break}if(!n){this._wrapRows()}}else{p=[];return}};this._wrapRows=function(){var t=this;p=[];var e=1,n=0;for(var h=0;h<this._lineData.length;h++){var r=t._lineData[h],s=r.width+t._padding*(r.width?2:1)+r.shapeWidth;if(i.sum(p.map(function(t){return i.max(t,function(t){return i.max([t.height,t.shapeHeight])})}))>o){p=[];break}if(s>g){p=[];t._wrapLines();break}else if(n+s<g){n+=s}else if(t._direction!=="column"){n=s;e++}if(!p[e-1]){p[e-1]=[]}p[e-1].push(r);if(t._direction==="column"){n=0;e++}}};this._wrapRows();if(!p.length||i.sum(p,this._rowHeight.bind(this))+this._padding>o){f=i.sum(this._lineData.map(function(t){return t.shapeWidth+a._padding}))-this._padding;for(var y=0;y<this._lineData.length;y++){a._lineData[y].width=0;a._lineData[y].height=0}this._wrapRows()}if(p.length&&i.sum(p,this._rowHeight.bind(this))+this._padding<o){p.forEach(function(t,e){t.forEach(function(t){if(e){t.y=i.sum(p.slice(0,e),a._rowHeight.bind(a))}})});f=i.max(p,this._rowWidth.bind(this))}}var v=i.max(this._lineData,function(t,e){return i.max([t.height,a._fetchConfig("height",t.data,e)])+t.y})+this._titleHeight,m=f;this._outerBounds.width=m;this._outerBounds.height=v;var x=this._padding,C=this._padding;if(this._align==="center"){x=(this._width-m)/2}else if(this._align==="right"){x=this._width-this._padding-m}if(this._verticalAlign==="middle"){C=(this._height-v)/2}else if(this._verticalAlign==="bottom"){C=this._height-this._padding-v}this._outerBounds.x=x;this._outerBounds.y=C;(new r.TextBox).data(this._title?[{text:this._title}]:[]).duration(this._duration).select(this._group.node()).textAnchor({left:"start",center:"middle",right:"end"}[this._align]).width(this._width-this._padding*2).x(this._padding).y(this._outerBounds.y).config(this._titleConfig).render();this._shapes=[];var b=this._shapeConfig,H={id:function(t){return t.id},label:function(t){return t.label},lineHeight:function(t){return t.lH}};var D=this._data.map(function(t,i){var e={__d3plus__:true,data:t,i:i,id:a._id(t,i),label:a._lineData[i].width?a._label(t,i):false,lH:a._lineHeight(t,i),shape:a._shape(t,i)};var n=function(n){if(n!=="labelBounds"&&{}.hasOwnProperty.call(b,n)){if(typeof b[n]==="function"){e[n]=b[n](t,i);H[n]=function(t){return t[n]}}else if(n==="on"){H[n]={};var h=function(t){if({}.hasOwnProperty.call(b[n],t)){H[n][t]=function(i){if(!b[n][t]){return}b[n][t].bind(this)(i.data,i.i)}}};for(var r in b[n])h(r)}}};for(var h in b)n(h);return e});this._shapes=[];["Circle","Rect"].forEach(function(t){a._shapes.push((new h[t]).data(D.filter(function(i){return i.shape===t})).duration(a._duration).labelPadding(0).select(a._group.node()).verticalAlign("top").config(Object.assign({},b,H)).render())});if(s){setTimeout(s,this._duration+100)}return this};s.prototype.active=function t(i){this._shapes.forEach(function(t){return t.active(i)});return this};s.prototype.align=function t(i){return arguments.length?(this._align=i,this):this._align};s.prototype.data=function t(i){return arguments.length?(this._data=i,this):this._data};s.prototype.direction=function t(i){return arguments.length?(this._direction=i,this):this._direction};s.prototype.duration=function t(i){return arguments.length?(this._duration=i,this):this._duration};s.prototype.height=function t(i){return arguments.length?(this._height=i,this):this._height};s.prototype.hover=function t(i){this._shapes.forEach(function(t){return t.hover(i)});return this};s.prototype.id=function t(i){return arguments.length?(this._id=i,this):this._id};s.prototype.label=function t(i){return arguments.length?(this._label=typeof i==="function"?i:n.constant(i),this):this._label};s.prototype.outerBounds=function t(){return this._outerBounds};s.prototype.padding=function t(i){return arguments.length?(this._padding=i,this):this._padding};s.prototype.select=function t(i){return arguments.length?(this._select=e.select(i),this):this._select};s.prototype.shape=function t(i){return arguments.length?(this._shape=typeof i==="function"?i:n.constant(i),this):this._shape};s.prototype.shapeConfig=function t(i){return arguments.length?(this._shapeConfig=Object.assign(this._shapeConfig,i),this):this._shapeConfig};s.prototype.title=function t(i){return arguments.length?(this._title=i,this):this._title};s.prototype.titleConfig=function t(i){return arguments.length?(this._titleConfig=Object.assign(this._titleConfig,i),this):this._titleConfig};s.prototype.verticalAlign=function t(i){return arguments.length?(this._verticalAlign=i,this):this._verticalAlign};s.prototype.width=function t(i){return arguments.length?(this._width=i,this):this._width};return s}(n.BaseClass);t.Legend=s;Object.defineProperty(t,"__esModule",{value:true})});