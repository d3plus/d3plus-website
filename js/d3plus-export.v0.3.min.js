/*
  d3plus-export v0.3.0
  Export methods for transforming and downloading SVG.
  Copyright (c) 2017 D3plus - https://d3plus.org
  @license MIT
*/
(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?t(exports,require("html2canvas"),require("canvg-browser"),require("d3-selection"),require("canvas-toBlob"),require("file-saver")):typeof define==="function"&&define.amd?define("d3plus-export",["exports","html2canvas","canvg-browser","d3-selection","canvas-toBlob","file-saver"],t):t(e.d3plus=e.d3plus||{},e.html2canvas,e.canvg,e.d3Selection,null,e.fileSaver)})(this,function(e,t,a,s,i,l){"use strict";t="default"in t?t["default"]:t;a="default"in a?a["default"]:a;var r={background:false,callback:function(){},exclude:[],padding:0,scale:1};var n={ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true};function c(e){var t=s.select(e).attr("transform");var a=1,i=0,l=0;if(t){a=t.match(/scale\(([^a-z]+)\)/i);if(a){a=parseFloat(a[1])}else{a=1}var r=t.match(/translate\(([^a-z]+)\)/i);if(r){var n;n=r[1].replace(", ",",").replace(/([^a-z]),*\s([^a-z])/gi,"$1,$2").split(",").map(function(e){return parseFloat(e)*a}),i=n[0],l=n[1]}}return[a,i,l]}var o=function(e,i){if(!e){return}if(!(e instanceof Array)){e=[e]}i=Object.assign({},r,i);var l=new RegExp(/(MSIE|Trident\/|Edge\/)/i).test(navigator.userAgent);var o=window?window.devicePixelRatio||1:1;function d(e){var t=e.attr("stroke-width");e.attr("stroke-width",!t?0:t)}var h=e[0];if(h.constructor===Object){h=h.element}var v=i.height||parseFloat(s.select(h).style("height")),g=i.width||parseFloat(s.select(h).style("width"));var f,u,p=0,y=0;if(h.getBoundingClientRect){var m=h.getBoundingClientRect();p=m.left;y=m.top}else{p=h.offsetLeft;y=h.offsetTop}var x=document.createElement("canvas");x.width=(g+i.padding*2)*i.scale*o;x.height=(v+i.padding*2)*i.scale*o;x.style.width=(g+i.padding*2)*i.scale;x.style.height=(v+i.padding*2)*i.scale;var w=x.getContext("2d");w.scale(i.scale*o,i.scale*o);w.clearRect(0,0,x.width/2,x.height/2);if(i.background){w.beginPath();w.rect(0,0,x.width/2,x.height/2);w.fillStyle=i.background;w.fill()}var b=[];function k(e){if(i.exclude.includes(this)){return}var a=Object.assign({},e);if(this.tagName){var l=s.select(this).attr("opacity")||s.select(this).style("opacity");var r=s.select(this).style("display");var n=s.select(this).style("visibility");if(r==="none"||n==="hidden"||l&&parseFloat(l)===0){return}var h=this.tagName.toLowerCase();var m=c(this);var x=m[0];var w=m[1];var k=m[2];if(h==="g"){a.scale*=x;a.x+=w;a.y+=k}if(h==="svg"){var F=this.getBoundingClientRect();a.x+=F.left-p;a.y+=F.top-y;var O=s.select(this).attr("x");O=O?parseFloat(O)*a.scale:0;a.x+=O;var N=s.select(this).attr("y");N=N?parseFloat(N)*a.scale:0;a.y+=N;a.clip={height:parseFloat(s.select(this).attr("height")||s.select(this).style("height")),width:parseFloat(s.select(this).attr("width")||s.select(this).style("width")),x:O,y:N}}else{var A=s.select(this).attr("x");if(A){a.x+=parseFloat(A)*a.scale}var z=s.select(this).attr("y");if(z){a.y+=parseFloat(z)*a.scale}}}var C=(this.tagName||"").toLowerCase();if(!C.length){var E=(this.wholeText||"").replace(/\s/g,"");if(E.length){var T=this.nodeValue.replace(/^\s*/,"").replace(/^\n/,"").replace(/^\s*/,"").replace(/\n$/,"").replace(/\s*$/,"").replace(/\n$/,"");b.push({type:"text",style:this.parentNode,value:T,x:a.x,y:a.y})}}else if(C==="defs"){return}else if(C==="text"){var L=this.cloneNode(true);s.select(L).call(d);b.push(Object.assign({},a,{type:"svg",value:L}))}else if(["image","img"].includes(C)){var R=s.select(this).attr("href")||s.select(this).attr("xlink:href");if(R.length){var S=parseFloat(s.select(this).attr("height"))*a.scale,M=parseFloat(s.select(this).attr("width"))*a.scale;var B={clip:a.clip,height:S,loaded:false,type:"img",width:M,x:a.x,y:a.y};b.push(B);var q=new Image;q.crossOrigin="Anonymous";q.onload=function(){var e=document.createElement("canvas");var t=e.getContext("2d");e.height=S*o;e.width=M*o;t.drawImage(this,0,0,M*o,S*o);var a=document.createElement("img");a.src=e.toDataURL("image/png");B.value=a;B.loaded=true};q.src=R}}else if(["div","foreignobject","span"].includes(C)&&!s.select(this).selectAll("svg").size()){var I={height:v,loaded:false,type:"html",width:g,x:f-p,y:u-y};var P=document.createElement("canvas");P.width=(g+i.padding*2)*i.scale*o;P.height=(v+i.padding*2)*i.scale*o;var $=P.getContext("2d");$.scale(i.scale*o,i.scale*o);b.push(I);t(this,{allowTaint:true,background:undefined,canvas:P,height:v,letterRendering:true,taintTest:false,width:g}).then(function(e){I.value=e;I.loaded=true})}else if(C!=="svg"&&this.childNodes.length>0&&!s.select(this).selectAll("foreignobject, image, img, svg").size()){var X=this.cloneNode(true);s.select(X).selectAll("*").each(function(){s.select(this).call(d);if(s.select(this).attr("opacity")==="0"){this.parentNode.removeChild(this)}});b.push(Object.assign({},a,{type:"svg",value:X,tag:C}))}else if(this.childNodes.length>0){j(this,a)}else{var D=this.cloneNode(true);s.select(D).selectAll("*").each(function(){if(s.select(this).attr("opacity")==="0"){this.parentNode.removeChild(this)}});if(C==="line"){s.select(D).attr("x1",parseFloat(s.select(D).attr("x1"))+a.x);s.select(D).attr("x2",parseFloat(s.select(D).attr("x2"))+a.x);s.select(D).attr("y1",parseFloat(s.select(D).attr("y1"))+a.y);s.select(D).attr("y2",parseFloat(s.select(D).attr("y2"))+a.y)}else if(C==="path"){var H=c(D);var Y=H[0];var _=H[1];var U=H[2];if(s.select(D).attr("transform")){s.select(D).attr("transform","scale("+Y+")translate("+(_+a.x)+","+(U+a.y)+")")}}s.select(D).call(d);var V=s.select(D).attr("fill");var G=V&&V.indexOf("url")===0;b.push(Object.assign({},a,{type:"svg",value:D,tag:C}));if(G){var J=s.select(V.slice(4,-1)).node().cloneNode(true);var K=(J.tagName||"").toLowerCase();if(K==="pattern"){var Q=c(D);var W=Q[0];var Z=Q[1];var ee=Q[2];a.scale*=W;a.x+=Z;a.y+=ee;j(J,a)}}}}function j(e,t){s.selectAll(e.childNodes).each(function(){k.bind(this)(t)})}for(var F=0;F<e.length;F++){var O=e[F],N={scale:1,x:0,y:0};if(O.constructor===Object){N=Object.assign(N,O);O=O.element}f=N.x;u=N.y;k.bind(O)(N)}function A(){var e=true;for(var t=0;t<b.length;t++){if(b[t].loaded===false){e=false;break}}if(e){z()}else{setTimeout(A,500)}}A();function z(){for(var e=0;e<b.length;e++){var t=b[e];var r=t.clip||{height:v,width:g,x:0,y:0};switch(t.type){case"img":w.save();w.beginPath();w.translate(i.padding+r.x,i.padding+r.y);w.rect(0,0,r.width,r.height);w.clip();w.drawImage(t.value,t.x+r.x,t.y+r.y,t.width,t.height);w.restore();break;case"html":w.save();w.beginPath();w.translate(i.padding,i.padding);w.drawImage(t.value,t.x,t.y,t.width,t.height);w.restore();break;case"text":var c=s.select(t.style);var o=t.value.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");var d=c.style("color"),h=c.style("font-size");var f=c.style("font-family").split(",")[0];if(f.indexOf("'")!==0){f="'"+f+"'"}var u="<text stroke='none' dy='"+h+"' fill='"+d+"' font-family="+f+" font-size='"+h+"'>"+o+"</text>";w.save();w.translate(i.padding,i.padding);a(x,u,Object.assign({},n,{offsetX:t.x,offsetY:t.y}));w.restore();break;case"svg":var p=l?(new XMLSerializer).serializeToString(t.value):t.value.outerHTML;w.save();w.translate(i.padding+r.x,i.padding+r.y);w.rect(0,0,r.width,r.height);w.clip();a(x,p,Object.assign({},n,{offsetX:t.x+r.x,offsetY:t.y+r.y}));w.restore();break;default:console.warn("uncaught",t);break}}i.callback(x)}};var d={filename:"download",type:"png"};var h=function(e,t,a){if(t===void 0)t={};if(a===void 0)a={};if(!e){return}t=Object.assign({},d,t);var s=new RegExp(/(MSIE|Trident\/|Edge\/)/i).test(navigator.userAgent);if(!(e instanceof Array)&&t.type==="svg"){var i=s?(new XMLSerializer).serializeToString(e):e.outerHTML;l.saveAs(new Blob([i],{type:"application/svg+xml"}),t.filename+".svg")}o(e,Object.assign({},a,{callback:function(e){if(a.callback){a.callback(e)}if(["jpg","png"].includes(t.type)){e.toBlob(function(e){return l.saveAs(e,t.filename)})}}}))};e.dom2canvas=o;e.saveElement=h;Object.defineProperty(e,"__esModule",{value:true})});