/*
  d3plus-export v0.3.4
  Export methods for transforming and downloading SVG.
  Copyright (c) 2018 D3plus - https://d3plus.org
  @license MIT
*/
if(typeof Object.assign!=="function"){Object.defineProperty(Object,"assign",{value:function e(t){"use strict";if(t===null){throw new TypeError("Cannot convert undefined or null to object")}var a=Object(t);for(var r=1;r<arguments.length;r++){var i=arguments[r];if(i!==null){for(var s in i){if(Object.prototype.hasOwnProperty.call(i,s)){a[s]=i[s]}}}}return a},writable:true,configurable:true})}if(!Array.prototype.includes){Object.defineProperty(Array.prototype,"includes",{value:function e(t,a){var r=Object(this);var i=r.length>>>0;if(i===0)return false;var s=a|0;var l=Math.max(s>=0?s:i-Math.abs(s),0);function n(e,t){return e===t||typeof e==="number"&&typeof t==="number"&&isNaN(e)&&isNaN(t)}while(l<i){if(n(r[l],t)){return true}l++}return false}})}(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?t(exports,require("html2canvas"),require("canvg-browser"),require("d3-selection"),require("canvas-toBlob"),require("file-saver")):typeof define==="function"&&define.amd?define("d3plus-export",["exports","html2canvas","canvg-browser","d3-selection","canvas-toBlob","file-saver"],t):t(e.d3plus={},e.html2canvas,e.canvg,e.d3Selection,null,e.fileSaver)})(this,function(e,Q,v,W,t,s){"use strict";Q=Q&&Q.hasOwnProperty("default")?Q["default"]:Q;v=v&&v.hasOwnProperty("default")?v["default"]:v;function Z(e){var t=e.attr("stroke-width");e.attr("stroke-width",!t?0:t);var a=["none","transparent"].includes(e.attr("fill"));var r=e.attr("fill-opacity");e.attr("fill-opacity",a?0:r)}var o={background:false,callback:function(){},exclude:[],padding:0,scale:1};var g={ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true};function ee(e){var t;var a=W.select(e).attr("transform");var r=1,i=0,s=0;if(a){r=a.match(/scale\(([^a-z]+)\)/i);if(r){r=parseFloat(r[1])}else{r=1}var l=a.match(/translate\(([^a-z]+)\)/i);if(l){t=l[1].replace(", ",",").replace(/([^a-z]),*\s([^a-z])/gi,"$1,$2").split(",").map(function(e){return parseFloat(e)*r}),i=t[0],s=t[1]}}return[r,i,s]}function l(e,X){if(!e){return}if(!(e instanceof Array)){e=[e]}X=Object.assign({},o,X);var h=new RegExp(/(MSIE|Trident\/|Edge\/)/i).test(navigator.userAgent);var D=window?window.devicePixelRatio||1:1;var t=e[0];if(t.constructor===Object){t=t.element}var H=X.height||parseFloat(W.select(t).style("height")),Y=X.width||parseFloat(W.select(t).style("width"));var _,U,V=0,G=0;if(t.getBoundingClientRect){var a=t.getBoundingClientRect();V=a.left;G=a.top}else{V=t.offsetLeft;G=t.offsetTop}var d=document.createElement("canvas");d.width=(Y+X.padding*2)*X.scale*D;d.height=(H+X.padding*2)*X.scale*D;d.style.width=(Y+X.padding*2)*X.scale;d.style.height=(H+X.padding*2)*X.scale;var f=d.getContext("2d");f.scale(X.scale*D,X.scale*D);f.clearRect(0,0,d.width/D,d.height/D);if(X.background){f.beginPath();f.rect(0,0,d.width/D,d.height/D);f.fillStyle=X.background;f.fill()}var J=[];function r(e){var t=(this.tagName||"").toLowerCase();if(X.exclude.includes(this)||t==="foreignobject"){return}var a=Object.assign({},e);if(this.tagName){var r=W.select(this).attr("opacity")||W.select(this).style("opacity");var i=W.select(this).style("display");var s=W.select(this).style("visibility");if(i==="none"||s==="hidden"||r&&parseFloat(r)===0){return}var l=this.tagName.toLowerCase();var n=ee(this);var c=n[0];var o=n[1];var h=n[2];if(l==="g"){a.scale*=c;a.x+=o;a.y+=h}if(l==="svg"){var d=this.getBoundingClientRect();a.x+=d.left-V;a.y+=d.top-G;var f=W.select(this).attr("x");f=f?parseFloat(f)*a.scale:0;a.x+=f;var v=W.select(this).attr("y");v=v?parseFloat(v)*a.scale:0;a.y+=v;a.clip={height:parseFloat(W.select(this).attr("height")||W.select(this).style("height")),width:parseFloat(W.select(this).attr("width")||W.select(this).style("width")),x:f,y:v}}else{var g=W.select(this).attr("x");if(g){a.x+=parseFloat(g)*a.scale}var u=W.select(this).attr("y");if(u){a.y+=parseFloat(u)*a.scale}}}if(!t.length){var p=(this.wholeText||"").replace(/\s/g,"");if(p.length){var y=this.nodeValue.replace(/^\s*/,"").replace(/^\n/,"").replace(/^\s*/,"").replace(/\n$/,"").replace(/\s*$/,"").replace(/\n$/,"");J.push({type:"text",style:this.parentNode,value:y,x:a.x,y:a.y})}}else if(t==="defs"){return}else if(t==="text"){var m=this.cloneNode(true);W.select(m).call(Z);J.push(Object.assign({},a,{type:"svg",value:m}))}else if(["image","img"].includes(t)){var b=W.select(this).attr("href")||W.select(this).attr("xlink:href");if(b.length){var x=parseFloat(W.select(this).attr("height"))*a.scale,w=parseFloat(W.select(this).attr("width"))*a.scale;var O={clip:a.clip,height:x,loaded:false,type:"img",width:w,x:a.x,y:a.y};J.push(O);var j=new Image;j.crossOrigin="Anonymous";j.onload=function(){var e=document.createElement("canvas");var t=e.getContext("2d");e.height=x*D;e.width=w*D;t.drawImage(this,0,0,w*D,x*D);var a=document.createElement("img");a.src=e.toDataURL("image/png");O.value=a;O.loaded=true};j.src=b}}else if(["div","span"].includes(t)&&!W.select(this).selectAll("svg").size()){var k={height:H,loaded:false,type:"html",width:Y,x:_-V,y:U-G};var N=document.createElement("canvas");N.width=(Y+X.padding*2)*X.scale*D;N.height=(H+X.padding*2)*X.scale*D;var F=N.getContext("2d");F.scale(X.scale*D,X.scale*D);J.push(k);Q(this,{allowTaint:true,canvas:N,height:H,width:Y}).then(function(e){k.value=e;k.loaded=true})}else if(t!=="svg"&&this.childNodes.length>0&&!W.select(this).selectAll("image, img, svg").size()){var A=this.cloneNode(true);W.select(A).selectAll("*").each(function(){W.select(this).call(Z);if(W.select(this).attr("opacity")==="0"){this.parentNode.removeChild(this)}});J.push(Object.assign({},a,{type:"svg",value:A,tag:t}))}else if(this.childNodes.length>0){K(this,a)}else{var C=this.cloneNode(true);W.select(C).selectAll("*").each(function(){if(W.select(this).attr("opacity")==="0"){this.parentNode.removeChild(this)}});if(t==="line"){W.select(C).attr("x1",parseFloat(W.select(C).attr("x1"))+a.x);W.select(C).attr("x2",parseFloat(W.select(C).attr("x2"))+a.x);W.select(C).attr("y1",parseFloat(W.select(C).attr("y1"))+a.y);W.select(C).attr("y2",parseFloat(W.select(C).attr("y2"))+a.y)}else if(t==="path"){var z=ee(C);var E=z[0];var T=z[1];var M=z[2];if(W.select(C).attr("transform")){W.select(C).attr("transform","scale("+E+")translate("+(T+a.x)+","+(M+a.y)+")")}}W.select(C).call(Z);var P=W.select(C).attr("fill");var L=P&&P.indexOf("url")===0;J.push(Object.assign({},a,{type:"svg",value:C,tag:t}));if(L){var S=W.select(P.slice(4,-1)).node().cloneNode(true);var R=(S.tagName||"").toLowerCase();if(R==="pattern"){var B=ee(C);var q=B[0];var I=B[1];var $=B[2];a.scale*=q;a.x+=I;a.y+=$;K(S,a)}}}}function K(e,t){W.selectAll(e.childNodes).each(function(){r.bind(this)(t)})}for(var i=0;i<e.length;i++){var s=e[i],l={scale:1,x:0,y:0};if(s.constructor===Object){l=Object.assign(l,s);s=s.element}_=l.x;U=l.y;r.bind(s)(l)}function n(){var e=true;for(var t=0;t<J.length;t++){if(J[t].loaded===false){e=false;break}}if(e){c()}else{setTimeout(n,500)}}n();function c(){for(var e=0;e<J.length;e++){var t=J[e];var a=t.clip||{height:H,width:Y,x:0,y:0};switch(t.type){case"img":f.save();f.beginPath();f.translate(X.padding+a.x,X.padding+a.y);f.rect(0,0,a.width,a.height);f.clip();f.drawImage(t.value,t.x+a.x,t.y+a.y,t.width,t.height);f.restore();break;case"html":f.save();f.beginPath();f.translate(X.padding,X.padding);f.drawImage(t.value,t.x,t.y,t.width,t.height);f.restore();break;case"text":var r=W.select(t.style);var i=t.value.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");var s=r.style("color"),l=r.style("font-size");var n=r.style("font-family").split(",")[0];if(n.indexOf("'")!==0){n="'"+n+"'"}var c="<text stroke='none' dy='"+l+"' fill='"+s+"' font-family="+n+" font-size='"+l+"'>"+i+"</text>";f.save();f.translate(X.padding,X.padding);v(d,c,Object.assign({},g,{offsetX:t.x,offsetY:t.y}));f.restore();break;case"svg":var o=h?(new XMLSerializer).serializeToString(t.value):t.value.outerHTML;f.save();f.translate(X.padding+a.x,X.padding+a.y);f.rect(0,0,a.width,a.height);f.clip();v(d,o,Object.assign({},g,{offsetX:t.x+a.x,offsetY:t.y+a.y}));f.restore();break;default:console.warn("uncaught",t);break}}X.callback(d)}}var n={filename:"download",type:"png"};function a(e,t,a){if(t===void 0)t={};if(a===void 0)a={};if(!e){return}t=Object.assign({},n,t);var r=new RegExp(/(MSIE|Trident\/|Edge\/)/i).test(navigator.userAgent);if(!(e instanceof Array)&&t.type==="svg"){var i=r?(new XMLSerializer).serializeToString(e):e.outerHTML;s.saveAs(new Blob([i],{type:"application/svg+xml"}),t.filename+".svg")}l(e,Object.assign({},a,{callback:function(e){if(a.callback){a.callback(e)}if(["jpg","png"].includes(t.type)){e.toBlob(function(e){return s.saveAs(e,t.filename)})}}}))}e.dom2canvas=l;e.saveElement=a;Object.defineProperty(e,"__esModule",{value:true})});