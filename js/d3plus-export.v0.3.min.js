/*
  d3plus-export v0.3.2
  Export methods for transforming and downloading SVG.
  Copyright (c) 2017 D3plus - https://d3plus.org
  @license MIT
*/
if(typeof Object.assign!=="function"){Object.defineProperty(Object,"assign",{value:function e(t){"use strict";if(t===null){throw new TypeError("Cannot convert undefined or null to object")}var a=Object(t);for(var r=1;r<arguments.length;r++){var i=arguments[r];if(i!==null){for(var s in i){if(Object.prototype.hasOwnProperty.call(i,s)){a[s]=i[s]}}}}return a},writable:true,configurable:true})}if(!Array.prototype.includes){Object.defineProperty(Array.prototype,"includes",{value:function e(t,a){var r=Object(this);var i=r.length>>>0;if(i===0)return false;var s=a|0;var l=Math.max(s>=0?s:i-Math.abs(s),0);function n(e,t){return e===t||typeof e==="number"&&typeof t==="number"&&isNaN(e)&&isNaN(t)}while(l<i){if(n(r[l],t)){return true}l++}return false}})}(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?t(exports,require("html2canvas"),require("canvg-browser"),require("d3-selection"),require("canvas-toBlob"),require("file-saver")):typeof define==="function"&&define.amd?define("d3plus-export",["exports","html2canvas","canvg-browser","d3-selection","canvas-toBlob","file-saver"],t):t(e.d3plus={},e.html2canvas,e.canvg,e.d3Selection,null,e.fileSaver)})(this,function(e,t,a,r,i,s){"use strict";t=t&&t.hasOwnProperty("default")?t["default"]:t;a=a&&a.hasOwnProperty("default")?a["default"]:a;var l=function(e){var t=e.attr("stroke-width");e.attr("stroke-width",!t?0:t);var a=["none","transparent"].includes(e.attr("fill"));var r=e.attr("fill-opacity");e.attr("fill-opacity",a?0:r)};var n={background:false,callback:function(){},exclude:[],padding:0,scale:1};var c={ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true};function o(e){var t=r.select(e).attr("transform");var a=1,i=0,s=0;if(t){a=t.match(/scale\(([^a-z]+)\)/i);if(a){a=parseFloat(a[1])}else{a=1}var l=t.match(/translate\(([^a-z]+)\)/i);if(l){var n;n=l[1].replace(", ",",").replace(/([^a-z]),*\s([^a-z])/gi,"$1,$2").split(",").map(function(e){return parseFloat(e)*a}),i=n[0],s=n[1]}}return[a,i,s]}var h=function(e,i){if(!e){return}if(!(e instanceof Array)){e=[e]}i=Object.assign({},n,i);var s=new RegExp(/(MSIE|Trident\/|Edge\/)/i).test(navigator.userAgent);var h=window?window.devicePixelRatio||1:1;var d=e[0];if(d.constructor===Object){d=d.element}var f=i.height||parseFloat(r.select(d).style("height")),v=i.width||parseFloat(r.select(d).style("width"));var g,u,p=0,y=0;if(d.getBoundingClientRect){var m=d.getBoundingClientRect();p=m.left;y=m.top}else{p=d.offsetLeft;y=d.offsetTop}var b=document.createElement("canvas");b.width=(v+i.padding*2)*i.scale*h;b.height=(f+i.padding*2)*i.scale*h;b.style.width=(v+i.padding*2)*i.scale;b.style.height=(f+i.padding*2)*i.scale;var x=b.getContext("2d");x.scale(i.scale*h,i.scale*h);x.clearRect(0,0,b.width/2,b.height/2);if(i.background){x.beginPath();x.rect(0,0,b.width/2,b.height/2);x.fillStyle=i.background;x.fill()}var w=[];function O(e){var a=(this.tagName||"").toLowerCase();if(i.exclude.includes(this)||a==="foreignobject"){return}var s=Object.assign({},e);if(this.tagName){var n=r.select(this).attr("opacity")||r.select(this).style("opacity");var c=r.select(this).style("display");var d=r.select(this).style("visibility");if(c==="none"||d==="hidden"||n&&parseFloat(n)===0){return}var m=this.tagName.toLowerCase();var b=o(this);var x=b[0];var O=b[1];var k=b[2];if(m==="g"){s.scale*=x;s.x+=O;s.y+=k}if(m==="svg"){var N=this.getBoundingClientRect();s.x+=N.left-p;s.y+=N.top-y;var F=r.select(this).attr("x");F=F?parseFloat(F)*s.scale:0;s.x+=F;var A=r.select(this).attr("y");A=A?parseFloat(A)*s.scale:0;s.y+=A;s.clip={height:parseFloat(r.select(this).attr("height")||r.select(this).style("height")),width:parseFloat(r.select(this).attr("width")||r.select(this).style("width")),x:F,y:A}}else{var C=r.select(this).attr("x");if(C){s.x+=parseFloat(C)*s.scale}var z=r.select(this).attr("y");if(z){s.y+=parseFloat(z)*s.scale}}}if(!a.length){var E=(this.wholeText||"").replace(/\s/g,"");if(E.length){var T=this.nodeValue.replace(/^\s*/,"").replace(/^\n/,"").replace(/^\s*/,"").replace(/\n$/,"").replace(/\s*$/,"").replace(/\n$/,"");w.push({type:"text",style:this.parentNode,value:T,x:s.x,y:s.y})}}else if(a==="defs"){return}else if(a==="text"){var M=this.cloneNode(true);r.select(M).call(l);w.push(Object.assign({},s,{type:"svg",value:M}))}else if(["image","img"].includes(a)){var P=r.select(this).attr("href")||r.select(this).attr("xlink:href");if(P.length){var L=parseFloat(r.select(this).attr("height"))*s.scale,S=parseFloat(r.select(this).attr("width"))*s.scale;var R={clip:s.clip,height:L,loaded:false,type:"img",width:S,x:s.x,y:s.y};w.push(R);var B=new Image;B.crossOrigin="Anonymous";B.onload=function(){var e=document.createElement("canvas");var t=e.getContext("2d");e.height=L*h;e.width=S*h;t.drawImage(this,0,0,S*h,L*h);var a=document.createElement("img");a.src=e.toDataURL("image/png");R.value=a;R.loaded=true};B.src=P}}else if(["div","span"].includes(a)&&!r.select(this).selectAll("svg").size()){var q={height:f,loaded:false,type:"html",width:v,x:g-p,y:u-y};var I=document.createElement("canvas");I.width=(v+i.padding*2)*i.scale*h;I.height=(f+i.padding*2)*i.scale*h;var $=I.getContext("2d");$.scale(i.scale*h,i.scale*h);w.push(q);t(this,{allowTaint:true,canvas:I,height:f,width:v}).then(function(e){q.value=e;q.loaded=true})}else if(a!=="svg"&&this.childNodes.length>0&&!r.select(this).selectAll("image, img, svg").size()){var X=this.cloneNode(true);r.select(X).selectAll("*").each(function(){r.select(this).call(l);if(r.select(this).attr("opacity")==="0"){this.parentNode.removeChild(this)}});w.push(Object.assign({},s,{type:"svg",value:X,tag:a}))}else if(this.childNodes.length>0){j(this,s)}else{var D=this.cloneNode(true);r.select(D).selectAll("*").each(function(){if(r.select(this).attr("opacity")==="0"){this.parentNode.removeChild(this)}});if(a==="line"){r.select(D).attr("x1",parseFloat(r.select(D).attr("x1"))+s.x);r.select(D).attr("x2",parseFloat(r.select(D).attr("x2"))+s.x);r.select(D).attr("y1",parseFloat(r.select(D).attr("y1"))+s.y);r.select(D).attr("y2",parseFloat(r.select(D).attr("y2"))+s.y)}else if(a==="path"){var H=o(D);var Y=H[0];var _=H[1];var U=H[2];if(r.select(D).attr("transform")){r.select(D).attr("transform","scale("+Y+")translate("+(_+s.x)+","+(U+s.y)+")")}}r.select(D).call(l);var V=r.select(D).attr("fill");var G=V&&V.indexOf("url")===0;w.push(Object.assign({},s,{type:"svg",value:D,tag:a}));if(G){var J=r.select(V.slice(4,-1)).node().cloneNode(true);var K=(J.tagName||"").toLowerCase();if(K==="pattern"){var Q=o(D);var W=Q[0];var Z=Q[1];var ee=Q[2];s.scale*=W;s.x+=Z;s.y+=ee;j(J,s)}}}}function j(e,t){r.selectAll(e.childNodes).each(function(){O.bind(this)(t)})}for(var k=0;k<e.length;k++){var N=e[k],F={scale:1,x:0,y:0};if(N.constructor===Object){F=Object.assign(F,N);N=N.element}g=F.x;u=F.y;O.bind(N)(F)}function A(){var e=true;for(var t=0;t<w.length;t++){if(w[t].loaded===false){e=false;break}}if(e){C()}else{setTimeout(A,500)}}A();function C(){for(var e=0;e<w.length;e++){var t=w[e];var l=t.clip||{height:f,width:v,x:0,y:0};switch(t.type){case"img":x.save();x.beginPath();x.translate(i.padding+l.x,i.padding+l.y);x.rect(0,0,l.width,l.height);x.clip();x.drawImage(t.value,t.x+l.x,t.y+l.y,t.width,t.height);x.restore();break;case"html":x.save();x.beginPath();x.translate(i.padding,i.padding);x.drawImage(t.value,t.x,t.y,t.width,t.height);x.restore();break;case"text":var n=r.select(t.style);var o=t.value.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");var h=n.style("color"),d=n.style("font-size");var g=n.style("font-family").split(",")[0];if(g.indexOf("'")!==0){g="'"+g+"'"}var u="<text stroke='none' dy='"+d+"' fill='"+h+"' font-family="+g+" font-size='"+d+"'>"+o+"</text>";x.save();x.translate(i.padding,i.padding);a(b,u,Object.assign({},c,{offsetX:t.x,offsetY:t.y}));x.restore();break;case"svg":var p=s?(new XMLSerializer).serializeToString(t.value):t.value.outerHTML;x.save();x.translate(i.padding+l.x,i.padding+l.y);x.rect(0,0,l.width,l.height);x.clip();a(b,p,Object.assign({},c,{offsetX:t.x+l.x,offsetY:t.y+l.y}));x.restore();break;default:console.warn("uncaught",t);break}}i.callback(b)}};var d={filename:"download",type:"png"};var f=function(e,t,a){if(t===void 0)t={};if(a===void 0)a={};if(!e){return}t=Object.assign({},d,t);var r=new RegExp(/(MSIE|Trident\/|Edge\/)/i).test(navigator.userAgent);if(!(e instanceof Array)&&t.type==="svg"){var i=r?(new XMLSerializer).serializeToString(e):e.outerHTML;s.saveAs(new Blob([i],{type:"application/svg+xml"}),t.filename+".svg")}h(e,Object.assign({},a,{callback:function(e){if(a.callback){a.callback(e)}if(["jpg","png"].includes(t.type)){e.toBlob(function(e){return s.saveAs(e,t.filename)})}}}))};e.dom2canvas=h;e.saveElement=f;Object.defineProperty(e,"__esModule",{value:true})});