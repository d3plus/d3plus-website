/*
  d3plus-export v0.3.9
  Export methods for transforming and downloading SVG.
  Copyright (c) 2019 D3plus - https://d3plus.org
  @license MIT
*/
if(typeof Object.assign!=="function"){Object.defineProperty(Object,"assign",{value:function e(t){"use strict";if(t===null){throw new TypeError("Cannot convert undefined or null to object")}var a=Object(t);for(var r=1;r<arguments.length;r++){var i=arguments[r];if(i!==null){for(var s in i){if(Object.prototype.hasOwnProperty.call(i,s)){a[s]=i[s]}}}}return a},writable:true,configurable:true})}if(!Array.prototype.includes){Object.defineProperty(Array.prototype,"includes",{value:function e(t,a){var r=Object(this);var i=r.length>>>0;if(i===0)return false;var s=a|0;var l=Math.max(s>=0?s:i-Math.abs(s),0);function n(e,t){return e===t||typeof e==="number"&&typeof t==="number"&&isNaN(e)&&isNaN(t)}while(l<i){if(n(r[l],t)){return true}l++}return false}})}(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?t(exports,require("html2canvas"),require("canvg-browser"),require("d3-selection"),require("canvas-toBlob"),require("file-saver")):typeof define==="function"&&define.amd?define("d3plus-export",["exports","html2canvas","canvg-browser","d3-selection","canvas-toBlob","file-saver"],t):t(e.d3plus={},e.html2canvas,e.canvg,e.d3Selection,null,e.fileSaver)})(this,function(e,K,v,Q,t,s){"use strict";K=K&&K.hasOwnProperty("default")?K["default"]:K;v=v&&v.hasOwnProperty("default")?v["default"]:v;function W(e){var t=e.attr("stroke-width");e.attr("stroke-width",!t?0:t);var a=["none","transparent"].includes(e.attr("fill"));var r=e.attr("fill-opacity");e.attr("fill-opacity",a?0:r)}var o={background:false,callback:function(){},exclude:[],padding:0,scale:1};var g={ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true};function Z(e){var t;var a=Q.select(e).attr("transform");var r=1,i=0,s=0;if(a){r=a.match(/scale\(([^a-z]+)\)/i);if(r){r=parseFloat(r[1])}else{r=1}var l=a.match(/translate\(([^a-z]+)\)/i);if(l){t=l[1].replace(", ",",").replace(/([^a-z]),*\s([^a-z])/gi,"$1,$2").split(",").map(function(e){return parseFloat(e)*r}),i=t[0],s=t[1]}}return[r,i,s]}function l(e,$){if(!e){return}if(!(e instanceof Array)){e=[e]}$=Object.assign({},o,$);var d=new RegExp(/(MSIE|Trident\/|Edge\/)/i).test(navigator.userAgent);var X=window?window.devicePixelRatio||1:1;var t=e[0];if(t.constructor===Object){t=t.element}var D=$.height||parseFloat(Q.select(t).style("height")),H=$.width||parseFloat(Q.select(t).style("width"));var Y,_,U=0,V=0;if(t.getBoundingClientRect){var a=t.getBoundingClientRect();U=a.left;V=a.top}else{U=t.offsetLeft;V=t.offsetTop}var h=document.createElement("canvas");h.width=(H+$.padding*2)*$.scale*X;h.height=(D+$.padding*2)*$.scale*X;h.style.width=(H+$.padding*2)*$.scale;h.style.height=(D+$.padding*2)*$.scale;var f=h.getContext("2d");f.scale($.scale*X,$.scale*X);f.clearRect(0,0,h.width/X,h.height/X);if($.background){f.beginPath();f.rect(0,0,h.width/X,h.height/X);f.fillStyle=$.background;f.fill()}var G=[];function r(e){var t=(this.tagName||"").toLowerCase();if($.exclude.includes(this)||t==="foreignobject"){return}var a=Object.assign({},e);if(this.tagName){var r=Q.select(this).attr("opacity")||Q.select(this).style("opacity");var i=Q.select(this).style("display");var s=Q.select(this).style("visibility");if(i==="none"||s==="hidden"||r&&parseFloat(r)===0){return}var l=this.tagName.toLowerCase();if(l.length&&["defs","title","desc"].includes(l)){return}if(l==="svg"){if(!a.svg){var n=this.getBoundingClientRect();var c=n.left;var o=n.top;a.x+=c-U;a.y+=o-V;a.svg=true}var d=Q.select(this).attr("x");d=d?parseFloat(d)*a.scale:0;a.x+=d;var h=Q.select(this).attr("y");h=h?parseFloat(h)*a.scale:0;a.y+=h;a.clip={height:parseFloat(Q.select(this).attr("height")||Q.select(this).style("height")),width:parseFloat(Q.select(this).attr("width")||Q.select(this).style("width")),x:d,y:h}}else{var f=Q.select(this).attr("x");if(f){a.x+=parseFloat(f)*a.scale}var v=Q.select(this).attr("y");if(v){a.y+=parseFloat(v)*a.scale}}}if(!t.length){var g=(this.wholeText||"").replace(/\s/g,"");if(g.length){var u=this.nodeValue.replace(/^\s*/,"").replace(/^\n/,"").replace(/^\s*/,"").replace(/\n$/,"").replace(/\s*$/,"").replace(/\n$/,"");G.push({type:"text",style:this.parentNode,value:u,x:a.x,y:a.y})}}else if(t==="text"){var p=this.cloneNode(true);Q.select(p).call(W);G.push(Object.assign({},a,{type:"svg",value:p}))}else if(["image","img"].includes(t)){var y=Q.select(this).attr("href")||Q.select(this).attr("xlink:href");if(y.length){var m=parseFloat(Q.select(this).attr("height"))*a.scale,x=parseFloat(Q.select(this).attr("width"))*a.scale;var b={clip:a.clip,height:m,loaded:false,type:"img",width:x,x:a.x,y:a.y};G.push(b);var w=new Image;w.crossOrigin="Anonymous";w.onload=function(){var e=document.createElement("canvas");var t=e.getContext("2d");e.height=m*X;e.width=x*X;t.drawImage(this,0,0,x*X,m*X);var a=document.createElement("img");a.src=e.toDataURL("image/png");b.value=a;b.loaded=true};w.src=y}}else if(!["svg","g","text"].includes(t)&&!Q.select(this).selectAll("svg").size()){var O=$.scale*X;var j={height:D+$.padding*2+V,loaded:false,type:"html",width:H+$.padding*2+U,x:Y-U,y:_-V};var k=document.createElement("canvas");k.width=(H+$.padding*2+U)*O;k.height=(D+$.padding*2+V)*O;k.style.width=(H+$.padding*2+U)*O+"px";k.style.height=(D+$.padding*2+V)*O+"px";var N=k.getContext("2d");N.scale(O,O);G.push(j);K(this,{allowTaint:true,canvas:k}).then(function(e){j.value=e;j.loaded=true})}else if(t!=="svg"&&this.childNodes.length>0&&!Q.select(this).selectAll("image, img, svg").size()){var F=this.cloneNode(true);Q.select(F).selectAll("*").each(function(){Q.select(this).call(W);if(Q.select(this).attr("opacity")==="0"){this.parentNode.removeChild(this)}});G.push(Object.assign({},a,{type:"svg",value:F,tag:t}))}else if(this.childNodes.length>0){J(this,a)}else{var A=this.cloneNode(true);Q.select(A).selectAll("*").each(function(){if(Q.select(this).attr("opacity")==="0"){this.parentNode.removeChild(this)}});if(t==="line"){Q.select(A).attr("x1",parseFloat(Q.select(A).attr("x1"))+a.x);Q.select(A).attr("x2",parseFloat(Q.select(A).attr("x2"))+a.x);Q.select(A).attr("y1",parseFloat(Q.select(A).attr("y1"))+a.y);Q.select(A).attr("y2",parseFloat(Q.select(A).attr("y2"))+a.y)}else if(t==="path"){var C=Z(A);var z=C[0];var E=C[1];var T=C[2];if(Q.select(A).attr("transform")){Q.select(A).attr("transform","scale("+z+")translate("+(E+a.x)+","+(T+a.y)+")")}}Q.select(A).call(W);var M=Q.select(A).attr("fill");var P=M&&M.indexOf("url")===0;G.push(Object.assign({},a,{type:"svg",value:A,tag:t}));if(P){var L=Q.select(M.slice(4,-1)).node().cloneNode(true);var S=(L.tagName||"").toLowerCase();if(S==="pattern"){var R=Z(A);var B=R[0];var q=R[1];var I=R[2];a.scale*=B;a.x+=q;a.y+=I;J(L,a)}}}}function J(e,t){Q.selectAll(e.childNodes).each(function(){r.bind(this)(t)})}for(var i=0;i<e.length;i++){var s=e[i],l={scale:1,x:0,y:0,svg:false};if(s.constructor===Object){l=Object.assign(l,s);s=s.element}Y=l.x;_=l.y;r.bind(s)(l)}function n(){var e=true;for(var t=0;t<G.length;t++){if(G[t].loaded===false){e=false;break}}if(e){c()}else{setTimeout(n,500)}}n();function c(){for(var e=0;e<G.length;e++){var t=G[e];var a=t.clip||{height:D,width:H,x:0,y:0};switch(t.type){case"img":f.save();f.beginPath();f.translate($.padding+a.x,$.padding+a.y);f.rect(0,0,a.width,a.height);f.clip();f.drawImage(t.value,t.x+a.x,t.y+a.y,t.width,t.height);f.restore();break;case"html":f.save();f.beginPath();f.translate($.padding,$.padding);f.drawImage(t.value,t.x,t.y,t.width,t.height);f.restore();break;case"text":var r=Q.select(t.style);var i=t.value.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");var s=r.style("color"),l=r.style("font-size");var n=r.style("font-family").split(",")[0];if(n.indexOf("'")!==0){n="'"+n+"'"}var c="<text stroke='none' dy='"+l+"' fill='"+s+"' font-family="+n+" font-size='"+l+"'>"+i+"</text>";f.save();f.translate($.padding,$.padding);v(h,c,Object.assign({},g,{offsetX:t.x,offsetY:t.y}));f.restore();break;case"svg":var o=d?(new XMLSerializer).serializeToString(t.value):t.value.outerHTML;f.save();f.translate($.padding+a.x+t.x,$.padding+a.y+t.y);f.rect(0,0,a.width,a.height);f.clip();v(h,o,Object.assign({},g,{offsetX:t.x+a.x,offsetY:t.y+a.y}));f.restore();break;default:console.warn("uncaught",t);break}}$.callback(h)}}var n={filename:"download",type:"png"};function a(e,t,a){if(t===void 0)t={};if(a===void 0)a={};if(!e){return}t=Object.assign({},n,t);var r=new RegExp(/(MSIE|Trident\/|Edge\/)/i).test(navigator.userAgent);if(!(e instanceof Array)&&t.type==="svg"){var i=r?(new XMLSerializer).serializeToString(e):e.outerHTML;s.saveAs(new Blob([i],{type:"application/svg+xml"}),t.filename+".svg")}l(e,Object.assign({},a,{callback:function(e){if(a.callback){a.callback(e)}if(["jpg","png"].includes(t.type)){e.toBlob(function(e){return s.saveAs(e,t.filename)})}}}))}e.dom2canvas=l;e.saveElement=a;Object.defineProperty(e,"__esModule",{value:true})});